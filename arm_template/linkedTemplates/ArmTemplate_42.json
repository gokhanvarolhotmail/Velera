{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "factoryName": {
            "type": "string",
            "metadata": "Data Factory name",
            "defaultValue": "EnterpriseDataSourceProdDF"
        }
    },
    "variables": {
        "factoryId": "[concat('Microsoft.DataFactory/factories/', parameters('factoryName'))]"
    },
    "resources": [
        {
            "name": "[concat(parameters('factoryName'), '/CrossCycle_Adjustments')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "FirstData"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "dropZoneTransactions_CrossCycle",
                                "type": "DatasetReference"
                            },
                            "name": "CrossCycle"
                        },
                        {
                            "dataset": {
                                "referenceName": "src_stgCCUMSTR",
                                "type": "DatasetReference"
                            },
                            "name": "CCUMSTR"
                        },
                        {
                            "dataset": {
                                "referenceName": "FDTransactionCriteria",
                                "type": "DatasetReference"
                            },
                            "name": "TransactionCriteria"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "snk_cnfmFISTransactions",
                                "type": "DatasetReference"
                            },
                            "name": "sink1"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "BaseTransformations"
                        },
                        {
                            "name": "Trim"
                        },
                        {
                            "name": "Join1"
                        },
                        {
                            "name": "Join2"
                        },
                        {
                            "name": "Filter2"
                        },
                        {
                            "name": "HashAndNullTxnName"
                        },
                        {
                            "name": "LimitSelect"
                        },
                        {
                            "name": "TNCFilter"
                        },
                        {
                            "name": "Dedupe"
                        },
                        {
                            "name": "Join3"
                        },
                        {
                            "name": "TrimCriteria"
                        },
                        {
                            "name": "TrimCCUMSTR"
                        }
                    ],
                    "script": "parameters{\n\tfileName as string\n}\nsource(output(\n\t\tCrossCycle_Adjustments_ID as string,\n\t\tReportDate as string,\n\t\tCreditUnion as string,\n\t\tRDT_CHD_ACCOUNT_NUMBER as string,\n\t\tRDT_DP_BATCH_TYPE as string,\n\t\tRDT_DP_EXP_JUL_DATE as string,\n\t\tRDT_DP_TYPE as string,\n\t\tRDT_DP_SYS_1 as string,\n\t\tRDT_DP_SYS_5 as string,\n\t\tRDT_DP_DATE as string,\n\t\tRDT_DP_EXP_ADJ_BATCH as string,\n\t\tRTI_REG_INDUSTRY_TRAN_ID as string,\n\t\tRDT_DP_NET_ADJ_AMOUNT as string,\n\t\tRDT_DP_ORIG_JUL_DATE as string,\n\t\tSQLDLOG_JobID as string,\n\t\tRDT_REC_CODE_KEY as string,\n\t\tRDT_REC_TYPE_CONTROL as string,\n\t\tRDT_NO_POST_REASON as string,\n\t\tRDT_SC_1 as string,\n\t\tRDT_SC_2 as string,\n\t\tRDT_SC_3 as string,\n\t\tRDT_SC_4 as string,\n\t\tRDT_SC_5 as string,\n\t\tRDT_SC_6 as string,\n\t\tRDT_SC_7 as string,\n\t\tRDT_SC_8 as string,\n\t\tRDT_CHD_SYSTEM_NO as string,\n\t\tRDT_CHD_PRIN_BANK as string,\n\t\tRDT_CHD_AGENT_BANK as string,\n\t\tRDT_TRANSACTION_CODE as string,\n\t\tRDT_MRCH_SYSTEM_NO as string,\n\t\tRDT_MRCH_PRIN_BANK as string,\n\t\tRDT_MRCH_AGENT_NO as string,\n\t\tRDT_MRCH_ACCOUNT_NUMBER as string,\n\t\tRDT_CHD_EXT_STATUS as string,\n\t\tRDT_CHD_INT_STATUS as string,\n\t\tRDT_TANI as string,\n\t\tRDT_TRANSFER_FLAG as string,\n\t\tRDT_ITEM_ASSES_CODE_NUM as string,\n\t\tRDT_MRCH_SIC_CODE as string,\n\t\tRDT_TRANSACTION_DATE as string,\n\t\tRDT_DP_AUDIT_TRAIL as string,\n\t\tRDT_DP_OLD_BALANCE_CYC_OP as string,\n\t\tRDT_DP_NEW_BALANCE_CYC_OP as string,\n\t\tRDT_DP_NET_PRIN_CHNG as string,\n\t\tRDT_DP_NET_BILLED_FIN_CHG_CHNG as string,\n\t\tRDT_DP_CHNG_CAINT_BILLED as string,\n\t\tRDT_DP_CHNG_MRCH_SC_BILLED as string,\n\t\tRDT_DP_CHNG_MRCHINT_BILLED as string,\n\t\tRDT_DP_CHNG_CRLIFE_BILLED as string,\n\t\tRDT_DP_CHNG_CTD_ACC_CASHINT as string,\n\t\tRDT_DP_CHNG_CTD_ACC_MRCHINT as string,\n\t\tRDT_DP_TOTAL_BALANCE_CHNG as string,\n\t\tRDT_DP_NET_FIN_CHG_MTJ as string,\n\t\tRDT_DP_CHNG_CREDINT_PAID as string,\n\t\tRDT_DP_CHNG_CTD_CREDINT as string,\n\t\tRDT_DP_CHNG_REBATE_AMT as string,\n\t\tRDT_DP_ENTERED_ACCT_NO as string,\n\t\tRDT_DP_LOYALTY_MRCH_TYPE as string,\n\t\tRDT_DP_RIS_IND as string,\n\t\tRDT_DP_MRCH_RIS_IND as string,\n\t\tRDT_DP_MAIL_PHONE_IND as string,\n\t\tRDT_DP_FLOOR_LIMIT_IND as string,\n\t\tRDT_DP_CWB_CRB_IND as string,\n\t\tRDT_DP_LCS_IND as string,\n\t\tRDT_DP_MATCHING_AUTH_IND as string,\n\t\tRDT_ADDL_SEGS_NO as string,\n\t\tREG_SEGMENT_CODE as string,\n\t\tRTI_REG_TRAN_ID_SOURCE as string,\n\t\tRTI_REG_MISC_AMOUNT as string,\n\t\tRTI_REG_TICKET_AUTH_AMOUNT as string,\n\t\tRTI_REG_BNK_RFRN_ID as string,\n\t\tRTI_REG_ORIG_TRAN_ID as string,\n\t\tRTI_REG_CARD_INPUT_MODE_CD as string,\n\t\tOTI_SEGMENT_CODE as string,\n\t\tOTI_ORIGINAL_REF_NO as string,\n\t\tOTI_ORIGINAL_POST_DATE as string,\n\t\tOTI_ORIGINAL_ADJ_TRAN_DT as string,\n\t\tAPR_SEGMENT_CODE as string,\n\t\tAPR_EAPR_CASH_INT as string,\n\t\tAPR_EAPR_MRCH_INT as string,\n\t\tAPR_EAPR_CASH_ITEM_CHG as string,\n\t\tAPR_EAPR_MRCH_ITEM_CHG as string,\n\t\tAPR_EAPR_LATE_CHG as string,\n\t\tAPR_EAPR_OVLM_CHG as string,\n\t\tAPR2_SEGMENT_CODE as string,\n\t\tAPR2_EAPR_MIN_CHG as string,\n\t\tAPR2_EAPR_STMT_CHG as string,\n\t\tAPR2_EAPR_CR_LIFE_CHG as string,\n\t\tAPR2_EAPR_REBATE_AMT as string,\n\t\tAPR2_EAPR_MIN_FINC_CASH_AM as string,\n\t\tAPR2_EAPR_MXCP_CRDT_AM as string,\n\t\tDFP_SEGMENT_CODE as string,\n\t\tRDT_DFP_FEE_NM as string,\n\t\tRDT_DFP_FEE_AM as string,\n\t\tRDT_DFP_PSTN_BCKT_ID as string,\n\t\tRDT_DFP_MMB_CD as string,\n\t\tRDT_DFP_RCUR_ID as string,\n\t\tRDT_DFP_LTTR_IN as string,\n\t\tRDT_DFP_MEMO_IN as string,\n\t\tRDT_DFP_BTCH_ALPH_CD as string,\n\t\tRDT_DFP_EMBD_IN as string,\n\t\tRDT_DFP_RESN_CD as string,\n\t\tRDT_DFP_STMT_PSTN_CD as string,\n\t\tRDT_DFP_RPT_CD as string,\n\t\tRDT_DFP_DYNM_FEE_GNRC_CD as string,\n\t\tRDT_TKN_CDT as string,\n\t\tRDT_TKN_SRVC_NMBR_ID as string,\n\t\tRDT_WLLT_ID as string,\n\t\tRDT_TKN_RQST_ID as string,\n\t\tRDT_TKN_FILLER as string,\n\t\tRDT_GNRC_TRAN_FLD_SEG_CD as string,\n\t\tRDT_CARD_ACCP_TERM_ID as string,\n\t\tRDT_MRCH_FULL_ZIP_CD as string,\n\t\tRDT_GTF_FILLER as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> CrossCycle\nsource(output(\n\t\tSPAIdentifier as string,\n\t\tsys as string,\n\t\tprin as string,\n\t\tagent as string,\n\t\tcu_odindx as string,\n\t\tcardtyp as string,\n\t\tInterestRate as string,\n\t\tAnnualFee as string,\n\t\tOverlimitFee as string,\n\t\tLateFee as string,\n\t\tCwbFee as string,\n\t\tAutoDQFee as string,\n\t\tGroupNo as string,\n\t\tGroupDesc as string,\n\t\tItemizedPerAcct as string,\n\t\tPrimaryBillingSys as string,\n\t\tPlatform as string,\n\t\tSPA as string,\n\t\tDateProcessed as string,\n\t\tStatus as string,\n\t\tUniversalAddressing as string,\n\t\tSeparateEntityFlag as string,\n\t\tInternationalDateFormat as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> CCUMSTR\nsource(output(\n\t\tTransactionCriteriaID as string,\n\t\tFD_Source_System_Key as string,\n\t\tTransactionName as string,\n\t\tBINType as string,\n\t\tTransactionCode as string,\n\t\tResponseCodeOperator as string,\n\t\tResponseCode as string,\n\t\tMerchantTypeOperator as string,\n\t\tMerchantType as string,\n\t\tPOSEntryCode as string,\n\t\tNetworkID as string,\n\t\tReferenceNumberOperator as string,\n\t\tReferenceNumber as string,\n\t\tAuthorizationResponseOperator as string,\n\t\tAuthorizationResponse as string,\n\t\tAuthorizationType as string,\n\t\tReasonCodeOperator as string,\n\t\tReasonCode as string,\n\t\tCreateDate as string,\n\t\tAuthorizationTypeOperator as string,\n\t\tAcctNumMerchNumMatchInd as string,\n\t\tOperatorCodeOperator as string,\n\t\tOperatorCode as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> TransactionCriteria\nTrim derive(Account_ID = RDT_CHD_ACCOUNT_NUMBER,\n\t\tAcquirer_ClintID = 'UNK',\n\t\tAcquirer_NetworkID = 'UNK',\n\t\tBINISO = substring(RDT_CHD_ACCOUNT_NUMBER,1,6),\n\t\tBINEXT = RDT_CHD_ACCOUNT_NUMBER,\n\t\tCardDescription = 'UNK',\n\t\tSource = 'FD',\n\t\tInterchange = toFloat(0.00),\n\t\tcardentrymethod = '000',\n\t\tIssuer_clientid = 'UNK',\n\t\tIssuer_Network = 'UNK',\n\t\tMerchantName = 'Adjustment Transaction',\n\t\tMerchantTypeCC = right('000' + RDT_MRCH_SIC_CODE,4),\n\t\tMonetary = 1,\n\t\tOnusdescription = 'UNK',\n\t\tOriginalDataTransmissionDate = toDate(DefaultDate),\n\t\tOriginDate = toDate(RDT_TRANSACTION_DATE,'yyMMdd'),\n\t\tRecurringDesc = case(left(RDT_CHD_ACCOUNT_NUMBER,1)=='4'&&RDT_DP_MAIL_PHONE_IND=='2','Yes','No'),\n\t\tResponseCode_src = '00',\n\t\tSettlementAmount = toFloat(RDT_DP_NET_PRIN_CHNG),\n\t\tSurchargeAmount = toFloat('0.00'),\n\t\tTerminalCity = 'UNK',\n\t\tTerminalState = 'UNK',\n\t\tTerminalCountry = 'UNK',\n\t\tTerminalZip = 'UNK',\n\t\tTerminalAddress = 'UNK',\n\t\tTerminalkey = 'UNK',\n\t\tTransactiontypecode = RDT_TRANSACTION_CODE,\n\t\tReferenceCC = RDT_DP_TYPE + RDT_DP_SYS_1 + RDT_DP_SYS_5 + RDT_DP_DATE + '000' + RDT_DP_EXP_ADJ_BATCH,\n\t\tMerchantAccountNumber = RDT_MRCH_ACCOUNT_NUMBER,\n\t\tSettlementDate = toDate(DefaultDate),\n\t\tTransmissionDate = toDate(DefaultDate),\n\t\tTransmissionTime = 'UNK',\n\t\tTimeLocalTransaction = 'UNK',\n\t\tOperCode = 'UNK',\n\t\tAuthorizationNo = 'UNK',\n\t\tClientNo = 'UNK',\n\t\ttransaction_amount = toFloat(0.00),\n\t\tis_authorization = 0,\n\t\tAcquiringRTN = 'UNK',\n\t\tSettlementRTN = 'UNK',\n\t\tForwardingRTN = 'UNK',\n\t\tTraceNumber = 'UNK',\n\t\tAcqTraceNumber = 'UNK',\n\t\tVisaTransactionID = 'UNK',\n\t\tMasterCardTransactionID = 'UNK',\n\t\tISOMessageType = 'UNK',\n\t\tTokenRequestId = iif(length(RDT_TKN_RQST_ID)==11,RDT_TKN_RQST_ID,toString(null()))) ~> BaseTransformations\nLimitSelect derive(DefaultDate = '1900-01-01',\n\t\tImportFileDate = toDate(concat(substring($fileName,23,4),'-',substring($fileName,27,2),'-',substring($fileName,29,2)),'yyyy-MM-dd'),\n\t\teach(match(type=='string'), $$ = ltrim(rtrim($$)))) ~> Trim\nBaseTransformations, TrimCCUMSTR join(RDT_CHD_SYSTEM_NO == sys\n\t&& RDT_CHD_PRIN_BANK == prin\n\t&& RDT_CHD_AGENT_BANK == agent,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> Join1\nJoin1, TNCFilter join(Platform == BINType\n\t&& Transactiontypecode == TransactionCode,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> Join2\nJoin2 filter(isNull(BINType)||\r\n(FD_Source_System_Key=='2'\r\n&&\r\n(isNull(MerchantType)||MerchantType=='NULL'||\r\n(MerchantTypeOperator=='IN'&&iifNull(locate(MerchantTypeCC,MerchantType),0)!=0)||\r\n(MerchantTypeOperator=='NOT IN'&&iifNull(locate(MerchantTypeCC,MerchantType),0)==0))\r\n&&\r\n(isNull(ReferenceNumber)||ReferenceNumber=='NULL'||\r\n(ReferenceNumberOperator=='='&& substring(ReferenceCC,12,2) ==ReferenceNumber)||\r\n(ReferenceNumberOperator=='<>'&& substring(ReferenceCC,12,2) !=ReferenceNumber))\r\n&&\r\n(isNull(AcctNumMerchNumMatchInd)||AcctNumMerchNumMatchInd=='NULL'||\r\n(AcctNumMerchNumMatchInd=='Y'&&left(Account_ID,6)==left(MerchantAccountNumber,6)||\r\n(AcctNumMerchNumMatchInd=='N'&&left(Account_ID,6)!=left(MerchantAccountNumber,6)))))) ~> Filter2\nJoin3 derive(Transaction_Key = crc32(iif(isNull(Account_ID),'',Account_ID)\r\n, iif(isNull(OriginDate),'',toString(OriginDate))\r\n, iif(isNull(TimeLocalTransaction),'',TimeLocalTransaction)\r\n, iif(isNull(TransmissionDate),'',toString(TransmissionDate))\r\n, iif(isNull(TransmissionTime),'',TransmissionTime)\r\n, iif(isNull(SettlementAmount),0.00,SettlementAmount)\r\n, iif(isNull(Transactiontypecode),'',Transactiontypecode)\r\n, iif(isNull(ReferenceCC),'',ReferenceCC)\r\n, 2),\n\t\tTransactionName = iif(isNull(TransactionName),'Unknown', TransactionName)) ~> HashAndNullTxnName\nCrossCycle select(mapColumn(\n\t\tCrossCycle_Adjustments_ID,\n\t\tReportDate,\n\t\tRDT_CHD_ACCOUNT_NUMBER,\n\t\tRDT_MRCH_SIC_CODE,\n\t\tRDT_TRANSACTION_DATE,\n\t\tRDT_CHD_ACCOUNT_NUMBER,\n\t\tRDT_DP_MAIL_PHONE_IND,\n\t\tRDT_DP_NET_PRIN_CHNG,\n\t\tRDT_TRANSACTION_CODE,\n\t\tRDT_MRCH_ACCOUNT_NUMBER,\n\t\tRDT_DP_TYPE,\n\t\tRDT_DP_SYS_1,\n\t\tRDT_DP_SYS_5,\n\t\tRDT_DP_DATE,\n\t\tRDT_DP_EXP_ADJ_BATCH,\n\t\tRDT_CHD_SYSTEM_NO,\n\t\tRDT_CHD_AGENT_BANK,\n\t\tRDT_CHD_PRIN_BANK,\n\t\tRDT_TKN_RQST_ID\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> LimitSelect\nTrimCriteria filter(FD_Source_System_Key=='2') ~> TNCFilter\nFilter2 aggregate(groupBy(CrossCycle_Adjustments_ID),\n\tTransactionName = max(TransactionName)) ~> Dedupe\nJoin1, Dedupe join(Trim@CrossCycle_Adjustments_ID == Dedupe@CrossCycle_Adjustments_ID,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> Join3\nTransactionCriteria derive(each(match(type=='string'), $$ = trim($$))) ~> TrimCriteria\nCCUMSTR derive(each(match(type=='string'), $$ = trim($$))) ~> TrimCCUMSTR\nHashAndNullTxnName sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tAccountNumber as string,\n\t\tAcquirerAccountNumber as string,\n\t\tAcquirerNetworkCode as string,\n\t\tBin_ISO as string,\n\t\tBin_EXT as string,\n\t\tCardEntryMethodCode as string,\n\t\tCardPresenceDescription as string,\n\t\tImportFileDate as date,\n\t\tSource as string,\n\t\tInterchangeAmount as float,\n\t\tIssuerAccountNumber as string,\n\t\tIssuerNetworkCode as string,\n\t\tMerchantName as string,\n\t\tMerchantType as string,\n\t\tMonetary as integer,\n\t\tOnUsDescription as string,\n\t\tOriginalDataTransmissionDate as date,\n\t\tOriginDate as date,\n\t\tRecurringDescription as string,\n\t\tResponseCode as string,\n\t\tSettlementAmount as float,\n\t\tSettlementDate as date,\n\t\tSurchargeAmount as float,\n\t\tTerminalAddress as string,\n\t\tTerminalCity as string,\n\t\tTerminalCountry as string,\n\t\tTerminalKey as string,\n\t\tTerminalState as string,\n\t\tTerminalZipCode as string,\n\t\tTokenRequestId as string,\n\t\tTransactionName as string,\n\t\tTransactionTypeCode as string,\n\t\tTransmissionDate as date,\n\t\tTransmissionTime as string,\n\t\tTimeLocalTransaction as string,\n\t\tRetrievalReferenceNumber as string,\n\t\tTransaction_Key as long,\n\t\tAgentNo as string,\n\t\tSystemNo as string,\n\t\tOperCode as string,\n\t\tPrincipalNo as string,\n\t\tAuthorizationNo as string,\n\t\tClientNo as string,\n\t\ttransaction_amount as float,\n\t\tis_authorization as integer,\n\t\tAcquiringRTN as string,\n\t\tSettlementRTN as string,\n\t\tTraceNumber as string,\n\t\tAcqTraceNumber as string,\n\t\tVisaTransactionID as string,\n\t\tMasterCardTransactionID as string,\n\t\tMerchantAccountNumber as string,\n\t\tISOMessageType as string,\n\t\tForwardingRTN as string\n\t),\n\tformat: 'parquet',\n\tpartitionFileNames:[($fileName)],\n\tumask: 0022,\n\tpreCommands: [],\n\tpostCommands: [],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tmapColumn(\n\t\tAccountNumber = Account_ID,\n\t\tAcquirerAccountNumber = Acquirer_ClintID,\n\t\tAcquirerNetworkCode = Acquirer_NetworkID,\n\t\tBin_ISO = BINISO,\n\t\tBin_EXT = BINEXT,\n\t\tCardEntryMethodCode = cardentrymethod,\n\t\tCardPresenceDescription = CardDescription,\n\t\tImportFileDate,\n\t\tSource,\n\t\tInterchangeAmount = Interchange,\n\t\tIssuerAccountNumber = Issuer_clientid,\n\t\tIssuerNetworkCode = Issuer_Network,\n\t\tMerchantName,\n\t\tMerchantType = MerchantTypeCC,\n\t\tMonetary,\n\t\tOnUsDescription = Onusdescription,\n\t\tOriginalDataTransmissionDate,\n\t\tOriginDate,\n\t\tRecurringDescription = RecurringDesc,\n\t\tResponseCode = ResponseCode_src,\n\t\tSettlementAmount,\n\t\tSettlementDate,\n\t\tSurchargeAmount,\n\t\tTerminalAddress,\n\t\tTerminalCity,\n\t\tTerminalCountry,\n\t\tTerminalKey = Terminalkey,\n\t\tTerminalState,\n\t\tTerminalZipCode = TerminalZip,\n\t\tTokenRequestId,\n\t\tTransactionName,\n\t\tTransactionTypeCode = Transactiontypecode,\n\t\tTransmissionDate,\n\t\tTransmissionTime,\n\t\tTimeLocalTransaction,\n\t\tRetrievalReferenceNumber = ReferenceCC,\n\t\tTransaction_Key,\n\t\tAgentNo = RDT_CHD_AGENT_BANK,\n\t\tSystemNo = RDT_CHD_SYSTEM_NO,\n\t\tPrincipalNo = RDT_CHD_PRIN_BANK,\n\t\tOperCode,\n\t\ttransaction_amount,\n\t\tis_authorization,\n\t\tAuthorizationNo,\n\t\tClientNo,\n\t\tAcquiringRTN,\n\t\tSettlementRTN,\n\t\tTraceNumber,\n\t\tAcqTraceNumber,\n\t\tVisaTransactionID,\n\t\tMasterCardTransactionID,\n\t\tMerchantAccountNumber = RDT_MRCH_ACCOUNT_NUMBER,\n\t\tISOMessageType,\n\t\tForwardingRTN\n\t),\n\tpartitionBy('hash', 1)) ~> sink1"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/populate_DWDimUser')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "Dimensions"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "User_Source",
                                "type": "DatasetReference"
                            },
                            "name": "Usercsv"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "dim_usertable",
                                "type": "DatasetReference"
                            },
                            "name": "sink1"
                        }
                    ],
                    "transformations": [],
                    "script": "source(output(\n\t\tUserID as string,\n\t\tClientID as string,\n\t\tBINID as string,\n\t\tUserName as string,\n\t\tBIN as string,\n\t\tmeta_batch_key as string,\n\t\tmeta_insert_date as string,\n\t\tmeta_update_date as string,\n\t\tmeta_hash as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> Usercsv\nUsercsv sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tUserID as integer,\n\t\tClientID as string,\n\t\tBINID as string,\n\t\tUserName as string,\n\t\tBIN as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\ttruncate:true,\n\tformat: 'table',\n\tstaged: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tClientID,\n\t\tBINID,\n\t\tUserName,\n\t\tBIN\n\t)) ~> sink1"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/Copy_Raw_To_Drop')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "Utilities"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "src_raw",
                                "type": "DatasetReference"
                            },
                            "name": "Raw"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "dropZoneTransactions_meta_Transactions",
                                "type": "DatasetReference"
                            },
                            "name": "Drop"
                        }
                    ],
                    "transformations": [],
                    "script": "source(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\twildcardPaths:['FIS/Transactions/**/**/**/*.*']) ~> Raw\nRaw sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tColumn_1 as string,\n\t\tColumn_2 as string,\n\t\tColumn_3 as string,\n\t\tColumn_4 as string,\n\t\tColumn_5 as string,\n\t\tColumn_6 as string,\n\t\tColumn_7 as string,\n\t\tColumn_8 as string,\n\t\tColumn_9 as string,\n\t\tColumn_10 as string,\n\t\tColumn_11 as string,\n\t\tColumn_12 as string,\n\t\tColumn_13 as string,\n\t\tColumn_14 as string,\n\t\tColumn_15 as string,\n\t\tColumn_16 as string,\n\t\tColumn_17 as string,\n\t\tColumn_18 as string,\n\t\tColumn_19 as string,\n\t\tColumn_20 as string,\n\t\tColumn_21 as string,\n\t\tColumn_22 as string,\n\t\tColumn_23 as string,\n\t\tColumn_24 as string,\n\t\tColumn_25 as string,\n\t\tColumn_26 as string,\n\t\tColumn_27 as string,\n\t\tColumn_28 as string,\n\t\tColumn_29 as string,\n\t\tColumn_30 as string,\n\t\tColumn_31 as string,\n\t\tColumn_32 as string,\n\t\tColumn_33 as string,\n\t\tColumn_34 as string,\n\t\tColumn_35 as string,\n\t\tColumn_36 as string,\n\t\tColumn_37 as string,\n\t\tColumn_38 as string,\n\t\tColumn_39 as string,\n\t\tColumn_40 as string,\n\t\tColumn_41 as string,\n\t\tColumn_42 as string,\n\t\tColumn_43 as string,\n\t\tColumn_44 as string,\n\t\tColumn_45 as string,\n\t\tColumn_46 as string,\n\t\tColumn_47 as string,\n\t\tColumn_48 as string,\n\t\tColumn_49 as string,\n\t\tColumn_50 as string,\n\t\tColumn_51 as string,\n\t\tColumn_52 as string,\n\t\tColumn_53 as string,\n\t\tColumn_54 as string,\n\t\tColumn_55 as string,\n\t\tColumn_56 as string,\n\t\tColumn_57 as string,\n\t\tColumn_58 as string,\n\t\tColumn_59 as string,\n\t\tColumn_60 as string,\n\t\tColumn_61 as string,\n\t\tColumn_62 as string,\n\t\tColumn_63 as string,\n\t\tColumn_64 as string,\n\t\tColumn_65 as string,\n\t\tColumn_66 as string,\n\t\tColumn_67 as string,\n\t\tColumn_68 as string,\n\t\tColumn_69 as string,\n\t\tColumn_70 as string,\n\t\tColumn_71 as string,\n\t\tColumn_72 as string,\n\t\tColumn_73 as string,\n\t\tColumn_74 as string,\n\t\tColumn_75 as string,\n\t\tColumn_76 as string,\n\t\tColumn_77 as string,\n\t\tColumn_78 as string,\n\t\tColumn_79 as string,\n\t\tColumn_80 as string,\n\t\tColumn_81 as string,\n\t\tColumn_82 as string,\n\t\tColumn_83 as string,\n\t\tColumn_84 as string,\n\t\tColumn_85 as string,\n\t\tColumn_86 as string,\n\t\tColumn_87 as string,\n\t\tColumn_88 as string,\n\t\tColumn_89 as string,\n\t\tColumn_90 as string,\n\t\tColumn_91 as string,\n\t\tColumn_92 as string,\n\t\tColumn_93 as string,\n\t\tColumn_94 as string,\n\t\tColumn_95 as string,\n\t\tColumn_96 as string,\n\t\tColumn_97 as string,\n\t\tColumn_98 as string,\n\t\tColumn_99 as string,\n\t\tColumn_100 as string,\n\t\tColumn_101 as string,\n\t\tColumn_102 as string,\n\t\tColumn_103 as string,\n\t\tColumn_104 as string,\n\t\tColumn_105 as string,\n\t\tColumn_106 as string,\n\t\tColumn_107 as string,\n\t\tColumn_108 as string,\n\t\tColumn_109 as string,\n\t\tColumn_110 as string,\n\t\tColumn_111 as string,\n\t\tColumn_112 as string,\n\t\tColumn_113 as string,\n\t\tColumn_114 as string,\n\t\tColumn_115 as string,\n\t\tColumn_116 as string,\n\t\tColumn_117 as string,\n\t\tColumn_118 as string,\n\t\tColumn_119 as string,\n\t\tColumn_120 as string,\n\t\tColumn_121 as string,\n\t\tColumn_122 as string,\n\t\tColumn_123 as string,\n\t\tColumn_124 as string,\n\t\tColumn_125 as string,\n\t\tColumn_126 as string,\n\t\tColumn_127 as string,\n\t\tColumn_128 as string,\n\t\tColumn_129 as string,\n\t\tColumn_130 as string,\n\t\tColumn_131 as string,\n\t\tColumn_132 as string,\n\t\tColumn_133 as string,\n\t\tColumn_134 as string,\n\t\tColumn_135 as string,\n\t\tColumn_136 as string,\n\t\tColumn_137 as string,\n\t\tColumn_138 as string,\n\t\tColumn_139 as string,\n\t\tColumn_140 as string,\n\t\tColumn_141 as string,\n\t\tColumn_142 as string,\n\t\tColumn_143 as string,\n\t\tColumn_144 as string,\n\t\tColumn_145 as string,\n\t\tColumn_146 as string,\n\t\tColumn_147 as string,\n\t\tColumn_148 as string,\n\t\tColumn_149 as string,\n\t\tColumn_150 as string,\n\t\tColumn_151 as string,\n\t\tColumn_152 as string,\n\t\tColumn_153 as string,\n\t\tColumn_154 as string,\n\t\tColumn_155 as string,\n\t\tColumn_156 as string,\n\t\tColumn_157 as string,\n\t\tColumn_158 as string,\n\t\tColumn_159 as string,\n\t\tColumn_160 as string,\n\t\tColumn_161 as string,\n\t\tColumn_162 as string,\n\t\tColumn_163 as string,\n\t\tColumn_164 as string,\n\t\tColumn_165 as string,\n\t\tColumn_166 as string,\n\t\tColumn_167 as string,\n\t\tColumn_168 as string,\n\t\tColumn_169 as string,\n\t\tColumn_170 as string,\n\t\tColumn_171 as string,\n\t\tColumn_172 as string,\n\t\tColumn_173 as string,\n\t\tColumn_174 as string,\n\t\tColumn_175 as string,\n\t\tColumn_176 as string,\n\t\tColumn_177 as string,\n\t\tColumn_178 as string,\n\t\tColumn_179 as string,\n\t\tColumn_180 as string,\n\t\tColumn_181 as string,\n\t\tColumn_182 as string,\n\t\tColumn_183 as string,\n\t\tColumn_184 as string,\n\t\tColumn_185 as string,\n\t\tColumn_186 as string,\n\t\tColumn_187 as string,\n\t\tColumn_188 as string,\n\t\tColumn_189 as string,\n\t\tColumn_190 as string,\n\t\tColumn_191 as string,\n\t\tColumn_192 as string,\n\t\tColumn_193 as string,\n\t\tColumn_194 as string,\n\t\tColumn_195 as string,\n\t\tColumn_196 as string,\n\t\tColumn_197 as string,\n\t\tColumn_198 as string,\n\t\tColumn_199 as string,\n\t\tColumn_200 as string,\n\t\tColumn_201 as string,\n\t\tColumn_202 as string,\n\t\tColumn_203 as string,\n\t\tColumn_204 as string,\n\t\tColumn_205 as string,\n\t\tColumn_206 as string,\n\t\tColumn_207 as string,\n\t\tColumn_208 as string,\n\t\tColumn_209 as string,\n\t\tColumn_210 as string,\n\t\tColumn_211 as string,\n\t\tColumn_212 as string,\n\t\tColumn_213 as string,\n\t\tColumn_214 as string,\n\t\tColumn_215 as string,\n\t\tColumn_216 as string,\n\t\tColumn_217 as string,\n\t\tColumn_218 as string,\n\t\tColumn_219 as string,\n\t\tColumn_220 as string,\n\t\tColumn_221 as string,\n\t\tColumn_222 as string,\n\t\tColumn_223 as string,\n\t\tColumn_224 as string,\n\t\tColumn_225 as string,\n\t\tColumn_226 as string,\n\t\tColumn_227 as string,\n\t\tColumn_228 as string,\n\t\tColumn_229 as string,\n\t\tColumn_230 as string,\n\t\tColumn_231 as string,\n\t\tColumn_232 as string,\n\t\tColumn_233 as string,\n\t\tColumn_234 as string,\n\t\tColumn_235 as string,\n\t\tColumn_236 as string,\n\t\tColumn_237 as string,\n\t\tColumn_238 as string,\n\t\tColumn_239 as string,\n\t\tColumn_240 as string,\n\t\tColumn_241 as string,\n\t\tColumn_242 as string,\n\t\tColumn_243 as string,\n\t\tColumn_244 as string,\n\t\tColumn_245 as string,\n\t\tColumn_246 as string,\n\t\tColumn_247 as string,\n\t\tColumn_248 as string,\n\t\tColumn_249 as string,\n\t\tColumn_250 as string,\n\t\tColumn_251 as string,\n\t\tColumn_252 as string,\n\t\tColumn_253 as string,\n\t\tColumn_254 as string,\n\t\tColumn_255 as string,\n\t\tColumn_256 as string,\n\t\tColumn_257 as string,\n\t\tColumn_258 as string,\n\t\tColumn_259 as string,\n\t\tColumn_260 as string,\n\t\tColumn_261 as string,\n\t\tColumn_262 as string,\n\t\tColumn_263 as string,\n\t\tColumn_264 as string,\n\t\tColumn_265 as string,\n\t\tColumn_266 as string,\n\t\tColumn_267 as string,\n\t\tColumn_268 as string,\n\t\tColumn_269 as string,\n\t\tColumn_270 as string,\n\t\tColumn_271 as string,\n\t\tColumn_272 as string,\n\t\tColumn_273 as string,\n\t\tColumn_274 as string,\n\t\tColumn_275 as string,\n\t\tColumn_276 as string,\n\t\tColumn_277 as string,\n\t\tColumn_278 as string,\n\t\tColumn_279 as string,\n\t\tColumn_280 as string,\n\t\tColumn_281 as string,\n\t\tColumn_282 as string,\n\t\tColumn_283 as string,\n\t\tColumn_284 as string,\n\t\tColumn_285 as string,\n\t\tColumn_286 as string,\n\t\tColumn_287 as string,\n\t\tColumn_288 as string,\n\t\tColumn_289 as string,\n\t\tColumn_290 as string,\n\t\tColumn_291 as string,\n\t\tColumn_292 as string,\n\t\tColumn_293 as string,\n\t\tColumn_294 as string,\n\t\tColumn_295 as string,\n\t\tColumn_296 as string,\n\t\tColumn_297 as string,\n\t\tColumn_298 as string,\n\t\tColumn_299 as string,\n\t\tColumn_300 as string,\n\t\tColumn_301 as string,\n\t\tColumn_302 as string,\n\t\tColumn_303 as string,\n\t\tColumn_304 as string,\n\t\tColumn_305 as string,\n\t\tColumn_306 as string,\n\t\tColumn_307 as string,\n\t\tColumn_308 as string\n\t),\n\tumask: 0022,\n\tpreCommands: [],\n\tpostCommands: [],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Drop"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/populate_DimBinandRTN')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "Dimensions/Static Dimensions"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "FIS_Client",
                                "type": "DatasetReference"
                            },
                            "name": "client"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Client",
                                "type": "DatasetReference"
                            },
                            "name": "DWClient"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Routing_Number",
                                "type": "DatasetReference"
                            },
                            "name": "dimRTN"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_BIN",
                                "type": "DatasetReference"
                            },
                            "name": "dimBIN"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "dim_Routing_Number",
                                "type": "DatasetReference"
                            },
                            "name": "RTNDimension"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_BIN",
                                "type": "DatasetReference"
                            },
                            "name": "BinDimension"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "BINList"
                        },
                        {
                            "name": "populateprocessdate"
                        },
                        {
                            "name": "RTNList"
                        },
                        {
                            "name": "BinISOAndHash"
                        },
                        {
                            "name": "removeBlankBIN"
                        },
                        {
                            "name": "removeBlankRTN"
                        },
                        {
                            "name": "removeduplicateBin"
                        },
                        {
                            "name": "removeduplicatRTN"
                        },
                        {
                            "name": "filterNull"
                        },
                        {
                            "name": "Join1"
                        },
                        {
                            "name": "Select1"
                        },
                        {
                            "name": "Exists1"
                        },
                        {
                            "name": "Exists2"
                        },
                        {
                            "name": "RTNHash"
                        },
                        {
                            "name": "Sort1"
                        },
                        {
                            "name": "Sort2"
                        },
                        {
                            "name": "Trim"
                        }
                    ],
                    "script": "source(output(\n\t\tSourceSystemKey as string,\n\t\tClientNumber as string,\n\t\tFinancialInstitutionName as string,\n\t\tBINNumber as string,\n\t\tRouteTransitNumber as string,\n\t\tAddressLine1 as string,\n\t\tAddressLine2 as string,\n\t\tAddressCity as string,\n\t\tAddressState as string,\n\t\tAddressPostalCode as string,\n\t\tis_current as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> client\nsource(output(\n\t\tclient_key as long,\n\t\tir_id as integer,\n\t\tclient_name as string,\n\t\tstreet_address1 as string,\n\t\tstreet_address2 as string,\n\t\tcity as string,\n\t\tstate as string,\n\t\tzipcode as string,\n\t\tclient_number as string,\n\t\tis_current as boolean,\n\t\tbegin_effective_date as timestamp,\n\t\tend_effective_date as timestamp,\n\t\tPREFERRED_NAME as string,\n\t\tPARENT_CLIENT_KEY as long,\n\t\tMERGER_ACQUISITION_DTE as date,\n\t\tGEOGRAPHIC_REGION_KEY as integer,\n\t\tASSET_SIZE_KEY as integer,\n\t\tPORTFOLIO_SIZE_KEY as integer,\n\t\tASSET_SIZE_AMT as decimal(19,4),\n\t\tPORTFOLIO_SIZE_CNT as integer,\n\t\tBUSINESS_PARTNER_CLIENT_KEY as long,\n\t\tCREATE_DTE as date\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false) ~> DWClient\nsource(output(\n\t\trouting_number_key as long,\n\t\tsource_system_key as integer,\n\t\tsource_system_id as string,\n\t\trouting_number as string,\n\t\tclient_key as long,\n\t\tmeta_insert_date as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false) ~> dimRTN\nsource(output(\n\t\tbin_key as long,\n\t\tsource_system_key as integer,\n\t\tsource_system_id as string,\n\t\tbankIdentificationNumberISO as string,\n\t\tbankIdentificationNumberEXT as string,\n\t\tbin_type as string,\n\t\tclient_key as long\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false) ~> dimBIN\nSelect1 select(mapColumn(\n\t\tBIN = BINNumber,\n\t\tprocessDate,\n\t\tclient_key_bin = client_key,\n\t\tsource_system_key\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> BINList\nfilterNull derive(processDate = currentUTC(),\n\t\tis_current_client = is_current,\n\t\tSourceSystemKey = toInteger(SourceSystemKey)) ~> populateprocessdate\nSelect1 select(mapColumn(\n\t\tRoutingTransitNumber = RouteTransitNumber,\n\t\tprocessDate,\n\t\tclient_key_rtn = client_key,\n\t\tsource_system_key\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> RTNList\nBINList derive(BinISO = left(BIN, 6),\n\t\tbin_key = crc32(iif(isNull(BIN),iif(isNull(left(BIN,6)),'',left(BIN,6)),BIN))) ~> BinISOAndHash\nBinISOAndHash filter(!isNull(BIN)) ~> removeBlankBIN\nRTNHash filter(!isNull(RoutingTransitNumber)) ~> removeBlankRTN\nremoveBlankBIN aggregate(groupBy(BIN,\n\t\tBinISO,\n\t\tprocessDate,\n\t\tsource_system_key,\n\t\tbin_key),\n\tcount = count(BIN),\n\t\tclient_key_bin = max(client_key_bin)) ~> removeduplicateBin\nremoveBlankRTN aggregate(groupBy(RoutingTransitNumber,\n\t\tprocessDate,\n\t\tsource_system_key,\n\t\trouting_number_key),\n\tcount = count(RoutingTransitNumber),\n\t\tclient_key_rtn = max(client_key_rtn)) ~> removeduplicatRTN\nTrim filter(!isNull(ClientNumber)) ~> filterNull\npopulateprocessdate, DWClient join(ClientNumber == client_number,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> Join1\nJoin1 select(mapColumn(\n\t\tClientNumber,\n\t\tFinancialInstitutionName,\n\t\tBINNumber,\n\t\tRouteTransitNumber,\n\t\tAddressLine1,\n\t\tAddressLine2,\n\t\tAddressCity,\n\t\tAddressState,\n\t\tAddressPostalCode,\n\t\tis_current = is_current_client,\n\t\tprocessDate,\n\t\tsource_system_key = SourceSystemKey,\n\t\tclient_key\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select1\nremoveduplicatRTN, dimRTN exists(RoutingTransitNumber == routing_number,\n\tnegate:true,\n\tbroadcast: 'auto')~> Exists1\nremoveduplicateBin, dimBIN exists(BIN == bankIdentificationNumberEXT,\n\tnegate:true,\n\tbroadcast: 'auto')~> Exists2\nRTNList derive(routing_number_key = crc32(iif(isNull(RoutingTransitNumber),'',RoutingTransitNumber)\r\n, iif(isNull(client_key_rtn),0,toInteger(client_key_rtn)))) ~> RTNHash\nExists2 sort(asc(bin_key, false)) ~> Sort1\nExists1 sort(asc(routing_number_key, false)) ~> Sort2\nclient derive(each(match(type=='string'), $$ = trim($$))) ~> Trim\nSort2 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\trouting_number_key as long,\n\t\tsource_system_key as integer,\n\t\tsource_system_id as string,\n\t\trouting_number as string,\n\t\tis_pseudo as boolean,\n\t\tis_primary as boolean,\n\t\tclient_key as long,\n\t\tcreate_date as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tpostSQLs:['ALTER INDEX ALL ON [FinancialInstitution].[dim_routing_number]  REBUILD'],\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\trouting_number_key,\n\t\tsource_system_key,\n\t\tsource_system_id = RoutingTransitNumber,\n\t\trouting_number = RoutingTransitNumber,\n\t\tclient_key = client_key_rtn,\n\t\tmeta_insert_date = processDate\n\t)) ~> RTNDimension\nSort1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tbin_key as long,\n\t\tsource_system_key as integer,\n\t\tsource_system_id as string,\n\t\tbankIdentificationNumberISO as string,\n\t\tbankIdentificationNumberEXT as string,\n\t\tbin_type as string,\n\t\tclient_key as long\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tpostSQLs:['ALTER INDEX ALL ON [FinancialInstitution].[dim_bin]  REBUILD'],\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tbin_key,\n\t\tsource_system_key,\n\t\tsource_system_id = BIN,\n\t\tbankIdentificationNumberISO = BinISO,\n\t\tbankIdentificationNumberEXT = BIN,\n\t\tclient_key = client_key_bin\n\t)) ~> BinDimension"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/populate_DimTerminal')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "This is to populate the dim_terminal in the DW.",
                "folder": {
                    "name": "Dimensions"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "dim_Terminal",
                                "type": "DatasetReference"
                            },
                            "name": "srcdimTerminal"
                        },
                        {
                            "dataset": {
                                "referenceName": "FIS_COOP_Terminals",
                                "type": "DatasetReference"
                            },
                            "name": "srcFISATMList"
                        },
                        {
                            "dataset": {
                                "referenceName": "src_cnfmFISTransactions",
                                "type": "DatasetReference"
                            },
                            "name": "ConformedTransactions"
                        },
                        {
                            "dataset": {
                                "referenceName": "FD_COOP_Terminals_OnPremise",
                                "type": "DatasetReference"
                            },
                            "name": "srcFDTerminalsOnPremise"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Routing_Number",
                                "type": "DatasetReference"
                            },
                            "name": "dwRTNNum"
                        },
                        {
                            "dataset": {
                                "referenceName": "src_rawFDATMList",
                                "type": "DatasetReference"
                            },
                            "name": "srcFDATMList"
                        },
                        {
                            "dataset": {
                                "referenceName": "src_rawFDParIDReference",
                                "type": "DatasetReference"
                            },
                            "name": "srcFDParReference"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Client",
                                "type": "DatasetReference"
                            },
                            "name": "dwClientDim"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Source_System",
                                "type": "DatasetReference"
                            },
                            "name": "srcSourceSystem"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "dim_Terminal",
                                "type": "DatasetReference"
                            },
                            "name": "dimTerminal"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "TerminalsWithSourceKey"
                        },
                        {
                            "name": "joinATMLookup"
                        },
                        {
                            "name": "JoinFDATMsOnPremise"
                        },
                        {
                            "name": "TerminalAttributes"
                        },
                        {
                            "name": "RemoveNullTerminalKeys"
                        },
                        {
                            "name": "DistinctTerminals"
                        },
                        {
                            "name": "SelectFISATMs"
                        },
                        {
                            "name": "FDOnPremiseFlg"
                        },
                        {
                            "name": "SelectForUpsert"
                        },
                        {
                            "name": "deriveColumns"
                        },
                        {
                            "name": "DerivePseudoRTN"
                        },
                        {
                            "name": "SelectRTN"
                        },
                        {
                            "name": "MarkUpserts"
                        },
                        {
                            "name": "SelectDimTerminals"
                        },
                        {
                            "name": "HashKey"
                        },
                        {
                            "name": "Dedupe"
                        },
                        {
                            "name": "JoinDimTerminal"
                        },
                        {
                            "name": "DeriveTerminalUpdates"
                        },
                        {
                            "name": "TrimFISColumns"
                        },
                        {
                            "name": "FilterFISHeaders"
                        },
                        {
                            "name": "dedupeFISATMList"
                        },
                        {
                            "name": "TrimFDATMList"
                        },
                        {
                            "name": "TrimFDParReference"
                        },
                        {
                            "name": "JoinparID"
                        },
                        {
                            "name": "SelectFDATMs"
                        },
                        {
                            "name": "FilterFDATMHeaders"
                        },
                        {
                            "name": "dedupeFDATMList"
                        },
                        {
                            "name": "JoindimClient"
                        },
                        {
                            "name": "JoinRTN"
                        },
                        {
                            "name": "DistinctFISATMs"
                        },
                        {
                            "name": "JoinSourceSystemKey"
                        },
                        {
                            "name": "JoinATMs"
                        },
                        {
                            "name": "DeriveATMs"
                        },
                        {
                            "name": "SelectFinalATMs"
                        },
                        {
                            "name": "SelectFactTerminals"
                        },
                        {
                            "name": "deriveATMMerchantTypeFlag"
                        },
                        {
                            "name": "rankATMs"
                        },
                        {
                            "name": "filerRank"
                        }
                    ],
                    "script": "parameters{\n\tfileName as string\n}\nsource(output(\n\t\tatm_terminal_key as long,\n\t\tsource_system_key as integer,\n\t\tterminal_key as string,\n\t\tclient_key as long,\n\t\tcoop_atm_indicator as boolean,\n\t\ton_premise_indicator as boolean,\n\t\tatm_indicator as boolean,\n\t\tload_date as date,\n\t\tmodified_date as date,\n\t\tcreate_date as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false,\n\tpartitionColumn: 'atm_terminal_key',\n\tpartitionBy('external', 20)) ~> srcdimTerminal\nsource(output(\n\t\t{ATM ID} as string,\n\t\t{INSTITUTION ID} as string,\n\t\t{INSTITUTION NAME} as string,\n\t\tADDRESS as string,\n\t\tCITY as string,\n\t\tSTATE as string,\n\t\tZIP as string,\n\t\tTH as string,\n\t\t{TERM CONFIG ID} as string,\n\t\t{LOAD IMAGE INFO ID} as string,\n\t\t{OVLY IMAGE INFO ID} as string,\n\t\t{DYN SCRN UPDT LIST} as string,\n\t\t{VENDOR MODEL} as string,\n\t\t{CANISTER INFO LIST} as string,\n\t\t{FAST CASH LIST} as string,\n\t\t{SETL CARD GRP LIST} as string,\n\t\t{CRD DATA INPUT CAP} as string,\n\t\t{CASH MGMT BY CAN} as string,\n\t\t{ONLINE FEE GROUP} as string,\n\t\t{DISPENSE ALGORITHM} as string,\n\t\t{MAX TRANS PER RCPT} as string,\n\t\t{RECEIPT PRINTER LENGTH} as string,\n\t\t{PRINT BAL NON-INQ} as string,\n\t\t{BAL INQ DSPLY OPT} as string,\n\t\t{CIRCUIT ID} as string,\n\t\t{TANDEM PORT} as string,\n\t\t{NAT ADDRESS & PORT} as string,\n\t\t{MESSAGE TERM ID} as string,\n\t\t{DIAL COMM TYPE} as string\n\t),\n\tallowSchemaDrift: false,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\trowUrlColumn: 'file_name') ~> srcFISATMList\nsource(output(\n\t\tAccountNumber as string,\n\t\tAcquirerAccountNumber as string,\n\t\tAcquirerNetworkCode as string,\n\t\tBin_ISO as string,\n\t\tBin_EXT as string,\n\t\tCardEntryMethodCode as string,\n\t\tCardPresenceDescription as string,\n\t\tImportFileDate as date,\n\t\tSource as string,\n\t\tInterchangeAmount as float,\n\t\tIssuerAccountNumber as string,\n\t\tIssuerNetworkCode as string,\n\t\tMerchantName as string,\n\t\tMerchantType as string,\n\t\tMonetary as integer,\n\t\tOnUsDescription as string,\n\t\tOriginalDataTransmissionDate as date,\n\t\tOriginDate as date,\n\t\tRecurringDescription as string,\n\t\tResponseCode as string,\n\t\tSettlementAmount as float,\n\t\tSettlementDate as date,\n\t\tSurchargeAmount as float,\n\t\tTerminalAddress as string,\n\t\tTerminalCity as string,\n\t\tTerminalCountry as string,\n\t\tTerminalKey as string,\n\t\tTerminalState as string,\n\t\tTerminalZipCode as string,\n\t\tTokenRequestId as string,\n\t\tTransactionName as string,\n\t\tTransactionTypeCode as string,\n\t\tTransmissionDate as date,\n\t\tTransmissionTime as string,\n\t\tTimeLocalTransaction as string,\n\t\tRetrievalReferenceNumber as string,\n\t\tTransaction_Key as long,\n\t\tAgentNo as string,\n\t\tSystemNo as string,\n\t\tOperCode as string,\n\t\tPrincipalNo as string,\n\t\tAuthorizationNo as string,\n\t\tClientNo as string,\n\t\ttransaction_amount as float,\n\t\tis_authorization as integer,\n\t\tAcquiringRTN as string,\n\t\tSettlementRTN as string,\n\t\tTraceNumber as string,\n\t\tAcqTraceNumber as string,\n\t\tVisaTransactionID as string,\n\t\tMasterCardTransactionID as string,\n\t\tMerchantAccountNumber as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tformat: 'parquet') ~> ConformedTransactions\nsource(output(\n\t\t{Term Id} as string,\n\t\t{FI Name} as string,\n\t\tLine as string,\n\t\tMake as string,\n\t\tModel as string,\n\t\tStreet as string,\n\t\tCity as string,\n\t\tState as string,\n\t\tZip as string,\n\t\tOFF_PREMISE_IND as string,\n\t\tDEPOSIT_WITH_ENVELOPE_IND as string,\n\t\tDEPOSIT_WITH_CASH_IND as string,\n\t\tDEPOSIT_WITH_CHECK_IND as string,\n\t\tAPPLICATION_NAME as string,\n\t\t{Last Trans} as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcFDTerminalsOnPremise\nsource(output(\n\t\trouting_number_key as long,\n\t\tsource_system_key as integer,\n\t\tsource_system_id as string,\n\t\trouting_number as string,\n\t\tclient_key as long,\n\t\tmeta_insert_date as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false,\n\tpartitionColumn: 'routing_number_key',\n\tpartitionBy('external', 2)) ~> dwRTNNum\nsource(output(\n\t\t{Holding Company} as string,\n\t\t{Part Id} as string,\n\t\t{Term Id} as string,\n\t\t{FI Name} as string,\n\t\tLine as string,\n\t\tMake as string,\n\t\tModel as string,\n\t\tStreet as string,\n\t\tCity as string,\n\t\tState as string,\n\t\tZip as string,\n\t\tDEPOSIT_WITH_ENVELOPE_IND as string,\n\t\tDEPOSIT_WITH_CASH_IND as string,\n\t\tDEPOSIT_WITH_CHECK_IND as string,\n\t\tAPPLICATION_NAME as string,\n\t\t{Last Trans} as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcFDATMList\nsource(output(\n\t\tpar_id as string,\n\t\tclient_id as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcFDParReference\nsource(output(\n\t\tclient_key as long,\n\t\tir_id as integer,\n\t\tclient_name as string,\n\t\tstreet_address1 as string,\n\t\tstreet_address2 as string,\n\t\tcity as string,\n\t\tstate as string,\n\t\tzipcode as string,\n\t\tclient_number as string,\n\t\tis_current as boolean,\n\t\tbegin_effective_date as timestamp,\n\t\tend_effective_date as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false) ~> dwClientDim\nsource(output(\n\t\tsource_system_key as integer,\n\t\tsource_system_name as string,\n\t\tsource_system_description as string,\n\t\tsource_system_abbreviation as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false) ~> srcSourceSystem\nJoinSourceSystemKey select(mapColumn(\n\t\tTerminalKey,\n\t\tload_date = ImportFileDate,\n\t\tsource_system_key,\n\t\tatm_indicator\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> TerminalsWithSourceKey\nTerminalsWithSourceKey, SelectFinalATMs join(TerminalKey == atm_id,\n\tjoinType:'outer',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'right')~> joinATMLookup\njoinATMLookup, FDOnPremiseFlg join(TerminalKey == {Term Id}\n\t&& source_system_key == 2,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'right')~> JoinFDATMsOnPremise\nRemoveNullTerminalKeys select(mapColumn(\n\t\tImportFileDate,\n\t\tTerminalKey,\n\t\tSource,\n\t\tMerchantType\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> TerminalAttributes\nConformedTransactions filter(!isNull(TerminalKey)&&TerminalKey!='UNK') ~> RemoveNullTerminalKeys\nderiveATMMerchantTypeFlag aggregate(groupBy(TerminalKey,\n\t\tImportFileDate,\n\t\tSource),\n\tatm_indicator = max(atm_indicator)) ~> DistinctTerminals\nDistinctFISATMs select(mapColumn(\n\t\tfis_atm_id = {ATM ID},\n\t\tfis_atm_client_key = rtn_client_key,\n\t\tfis_atm_source_system_key = atm_source_system_key\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectFISATMs\nsrcFDTerminalsOnPremise select(mapColumn(\n\t\t{Term Id},\n\t\tOFF_PREMISE_IND\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> FDOnPremiseFlg\nDeriveTerminalUpdates select(mapColumn(\n\t\tTerminalKey,\n\t\tTerminalHashkey,\n\t\tclient_key,\n\t\tload_date,\n\t\tsource_system_key,\n\t\tcoop_atm_indicator,\n\t\tOFF_PREMISE_IND,\n\t\tatm_indicator,\n\t\tCreateDate = create_date,\n\t\tmodified_date\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectForUpsert\nJoinFDATMsOnPremise derive(on_premise_indicator = iif(upper(OFF_PREMISE_IND) == 'N', toBoolean('y'),toBoolean('n')),\n\t\tcoop_atm_indicator = iif(isNull(atm_id),toBoolean('n'),toBoolean('y')),\n\t\tTerminalKey = coalesce(TerminalKey,atm_id),\n\t\tsource_system_key = coalesce(atm_source_system_key, source_system_key),\n\t\tatm_indicator = iif(!isNull(atm_id),toBoolean('y'),atm_indicator)) ~> deriveColumns\nFilterFISHeaders derive(pseudo_rtn = iif(left({INSTITUTION ID},2)=='59',substring({INSTITUTION ID},3),toString(null())),\n\t\tfile_date = toInteger(regexExtract(regexReplace(split(replace(file_name,'%20',''),'/')[5],'([^0-9])',''),'(\\\\d+)')),\n\t\t{INSTITUTION ID} = lpad({INSTITUTION ID},9,'0')) ~> DerivePseudoRTN\ndwRTNNum select(mapColumn(\n\t\trouting_number,\n\t\trtn_client_key = client_key,\n\t\trtn_source_system_key = source_system_key\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectRTN\nSelectForUpsert alterRow(upsertIf(true())) ~> MarkUpserts\nsrcdimTerminal select(mapColumn(\n\t\tatm_terminal_key,\n\t\tdim_terminal_key = terminal_key,\n\t\tdim_client_key = client_key,\n\t\tdim_atm_indicator = atm_indicator,\n\t\tdim_source_system_key = source_system_key,\n\t\tdim_load_date = load_date,\n\t\tdim_create_date = create_date\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectDimTerminals\nDedupe derive(TerminalHashkey = crc32(iif(isNull(TerminalKey),'',TerminalKey)\n, iif(isNull(source_system_key),0,source_system_key))) ~> HashKey\nderiveColumns aggregate(groupBy(TerminalKey,\n\t\tload_date,\n\t\tsource_system_key,\n\t\tcoop_atm_indicator,\n\t\tOFF_PREMISE_IND,\n\t\tatm_indicator),\n\tatm_client_key = min(atm_client_key)) ~> Dedupe\nSelectFactTerminals, SelectDimTerminals join(TerminalKey == dim_terminal_key,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinDimTerminal\nJoinDimTerminal derive(load_date = iif(load_date>dim_load_date||isNull(load_date),coalesce(dim_load_date,load_date),load_date),\n\t\tcreate_date = coalesce(dim_create_date,currentTimestamp()),\n\t\tmodified_date = iif(load_date>dim_load_date||isNull(dim_load_date),coalesce(load_date,dim_load_date),dim_load_date),\n\t\tsource_system_key = coalesce(dim_source_system_key,source_system_key),\n\t\tclient_key = coalesce(atm_client_key,dim_client_key),\n\t\tatm_indicator = case(dim_atm_indicator==toBoolean('y'), dim_atm_indicator, atm_indicator),\n\t\tTerminalHashkey = coalesce(atm_terminal_key, TerminalHashkey)) ~> DeriveTerminalUpdates\nsrcFISATMList derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null())))),\n\t\tatm_source_system_key = 1) ~> TrimFISColumns\nTrimFISColumns filter({ATM ID}!='ATM ID') ~> FilterFISHeaders\nfilerRank aggregate(groupBy({ATM ID},\n\t\t{INSTITUTION ID},\n\t\tpseudo_rtn,\n\t\tatm_source_system_key),\n\tcount = count()) ~> dedupeFISATMList\nsrcFDATMList derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null())))),\n\t\tatm_source_system_key = 2) ~> TrimFDATMList\nsrcFDParReference derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null()))))) ~> TrimFDParReference\ndedupeFDATMList, TrimFDParReference join({Part Id} == par_id,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinparID\nJoindimClient select(mapColumn(\n\t\tfd_atm_id = {Term Id},\n\t\tfd_atm_client_key = client_key,\n\t\tfd_atm_source_system_key = atm_source_system_key\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectFDATMs\nTrimFDATMList filter({Holding Company}!='Holding Company') ~> FilterFDATMHeaders\nFilterFDATMHeaders aggregate(groupBy({Part Id},\n\t\t{Term Id},\n\t\tatm_source_system_key),\n\tcount = count()) ~> dedupeFDATMList\nJoinparID, dwClientDim join(client_id == client_number,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoindimClient\ndedupeFISATMList, SelectRTN join(iif({INSTITUTION ID}==routing_number,{INSTITUTION ID}==routing_number,pseudo_rtn==routing_number),\n\tjoinType:'cross',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinRTN\nJoinRTN aggregate(groupBy({ATM ID},\n\t\trtn_client_key,\n\t\tatm_source_system_key),\n\tcount = count()) ~> DistinctFISATMs\nDistinctTerminals, srcSourceSystem join(Source == source_system_abbreviation,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinSourceSystemKey\nSelectFISATMs, SelectFDATMs join(fis_atm_id == fd_atm_id,\n\tjoinType:'outer',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinATMs\nJoinATMs derive(atm_id = coalesce(fis_atm_id, fd_atm_id),\n\t\tatm_client_key = coalesce(fis_atm_client_key, fd_atm_client_key),\n\t\tatm_source_system_key = coalesce(fis_atm_source_system_key, fd_atm_source_system_key)) ~> DeriveATMs\nDeriveATMs select(mapColumn(\n\t\tatm_id,\n\t\tatm_client_key,\n\t\tatm_source_system_key\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectFinalATMs\nHashKey select(mapColumn(\n\t\tTerminalKey,\n\t\tload_date,\n\t\tsource_system_key,\n\t\tcoop_atm_indicator,\n\t\tOFF_PREMISE_IND,\n\t\tatm_client_key,\n\t\tatm_indicator,\n\t\tTerminalHashkey\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectFactTerminals\nTerminalAttributes derive(atm_indicator = case(MerchantType=='6011',toBoolean('y'),toBoolean('n'))) ~> deriveATMMerchantTypeFlag\nDerivePseudoRTN window(over({ATM ID}),\n\tdesc(file_date, false),\n\trank = rowNumber()) ~> rankATMs\nrankATMs filter(rank==1) ~> filerRank\nMarkUpserts sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tatm_terminal_key as long,\n\t\tsource_system_key as integer,\n\t\tterminal_key as string,\n\t\tclient_key as long,\n\t\tcoop_atm_indicator as boolean,\n\t\ton_premise_indicator as boolean,\n\t\tatm_indicator as boolean,\n\t\tload_date as date,\n\t\tmodified_date as date,\n\t\tcreate_date as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:false,\n\tupsertable:true,\n\tkeys:['atm_terminal_key','source_system_key','terminal_key'],\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tbatchSize: 5000,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tatm_terminal_key = TerminalHashkey,\n\t\tsource_system_key,\n\t\tterminal_key = TerminalKey,\n\t\tclient_key,\n\t\tcoop_atm_indicator,\n\t\ton_premise_indicator = OFF_PREMISE_IND,\n\t\tatm_indicator,\n\t\tload_date,\n\t\tmodified_date,\n\t\tcreate_date = CreateDate\n\t)) ~> dimTerminal"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/populate_DimAccount')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "This is to populate Dim Account to the Azure DW.",
                "folder": {
                    "name": "Dimensions"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "src_stgFISDemographics",
                                "type": "DatasetReference"
                            },
                            "name": "FISDebitDemographic"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Account",
                                "type": "DatasetReference"
                            },
                            "name": "DwDimAccount"
                        },
                        {
                            "dataset": {
                                "referenceName": "fact_Transaction",
                                "type": "DatasetReference"
                            },
                            "name": "FactTransactions"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_BIN",
                                "type": "DatasetReference"
                            },
                            "name": "dwDimBin"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "dim_Account",
                                "type": "DatasetReference"
                            },
                            "name": "SnkDimAccount"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "SelectAccountAttributes"
                        },
                        {
                            "name": "ConvertAttributesAndApplyLogic"
                        },
                        {
                            "name": "TrimSpaces"
                        },
                        {
                            "name": "CreateHashkeys"
                        },
                        {
                            "name": "DistinctAttributes"
                        },
                        {
                            "name": "JoinAccounts"
                        },
                        {
                            "name": "ResetAttributesforNewIssueDate"
                        },
                        {
                            "name": "ExpirationDatePassOne"
                        },
                        {
                            "name": "FirstTxDateLogic"
                        },
                        {
                            "name": "AdditionalLogic"
                        },
                        {
                            "name": "SelectUpsertColumns"
                        },
                        {
                            "name": "Upsert"
                        },
                        {
                            "name": "ActivationDateLogic"
                        },
                        {
                            "name": "JoinTransactions"
                        },
                        {
                            "name": "ExpirationDatePassTwo"
                        },
                        {
                            "name": "IssueDateFillIn"
                        },
                        {
                            "name": "FilterHeader"
                        },
                        {
                            "name": "JoinBinwithBankEXT"
                        },
                        {
                            "name": "windowgetbankExtDesc"
                        },
                        {
                            "name": "filtergetonerecord"
                        },
                        {
                            "name": "selectkeycols"
                        },
                        {
                            "name": "JoinwithAcctNbr"
                        }
                    ],
                    "script": "source(output(\n\t\tFISDebitDemographicID as string,\n\t\tAccountNumber as string,\n\t\tPlasticNumber as string,\n\t\tGreetingName as string,\n\t\tFinancialInstitutionRouteTransit as string,\n\t\tCardStatus as string,\n\t\tLastUsedDate as string,\n\t\tAuthorizationLimitGroup as string,\n\t\tPINOffset as string,\n\t\tTrackTwoDate as string,\n\t\tDDAAccountNumber as string,\n\t\tSavingsAccountNumber as string,\n\t\tAdditionalDDAAccountNumberOne as string,\n\t\tAdditionalDDAAccountNumberTwo as string,\n\t\tAdditionalDDAAccountNumberThree as string,\n\t\tAdditionalDDAAccountNumberFour as string,\n\t\tAdditionalDDAAccountNumberFive as string,\n\t\tAdditionalSavingsAccountNumberOne as string,\n\t\tAdditionalSavingsAccountNumberTwo as string,\n\t\tAdditionalSavingsAccountNumberThree as string,\n\t\tAdditionalSavingsAccountNumberFour as string,\n\t\tAdditionalSavingsAccountNumberFive as string,\n\t\tAdditionalCreditAccountNumberOne as string,\n\t\tAdditionalCreditAccountNumberTwo as string,\n\t\tAdditionalCreditAccountNumberThree as string,\n\t\tAdditionalCreditAccountNumberFour as string,\n\t\tAdditionalOtherAccountNumberOne as string,\n\t\tAdditionalOtherAccountNumberTwo as string,\n\t\tAdditionalOtherAccountNumberThree as string,\n\t\tAdditionalOtherAccountNumberFour as string,\n\t\tCardholderAddressLineOne as string,\n\t\tCardholderAddressLineTwo as string,\n\t\tCardholderAddressCity as string,\n\t\tCardholderAddressState as string,\n\t\tCardholderAddressZip as string,\n\t\tCardholderFirstName as string,\n\t\tCardholderLastName as string,\n\t\tCardholderMiddleInitial as string,\n\t\tCardActivationFlag as string,\n\t\tOriginalIssueDate as string,\n\t\tLastIssueDate as string,\n\t\tNationalIdentifier as string,\n\t\tMothersMaidenName as string,\n\t\tHomePhone as string,\n\t\tWorkPhone as string,\n\t\tUserValidation as string,\n\t\tVRUCounter as string,\n\t\tBirthDate as string,\n\t\tCardActivationMethod as string,\n\t\tCardActivationDate as string,\n\t\tCardActivationTime as string,\n\t\tPreviousExpirationDate as string,\n\t\tPreviousCardActivationStatus as string,\n\t\tCardStatusTwo as string,\n\t\tFISDebitImportFileName as string,\n\t\tCreateDate as string,\n\t\tBINNumber as string,\n\t\tClientNumberIssuer as string,\n\t\tHashFullRecord as string,\n\t\tLastUpdatedDate as string,\n\t\tReportDate as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> FISDebitDemographic\nsource(output(\n\t\taccount_key as string,\n\t\tsource_system_key as integer,\n\t\tbin_key as long,\n\t\tclient_key as long,\n\t\taccount_number as string,\n\t\taccount_issue_date as date,\n\t\taccount_activation_date as date,\n\t\taccount_activation_flag as string,\n\t\taccount_status_flag as string,\n\t\taccount_expiration_date as date,\n\t\tfirst_txn_date as date,\n\t\tdurable_key as integer,\n\t\tload_date as date,\n\t\tcreate_date as timestamp,\n\t\tmodified_date as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'Select * from [member].[dim_account] with (nolock) where source_system_key = 1',\n\tformat: 'query',\n\tstaged: false,\n\tpartitionColumn: 'account_number',\n\tpartitionBy('external', 5)) ~> DwDimAccount\nsource(output(\n\t\tsource_system_key as integer,\n\t\taccount_key_trans as string,\n\t\tsettlement_date as date\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'Select source_system_key, account_key as account_key_trans, min(settlement_date_key) as settlement_date FROM [transaction].[fact_transaction] with (nolock) where source_system_key = 1 and settlement_date_key >\\'1900-01-01\\' group by source_system_key, account_key',\n\tformat: 'query',\n\tstaged: false,\n\tpartitionColumn: 'account_key_trans',\n\tpartitionBy('external', 5)) ~> FactTransactions\nsource(output(\n\t\tdw_binkey as long,\n\t\tdw_clientkey as long,\n\t\tbankIdentificationNumberISO as string,\n\t\tbankIdentificationNumberEXT as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'select distinct bin_key as dw_binkey, client_key as dw_clientkey, bankIdentificationNumberISO, bankIdentificationNumberEXT from [financialinstitution].[dim_bin] with (nolock)',\n\tformat: 'query',\n\tstaged: false,\n\tpartitionColumn: 'bankIdentificationNumberEXT',\n\tpartitionBy('external', 2)) ~> dwDimBin\nFilterHeader select(mapColumn(\n\t\tCardActivationFlag,\n\t\tAccountNumber,\n\t\tCardStatus,\n\t\tCardActivationDate,\n\t\tExpirationDate = TrackTwoDate,\n\t\tOriginalIssueDate,\n\t\tLastIssueDate,\n\t\tReportDate\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectAccountAttributes\nTrimSpaces derive(ReportDate = toDate(ReportDate, 'yyyy-MM-dd'),\n\t\tCardActivationDate = toDate(CardActivationDate, 'yyyy-MM-dd'),\n\t\tIssueDateQualified = coalesce(iif(\ntoDate(LastIssueDate, 'yyyy-MM-dd') > toDate(OriginalIssueDate, 'yyyy-MM-dd') \n, toDate(LastIssueDate, 'yyyy-MM-dd'), toDate(OriginalIssueDate, 'yyyy-MM-dd'))\n,toDate('1900-01-01')),\n\t\tExpirationDate = case(toString(toDate(case(\nExpirationDate == ''\n||ExpirationDate == 'NULL'\n||ExpirationDate == '0000'\n||substring(ExpirationDate,3,2) == '0000'\n||toInteger(substring(ExpirationDate,3,2)) < 01\n||toInteger(substring(ExpirationDate,3,2))  > 12\n,'1900-01-01' , concat('20',substring(ExpirationDate,1,2),'-',substring(ExpirationDate,3,2),'-01')\n))) != '1900-01-01',\n(addMonths(addDays(toDate(case(\nExpirationDate == ''\n||ExpirationDate == 'NULL'\n||ExpirationDate == '0000'\n||substring(ExpirationDate,3,2) == '0000'\n||toInteger(substring(ExpirationDate,3,2)) < 01\n||toInteger(substring(ExpirationDate,3,2))  > 12\n,'1900-01-01' , concat('20',substring(ExpirationDate,1,2),'-',substring(ExpirationDate,3,2),'-01')\n)), -1), 1))\n,toDate(case(\nExpirationDate == ''\n||ExpirationDate == 'NULL'\n||ExpirationDate == '0000'\n||substring(ExpirationDate,3,2) == '0000'\n||toInteger(substring(ExpirationDate,3,2)) < 01\n||toInteger(substring(ExpirationDate,3,2))  > 12\n,'1900-01-01' , concat('20',substring(ExpirationDate,1,2),'-',substring(ExpirationDate,3,2),'-01')\n))),\n\t\tCardholderStatus = toInteger(CardStatus),\n\t\tsource_system_key_FIS = 1,\n\t\tCardActivationFlag = case(\n    isNull(CardActivationFlag)\n    || CardActivationFlag == ''\n    && CardActivationDate != '1900-01-01'\n    , 'Y', CardActivationFlag)) ~> ConvertAttributesAndApplyLogic\nSelectAccountAttributes derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null()))))) ~> TrimSpaces\nJoinwithAcctNbr derive(AccountHashkey = md5(iif(isNull(DistinctAttributes@AccountNumber),'',DistinctAttributes@AccountNumber)\n, iif(isNull(source_system_key_FIS),0,source_system_key_FIS))) ~> CreateHashkeys\nConvertAttributesAndApplyLogic aggregate(groupBy(AccountNumber,\n\t\tsource_system_key_FIS),\n\tcount = count(),\n\t\tCardActivationDate = max(CardActivationDate),\n\t\tExpirationDate = max(ExpirationDate),\n\t\tIssueDateQualified = max(IssueDateQualified),\n\t\tCardActivationFlag = max(CardActivationFlag),\n\t\tCardStatus = case(min(CardholderStatus)==0,'Non-Statused','Statused'),\n\t\tReportDate = max(ReportDate)) ~> DistinctAttributes\nCreateHashkeys, DwDimAccount join(AccountHashkey == account_key,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinAccounts\nIssueDateFillIn derive(account_activation_date = iif(IssueDateQualified_updated>account_issue_date||isNull(account_issue_date)||account_activation_date<account_issue_date||account_activation_date<IssueDateQualified_updated,toDate('1900-01-01'),account_activation_date),\n\t\taccount_expiration_date = iif(IssueDateQualified_updated>account_issue_date||isNull(account_issue_date)||account_expiration_date<account_issue_date||account_expiration_date<IssueDateQualified_updated,toDate('1900-01-01'),account_expiration_date),\n\t\tfirst_txn_date = iif(IssueDateQualified_updated>account_issue_date||isNull(account_issue_date)||settlement_date<account_issue_date||settlement_date<IssueDateQualified_updated,toDate('1900-01-01'),settlement_date)) ~> ResetAttributesforNewIssueDate\nResetAttributesforNewIssueDate derive(ExpirationDate_passone = iif(ExpirationDate<IssueDateQualified_updated || ExpirationDate<account_expiration_date || ExpirationDate==toDate('1900-01-01') || isNull(ExpirationDate)\r\n    ,coalesce(account_expiration_date,toDate('1900-01-01'))\r\n    ,ExpirationDate)) ~> ExpirationDatePassOne\nExpirationDatePassOne derive(first_txn_date_updated = iif(isNull(first_txn_date)||first_txn_date==toDate('1900-01-01')\r\n    ,iif(settlement_date>IssueDateQualified_updated && iif(ExpirationDate_passone==toDate('1900-01-01')||isNull(ExpirationDate_passone), true(),settlement_date<ExpirationDate_passone)\r\n        , settlement_date\r\n        , toDate('1900-01-01'))\r\n    ,first_txn_date)) ~> FirstTxDateLogic\nExpirationDatePassTwo derive(dw_binkey = coalesce(dw_binkey, bin_key),\n\t\tdw_clientkey = coalesce(dw_clientkey, client_key),\n\t\tCardActivationFlag = coalesce(CardActivationFlag, account_activation_flag),\n\t\tCardStatus = coalesce(CardStatus, account_status_flag),\n\t\tReportDate = coalesce(load_date,ReportDate),\n\t\tcreate_date_new = coalesce(create_date,currentTimestamp()),\n\t\treport_date_updated = toTimestamp(ReportDate)) ~> AdditionalLogic\nAdditionalLogic select(mapColumn(\n\t\tsource_system_key_FIS,\n\t\tAccountHashKey = AccountHashkey,\n\t\tdw_binkey,\n\t\tdw_clientkey,\n\t\tAccountNumber = DistinctAttributes@AccountNumber,\n\t\tIssueDateQualified = IssueDateQualified_updated,\n\t\tfirst_txn_date = first_txn_date_updated,\n\t\tExpirationDate = ExpirationDate_passtwo,\n\t\tCardActivationDate = CardActivationDate_updated,\n\t\tCardActivationFlag,\n\t\tCardStatus,\n\t\tReportDate,\n\t\tcreate_date_new,\n\t\tmodified_date = report_date_updated\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectUpsertColumns\nSelectUpsertColumns alterRow(upsertIf(true())) ~> Upsert\nFirstTxDateLogic derive(CardActivationDate_updated = iif(isNull(CardActivationDate)||CardActivationDate==toDate('1900-01-01')||CardActivationDate<IssueDateQualified_updated||CardActivationDate>ExpirationDate_passone\r\n    ,coalesce(account_activation_date,toDate('1900-01-01'))\r\n,CardActivationDate)) ~> ActivationDateLogic\nJoinAccounts, FactTransactions join(DistinctAttributes@AccountNumber == account_key_trans\n\t&& source_system_key_FIS == FactTransactions@source_system_key,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinTransactions\nActivationDateLogic derive(ExpirationDate_passtwo = iif(ExpirationDate_passone==toDate('1900-01-01')||ExpirationDate_passone<CardActivationDate_updated\r\n    ,iif(first_txn_date_updated==toDate('1900-01-01')\r\n        ,iif(CardActivationDate_updated==toDate('1900-01-01')\r\n            ,IssueDateQualified_updated,CardActivationDate_updated)\r\n    ,first_txn_date_updated)\r\n,ExpirationDate_passone)) ~> ExpirationDatePassTwo\nJoinTransactions derive(IssueDateQualified_updated = iif(IssueDateQualified==toDate('1900-01-01')||isNull(IssueDateQualified)\r\n    ,iif(account_issue_date==toDate('1900-01-01')\r\n        ,iif(CardActivationDate==toDate('1900-01-01')||isNull(CardActivationDate)\r\n            ,iif(isNull(settlement_date),toDate('1900-01-01'),settlement_date)\r\n        ,CardActivationDate)\r\n    ,account_issue_date)\r\n,IssueDateQualified)) ~> IssueDateFillIn\nFISDebitDemographic filter(FISDebitDemographicID!='FISDebitDemographicID') ~> FilterHeader\nDistinctAttributes, dwDimBin join(left(AccountNumber,6) == left(bankIdentificationNumberEXT,6)\r\n&&\r\nlike(AccountNumber,bankIdentificationNumberEXT + '%'),\n\tjoinType:'cross',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinBinwithBankEXT\nJoinBinwithBankEXT window(over(AccountNumber,\n\t\tCardActivationFlag,\n\t\tCardActivationDate,\n\t\tExpirationDate,\n\t\tIssueDateQualified,\n\t\tReportDate,\n\t\tCardStatus),\n\tdesc(bankIdentificationNumberEXT, true),\n\trownumber_bin_client = rowNumber()) ~> windowgetbankExtDesc\nwindowgetbankExtDesc filter(rownumber_bin_client==1) ~> filtergetonerecord\nfiltergetonerecord select(mapColumn(\n\t\tAccountNumber,\n\t\tdw_binkey,\n\t\tdw_clientkey\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> selectkeycols\nDistinctAttributes, selectkeycols join(DistinctAttributes@AccountNumber == selectkeycols@AccountNumber,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinwithAcctNbr\nUpsert sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\taccount_key as string,\n\t\tsource_system_key as integer,\n\t\tbin_key as long,\n\t\tclient_key as long,\n\t\taccount_number as string,\n\t\taccount_issue_date as date,\n\t\taccount_activation_date as date,\n\t\taccount_activation_flag as string,\n\t\taccount_status_flag as string,\n\t\taccount_expiration_date as date,\n\t\tfirst_txn_date as date,\n\t\tdurable_key as integer,\n\t\tload_date as date,\n\t\tcreate_date as timestamp,\n\t\tmodified_date as timestamp,\n\t\taccount_closed_date as date,\n\t\taccount_delinquent_date as date\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:false,\n\tupsertable:true,\n\tkeys:['account_key'],\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\taccount_key = AccountHashKey,\n\t\tsource_system_key = source_system_key_FIS,\n\t\tbin_key = dw_binkey,\n\t\tclient_key = dw_clientkey,\n\t\taccount_number = AccountNumber,\n\t\taccount_issue_date = IssueDateQualified,\n\t\taccount_activation_date = CardActivationDate,\n\t\taccount_activation_flag = CardActivationFlag,\n\t\taccount_status_flag = CardStatus,\n\t\taccount_expiration_date = ExpirationDate,\n\t\tfirst_txn_date,\n\t\tload_date = ReportDate,\n\t\tcreate_date = create_date_new,\n\t\tmodified_date\n\t)) ~> SnkDimAccount"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/ChargeOff')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "FirstData"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "dropZoneTransactions_ChargeOff",
                                "type": "DatasetReference"
                            },
                            "name": "ChargeOffSource"
                        },
                        {
                            "dataset": {
                                "referenceName": "src_stgCCUMSTR",
                                "type": "DatasetReference"
                            },
                            "name": "CCUMSTR"
                        },
                        {
                            "dataset": {
                                "referenceName": "FDTransactionCriteria",
                                "type": "DatasetReference"
                            },
                            "name": "TransactionCriteria"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "snk_cnfmFISTransactions",
                                "type": "DatasetReference"
                            },
                            "name": "sink1"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "Trim"
                        },
                        {
                            "name": "BaseTransformations"
                        },
                        {
                            "name": "Join1"
                        },
                        {
                            "name": "Join2"
                        },
                        {
                            "name": "Filter1"
                        },
                        {
                            "name": "HashAndTxnNameFields"
                        },
                        {
                            "name": "LimitSelect"
                        },
                        {
                            "name": "Dedupe"
                        },
                        {
                            "name": "Join3"
                        },
                        {
                            "name": "TrimCriteria"
                        },
                        {
                            "name": "TrimCCUMSTR"
                        }
                    ],
                    "script": "parameters{\n\tfileName as string\n}\nsource(output(\n\t\tChargeOff_ID as string,\n\t\tReportDate as string,\n\t\tCreditUnion as string,\n\t\tRDT_CHD_ACCOUNT_NUMBER as string,\n\t\tRDT_DCX_BATCH_TYPE as string,\n\t\tRDT_DCX_JULIAN_DATE as string,\n\t\tRDT_DCX_TYPE as string,\n\t\tRDT_DCX_SYS_4 as string,\n\t\tRDT_DCX_SYS_2 as string,\n\t\tRDT_DCX_DATE as string,\n\t\tRDT_DCX_2 as string,\n\t\tRDT_DCX_LAST_6 as string,\n\t\tRTI_REG_INDUSTRY_TRAN_ID as string,\n\t\tRDT_DCX_MON_TRAN_JOURNAL_AMT as string,\n\t\tRDT_TRANSACTION_DATE as string,\n\t\tSQLDLOG_JobID as string,\n\t\tRDT_REC_CODE_KEY as string,\n\t\tRDT_REC_TYPE_CONTROL as string,\n\t\tRDT_NO_POST_REASON as string,\n\t\tRDT_SC_1 as string,\n\t\tRDT_SC_2 as string,\n\t\tRDT_SC_3 as string,\n\t\tRDT_SC_4 as string,\n\t\tRDT_SC_5 as string,\n\t\tRDT_SC_6 as string,\n\t\tRDT_SC_7 as string,\n\t\tRDT_SC_8 as string,\n\t\tRDT_CHD_SYSTEM_NO as string,\n\t\tRDT_CHD_PRIN_BANK as string,\n\t\tRDT_CHD_AGENT_BANK as string,\n\t\tRDT_TRANSACTION_CODE as string,\n\t\tRDT_MRCH_SYSTEM_NO as string,\n\t\tRDT_MRCH_PRIN_BANK as string,\n\t\tRDT_MRCH_AGENT_NO as string,\n\t\tRDT_MRCH_ACCOUNT_NUMBER as string,\n\t\tRDT_CHD_EXT_STATUS as string,\n\t\tRDT_CHD_INT_STATUS as string,\n\t\tRDT_TANI as string,\n\t\tRDT_TRANSFER_FLAG as string,\n\t\tRDT_ITEM_ASSES_CODE_NUM as string,\n\t\tRDT_MRCH_SIC_CODE as string,\n\t\tRDT_DCX_ADJ_SALE_FEE_AM as string,\n\t\tRDT_DCX_AUDIT_TRAIL_DATE as string,\n\t\tRDT_DCX_PRIN_TOTAL as string,\n\t\tRDT_DCX_PRIN_CASH as string,\n\t\tRDT_DCX_PRIN_MRCH as string,\n\t\tRDT_DCX_STMT_FIN_CHG_OFF as string,\n\t\tRDT_DCX_MTJ_FIN_CHG_OFF as string,\n\t\tRDT_DCX_BAL_TRAN_DUAL_FLAG as string,\n\t\tRDT_DCX_PRIN_MISC_CHGS as string,\n\t\tRDT_DCX_CR_LIFE_CHG_OFF as string,\n\t\tRDT_DCX_ACCRUED_CASHINT as string,\n\t\tRDT_DCX_ACCRUED_MRCHINT as string,\n\t\tRDT_DCX_BALANCE_CHG_OFF as string,\n\t\tRDT_DCX_OLD_OPEN_BALANCE as string,\n\t\tRDT_DCX_ACCRUED_CRDINT as string,\n\t\tRDT_ADDL_SEGS_NO as string,\n\t\tREG_SEGMENT_CODE as string,\n\t\tRTI_REG_TRAN_ID_SOURCE as string,\n\t\tRTI_REG_MISC_AMOUNT as string,\n\t\tRTI_REG_TICKET_AUTH_AMOUNT as string,\n\t\tRTI_REG_BNK_RFRN_ID as string,\n\t\tRTI_REG_ORIG_TRAN_ID as string,\n\t\tRTI_REG_CARD_INPUT_MODE_CD as string,\n\t\tOTI_SEGMENT_CODE as string,\n\t\tOTI_ORIGINAL_REF_NO as string,\n\t\tOTI_ORIGINAL_POST_DATE as string,\n\t\tOTI_ORIGINAL_ADJ_TRAN_DT as string,\n\t\tAPR_SEGMENT_CODE as string,\n\t\tAPR_EAPR_CASH_INT as string,\n\t\tAPR_EAPR_MRCH_INT as string,\n\t\tAPR_EAPR_CASH_ITEM_CHG as string,\n\t\tAPR_EAPR_MRCH_ITEM_CHG as string,\n\t\tAPR_EAPR_LATE_CHG as string,\n\t\tAPR_EAPR_OVLM_CHG as string,\n\t\tAPR2_SEGMENT_CODE as string,\n\t\tAPR2_EAPR_MIN_CHG as string,\n\t\tAPR2_EAPR_STMT_CHG as string,\n\t\tAPR2_EAPR_CR_LIFE_CHG as string,\n\t\tAPR2_EAPR_REBATE_AMT as string,\n\t\tAPR2_EAPR_MIN_FINC_CASH_AM as string,\n\t\tAPR2_EAPR_MXCP_CRDT_AM as string,\n\t\tDFP_SEGMENT_CODE as string,\n\t\tRDT_DFP_FEE_NM as string,\n\t\tRDT_DFP_FEE_AM as string,\n\t\tRDT_DFP_PSTN_BCKT_ID as string,\n\t\tRDT_DFP_MMB_CD as string,\n\t\tRDT_DFP_RCUR_ID as string,\n\t\tRDT_DFP_LTTR_IN as string,\n\t\tRDT_DFP_MEMO_IN as string,\n\t\tRDT_DFP_BTCH_ALPH_CD as string,\n\t\tRDT_DFP_EMBD_IN as string,\n\t\tRDT_DFP_RESN_CD as string,\n\t\tRDT_DFP_STMT_PSTN_CD as string,\n\t\tRDT_DFP_RPT_CD as string,\n\t\tRDT_DFP_DYNM_FEE_GNRC_CD as string,\n\t\tRDT_TKN_CDT as string,\n\t\tRDT_TKN_SRVC_NMBR_ID as string,\n\t\tRDT_WLLT_ID as string,\n\t\tRDT_TKN_RQST_ID as string,\n\t\tRDT_TKN_FILLER as string,\n\t\tRDT_GNRC_TRAN_FLD_SEG_CD as string,\n\t\tRDT_CARD_ACCP_TERM_ID as string,\n\t\tRDT_MRCH_FULL_ZIP_CD as string,\n\t\tRDT_GTF_FILLER as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> ChargeOffSource\nsource(output(\n\t\tSPAIdentifier as string,\n\t\tsys as string,\n\t\tprin as string,\n\t\tagent as string,\n\t\tcu_odindx as string,\n\t\tcardtyp as string,\n\t\tInterestRate as string,\n\t\tAnnualFee as string,\n\t\tOverlimitFee as string,\n\t\tLateFee as string,\n\t\tCwbFee as string,\n\t\tAutoDQFee as string,\n\t\tGroupNo as string,\n\t\tGroupDesc as string,\n\t\tItemizedPerAcct as string,\n\t\tPrimaryBillingSys as string,\n\t\tPlatform as string,\n\t\tSPA as string,\n\t\tDateProcessed as string,\n\t\tStatus as string,\n\t\tUniversalAddressing as string,\n\t\tSeparateEntityFlag as string,\n\t\tInternationalDateFormat as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> CCUMSTR\nsource(output(\n\t\tTransactionCriteriaID as string,\n\t\tFD_Source_System_Key as string,\n\t\tTransactionName as string,\n\t\tBINType as string,\n\t\tTransactionCode as string,\n\t\tResponseCodeOperator as string,\n\t\tResponseCode as string,\n\t\tMerchantTypeOperator as string,\n\t\tMerchantType as string,\n\t\tPOSEntryCode as string,\n\t\tNetworkID as string,\n\t\tReferenceNumberOperator as string,\n\t\tReferenceNumber as string,\n\t\tAuthorizationResponseOperator as string,\n\t\tAuthorizationResponse as string,\n\t\tAuthorizationType as string,\n\t\tReasonCodeOperator as string,\n\t\tReasonCode as string,\n\t\tCreateDate as string,\n\t\tAuthorizationTypeOperator as string,\n\t\tAcctNumMerchNumMatchInd as string,\n\t\tOperatorCodeOperator as string,\n\t\tOperatorCode as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> TransactionCriteria\nLimitSelect derive(each(match(type=='string'), $$ = ltrim(rtrim($$))),\n\t\tImportFileDate = toDate(concat(substring($fileName,11,4),'-',substring($fileName,15,2),'-',substring($fileName,17,2)),'yyyy-MM-dd'),\n\t\tdefaultdate = '1900-01-01') ~> Trim\nTrim derive(AccountNumber = RDT_CHD_ACCOUNT_NUMBER,\n\t\tAcquirer_ClientID = 'UNK',\n\t\tAcquirerNetworkID = 'UNK',\n\t\tbiniso = substring(RDT_CHD_ACCOUNT_NUMBER,1,6),\n\t\tbinext = RDT_CHD_ACCOUNT_NUMBER,\n\t\tcardentrymethod = '000',\n\t\tCardPrescenceDescription = 'UNK',\n\t\tSettlementAmount = toFloat(RDT_DCX_MON_TRAN_JOURNAL_AMT),\n\t\tResponseCode_src = '00',\n\t\tSurcharge = toFloat('0.00'),\n\t\tSource = 'FD',\n\t\tIssuerclient = 'UNK',\n\t\tIssuerNet = 'UNK',\n\t\tMerchantName = case( RDT_TRANSACTION_CODE=='370'||RDT_TRANSACTION_CODE=='371','Charge Off Transaction',case(RDT_TRANSACTION_CODE=='400','Account Transfer','UNK')),\n\t\tMerchantType_src = right('000' + RDT_MRCH_SIC_CODE,4),\n\t\tMonetary = 1,\n\t\tOnusdesc = 'UNK',\n\t\tOriginalDataTran = toDate(defaultdate),\n\t\tOriginDate = toDate(RDT_TRANSACTION_DATE,'yyMMdd'),\n\t\tRecurringdesc = 'UNK',\n\t\tTermialCity = 'UNK',\n\t\tTerminalState = 'UNK',\n\t\tTerminalCountry = 'UNK',\n\t\tTerminalZip = 'UNK',\n\t\tTerminalKey = 'UNK',\n\t\tTokenRequestId = iif(length(RDT_TKN_RQST_ID)==11,RDT_TKN_RQST_ID,toString(null())),\n\t\tTransactiontypecode = RDT_TRANSACTION_CODE,\n\t\tTransmissionDate = toDate(defaultdate),\n\t\tTransmissionTime = 'UNK',\n\t\tTimeLocalTransaction = 'UNK',\n\t\tInterchange = toFloat('0.00'),\n\t\tSettlementDate = toDate(defaultdate),\n\t\tTerminalAddress = 'UNK',\n\t\tReferenceNumberChargeoff = RDT_DCX_TYPE + RDT_DCX_SYS_4 + RDT_DCX_SYS_2 + RDT_DCX_DATE + RDT_DCX_2 + RDT_DCX_LAST_6,\n\t\tAuthorizationNo = 'UNK',\n\t\tOperCode = 'UNK',\n\t\tClientNo = 'UNK',\n\t\ttransaction_amount = toFloat(0.00),\n\t\tis_authorization = 0,\n\t\tAcquiringRTN = 'UNK',\n\t\tSettlementRTN = 'RTN',\n\t\tForwardingRTN = 'UNK',\n\t\tTraceNumber = 'UNK',\n\t\tAcqTraceNumber = 'UNK',\n\t\tVisaTransactionID = 'UNK',\n\t\tMasterCardTransactionID = 'UNK',\n\t\tISOMessageType = 'UNK') ~> BaseTransformations\nBaseTransformations, TrimCCUMSTR join(RDT_CHD_SYSTEM_NO == sys\n\t&& RDT_CHD_PRIN_BANK == prin\n\t&& RDT_CHD_AGENT_BANK == agent,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> Join1\nJoin1, TrimCriteria join(Platform == BINType\n\t&& Transactiontypecode == TransactionCode,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> Join2\nJoin2 filter(isNull(BINType)||\r\n(FD_Source_System_Key=='1'\r\n&&\r\n(isNull(MerchantType)||MerchantType=='NULL'||\r\n(MerchantTypeOperator=='IN'&&iifNull(locate(MerchantType_src,MerchantType),0)!=0)||\r\n(MerchantTypeOperator=='NOT IN'&&iifNull(locate(MerchantType_src,MerchantType),0)==0))\r\n&&\r\n(isNull(ReferenceNumber)||ReferenceNumber=='NULL'||\r\n(ReferenceNumberOperator=='='&& substring(ReferenceNumberChargeoff,12,2)==ReferenceNumber)||\r\n(ReferenceNumberOperator=='<>'&& substring(ReferenceNumberChargeoff,12,2) !=ReferenceNumber)))) ~> Filter1\nJoin3 derive(Transaction_Key = crc32(iif(isNull(AccountNumber),'',AccountNumber)\r\n, iif(isNull(OriginDate),'',toString(OriginDate))\r\n, iif(isNull(TimeLocalTransaction),'',TimeLocalTransaction)\r\n, iif(isNull(TransmissionDate),'',toString(TransmissionDate))\r\n, iif(isNull(TransmissionTime),'',TransmissionTime)\r\n, iif(isNull(SettlementAmount),0.00,SettlementAmount)\r\n, iif(isNull(Transactiontypecode),'',Transactiontypecode)\r\n, iif(isNull(ReferenceNumberChargeoff),'',ReferenceNumberChargeoff)\r\n, 2),\n\t\tTransactionName = iif(isNull(TransactionName),'Unknown', TransactionName)) ~> HashAndTxnNameFields\nChargeOffSource select(mapColumn(\n\t\tChargeOff_ID,\n\t\tReportDate,\n\t\tRDT_CHD_ACCOUNT_NUMBER,\n\t\tRDT_DCX_MON_TRAN_JOURNAL_AMT,\n\t\tRDT_TRANSACTION_DATE,\n\t\tRDT_DCX_TYPE,\n\t\tRDT_DCX_SYS_2,\n\t\tRDT_DCX_SYS_4,\n\t\tRDT_DCX_DATE,\n\t\tRDT_DCX_2,\n\t\tRDT_DCX_LAST_6,\n\t\tRDT_CHD_SYSTEM_NO,\n\t\tRDT_CHD_PRIN_BANK,\n\t\tRDT_TRANSACTION_CODE,\n\t\tRDT_MRCH_SIC_CODE,\n\t\tRDT_CHD_AGENT_BANK,\n\t\tRDT_MRCH_ACCOUNT_NUMBER,\n\t\tRDT_TKN_RQST_ID\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> LimitSelect\nFilter1 aggregate(groupBy(ChargeOff_ID),\n\tTransactionName = max(TransactionName)) ~> Dedupe\nJoin1, Dedupe join(Trim@ChargeOff_ID == Dedupe@ChargeOff_ID,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> Join3\nTransactionCriteria derive(each(match(type=='string'), $$ = trim($$))) ~> TrimCriteria\nCCUMSTR derive(each(match(type=='string'), $$ = trim($$))) ~> TrimCCUMSTR\nHashAndTxnNameFields sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tAccountNumber as string,\n\t\tAcquirerAccountNumber as string,\n\t\tAcquirerNetworkCode as string,\n\t\tBin_ISO as string,\n\t\tBin_EXT as string,\n\t\tCardEntryMethodCode as string,\n\t\tCardPresenceDescription as string,\n\t\tImportFileDate as date,\n\t\tSource as string,\n\t\tInterchangeAmount as float,\n\t\tIssuerAccountNumber as string,\n\t\tIssuerNetworkCode as string,\n\t\tMerchantName as string,\n\t\tMerchantType as string,\n\t\tMonetary as integer,\n\t\tOnUsDescription as string,\n\t\tOriginalDataTransmissionDate as date,\n\t\tOriginDate as date,\n\t\tRecurringDescription as string,\n\t\tResponseCode as string,\n\t\tSettlementAmount as float,\n\t\tSettlementDate as date,\n\t\tSurchargeAmount as float,\n\t\tTerminalAddress as string,\n\t\tTerminalCity as string,\n\t\tTerminalCountry as string,\n\t\tTerminalKey as string,\n\t\tTerminalState as string,\n\t\tTerminalZipCode as string,\n\t\tTokenRequestId as string,\n\t\tTransactionName as string,\n\t\tTransactionTypeCode as string,\n\t\tTransmissionDate as date,\n\t\tTransmissionTime as string,\n\t\tTimeLocalTransaction as string,\n\t\tRetrievalReferenceNumber as string,\n\t\tTransaction_Key as long,\n\t\tAgentNo as string,\n\t\tSystemNo as string,\n\t\tOperCode as string,\n\t\tPrincipalNo as string,\n\t\tAuthorizationNo as string,\n\t\tClientNo as string,\n\t\ttransaction_amount as float,\n\t\tis_authorization as integer,\n\t\tAcquiringRTN as string,\n\t\tSettlementRTN as string,\n\t\tTraceNumber as string,\n\t\tAcqTraceNumber as string,\n\t\tVisaTransactionID as string,\n\t\tMasterCardTransactionID as string,\n\t\tMerchantAccountNumber as string,\n\t\tISOMessageType as string,\n\t\tForwardingRTN as string\n\t),\n\tformat: 'parquet',\n\tpartitionFileNames:[($fileName)],\n\tumask: 0022,\n\tpreCommands: [],\n\tpostCommands: [],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tmapColumn(\n\t\tAccountNumber,\n\t\tAcquirerAccountNumber = Acquirer_ClientID,\n\t\tAcquirerNetworkCode = AcquirerNetworkID,\n\t\tBin_ISO = biniso,\n\t\tBin_EXT = binext,\n\t\tCardEntryMethodCode = cardentrymethod,\n\t\tCardPresenceDescription = CardPrescenceDescription,\n\t\tImportFileDate,\n\t\tSource,\n\t\tInterchangeAmount = Interchange,\n\t\tIssuerAccountNumber = Issuerclient,\n\t\tIssuerNetworkCode = IssuerNet,\n\t\tMerchantName,\n\t\tMerchantType = MerchantType_src,\n\t\tMonetary,\n\t\tOnUsDescription = Onusdesc,\n\t\tOriginalDataTransmissionDate = OriginalDataTran,\n\t\tOriginDate,\n\t\tRecurringDescription = Recurringdesc,\n\t\tResponseCode = ResponseCode_src,\n\t\tSettlementAmount,\n\t\tSettlementDate,\n\t\tSurchargeAmount = Surcharge,\n\t\tTerminalAddress,\n\t\tTerminalCity = TermialCity,\n\t\tTerminalCountry,\n\t\tTerminalKey,\n\t\tTerminalState,\n\t\tTerminalZipCode = TerminalZip,\n\t\tTokenRequestId,\n\t\tTransactionName,\n\t\tTransactionTypeCode = Transactiontypecode,\n\t\tTransmissionDate,\n\t\tTransmissionTime,\n\t\tTimeLocalTransaction,\n\t\tRetrievalReferenceNumber = ReferenceNumberChargeoff,\n\t\tTransaction_Key,\n\t\tAgentNo = RDT_CHD_AGENT_BANK,\n\t\tSystemNo = RDT_CHD_SYSTEM_NO,\n\t\tOperCode,\n\t\tPrincipalNo = RDT_CHD_PRIN_BANK,\n\t\tAuthorizationNo,\n\t\tClientNo,\n\t\ttransaction_amount,\n\t\tis_authorization,\n\t\tAcquiringRTN,\n\t\tSettlementRTN,\n\t\tTraceNumber,\n\t\tAcqTraceNumber,\n\t\tVisaTransactionID,\n\t\tMasterCardTransactionID,\n\t\tMerchantAccountNumber = RDT_MRCH_ACCOUNT_NUMBER,\n\t\tForwardingRTN,\n\t\tISOMessageType\n\t),\n\tpartitionBy('hash', 1)) ~> sink1"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/populate_DimNetwork')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "Dimensions"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "src_cnfmFISTransactions",
                                "type": "DatasetReference"
                            },
                            "name": "ConformedTransactions"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Network",
                                "type": "DatasetReference"
                            },
                            "name": "srcDimNetwork"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Source_System",
                                "type": "DatasetReference"
                            },
                            "name": "SourceSystem"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "dim_Network",
                                "type": "DatasetReference"
                            },
                            "name": "DimNetwork"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "NetworkCodes"
                        },
                        {
                            "name": "Acquirer"
                        },
                        {
                            "name": "Issuer"
                        },
                        {
                            "name": "AllNetworks"
                        },
                        {
                            "name": "DeDupe"
                        },
                        {
                            "name": "notExistsNetwork"
                        },
                        {
                            "name": "SourceSystemKeyTransform"
                        },
                        {
                            "name": "removeNullNetwork"
                        },
                        {
                            "name": "CreateNetworkHashkey"
                        },
                        {
                            "name": "GetCreateDate"
                        },
                        {
                            "name": "TrimSpaces"
                        }
                    ],
                    "script": "parameters{\n\tfileName as string\n}\nsource(output(\n\t\tAccountNumber as string,\n\t\tAcquirerAccountNumber as string,\n\t\tAcquirerNetworkCode as string,\n\t\tBin_ISO as string,\n\t\tBin_EXT as string,\n\t\tCardEntryMethodCode as string,\n\t\tCardPresenceDescription as string,\n\t\tImportFileDate as date,\n\t\tSource as string,\n\t\tInterchangeAmount as float,\n\t\tIssuerAccountNumber as string,\n\t\tIssuerNetworkCode as string,\n\t\tMerchantName as string,\n\t\tMerchantType as string,\n\t\tMonetary as integer,\n\t\tOnUsDescription as string,\n\t\tOriginalDataTransmissionDate as date,\n\t\tOriginDate as date,\n\t\tRecurringDescription as string,\n\t\tResponseCode as string,\n\t\tSettlementAmount as float,\n\t\tSettlementDate as date,\n\t\tSurchargeAmount as float,\n\t\tTerminalAddress as string,\n\t\tTerminalCity as string,\n\t\tTerminalCountry as string,\n\t\tTerminalKey as string,\n\t\tTerminalState as string,\n\t\tTerminalZipCode as string,\n\t\tTokenRequestId as string,\n\t\tTransactionName as string,\n\t\tTransactionTypeCode as string,\n\t\tTransmissionDate as date,\n\t\tTransmissionTime as string,\n\t\tTimeLocalTransaction as string,\n\t\tRetrievalReferenceNumber as string,\n\t\tTransaction_Key as long,\n\t\tAgentNo as string,\n\t\tSystemNo as string,\n\t\tOperCode as string,\n\t\tPrincipalNo as string,\n\t\tAuthorizationNo as string,\n\t\tClientNo as string,\n\t\ttransaction_amount as float,\n\t\tis_authorization as integer,\n\t\tAcquiringRTN as string,\n\t\tSettlementRTN as string,\n\t\tTraceNumber as string,\n\t\tAcqTraceNumber as string,\n\t\tVisaTransactionID as string,\n\t\tMasterCardTransactionID as string,\n\t\tMerchantAccountNumber as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tformat: 'parquet') ~> ConformedTransactions\nsource(output(\n\t\tnetwork_key as long,\n\t\tsource_system_key as integer,\n\t\tnetwork_id as string,\n\t\tnetwork_desc as string,\n\t\tnetwork_name_normalized as string,\n\t\tload_date as date,\n\t\tcreate_date as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false,\n\tpartitionColumn: 'network_key',\n\tpartitionBy('external', 10)) ~> srcDimNetwork\nsource(output(\n\t\tsource_system_key as integer,\n\t\tsource_system_name as string,\n\t\tsource_system_description as string,\n\t\tsource_system_abbreviation as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false) ~> SourceSystem\nSourceSystemKeyTransform select(mapColumn(\n\t\tAcquirerNetworkCode,\n\t\tImportFileDate,\n\t\tsource_system_key,\n\t\tIssuerNetworkCode,\n\t\tSource\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> NetworkCodes\nNetworkCodes select(mapColumn(\n\t\tNetworkCode = AcquirerNetworkCode,\n\t\tImportFileDate,\n\t\tsource_system_key,\n\t\tSource\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Acquirer\nNetworkCodes select(mapColumn(\n\t\tImportFileDate,\n\t\tsource_system_key,\n\t\tNetworkCode = IssuerNetworkCode,\n\t\tSource\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Issuer\nAcquirer, Issuer union(byName: true)~> AllNetworks\nCreateNetworkHashkey aggregate(groupBy(NetworkCode,\n\t\tsource_system_key,\n\t\tNetworkHashkey),\n\tImportFileDate = min(iifNull(ImportFileDate,currentDate()))) ~> DeDupe\nDeDupe, srcDimNetwork exists(NetworkHashkey == network_key,\n\tnegate:true,\n\tbroadcast: 'auto')~> notExistsNetwork\nTrimSpaces, SourceSystem lookup(Source == source_system_abbreviation,\n\tmultiple: true,\n\tbroadcast: 'right')~> SourceSystemKeyTransform\nnotExistsNetwork filter(!isNull(NetworkCode)) ~> removeNullNetwork\nAllNetworks derive(NetworkHashkey = crc32(iif(isNull(NetworkCode),'',NetworkCode)\r\n, iif(isNull(source_system_key),0,source_system_key))) ~> CreateNetworkHashkey\nremoveNullNetwork derive(create_date = currentTimestamp()) ~> GetCreateDate\nConformedTransactions derive(each(match(type=='string'), $$ = trim($$))) ~> TrimSpaces\nGetCreateDate sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tnetwork_key as long,\n\t\tsource_system_key as integer,\n\t\tnetwork_id as string,\n\t\tnetwork_desc as string,\n\t\tnetwork_name_normalized as string,\n\t\tload_date as date,\n\t\tcreate_date as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tbatchSize: 5000,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tnetwork_key = NetworkHashkey,\n\t\tsource_system_key,\n\t\tnetwork_id = NetworkCode,\n\t\tload_date = ImportFileDate,\n\t\tcreate_date\n\t)) ~> DimNetwork"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/populate_DimMerchantTerminalGeography')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "This dataflow will use transactional conformed files to populate DimMerchantTerminalGeography dimensional data and sink it to SQL DW dim_merchant",
                "folder": {
                    "name": "Dimensions"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "src_cnfmFISTransactions",
                                "type": "DatasetReference"
                            },
                            "name": "ConformedTransactions"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Source_System",
                                "type": "DatasetReference"
                            },
                            "name": "SrcDWDimSourceSystem"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Merchant_Terminal_Geography",
                                "type": "DatasetReference"
                            },
                            "name": "SrcDWDimMerchantTerminalGeography"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "dim_Merchant_Terminal_Geography",
                                "type": "DatasetReference"
                            },
                            "name": "LoadDWDimMerchantTerminalGeography"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "GetSourceSystemKey"
                        },
                        {
                            "name": "NewMerchantsTerminalGeography"
                        },
                        {
                            "name": "ChangeCaseBackToTitleCase"
                        },
                        {
                            "name": "MerchantAttributesWithKeys"
                        },
                        {
                            "name": "DistinctMerchantsFromSource"
                        },
                        {
                            "name": "ReplaceNullsWithBlankSpace"
                        },
                        {
                            "name": "FilterNULLsTemporary"
                        },
                        {
                            "name": "TrimSpaces"
                        },
                        {
                            "name": "ChangeAttributesToLowerForLookup"
                        },
                        {
                            "name": "LimitColumns"
                        },
                        {
                            "name": "CreateMerchantTerminalGeographyHashKey"
                        }
                    ],
                    "script": "parameters{\n\tfileName as string\n}\nsource(output(\n\t\tAccountNumber as string,\n\t\tAcquirerAccountNumber as string,\n\t\tAcquirerNetworkCode as string,\n\t\tBin_ISO as string,\n\t\tBin_EXT as string,\n\t\tCardEntryMethodCode as string,\n\t\tCardPresenceDescription as string,\n\t\tImportFileDate as date,\n\t\tSource as string,\n\t\tInterchangeAmount as float,\n\t\tIssuerAccountNumber as string,\n\t\tIssuerNetworkCode as string,\n\t\tMerchantName as string,\n\t\tMerchantType as string,\n\t\tMonetary as integer,\n\t\tOnUsDescription as string,\n\t\tOriginalDataTransmissionDate as date,\n\t\tOriginDate as date,\n\t\tRecurringDescription as string,\n\t\tResponseCode as string,\n\t\tSettlementAmount as float,\n\t\tSettlementDate as date,\n\t\tSurchargeAmount as float,\n\t\tTerminalAddress as string,\n\t\tTerminalCity as string,\n\t\tTerminalCountry as string,\n\t\tTerminalKey as string,\n\t\tTerminalState as string,\n\t\tTerminalZipCode as string,\n\t\tTokenRequestId as string,\n\t\tTransactionName as string,\n\t\tTransactionTypeCode as string,\n\t\tTransmissionDate as date,\n\t\tTransmissionTime as string,\n\t\tTimeLocalTransaction as string,\n\t\tRetrievalReferenceNumber as string,\n\t\tTransaction_Key as long,\n\t\tAgentNo as string,\n\t\tSystemNo as string,\n\t\tOperCode as string,\n\t\tPrincipalNo as string,\n\t\tAuthorizationNo as string,\n\t\tClientNo as string,\n\t\ttransaction_amount as float,\n\t\tis_authorization as integer,\n\t\tAcquiringRTN as string,\n\t\tSettlementRTN as string,\n\t\tTraceNumber as string,\n\t\tAcqTraceNumber as string,\n\t\tVisaTransactionID as string,\n\t\tMasterCardTransactionID as string,\n\t\tMerchantAccountNumber as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tformat: 'parquet') ~> ConformedTransactions\nsource(output(\n\t\tsource_system_key as integer,\n\t\tsource_system_name as string,\n\t\tsource_system_description as string,\n\t\tsource_system_abbreviation as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false) ~> SrcDWDimSourceSystem\nsource(output(\n\t\tmerchant_terminal_geography_key as long,\n\t\tsource_system_key as integer,\n\t\tterminal_city as string,\n\t\tterminal_state as string,\n\t\tterminal_zipcode as string,\n\t\tterminal_country as string,\n\t\tload_date as date,\n\t\tcreate_date as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false,\n\tpartitionColumn: 'merchant_terminal_geography_key',\n\tpartitionBy('external', 10)) ~> SrcDWDimMerchantTerminalGeography\nDistinctMerchantsFromSource, SrcDWDimSourceSystem lookup(Source == source_system_abbreviation,\n\tmultiple: true,\n\tbroadcast: 'auto')~> GetSourceSystemKey\nCreateMerchantTerminalGeographyHashKey, SrcDWDimMerchantTerminalGeography exists(MerchantTerminalGeographyHashKey == merchant_terminal_geography_key,\n\tnegate:true,\n\tbroadcast: 'auto')~> NewMerchantsTerminalGeography\nNewMerchantsTerminalGeography derive(CreateDate = currentTimestamp(),\n\t\tTerminalCity = initCap(TerminalCity),\n\t\tTerminalState = upper(TerminalState),\n\t\tTerminalCountry = upper(TerminalCountry)) ~> ChangeCaseBackToTitleCase\nGetSourceSystemKey select(mapColumn(\n\t\tTerminalCity,\n\t\tTerminalState,\n\t\tTerminalZipCode,\n\t\tTerminalCountry,\n\t\tImportFileDate,\n\t\tsource_system_key,\n\t\tSource\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> MerchantAttributesWithKeys\nChangeAttributesToLowerForLookup aggregate(groupBy(Source,\n\t\tTerminalCity,\n\t\tTerminalState,\n\t\tTerminalZipCode,\n\t\tTerminalCountry,\n\t\tImportFileDate),\n\tCountTerminalAddress = count(TerminalAddress)) ~> DistinctMerchantsFromSource\nTrimSpaces derive(TerminalCountry = iif(isNull(TerminalCountry),'', TerminalCountry),\n\t\tTerminalCity = iif(isNull(TerminalCity),'', TerminalCity),\n\t\tTerminalState = iif(isNull(TerminalState),'', TerminalState),\n\t\tTerminalZipCode = iif(isNull(TerminalZipCode),'', TerminalZipCode)) ~> ReplaceNullsWithBlankSpace\nChangeCaseBackToTitleCase filter(!isNull(MerchantTerminalGeographyHashKey) && !isNull(source_system_key)) ~> FilterNULLsTemporary\nLimitColumns derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null()))))) ~> TrimSpaces\nReplaceNullsWithBlankSpace derive(TerminalCity = lower(TerminalCity),\n\t\tTerminalState = lower(TerminalState),\n\t\tTerminalZipCode = lower(TerminalZipCode),\n\t\tTerminalCountry = lower(TerminalCountry)) ~> ChangeAttributesToLowerForLookup\nConformedTransactions select(mapColumn(\n\t\tSource,\n\t\tTerminalAddress,\n\t\tTerminalCity,\n\t\tTerminalCountry,\n\t\tTerminalState,\n\t\tTerminalZipCode,\n\t\tImportFileDate\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> LimitColumns\nMerchantAttributesWithKeys derive(MerchantTerminalGeographyHashKey = crc32(iif(isNull(TerminalCity),'',TerminalCity)\r\n, iif(isNull(TerminalState),'',TerminalState)\r\n, iif(isNull(TerminalZipCode),'',TerminalZipCode)\r\n, iif(isNull(TerminalCountry),'',TerminalCountry)\r\n, iif(isNull(source_system_key),0,source_system_key))) ~> CreateMerchantTerminalGeographyHashKey\nFilterNULLsTemporary sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tmerchant_terminal_geography_key as long,\n\t\tsource_system_key as integer,\n\t\tterminal_city as string,\n\t\tterminal_state as string,\n\t\tterminal_zipcode as string,\n\t\tterminal_country as string,\n\t\tload_date as date,\n\t\tcreate_date as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tbatchSize: 5000,\n\tdateFormat:'yyyy/MM/dd',\n\ttimestampFormat:'yyyy/MM/dd',\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tmerchant_terminal_geography_key = MerchantTerminalGeographyHashKey,\n\t\tsource_system_key,\n\t\tterminal_city = TerminalCity,\n\t\tterminal_state = TerminalState,\n\t\tterminal_zipcode = TerminalZipCode,\n\t\tterminal_country = TerminalCountry,\n\t\tload_date = ImportFileDate,\n\t\tcreate_date = CreateDate\n\t)) ~> LoadDWDimMerchantTerminalGeography"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/CD031')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "FirstData"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "dropZoneTransactions_CD031",
                                "type": "DatasetReference"
                            },
                            "name": "CD031Source"
                        },
                        {
                            "dataset": {
                                "referenceName": "FDTransactionCriteria",
                                "type": "DatasetReference"
                            },
                            "name": "FDCriteria"
                        },
                        {
                            "dataset": {
                                "referenceName": "src_stgCCUMSTR",
                                "type": "DatasetReference"
                            },
                            "name": "CCUMSTR"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "snk_cnfmFISTransactions",
                                "type": "DatasetReference"
                            },
                            "name": "ConformedTransactions"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "BaseTransformations"
                        },
                        {
                            "name": "TrimDefault"
                        },
                        {
                            "name": "HashKey"
                        },
                        {
                            "name": "FilterHeader"
                        },
                        {
                            "name": "JoinCCUMSTR"
                        },
                        {
                            "name": "JoinCriteria"
                        },
                        {
                            "name": "Filter"
                        },
                        {
                            "name": "SelectCriteria"
                        },
                        {
                            "name": "Dedupe"
                        },
                        {
                            "name": "JoinTxnName"
                        },
                        {
                            "name": "TrimCriteria"
                        },
                        {
                            "name": "TrimCCUMSTR"
                        }
                    ],
                    "script": "parameters{\n\tfileName as string\n}\nsource(output(\n\t\tCD031ID as string,\n\t\tRoutingTransit as string,\n\t\tSYS as string,\n\t\tPRN as string,\n\t\tAGT as string,\n\t\tReportDate as string,\n\t\tCardholderAccountNumber as string,\n\t\tBinNumber as string,\n\t\tMerchantAccountNumber as string,\n\t\tAuthorizationAmount as string,\n\t\tAuthorizationCode as string,\n\t\tKSCode as string,\n\t\tTransactionTime as string,\n\t\tAuthorizationResponse as string,\n\t\tActionCode as string,\n\t\tAuthorizationLine as string,\n\t\tElectronicAuthorizationSource as string,\n\t\tInternalStatusCode as string,\n\t\tExternalStatusCode as string,\n\t\tAccountCrossReference as string,\n\t\tExpirationDate as string,\n\t\tSICCode as string,\n\t\tZipCode as string,\n\t\tCreditLimit as string,\n\t\tPCPIND as string,\n\t\tPCCIND as string,\n\t\tCFCIND as string,\n\t\tCFFIND as string,\n\t\tTERMCD as string,\n\t\tTPCODE as string,\n\t\tOPCODE as string,\n\t\tTCCODE as string,\n\t\tWBCODE as string,\n\t\tTransactionDate as string,\n\t\tReasonCode as string,\n\t\tAuthorizationFileCode as string,\n\t\tMerchantTerminalLocation as string,\n\t\tPOSDeviceModel as string,\n\t\tPOSEntryCode as string,\n\t\tAccountTypeCode as string,\n\t\tPOSEntryCodeCapability as string,\n\t\tCardholderZipCode as string,\n\t\tCardholderAddress as string,\n\t\tPACMCode as string,\n\t\tAuthorizationMethod as string,\n\t\tBehaviorScoringCode as string,\n\t\tCreditBureauScore as string,\n\t\tACSAuthorizationLineNumber as string,\n\t\tDataCode as string,\n\t\tTranslatedMerchant as string,\n\t\tAuthorizationCharacteristicsCode as string,\n\t\tTransactionIdentifier as string,\n\t\tTransactionIdentifierValidator as string,\n\t\tFraudulentRiskCode as string,\n\t\tCounterfeitCode as string,\n\t\tPaymentKitingStrategyCode as string,\n\t\tLostStolenStrategyCode as string,\n\t\tFalconStrategyCode as string,\n\t\tQueuedAuthorizationCode as string,\n\t\tBehaviorScoreVariance as string,\n\t\tTotalAuthorizations as string,\n\t\tTotalOutstandingTransactions as string,\n\t\tDebitCardholderBalance as string,\n\t\tAuthorizationAdviceFlag as string,\n\t\tAuthorizationLocatorCode as string,\n\t\tFDRAuthorizationFlag as string,\n\t\tMarketSpecificAuthorizationData as string,\n\t\tCashbackAmount as string,\n\t\tMailTelephoneTransaction as string,\n\t\tMCAuthorizationDate as string,\n\t\tCVCErrorCode as string,\n\t\tDurationNumber as string,\n\t\tPPICode as string,\n\t\tCashAdvanceCreditLimit as string,\n\t\tCashAdvancePercentage as string,\n\t\tFDRTraceNumber as string,\n\t\tMCVisaSETCode as string,\n\t\tSRSCode as string,\n\t\tSRRCode as string,\n\t\tAuthorizationCashAdvanceCreditLimit as string,\n\t\tAuthorizationCashAdvanceCreditLine as string,\n\t\tSpendableAmount as string,\n\t\tMerchantName as string,\n\t\tMerchantCity as string,\n\t\tMerchantState as string,\n\t\tTotalCreditLinePercentage as string,\n\t\tCRIND as string,\n\t\tCDIND as string,\n\t\tTRCODE as string,\n\t\tRiskCode as string,\n\t\tReferralMemoryCode as string,\n\t\tDiversionAccount as string,\n\t\tPOSConditionCode as string,\n\t\tECommerceTransactionCode as string,\n\t\tFamilyCode as string,\n\t\tExtendedServiceCode as string,\n\t\tReferAuthorizationCode as string,\n\t\tTemproraryCreditLineCode as string,\n\t\tCAFLCode as string,\n\t\tRecurringPaymentMerchantAdviceCode as string,\n\t\tForeignCurrency as string,\n\t\tAdditionalAmount as string,\n\t\tTraceNumber as string,\n\t\tDateProcessed as string,\n\t\tIRCCDE as string,\n\t\tVRSNCDE as string,\n\t\tCREDUN as string,\n\t\tNonreceiptStrategyType as string,\n\t\tAuthTime12 as string,\n\t\tDAT_PRTL_AUTH_PRCS_CD as string,\n\t\tDAT_TRAN_CTGR_IN as string,\n\t\tDAT_TIME_PRTH_LIMIT_ID as string,\n\t\tDAT_PYMT_TRAN_TYPE_IN as string,\n\t\tCNTL_ID as string,\n\t\tDAT_WLLT_ID as string,\n\t\tNETWORK_ID as string,\n\t\tAMT_TRAN_FEE as string,\n\t\tFIN_ATH as string,\n\t\tDEV_TYPE as string,\n\t\tTR_TAG as string,\n\t\tAvailableCredit as string,\n\t\tPI_TYPE_CODE as string,\n\t\tTRIT_CODE as string,\n\t\tTAF_CODE as string,\n\t\tSQI_CODE as string,\n\t\tSERV_NO as string,\n\t\tPROMO_CODE as string,\n\t\tPROD_CODE as string,\n\t\tAUTHEN_CODE as string,\n\t\tMRP as string,\n\t\tTKREQID as string,\n\t\tACSAuthorizationStrategy as string,\n\t\tPosTransCode as string,\n\t\tTMGReportDate as string,\n\t\tATHTYP as string,\n\t\tWLLTID as string,\n\t\tCVM1 as string,\n\t\tCVM2 as string,\n\t\tStiprcCode as string,\n\t\tPosenvCode as string,\n\t\tPoiCode as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> CD031Source\nsource(output(\n\t\tTransactionCriteriaID as string,\n\t\tFD_Source_System_Key as string,\n\t\tTransactionName as string,\n\t\tBINType as string,\n\t\tTransactionCode as string,\n\t\tResponseCodeOperator as string,\n\t\tResponseCode as string,\n\t\tMerchantTypeOperator as string,\n\t\tMerchantType as string,\n\t\tPOSEntryCode as string,\n\t\tNetworkID as string,\n\t\tReferenceNumberOperator as string,\n\t\tReferenceNumber as string,\n\t\tAuthorizationResponseOperator as string,\n\t\tAuthorizationResponse as string,\n\t\tAuthorizationType as string,\n\t\tReasonCodeOperator as string,\n\t\tReasonCode as string,\n\t\tCreateDate as string,\n\t\tAuthorizationTypeOperator as string,\n\t\tAcctNumMerchNumMatchInd as string,\n\t\tOperatorCodeOperator as string,\n\t\tOperatorCode as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> FDCriteria\nsource(output(\n\t\tSPAIdentifier as string,\n\t\tsys as string,\n\t\tprin as string,\n\t\tagent as string,\n\t\tcu_odindx as string,\n\t\tcardtyp as string,\n\t\tInterestRate as string,\n\t\tAnnualFee as string,\n\t\tOverlimitFee as string,\n\t\tLateFee as string,\n\t\tCwbFee as string,\n\t\tAutoDQFee as string,\n\t\tGroupNo as string,\n\t\tGroupDesc as string,\n\t\tItemizedPerAcct as string,\n\t\tPrimaryBillingSys as string,\n\t\tPlatform as string,\n\t\tSPA as string,\n\t\tDateProcessed as string,\n\t\tStatus as string,\n\t\tUniversalAddressing as string,\n\t\tSeparateEntityFlag as string,\n\t\tInternationalDateFormat as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> CCUMSTR\nTrimDefault derive(AcquirerAccountNumber = 'UNK',\n\t\tAcquirerNetworkCode = case(NETWORK_ID!='',NETWORK_ID,'UNK'),\n\t\tBinISO = left(CardholderAccountNumber,6),\n\t\tBinEXT = CardholderAccountNumber,\n\t\tCardEntryMethodCode = POSEntryCode,\n\t\tSource = 'FD',\n\t\tInterchangeAmount = toFloat(0.00),\n\t\tIssuerAccountNumber = 'UNK',\n\t\tIssuerNetworkCode = 'UNK',\n\t\tMerchantName = MerchantName,\n\t\tMerchantType_trans = SICCode,\n\t\tMonetary = 0,\n\t\tOnUsDescription = 'UNK',\n\t\tOriginalDataTransmissionDate = toDate(defaultdate, 'yyyy-MM-dd'),\n\t\tOriginDate = iif(left(ReportDate,2)=='01' && left(TransactionDate,2)=='12',\r\n     toDate(concat(TransactionDate,'/',toString(toInteger(right(ReportDate,2))-1)),'MM/dd/yy'),\r\n     toDate(concat(TransactionDate,'/',right(ReportDate,2)),'MM/dd/yy')),\n\t\tRecurringDescription = case( left(CardholderAccountNumber,1) =='4'&& MailTelephoneTransaction == '2' , case((left(CardholderAccountNumber,1) =='2'||left(CardholderAccountNumber,1) =='5')&& MailTelephoneTransaction == '4','Recurring'), 'Not Recurring'),\n\t\tResponseCode_trans = coalesce(TCCODE,''),\n\t\tSettlementAmount = toFloat(AuthorizationAmount),\n\t\tSurchargeAmount = toFloat(AMT_TRAN_FEE),\n\t\tTerminalAddress = case((MerchantState=='AA'||MerchantState=='AE'||MerchantState=='AK'||MerchantState=='AL'||MerchantState=='AP'||MerchantState=='AR'||MerchantState=='AS'||MerchantState=='AZ'||MerchantState=='CA'||MerchantState=='CO'||MerchantState=='CT'||MerchantState=='DC'||MerchantState=='DE'||MerchantState=='FL'||MerchantState=='FM'||MerchantState=='GA'||MerchantState=='GU'||MerchantState=='HI'||MerchantState=='IA'||MerchantState=='ID'||MerchantState=='IL'||MerchantState=='IN'||MerchantState=='KS'||MerchantState=='KY'||MerchantState=='LA'||MerchantState=='MA'||MerchantState=='MD'||MerchantState=='ME'||MerchantState=='MH'||MerchantState=='MI'||MerchantState=='MN'||MerchantState=='MO'||MerchantState=='MP'||MerchantState=='MS'||MerchantState=='MT'||MerchantState=='NC'||MerchantState=='ND'||MerchantState=='NE'||MerchantState=='NH'||MerchantState=='NJ'||MerchantState=='NM'||MerchantState=='NV'||MerchantState=='NY'||MerchantState=='OH'||MerchantState=='OK'||MerchantState=='OR'||MerchantState=='PA'||MerchantState=='PR'||MerchantState=='PW'||MerchantState=='RI'||MerchantState=='SC'||MerchantState=='SD'||MerchantState=='TN'||MerchantState=='TX'||MerchantState=='UT'||MerchantState=='VI'||MerchantState=='VT'||MerchantState=='WA'||MerchantState=='WI'||MerchantState=='WV'||MerchantState=='WY')&&SICCode == '6011',MerchantName,''),\n\t\tTerminalCity = MerchantCity,\n\t\tTerminalCountry = case(MerchantState=='AA'||MerchantState=='AE'||MerchantState=='AK'||MerchantState=='AL'||MerchantState=='AP'||MerchantState=='AR'||MerchantState=='AS'||MerchantState=='AZ'||MerchantState=='CA'||MerchantState=='CO'||MerchantState=='CT'||MerchantState=='DC'||MerchantState=='DE'||MerchantState=='FL'||MerchantState=='FM'||MerchantState=='GA'||MerchantState=='GU'||MerchantState=='HI'||MerchantState=='IA'||MerchantState=='ID'||MerchantState=='IL'||MerchantState=='IN'||MerchantState=='KS'||MerchantState=='KY'||MerchantState=='LA'||MerchantState=='MA'||MerchantState=='MD'||MerchantState=='ME'||MerchantState=='MH'||MerchantState=='MI'||MerchantState=='MN'||MerchantState=='MO'||MerchantState=='MP'||MerchantState=='MS'||MerchantState=='MT'||MerchantState=='NC'||MerchantState=='ND'||MerchantState=='NE'||MerchantState=='NH'||MerchantState=='NJ'||MerchantState=='NM'||MerchantState=='NV'||MerchantState=='NY'||MerchantState=='OH'||MerchantState=='OK'||MerchantState=='OR'||MerchantState=='PA'||MerchantState=='PR'||MerchantState=='PW'||MerchantState=='RI'||MerchantState=='SC'||MerchantState=='SD'||MerchantState=='TN'||MerchantState=='TX'||MerchantState=='UT'||MerchantState=='VI'||MerchantState=='VT'||MerchantState=='WA'||MerchantState=='WI'||MerchantState=='WV'||MerchantState=='WY'||MerchantState=='','USA',MerchantState),\n\t\tTerminalKey = 'UNK',\n\t\tTerminalState = MerchantState,\n\t\tTerminalZipCode = ZipCode,\n\t\tTokenRequestId = iif(length(TKREQID)==11,TKREQID,toString(null())),\n\t\tTransactionName_deprecated = case(left(POSEntryCode,2) == '90','SIGNATURE',case(left(POSEntryCode,2) == '01','PINless',case(left(POSEntryCode,2) == '02','PIN',case(left(POSEntryCode,2) == '81', 'Internet','Others')))),\n\t\tTransactionTypeCode = '251',\n\t\tpresencedesc = case(left(POSEntryCode,2) =='01'&&(MailTelephoneTransaction!=''&&MailTelephoneTransaction!='0')||\r\nleft(POSEntryCode,2) =='00'&&(MailTelephoneTransaction!=''&&MailTelephoneTransaction!='0')||\r\nleft(POSEntryCode,2) =='T'||\r\nleft(POSEntryCode,2) =='10'||\r\nleft(POSEntryCode,2) =='81'||\r\nleft(POSEntryCode,2) ==' '\r\n,'Card Not Present','Card Present'),\n\t\tTransmissionDate = toDate(defaultdate,'yyyy-MM-dd'),\n\t\tTransmissionTime = 'UNK',\n\t\tTimeLocalTransaction = 'UNK',\n\t\tRetrievalReferenceNumber = 'UNK',\n\t\tSettlementDate = toDate(ReportDate,'MM/dd/yy'),\n\t\tAgentNo = AGT,\n\t\tSystemNo = SYS,\n\t\tOperCode = 'UNK',\n\t\tPrincipalNo = PRN,\n\t\tAuthorizationNo = 'UNK',\n\t\tClientNo = 'UNK',\n\t\ttransaction_amount = toFloat(0.00),\n\t\tis_authorization = 1,\n\t\tSettlementRTN = 'UNK',\n\t\tAcquiringRTN = 'UNK',\n\t\tForwardingRTN = 'UNK',\n\t\tTraceNumber = FDRTraceNumber,\n\t\tAcqTraceNumber = 'UNK',\n\t\tVisaTransactionID = MCVisaSETCode,\n\t\tMasterCardTransactionID = 'UNK',\n\t\tReasonCode_trans = coalesce(ReasonCode,'NaN'),\n\t\tAuthorizationResponse_trans = coalesce(AuthorizationResponse,'NaN'),\n\t\tISOMessageType = 'UNK',\n\t\tResponseCodeID = concat(TCCODE,AuthorizationResponse)) ~> BaseTransformations\nFilterHeader derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null())))),\n\t\tImportFileDate = toDate(concat(substring($fileName,7,4),'-',substring($fileName,11,2),'-',substring($fileName,13,2)),'yyyy-MM-dd'),\n\t\tdefaultdate = '1900-01-01') ~> TrimDefault\nJoinTxnName derive(Transaction_Key = crc32(iif(isNull(CardholderAccountNumber),'',CardholderAccountNumber)\r\n, iif(isNull(OriginDate),'',toString(OriginDate))\r\n, iif(isNull(TimeLocalTransaction),'',TimeLocalTransaction)\r\n, iif(isNull(TransmissionDate),'',toString(TransmissionDate))\r\n, iif(isNull(TransmissionTime),'',TransmissionTime)\r\n, iif(isNull(SettlementAmount),0.00,SettlementAmount)\r\n, iif(isNull(TransactionTypeCode),'',TransactionTypeCode)\r\n, iif(isNull(RetrievalReferenceNumber),'',RetrievalReferenceNumber)\r\n, 2),\n\t\tTransactionName_final = iif(isNull(TransactionName),'Unknown', TransactionName)) ~> HashKey\nCD031Source filter(CD031ID!='Prop_0') ~> FilterHeader\nBaseTransformations, TrimCCUMSTR join(TrimDefault@SYS == TrimCCUMSTR@sys\n\t&& PRN == prin\n\t&& AGT == agent,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinCCUMSTR\nJoinCCUMSTR, SelectCriteria join(Platform == BINType\n\t&& TransactionTypeCode == TransactionCode,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinCriteria\nJoinCriteria filter(FD_Source_System_Key=='4'\r\n&&\r\n(isNull(ResponseCode)||ResponseCode=='NULL'\r\n||(ResponseCodeOperator=='='&&ResponseCode_trans==ResponseCode)\r\n||(ResponseCodeOperator=='<>'&&ResponseCode_trans!=ResponseCode)\r\n||(ResponseCodeOperator=='IN'&&iifNull(locate(ResponseCode_trans,ResponseCode),0)!=0)\r\n||(ResponseCodeOperator=='NOT IN'&&iifNull(locate(ResponseCode_trans,ResponseCode),0)==0))\r\n&&\r\n(MerchantType=='NULL'||isNull(MerchantType)\r\n||(MerchantTypeOperator=='='&&MerchantType_trans==MerchantType)\r\n||(MerchantTypeOperator=='<>'&&MerchantType_trans!=MerchantType)\r\n||(MerchantTypeOperator=='IN'&&iifNull(locate(MerchantType_trans,MerchantType),0)!=0)\r\n||(MerchantTypeOperator=='NOT IN'&&iifNull(locate(MerchantType_trans,MerchantType),0)==0))\r\n&&\r\n(AuthorizationResponse_criteria=='NULL'||isNull(AuthorizationResponse_criteria)\r\n||(AuthorizationResponseOperator=='='&&AuthorizationResponse_trans==AuthorizationResponse_criteria)\r\n||(AuthorizationResponseOperator=='<>'&&AuthorizationResponse_trans!=AuthorizationResponse_criteria)\r\n||(AuthorizationResponseOperator=='IN'&&iifNull(locate(AuthorizationResponse_trans,AuthorizationResponse_criteria),0)!=0)\r\n||(AuthorizationResponseOperator=='NOT IN'&&iifNull(locate(AuthorizationResponse_trans,AuthorizationResponse_criteria),0)==0))\r\n&&\r\n(ReasonCode_criteria=='NULL'||isNull(ReasonCode_criteria)\r\n||(ReasonCodeOperator=='='&&ReasonCode_trans==ReasonCode_criteria)\r\n||(ReasonCodeOperator=='<>'&&ReasonCode_trans!=ReasonCode_criteria)\r\n||(ReasonCodeOperator=='IN'&&iifNull(locate(ReasonCode_trans,ReasonCode_criteria),0)!=0)\r\n||(ReasonCodeOperator=='NOT IN'&&iifNull(locate(ReasonCode_trans,ReasonCode_criteria),0)==0))) ~> Filter\nTrimCriteria select(mapColumn(\n\t\tTransactionCriteriaID,\n\t\tFD_Source_System_Key,\n\t\tTransactionName,\n\t\tBINType,\n\t\tTransactionCode,\n\t\tResponseCodeOperator,\n\t\tResponseCode,\n\t\tMerchantTypeOperator,\n\t\tMerchantType,\n\t\tPOSEntryCode,\n\t\tNetworkID,\n\t\tReferenceNumberOperator,\n\t\tReferenceNumber,\n\t\tAuthorizationResponseOperator,\n\t\tAuthorizationResponse_criteria = AuthorizationResponse,\n\t\tAuthorizationType,\n\t\tReasonCodeOperator,\n\t\tReasonCode_criteria = ReasonCode,\n\t\tCreateDate,\n\t\tAuthorizationTypeOperator,\n\t\tAcctNumMerchNumMatchInd\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectCriteria\nFilter aggregate(groupBy(CD031ID),\n\tTransactionName = min(TransactionName)) ~> Dedupe\nJoinCCUMSTR, Dedupe join(TrimDefault@CD031ID == Dedupe@CD031ID,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinTxnName\nFDCriteria derive(each(match(type=='string'), $$ = trim($$))) ~> TrimCriteria\nCCUMSTR derive(each(match(type=='string'), $$ = trim($$))) ~> TrimCCUMSTR\nHashKey sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tAccountNumber as string,\n\t\tAcquirerAccountNumber as string,\n\t\tAcquirerNetworkCode as string,\n\t\tBin_ISO as string,\n\t\tBin_EXT as string,\n\t\tCardEntryMethodCode as string,\n\t\tCardPresenceDescription as string,\n\t\tImportFileDate as date,\n\t\tSource as string,\n\t\tInterchangeAmount as float,\n\t\tIssuerAccountNumber as string,\n\t\tIssuerNetworkCode as string,\n\t\tMerchantName as string,\n\t\tMerchantType as string,\n\t\tMonetary as integer,\n\t\tOnUsDescription as string,\n\t\tOriginalDataTransmissionDate as date,\n\t\tOriginDate as date,\n\t\tRecurringDescription as string,\n\t\tResponseCode as string,\n\t\tSettlementAmount as float,\n\t\tSettlementDate as date,\n\t\tSurchargeAmount as float,\n\t\tTerminalAddress as string,\n\t\tTerminalCity as string,\n\t\tTerminalCountry as string,\n\t\tTerminalKey as string,\n\t\tTerminalState as string,\n\t\tTerminalZipCode as string,\n\t\tTokenRequestId as string,\n\t\tTransactionName as string,\n\t\tTransactionTypeCode as string,\n\t\tTransmissionDate as date,\n\t\tTransmissionTime as string,\n\t\tTimeLocalTransaction as string,\n\t\tRetrievalReferenceNumber as string,\n\t\tTransaction_Key as long,\n\t\tAgentNo as string,\n\t\tSystemNo as string,\n\t\tOperCode as string,\n\t\tPrincipalNo as string,\n\t\tAuthorizationNo as string,\n\t\tClientNo as string,\n\t\ttransaction_amount as float,\n\t\tis_authorization as integer,\n\t\tAcquiringRTN as string,\n\t\tSettlementRTN as string,\n\t\tTraceNumber as string,\n\t\tAcqTraceNumber as string,\n\t\tVisaTransactionID as string,\n\t\tMasterCardTransactionID as string,\n\t\tMerchantAccountNumber as string,\n\t\tISOMessageType as string,\n\t\tForwardingRTN as string\n\t),\n\tformat: 'parquet',\n\tpartitionFileNames:[($fileName)],\n\tumask: 0022,\n\tpreCommands: [],\n\tpostCommands: [],\n\tmapColumn(\n\t\tAccountNumber = CardholderAccountNumber,\n\t\tAcquirerAccountNumber,\n\t\tAcquirerNetworkCode,\n\t\tBin_ISO = BinISO,\n\t\tBin_EXT = BinEXT,\n\t\tCardEntryMethodCode = POSEntryCode,\n\t\tCardPresenceDescription = presencedesc,\n\t\tSource,\n\t\tImportFileDate,\n\t\tInterchangeAmount,\n\t\tIssuerAccountNumber,\n\t\tIssuerNetworkCode,\n\t\tMerchantName,\n\t\tMerchantType = MerchantType_trans,\n\t\tMonetary,\n\t\tOnUsDescription,\n\t\tOriginalDataTransmissionDate,\n\t\tOriginDate,\n\t\tRecurringDescription,\n\t\tResponseCode = ResponseCodeID,\n\t\tSettlementAmount,\n\t\tSettlementDate,\n\t\tSurchargeAmount,\n\t\tTerminalAddress,\n\t\tTerminalCity,\n\t\tTerminalCountry,\n\t\tTerminalKey,\n\t\tTerminalState,\n\t\tTerminalZipCode,\n\t\tTokenRequestId,\n\t\tTransactionName = TransactionName_final,\n\t\tTransactionTypeCode,\n\t\tTransmissionDate,\n\t\tTransmissionTime,\n\t\tTimeLocalTransaction,\n\t\tRetrievalReferenceNumber,\n\t\tTransaction_Key,\n\t\tAgentNo,\n\t\tSystemNo,\n\t\tOperCode,\n\t\tPrincipalNo,\n\t\tAuthorizationNo,\n\t\tClientNo,\n\t\ttransaction_amount,\n\t\tis_authorization,\n\t\tAcquiringRTN,\n\t\tSettlementRTN,\n\t\tTraceNumber,\n\t\tAcqTraceNumber,\n\t\tVisaTransactionID,\n\t\tMasterCardTransactionID,\n\t\tMerchantAccountNumber,\n\t\tISOMessageType,\n\t\tForwardingRTN\n\t),\n\tpartitionBy('hash', 1)) ~> ConformedTransactions"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/CD031_WIP')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "Temporary Loads"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "dropZoneTransactions_CD031",
                                "type": "DatasetReference"
                            },
                            "name": "CD031Source"
                        },
                        {
                            "dataset": {
                                "referenceName": "FDTransactionCriteria",
                                "type": "DatasetReference"
                            },
                            "name": "FDTransactionCriteria"
                        },
                        {
                            "dataset": {
                                "referenceName": "CCUMSTR",
                                "type": "DatasetReference"
                            },
                            "name": "CCUMSTR"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "snk_cnfmFISTransactions",
                                "type": "DatasetReference"
                            },
                            "name": "sink1"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "CalculatedColumns"
                        },
                        {
                            "name": "TrimDefault"
                        },
                        {
                            "name": "Join1"
                        },
                        {
                            "name": "SPAFilter"
                        },
                        {
                            "name": "Join2"
                        },
                        {
                            "name": "Filters"
                        },
                        {
                            "name": "DerivedColumn1"
                        },
                        {
                            "name": "Select1"
                        },
                        {
                            "name": "Filter1"
                        }
                    ],
                    "script": "source(output(\n\t\tCD031ID as string,\n\t\tRoutingTransit as string,\n\t\tSYS as string,\n\t\tPRN as string,\n\t\tAGT as string,\n\t\tReportDate as string,\n\t\tCardholderAccountNumber as string,\n\t\tBinNumber as string,\n\t\tMerchantAccountNumber as string,\n\t\tAuthorizationAmount as string,\n\t\tAuthorizationCode as string,\n\t\tKSCode as string,\n\t\tTransactionTime as string,\n\t\tAuthorizationResponse as string,\n\t\tActionCode as string,\n\t\tAuthorizationLine as string,\n\t\tElectronicAuthorizationSource as string,\n\t\tInternalStatusCode as string,\n\t\tExternalStatusCode as string,\n\t\tAccountCrossReference as string,\n\t\tExpirationDate as string,\n\t\tSICCode as string,\n\t\tZipCode as string,\n\t\tCreditLimit as string,\n\t\tPCPIND as string,\n\t\tPCCIND as string,\n\t\tCFCIND as string,\n\t\tCFFIND as string,\n\t\tTERMCD as string,\n\t\tTPCODE as string,\n\t\tOPCODE as string,\n\t\tTCCODE as string,\n\t\tWBCODE as string,\n\t\tTransactionDate as string,\n\t\tReasonCode as string,\n\t\tAuthorizationFileCode as string,\n\t\tMerchantTerminalLocation as string,\n\t\tPOSDeviceModel as string,\n\t\tPOSEntryCode as string,\n\t\tAccountTypeCode as string,\n\t\tPOSEntryCodeCapability as string,\n\t\tCardholderZipCode as string,\n\t\tCardholderAddress as string,\n\t\tPACMCode as string,\n\t\tAuthorizationMethod as string,\n\t\tBehaviorScoringCode as string,\n\t\tCreditBureauScore as string,\n\t\tACSAuthorizationLineNumber as string,\n\t\tDataCode as string,\n\t\tTranslatedMerchant as string,\n\t\tAuthorizationCharacteristicsCode as string,\n\t\tTransactionIdentifier as string,\n\t\tTransactionIdentifierValidator as string,\n\t\tFraudulentRiskCode as string,\n\t\tCounterfeitCode as string,\n\t\tPaymentKitingStrategyCode as string,\n\t\tLostStolenStrategyCode as string,\n\t\tFalconStrategyCode as string,\n\t\tQueuedAuthorizationCode as string,\n\t\tBehaviorScoreVariance as string,\n\t\tTotalAuthorizations as string,\n\t\tTotalOutstandingTransactions as string,\n\t\tDebitCardholderBalance as string,\n\t\tAuthorizationAdviceFlag as string,\n\t\tAuthorizationLocatorCode as string,\n\t\tFDRAuthorizationFlag as string,\n\t\tMarketSpecificAuthorizationData as string,\n\t\tCashbackAmount as string,\n\t\tMailTelephoneTransaction as string,\n\t\tMCAuthorizationDate as string,\n\t\tCVCErrorCode as string,\n\t\tDurationNumber as string,\n\t\tPPICode as string,\n\t\tCashAdvanceCreditLimit as string,\n\t\tCashAdvancePercentage as string,\n\t\tFDRTraceNumber as string,\n\t\tMCVisaSETCode as string,\n\t\tSRSCode as string,\n\t\tSRRCode as string,\n\t\tAuthorizationCashAdvanceCreditLimit as string,\n\t\tAuthorizationCashAdvanceCreditLine as string,\n\t\tSpendableAmount as string,\n\t\tMerchantName as string,\n\t\tMerchantCity as string,\n\t\tMerchantState as string,\n\t\tTotalCreditLinePercentage as string,\n\t\tCRIND as string,\n\t\tCDIND as string,\n\t\tTRCODE as string,\n\t\tRiskCode as string,\n\t\tReferralMemoryCode as string,\n\t\tDiversionAccount as string,\n\t\tPOSConditionCode as string,\n\t\tECommerceTransactionCode as string,\n\t\tFamilyCode as string,\n\t\tExtendedServiceCode as string,\n\t\tReferAuthorizationCode as string,\n\t\tTemproraryCreditLineCode as string,\n\t\tCAFLCode as string,\n\t\tRecurringPaymentMerchantAdviceCode as string,\n\t\tForeignCurrency as string,\n\t\tAdditionalAmount as string,\n\t\tTraceNumber as string,\n\t\tDateProcessed as string,\n\t\tIRCCDE as string,\n\t\tVRSNCDE as string,\n\t\tCREDUN as string,\n\t\tNonreceiptStrategyType as string,\n\t\tAuthTime12 as string,\n\t\tDAT_PRTL_AUTH_PRCS_CD as string,\n\t\tDAT_TRAN_CTGR_IN as string,\n\t\tDAT_TIME_PRTH_LIMIT_ID as string,\n\t\tDAT_PYMT_TRAN_TYPE_IN as string,\n\t\tCNTL_ID as string,\n\t\tDAT_WLLT_ID as string,\n\t\tNETWORK_ID as string,\n\t\tAMT_TRAN_FEE as string,\n\t\tFIN_ATH as string,\n\t\tDEV_TYPE as string,\n\t\tTR_TAG as string,\n\t\tAvailableCredit as string,\n\t\tPI_TYPE_CODE as string,\n\t\tTRIT_CODE as string,\n\t\tTAF_CODE as string,\n\t\tSQI_CODE as string,\n\t\tSERV_NO as string,\n\t\tPROMO_CODE as string,\n\t\tPROD_CODE as string,\n\t\tAUTHEN_CODE as string,\n\t\tMRP as string,\n\t\tTKREQID as string,\n\t\tACSAuthorizationStrategy as string,\n\t\tPosTransCode as string,\n\t\tTMGReportDate as string,\n\t\tATHTYP as string,\n\t\tWLLTID as string,\n\t\tCVM1 as string,\n\t\tCVM2 as string,\n\t\tStiprcCode as string,\n\t\tPosenvCode as string,\n\t\tPoiCode as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> CD031Source\nsource(output(\n\t\tTransactionCriteriaID as string,\n\t\tFD_Source_System_Key as string,\n\t\tTransactionName as string,\n\t\tBINType as string,\n\t\tTransactionCode as string,\n\t\tResponseCodeOperator as string,\n\t\tResponseCode as string,\n\t\tMerchantTypeOperator as string,\n\t\tMerchantType as string,\n\t\tPOSEntryCode as string,\n\t\tNetworkID as string,\n\t\tReferenceNumberOperator as string,\n\t\tReferenceNumber as string,\n\t\tAuthorizationResponseOperator as string,\n\t\tAuthorizationResponse as string,\n\t\tAuthorizationType as string,\n\t\tReasonCodeOperator as string,\n\t\tReasonCode as string,\n\t\tCreateDate as string,\n\t\tAuthorizationTypeOperator as string,\n\t\tAcctNumMerchNumMatchInd as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> FDTransactionCriteria\nsource(output(\n\t\tsys as string,\n\t\tprin as string,\n\t\tagent as string,\n\t\tPlatform as string,\n\t\tcu_odindx as string,\n\t\tCardCategory as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> CCUMSTR\nTrimDefault derive(AcquirerAccountNumber = 'UNK',\n\t\tAcquirerNetworkCode = case(NETWORK_ID!='',NETWORK_ID,'UNK'),\n\t\tBinISO = substring(BinNumber,1,6),\n\t\tBinEXT = BinNumber,\n\t\tCardEntryMethodCode = POSEntryCode,\n\t\tImportFileDate = toDate(TMGReportDate,'yyyy-MM-dd'),\n\t\tSource = 'FD',\n\t\tInterchangeAmount = toFloat(0.00),\n\t\tIssuerAccountNumber = 'UNK',\n\t\tIssuerNetworkCode = 'UNK',\n\t\tMerchantName = MerchantName,\n\t\tMerchantTypeCD031 = SICCode,\n\t\tMonetary = 0,\n\t\tOnUsDescription = 'UNK',\n\t\tOriginalDataTransmissionDate = toDate(defaultdate, 'yyyy-MM-dd'),\n\t\tOriginDate = toDate(defaultdate,'yyyy-MM-dd'),\n\t\tRecurringDescription = case( left(CardholderAccountNumber,1) =='4'&& MailTelephoneTransaction == '2' , case((left(CardholderAccountNumber,1) =='2'||left(CardholderAccountNumber,1) =='5')&& MailTelephoneTransaction == '2','YES'), 'No'),\n\t\tResponseCodeCD031 = TCCODE,\n\t\tSettlementAmount = toFloat(AuthorizationAmount),\n\t\tSurchargeAmount = toFloat(AMT_TRAN_FEE),\n\t\tTerminalAddress = case((MerchantState=='AA'||MerchantState=='AE'||MerchantState=='AK'||MerchantState=='AL'||MerchantState=='AP'||MerchantState=='AR'||MerchantState=='AS'||MerchantState=='AZ'||MerchantState=='CA'||MerchantState=='CO'||MerchantState=='CT'||MerchantState=='DC'||MerchantState=='DE'||MerchantState=='FL'||MerchantState=='FM'||MerchantState=='GA'||MerchantState=='GU'||MerchantState=='HI'||MerchantState=='IA'||MerchantState=='ID'||MerchantState=='IL'||MerchantState=='IN'||MerchantState=='KS'||MerchantState=='KY'||MerchantState=='LA'||MerchantState=='MA'||MerchantState=='MD'||MerchantState=='ME'||MerchantState=='MH'||MerchantState=='MI'||MerchantState=='MN'||MerchantState=='MO'||MerchantState=='MP'||MerchantState=='MS'||MerchantState=='MT'||MerchantState=='NC'||MerchantState=='ND'||MerchantState=='NE'||MerchantState=='NH'||MerchantState=='NJ'||MerchantState=='NM'||MerchantState=='NV'||MerchantState=='NY'||MerchantState=='OH'||MerchantState=='OK'||MerchantState=='OR'||MerchantState=='PA'||MerchantState=='PR'||MerchantState=='PW'||MerchantState=='RI'||MerchantState=='SC'||MerchantState=='SD'||MerchantState=='TN'||MerchantState=='TX'||MerchantState=='UT'||MerchantState=='VI'||MerchantState=='VT'||MerchantState=='WA'||MerchantState=='WI'||MerchantState=='WV'||MerchantState=='WY')&&SICCode == '6011',MerchantName,''),\n\t\tTerminalCity = MerchantCity,\n\t\tTerminalCountry = case(MerchantState=='AA'||MerchantState=='AE'||MerchantState=='AK'||MerchantState=='AL'||MerchantState=='AP'||MerchantState=='AR'||MerchantState=='AS'||MerchantState=='AZ'||MerchantState=='CA'||MerchantState=='CO'||MerchantState=='CT'||MerchantState=='DC'||MerchantState=='DE'||MerchantState=='FL'||MerchantState=='FM'||MerchantState=='GA'||MerchantState=='GU'||MerchantState=='HI'||MerchantState=='IA'||MerchantState=='ID'||MerchantState=='IL'||MerchantState=='IN'||MerchantState=='KS'||MerchantState=='KY'||MerchantState=='LA'||MerchantState=='MA'||MerchantState=='MD'||MerchantState=='ME'||MerchantState=='MH'||MerchantState=='MI'||MerchantState=='MN'||MerchantState=='MO'||MerchantState=='MP'||MerchantState=='MS'||MerchantState=='MT'||MerchantState=='NC'||MerchantState=='ND'||MerchantState=='NE'||MerchantState=='NH'||MerchantState=='NJ'||MerchantState=='NM'||MerchantState=='NV'||MerchantState=='NY'||MerchantState=='OH'||MerchantState=='OK'||MerchantState=='OR'||MerchantState=='PA'||MerchantState=='PR'||MerchantState=='PW'||MerchantState=='RI'||MerchantState=='SC'||MerchantState=='SD'||MerchantState=='TN'||MerchantState=='TX'||MerchantState=='UT'||MerchantState=='VI'||MerchantState=='VT'||MerchantState=='WA'||MerchantState=='WI'||MerchantState=='WV'||MerchantState=='WY'||MerchantState=='','USA',MerchantState),\n\t\tTerminalKey = 'UNK',\n\t\tTerminalState = MerchantState,\n\t\tTerminalZipCode = ZipCode,\n\t\tTokenRequestId = TKREQID,\n\t\tTransactionName = case(left(POSEntryCode,2) == '90','SIGNATURE',case(left(POSEntryCode,2) == '01','PINless',case(left(POSEntryCode,2) == '02','PIN',case(left(POSEntryCode,2) == '81', 'Internet','Others')))),\n\t\tTransactionTypeCode = '251',\n\t\tpresencedesc = case(left(POSEntryCode,2) =='01'&&(MailTelephoneTransaction!=''&&MailTelephoneTransaction!='0')||\nleft(POSEntryCode,2) =='00'&&(MailTelephoneTransaction!=''&&MailTelephoneTransaction!='0')||\nleft(POSEntryCode,2) =='T'||\nleft(POSEntryCode,2) =='10'||\nleft(POSEntryCode,2) =='81'||\nleft(POSEntryCode,2) ==' '\n,'CNP','CP'),\n\t\tTransmissionDate = toDate(defaultdate,'yyyy-MM-dd'),\n\t\tTransmissionTime = 'UNK',\n\t\tTimeLocalTransaction = 'UNK',\n\t\tRetrievalReferenceNumber = 'UNK',\n\t\tSettlementDate = toDate(ReportDate,'MM/dd/yy'),\n\t\tReasonCodeCD031 = ReasonCode,\n\t\tAuthorizationResponseCD031 = AuthorizationResponse) ~> CalculatedColumns\nCD031Source derive(each(match(type=='string'), $$ = rtrim(ltrim($$))),\n\t\tdefaultdate = '1900-01-01') ~> TrimDefault\nCalculatedColumns, Select1 join(PRN == prin\n\t&& AGT == agent\n\t&& SYS == v2,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> Join1\nCCUMSTR filter(cu_odindx=='0008'||cu_odindx=='0014'||cu_odindx=='0035'||cu_odindx=='0037'||cu_odindx=='0040'||cu_odindx=='0062'||cu_odindx=='0064'||cu_odindx=='0065'||cu_odindx=='0067'||cu_odindx=='0072'||cu_odindx=='0090'||cu_odindx=='0104'||cu_odindx=='0142'||cu_odindx=='0172'||cu_odindx=='0213'||cu_odindx=='0216'||cu_odindx=='0231'||cu_odindx=='0238'||cu_odindx=='0247'||cu_odindx=='0258'||cu_odindx=='0261'||cu_odindx=='0265'\n||cu_odindx=='0276'||cu_odindx=='0289'||cu_odindx=='0301'||cu_odindx=='0309'||cu_odindx=='0355'||cu_odindx=='0370'||cu_odindx=='0371'||cu_odindx=='0386'||cu_odindx=='0412'||cu_odindx=='0419'||cu_odindx=='0484'||cu_odindx=='0508'||cu_odindx=='0546'||cu_odindx=='0575'||cu_odindx=='0580'||cu_odindx=='0593'||cu_odindx=='0595'||cu_odindx=='0601'||cu_odindx=='0628'||cu_odindx=='0642'||cu_odindx=='0649'||cu_odindx=='0708'||cu_odindx=='0714'||cu_odindx=='0736'||cu_odindx=='0739'||cu_odindx=='0765'||cu_odindx=='0780'\n||cu_odindx=='0858'||cu_odindx=='3364') ~> SPAFilter\nJoin1, FDTransactionCriteria join(CardCategory == BINType\n\t&& TransactionTypeCode == TransactionCode,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> Join2\nJoin2 filter(isNull(BINType)||\r\n(FD_Source_System_Key=='4'\r\n&&\r\n(isNull(ResponseCode)||ResponseCode=='NULL'||(ResponseCodeOperator=='IN'&&iifNull(locate(ResponseCodeCD031,ResponseCode),0)!=0)||(ResponseCodeOperator=='NOT IN'&&iifNull(locate(ResponseCodeCD031,ResponseCode),0)==0))\r\n&&\r\n(isNull(MerchantType)||MerchantType=='NULL'||(MerchantTypeOperator=='IN'&&iifNull(locate(MerchantTypeCD031,MerchantType),0)!=0)||(MerchantTypeOperator=='NOT IN'&&iifNull(locate(MerchantTypeCD031,MerchantType),0)==0))\r\n&&\r\n(isNull(FDTransactionCriteria@AuthorizationResponse)||FDTransactionCriteria@AuthorizationResponse=='NULL'||(AuthorizationResponseOperator=='IN'&&iifNull(locate(AuthorizationResponseCD031,FDTransactionCriteria@AuthorizationResponse),0)!=0)||(AuthorizationResponseOperator=='NOT IN'&&iifNull(locate(AuthorizationResponseCD031,FDTransactionCriteria@AuthorizationResponse),0)==0))\r\n&&\r\n(isNull(FDTransactionCriteria@ReasonCode)||FDTransactionCriteria@ReasonCode=='NULL'||\r\n(ReasonCodeOperator=='IN'&&iifNull(locate(ReasonCodeCD031,FDTransactionCriteria@ReasonCode),0)!=0)||\r\n(ReasonCodeOperator=='NOT IN'&&iifNull(locate(ReasonCodeCD031,FDTransactionCriteria@ReasonCode),0)==0)||\r\n(ReasonCodeOperator=='='&&ReasonCodeCD031==FDTransactionCriteria@ReasonCode)||\r\n(ReasonCodeOperator=='<>'&&ReasonCodeCD031!=FDTransactionCriteria@ReasonCode)))) ~> Filters\nSPAFilter derive(v2 = sys) ~> DerivedColumn1\nDerivedColumn1 select(mapColumn(\n\t\tprin,\n\t\tagent,\n\t\tPlatform,\n\t\tcu_odindx,\n\t\tCardCategory,\n\t\tv2\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select1\nSelect1 filter(v2=='1121'||v2=='1373'||v2=='1472') ~> Filter1\nFilters sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tAccountNumber as string,\n\t\tAcquirerAccountNumber as string,\n\t\tAcquirerNetworkCode as string,\n\t\tBin_ISO as string,\n\t\tBin_EXT as string,\n\t\tCardEntryMethodCode as string,\n\t\tCardPresenceDescription as string,\n\t\tImportFileDate as date,\n\t\tSource as string,\n\t\tInterchangeAmount as float,\n\t\tIssuerAccountNumber as string,\n\t\tIssuerNetworkCode as string,\n\t\tMerchantName as string,\n\t\tMerchantType as string,\n\t\tMonetary as integer,\n\t\tOnUsDescription as string,\n\t\tOriginalDataTransmissionDate as date,\n\t\tOriginDate as date,\n\t\tRecurringDescription as string,\n\t\tResponseCode as string,\n\t\tSettlementAmount as float,\n\t\tSettlementDate as date,\n\t\tSurchargeAmount as float,\n\t\tTerminalAddress as string,\n\t\tTerminalCity as string,\n\t\tTerminalCountry as string,\n\t\tTerminalKey as string,\n\t\tTerminalState as string,\n\t\tTerminalZipCode as string,\n\t\tTokenRequestId as string,\n\t\tTransactionName as string,\n\t\tTransactionTypeCode as string,\n\t\tTransmissionDate as date,\n\t\tTransmissionTime as string,\n\t\tTimeLocalTransaction as string,\n\t\tRetrievalReferenceNumber as string,\n\t\tTransaction_Key as long,\n\t\tAgentNo as string,\n\t\tSystemNo as string,\n\t\tOperCode as string,\n\t\tPrincipalNo as string,\n\t\tAuthorizationNo as string,\n\t\tClientNo as string,\n\t\ttransaction_amount as float,\n\t\tis_authorization as integer,\n\t\tAcquiringRTN as string,\n\t\tSettlementRTN as string,\n\t\tTraceNumber as string,\n\t\tAcqTraceNumber as string,\n\t\tVisaTransactionID as string,\n\t\tMasterCardTransactionID as string,\n\t\tMerchantAccountNumber as string,\n\t\tISOMessageType as string,\n\t\tForwardingRTN as string\n\t),\n\tformat: 'parquet',\n\ttruncate: true,\n\tumask: 0022,\n\tpreCommands: [],\n\tpostCommands: [],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tmapColumn(\n\t\tAccountNumber = CardholderAccountNumber,\n\t\tAcquirerAccountNumber,\n\t\tAcquirerNetworkCode,\n\t\tBin_ISO = BinISO,\n\t\tBin_EXT = BinEXT,\n\t\tCardEntryMethodCode = TrimDefault@POSEntryCode,\n\t\tCardPresenceDescription = presencedesc,\n\t\tImportFileDate,\n\t\tSource,\n\t\tInterchangeAmount,\n\t\tIssuerAccountNumber,\n\t\tIssuerNetworkCode,\n\t\tMerchantName,\n\t\tMerchantType = SICCode,\n\t\tMonetary,\n\t\tOnUsDescription,\n\t\tOriginalDataTransmissionDate,\n\t\tOriginDate,\n\t\tRecurringDescription,\n\t\tResponseCode = TCCODE,\n\t\tSettlementAmount,\n\t\tSettlementDate,\n\t\tSurchargeAmount,\n\t\tTerminalAddress,\n\t\tTerminalCity,\n\t\tTerminalCountry,\n\t\tTerminalKey,\n\t\tTerminalState,\n\t\tTerminalZipCode,\n\t\tTokenRequestId,\n\t\tTransactionName = FDTransactionCriteria@TransactionName,\n\t\tTransactionTypeCode\n\t)) ~> sink1"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/populate_DimCustomer')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "This is to populate Dim Customer to the Azure DW.",
                "folder": {
                    "name": "Dimensions"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "src_stgFISDemographics",
                                "type": "DatasetReference"
                            },
                            "name": "FISDebitDemographic"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Customer",
                                "type": "DatasetReference"
                            },
                            "name": "DWdimCustomer"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "dim_Customer",
                                "type": "DatasetReference"
                            },
                            "name": "SnkDimCustomer"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "SelectCustomerAttributes"
                        },
                        {
                            "name": "Dedupe",
                            "description": "Aggregating data by 'CustomerHashkey, Lower_CardHolderFirstName, Lower_CardHolderMiddleInitial, Lower_CardHolderLastName, Lower_GreetingName, ReportDate, source_system_key_FIS' producing columns 'CardStatus'\n\n 0 = Non Statused (card has been activated\n 1 = Statused (card has not been activated)"
                        },
                        {
                            "name": "ConvertAttributeAndApplyLogic"
                        },
                        {
                            "name": "TrimSpaces"
                        },
                        {
                            "name": "CreateHashkeys"
                        },
                        {
                            "name": "SelectCustomersAttributes"
                        },
                        {
                            "name": "UpdateAttributes"
                        },
                        {
                            "name": "SortBeforeInsert"
                        },
                        {
                            "name": "JoinDW"
                        },
                        {
                            "name": "Upsert"
                        },
                        {
                            "name": "FilterHeader"
                        }
                    ],
                    "script": "source(output(\n\t\tFISDebitDemographicID as string,\n\t\tAccountNumber as string,\n\t\tPlasticNumber as string,\n\t\tGreetingName as string,\n\t\tFinancialInstitutionRouteTransit as string,\n\t\tCardStatus as string,\n\t\tLastUsedDate as string,\n\t\tAuthorizationLimitGroup as string,\n\t\tPINOffset as string,\n\t\tTrackTwoDate as string,\n\t\tDDAAccountNumber as string,\n\t\tSavingsAccountNumber as string,\n\t\tAdditionalDDAAccountNumberOne as string,\n\t\tAdditionalDDAAccountNumberTwo as string,\n\t\tAdditionalDDAAccountNumberThree as string,\n\t\tAdditionalDDAAccountNumberFour as string,\n\t\tAdditionalDDAAccountNumberFive as string,\n\t\tAdditionalSavingsAccountNumberOne as string,\n\t\tAdditionalSavingsAccountNumberTwo as string,\n\t\tAdditionalSavingsAccountNumberThree as string,\n\t\tAdditionalSavingsAccountNumberFour as string,\n\t\tAdditionalSavingsAccountNumberFive as string,\n\t\tAdditionalCreditAccountNumberOne as string,\n\t\tAdditionalCreditAccountNumberTwo as string,\n\t\tAdditionalCreditAccountNumberThree as string,\n\t\tAdditionalCreditAccountNumberFour as string,\n\t\tAdditionalOtherAccountNumberOne as string,\n\t\tAdditionalOtherAccountNumberTwo as string,\n\t\tAdditionalOtherAccountNumberThree as string,\n\t\tAdditionalOtherAccountNumberFour as string,\n\t\tCardholderAddressLineOne as string,\n\t\tCardholderAddressLineTwo as string,\n\t\tCardholderAddressCity as string,\n\t\tCardholderAddressState as string,\n\t\tCardholderAddressZip as string,\n\t\tCardholderFirstName as string,\n\t\tCardholderLastName as string,\n\t\tCardholderMiddleInitial as string,\n\t\tCardActivationFlag as string,\n\t\tOriginalIssueDate as string,\n\t\tLastIssueDate as string,\n\t\tNationalIdentifier as string,\n\t\tMothersMaidenName as string,\n\t\tHomePhone as string,\n\t\tWorkPhone as string,\n\t\tUserValidation as string,\n\t\tVRUCounter as string,\n\t\tBirthDate as string,\n\t\tCardActivationMethod as string,\n\t\tCardActivationDate as string,\n\t\tCardActivationTime as string,\n\t\tPreviousExpirationDate as string,\n\t\tPreviousCardActivationStatus as string,\n\t\tCardStatusTwo as string,\n\t\tFISDebitImportFileName as string,\n\t\tCreateDate as string,\n\t\tBINNumber as string,\n\t\tClientNumberIssuer as string,\n\t\tHashFullRecord as string,\n\t\tLastUpdatedDate as string,\n\t\tReportDate as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> FISDebitDemographic\nsource(output(\n\t\tcustomer_key as string,\n\t\tsource_system_key as integer,\n\t\tcardholder_first_name as string,\n\t\tcardholder_middle_initial as string,\n\t\tcardholder_greeting_name as string,\n\t\tcardholder_last_name as string,\n\t\tdate_of_birth as date,\n\t\tnational_identifier as string,\n\t\tcard_status as string,\n\t\tload_date as date,\n\t\tcreate_date as timestamp,\n\t\tmodified_date as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'Select * from member.dim_customer where source_system_key = 1',\n\tformat: 'query',\n\tstaged: false,\n\tpartitionColumn: 'customer_key',\n\tpartitionBy('external', 5)) ~> DWdimCustomer\nFilterHeader select(mapColumn(\n\t\tCardholderFirstName,\n\t\tCardholderMiddleInitial,\n\t\tCardholderLastName,\n\t\tNationalIdentifier,\n\t\tGreetingName,\n\t\tCardStatus,\n\t\tBirthDate,\n\t\tReportDate\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectCustomerAttributes\nCreateHashkeys aggregate(groupBy(CustomerHashkey,\n\t\tLower_CardHolderFirstName,\n\t\tLower_CardHolderMiddleInitial,\n\t\tLower_CardHolderLastName,\n\t\tLower_GreetingName,\n\t\tsource_system_key_FIS),\n\tCardStatus = case(max(CardStatus)==1,'Statused','Non-Statused'),\n\t\tBirthDate = max(BirthDate),\n\t\tNationalIdentifier = max(NationalIdentifier),\n\t\tReportDate = max(ReportDate)) ~> Dedupe\nTrimSpaces derive(Lower_CardHolderFirstName = lower(CardholderFirstName),\n\t\tLower_CardHolderMiddleInitial = lower(CardholderMiddleInitial),\n\t\tLower_CardHolderLastName = lower(CardholderLastName),\n\t\tLower_GreetingName = lower(GreetingName),\n\t\tBirthDate = toDate(BirthDate,'yyyy-MM-dd'),\n\t\tCardStatus = toInteger(CardStatus),\n\t\tsource_system_key_FIS = 1,\n\t\tReportDate = toDate(ReportDate, 'yyyy-MM-dd')) ~> ConvertAttributeAndApplyLogic\nSelectCustomerAttributes derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null()))))) ~> TrimSpaces\nSelectCustomersAttributes derive(CustomerHashkey = md5(iif(isNull(Lower_CardHolderFirstName),'',Lower_CardHolderFirstName)\r\n, iif(isNull(Lower_CardHolderMiddleInitial),'',Lower_CardHolderMiddleInitial)\r\n, iif(isNull(Lower_CardHolderLastName),'',Lower_CardHolderLastName)\r\n, iif(isNull(Lower_GreetingName),'',Lower_GreetingName)\r\n, iif(isNull(source_system_key_FIS),0,source_system_key_FIS))) ~> CreateHashkeys\nConvertAttributeAndApplyLogic select(mapColumn(\n\t\tCardStatus,\n\t\tReportDate,\n\t\tLower_CardHolderFirstName,\n\t\tLower_CardHolderMiddleInitial,\n\t\tLower_CardHolderLastName,\n\t\tLower_GreetingName,\n\t\tBirthDate,\n\t\tNationalIdentifier,\n\t\tsource_system_key_FIS\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectCustomersAttributes\nJoinDW derive(Title_CardHolderFirstName = initCap(Lower_CardHolderFirstName),\n\t\tTitle_CardHolderMiddleInitial = initCap(Lower_CardHolderMiddleInitial),\n\t\tTitle_CardHolderLastName = initCap(Lower_CardHolderLastName),\n\t\tTitle_GreetingName = initCap(Lower_GreetingName),\n\t\tbirth_date_updated = coalesce(BirthDate,date_of_birth),\n\t\tnational_identifier_updated = coalesce(NationalIdentifier,national_identifier),\n\t\tcard_status_updated = coalesce(CardStatus,card_status),\n\t\tload_date_updated = coalesce(load_date,ReportDate),\n\t\tcreate_date_updated = coalesce(create_date,currentTimestamp()),\n\t\tmodified_date = toTimestamp(ReportDate)) ~> UpdateAttributes\nUpsert sort(asc(CustomerHashkey, true),\n\tpartitionLevel: true) ~> SortBeforeInsert\nDedupe, DWdimCustomer join(CustomerHashkey == customer_key,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinDW\nUpdateAttributes alterRow(upsertIf(true())) ~> Upsert\nFISDebitDemographic filter(FISDebitDemographicID!='FISDebitDemographicID') ~> FilterHeader\nSortBeforeInsert sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tcustomer_key as string,\n\t\tsource_system_key as integer,\n\t\tcardholder_first_name as string,\n\t\tcardholder_middle_initial as string,\n\t\tcardholder_greeting_name as string,\n\t\tcardholder_last_name as string,\n\t\tdate_of_birth as date,\n\t\tnational_identifier as string,\n\t\tcard_status as string,\n\t\tload_date as date,\n\t\tcreate_date as timestamp,\n\t\tmodified_date as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:false,\n\tupsertable:true,\n\tkeys:['customer_key'],\n\tformat: 'table',\n\tstaged: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tcustomer_key = CustomerHashkey,\n\t\tsource_system_key = source_system_key_FIS,\n\t\tcardholder_first_name = Title_CardHolderFirstName,\n\t\tcardholder_middle_initial = Title_CardHolderMiddleInitial,\n\t\tcardholder_greeting_name = Title_GreetingName,\n\t\tcardholder_last_name = Title_CardHolderLastName,\n\t\tdate_of_birth = birth_date_updated,\n\t\tnational_identifier = national_identifier_updated,\n\t\tcard_status = card_status_updated,\n\t\tload_date = load_date_updated,\n\t\tcreate_date = create_date_updated,\n\t\tmodified_date\n\t)) ~> SnkDimCustomer"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/populate_DimResponseCode')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "Dimensions"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "src_cnfmFISTransactions",
                                "type": "DatasetReference"
                            },
                            "name": "ConformedTransactions"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Source_System",
                                "type": "DatasetReference"
                            },
                            "name": "SourceSystem"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Response_Code",
                                "type": "DatasetReference"
                            },
                            "name": "srcdimResponseCode"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "dim_Response_Code",
                                "type": "DatasetReference"
                            },
                            "name": "dimResponseCode"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "SourceSystemKeyTransform"
                        },
                        {
                            "name": "ResponseCode"
                        },
                        {
                            "name": "DedupeResponseCode"
                        },
                        {
                            "name": "notExistsResponseCode"
                        },
                        {
                            "name": "removeNullResponseCode"
                        },
                        {
                            "name": "CreateResponseCodeHashkey"
                        },
                        {
                            "name": "TrimSpaces"
                        },
                        {
                            "name": "DescAndCreateDate"
                        }
                    ],
                    "script": "parameters{\n\tfileName as string\n}\nsource(output(\n\t\tAccountNumber as string,\n\t\tAcquirerAccountNumber as string,\n\t\tAcquirerNetworkCode as string,\n\t\tBin_ISO as string,\n\t\tBin_EXT as string,\n\t\tCardEntryMethodCode as string,\n\t\tCardPresenceDescription as string,\n\t\tImportFileDate as date,\n\t\tSource as string,\n\t\tInterchangeAmount as float,\n\t\tIssuerAccountNumber as string,\n\t\tIssuerNetworkCode as string,\n\t\tMerchantName as string,\n\t\tMerchantType as string,\n\t\tMonetary as integer,\n\t\tOnUsDescription as string,\n\t\tOriginalDataTransmissionDate as date,\n\t\tOriginDate as date,\n\t\tRecurringDescription as string,\n\t\tResponseCode as string,\n\t\tSettlementAmount as float,\n\t\tSettlementDate as date,\n\t\tSurchargeAmount as float,\n\t\tTerminalAddress as string,\n\t\tTerminalCity as string,\n\t\tTerminalCountry as string,\n\t\tTerminalKey as string,\n\t\tTerminalState as string,\n\t\tTerminalZipCode as string,\n\t\tTokenRequestId as string,\n\t\tTransactionName as string,\n\t\tTransactionTypeCode as string,\n\t\tTransmissionDate as date,\n\t\tTransmissionTime as string,\n\t\tTimeLocalTransaction as string,\n\t\tRetrievalReferenceNumber as string,\n\t\tTransaction_Key as long,\n\t\tAgentNo as string,\n\t\tSystemNo as string,\n\t\tOperCode as string,\n\t\tPrincipalNo as string,\n\t\tAuthorizationNo as string,\n\t\tClientNo as string,\n\t\ttransaction_amount as float,\n\t\tis_authorization as integer,\n\t\tAcquiringRTN as string,\n\t\tSettlementRTN as string,\n\t\tTraceNumber as string,\n\t\tAcqTraceNumber as string,\n\t\tVisaTransactionID as string,\n\t\tMasterCardTransactionID as string,\n\t\tMerchantAccountNumber as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tformat: 'parquet') ~> ConformedTransactions\nsource(output(\n\t\tsource_system_key as integer,\n\t\tsource_system_name as string,\n\t\tsource_system_description as string,\n\t\tsource_system_abbreviation as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false) ~> SourceSystem\nsource(output(\n\t\tresponse_code_key as long,\n\t\tsource_system_key as integer,\n\t\tresponse_code_id as string,\n\t\tresponse_desc as string,\n\t\tresponse_outcome_group as string,\n\t\tresponse_detail as string,\n\t\tload_date as date,\n\t\tcreate_date as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false,\n\tpartitionColumn: 'response_code_key',\n\tpartitionBy('external', 2)) ~> srcdimResponseCode\nTrimSpaces, SourceSystem lookup(Source == source_system_abbreviation,\n\tmultiple: true,\n\tbroadcast: 'right')~> SourceSystemKeyTransform\nCreateResponseCodeHashkey select(mapColumn(\n\t\tImportFileDate,\n\t\tsource_system_key,\n\t\tResponseCode,\n\t\tResponseCodeHashkey\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> ResponseCode\nResponseCode aggregate(groupBy(ResponseCode,\n\t\tResponseCodeHashkey,\n\t\tsource_system_key),\n\tImportFileDate = min(iifNull(ImportFileDate,currentDate()))) ~> DedupeResponseCode\nDedupeResponseCode, srcdimResponseCode exists(ResponseCodeHashkey == response_code_key,\n\tnegate:true,\n\tbroadcast: 'auto')~> notExistsResponseCode\nDescAndCreateDate filter(!isNull(ResponseCode)) ~> removeNullResponseCode\nSourceSystemKeyTransform derive(ResponseCodeHashkey = crc32(iif(isNull(ResponseCode),'',ResponseCode)\r\n, iif(isNull(source_system_key),0,source_system_key))) ~> CreateResponseCodeHashkey\nConformedTransactions derive(each(match(type=='string'), $$ = trim($$))) ~> TrimSpaces\nnotExistsResponseCode derive(create_date = currentTimestamp(),\n\t\tresponse_desc = iif(source_system_key==2,substring(ResponseCode,3),toString(null()))) ~> DescAndCreateDate\nremoveNullResponseCode sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tresponse_code_key as long,\n\t\tsource_system_key as integer,\n\t\tresponse_code_id as string,\n\t\tresponse_desc as string,\n\t\tresponse_outcome_group as string,\n\t\tresponse_detail as string,\n\t\tload_date as date,\n\t\tcreate_date as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tbatchSize: 5000,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tresponse_code_key = ResponseCodeHashkey,\n\t\tsource_system_key,\n\t\tresponse_code_id = ResponseCode,\n\t\tresponse_desc,\n\t\tload_date = ImportFileDate,\n\t\tcreate_date\n\t)) ~> dimResponseCode"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/createFinalInterchange')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "Reference"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "Interchange_Network",
                                "type": "DatasetReference"
                            },
                            "name": "srcNetwork"
                        },
                        {
                            "dataset": {
                                "referenceName": "Interchange",
                                "type": "DatasetReference"
                            },
                            "name": "srcMainInterchange"
                        },
                        {
                            "dataset": {
                                "referenceName": "Interchange_TransactionName",
                                "type": "DatasetReference"
                            },
                            "name": "srcTxnName"
                        },
                        {
                            "dataset": {
                                "referenceName": "Interchange_MerchType",
                                "type": "DatasetReference"
                            },
                            "name": "srcMerchType"
                        },
                        {
                            "dataset": {
                                "referenceName": "Interchange_CardEntry",
                                "type": "DatasetReference"
                            },
                            "name": "srcCardEntry"
                        },
                        {
                            "dataset": {
                                "referenceName": "Interchange_AmountSettled",
                                "type": "DatasetReference"
                            },
                            "name": "srcAmountSettled"
                        },
                        {
                            "dataset": {
                                "referenceName": "Interchange_BIN",
                                "type": "DatasetReference"
                            },
                            "name": "srcBIN"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "all_ReferenceInterchange",
                                "type": "DatasetReference"
                            },
                            "name": "finalInterchangeFile"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "trimInterchangeNetwork"
                        },
                        {
                            "name": "trimInterchange"
                        },
                        {
                            "name": "trimInterchangeTxnName"
                        },
                        {
                            "name": "pivotInterchangeMerchType"
                        },
                        {
                            "name": "windowRowNum"
                        },
                        {
                            "name": "trimInterchangeCardEntry"
                        },
                        {
                            "name": "trimInterchangeAmountSettled"
                        },
                        {
                            "name": "trimInterchangeBIN"
                        },
                        {
                            "name": "joinNetwork"
                        },
                        {
                            "name": "trimInterchangeMerchType"
                        },
                        {
                            "name": "joinTxnName"
                        },
                        {
                            "name": "filterInterchangeNetworkTxnName"
                        },
                        {
                            "name": "joinCardEntry"
                        },
                        {
                            "name": "joinAmountSettled"
                        },
                        {
                            "name": "joinBIN"
                        },
                        {
                            "name": "joinMerchType"
                        },
                        {
                            "name": "selectInterchangePrep"
                        },
                        {
                            "name": "mapDrifted",
                            "description": "Creates an explicit mapping for each drifted column"
                        },
                        {
                            "name": "rankInterchange"
                        }
                    ],
                    "script": "source(output(\n\t\tInterchangeID as string,\n\t\tInterchangeNetworkID as string,\n\t\tNetworkOperator as string,\n\t\tNetwork as string\n\t),\n\tallowSchemaDrift: false,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcNetwork\nsource(output(\n\t\tInterchangeID as string,\n\t\tClientNumber as string,\n\t\tInterchangeRateName as string,\n\t\tInterchangeRateNameStartDate as string,\n\t\tInterchangeRateNameEndDate as string,\n\t\tFixedAmt as string,\n\t\tRequestedAmtPcnt as string,\n\t\tCompletedAmtPcnt as string,\n\t\tExceptionAmtPcnt as string,\n\t\tMinAmt as string,\n\t\tMaxAmt as string,\n\t\tRateStartDate as string,\n\t\tRateEndDate as string,\n\t\tIsOurTerminal as string,\n\t\tIsInternational as string,\n\t\tOnPremise as string,\n\t\tCreateDate as string,\n\t\tProcessingOrder as string\n\t),\n\tallowSchemaDrift: false,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcMainInterchange\nsource(output(\n\t\tInterchangeID as string,\n\t\tInterchangeTransactionNameID as string,\n\t\tTransactionNameOperator as string,\n\t\tTransactionName as string\n\t),\n\tallowSchemaDrift: false,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcTxnName\nsource(output(\n\t\tInterchangeID as string,\n\t\tInterchangeMerchTypeID as string,\n\t\tMerchTypeOperator as string,\n\t\tMerchType as string,\n\t\tMerchTypeOrder as string\n\t),\n\tallowSchemaDrift: false,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcMerchType\nsource(output(\n\t\tInterchangeID as string,\n\t\tInterchangeCardEntryID as string,\n\t\tCardEntryOperator as string,\n\t\tCardEntry as string\n\t),\n\tallowSchemaDrift: false,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcCardEntry\nsource(output(\n\t\tInterchangeID as string,\n\t\tInterchangeAmountSettledID as string,\n\t\tAmountSettledOperator as string,\n\t\tAmountSettled as string,\n\t\tAmountSettledOrder as string\n\t),\n\tallowSchemaDrift: false,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcAmountSettled\nsource(output(\n\t\tInterchangeID as string,\n\t\tInterchangeBINNumberID as string,\n\t\tBINNumberOperator as string,\n\t\tBINNumber as string\n\t),\n\tallowSchemaDrift: false,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcBIN\nsrcNetwork derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null())))),\n\t\tInterchangeID_network = InterchangeID) ~> trimInterchangeNetwork\nsrcMainInterchange derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null())))),\n\t\tover_column = 1,\n\t\tInterchangeID_master = InterchangeID) ~> trimInterchange\nsrcTxnName derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null())))),\n\t\tInterchangeID_txnName = InterchangeID) ~> trimInterchangeTxnName\nwindowRowNum pivot(groupBy(InterchangeID_merchtype),\n\tpivotBy(RowNum),\n\tMerchTypeOperator = max(MerchTypeOperator),\n\t\tMerchType = max(MerchType),\n\tcolumnNaming: '$N$V',\n\tlateral: false) ~> pivotInterchangeMerchType\ntrimInterchangeMerchType window(over(InterchangeID_merchtype),\n\tasc(MerchTypeOrder, true),\n\tRowNum = rowNumber()) ~> windowRowNum\nsrcCardEntry derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null())))),\n\t\tInterchangeID_cardentry = InterchangeID) ~> trimInterchangeCardEntry\nsrcAmountSettled derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null())))),\n\t\tInterchangeID_amntsettled = InterchangeID) ~> trimInterchangeAmountSettled\nsrcBIN derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null())))),\n\t\tInterchangeID_BIN = InterchangeID) ~> trimInterchangeBIN\ntrimInterchange, trimInterchangeNetwork join(InterchangeID_master == InterchangeID_network,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> joinNetwork\nsrcMerchType derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null())))),\n\t\tInterchangeID_merchtype = InterchangeID) ~> trimInterchangeMerchType\njoinNetwork, trimInterchangeTxnName join(InterchangeID_master == InterchangeID_txnName,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> joinTxnName\njoinTxnName filter(isNull(RateEndDate) && isNull(InterchangeRateNameEndDate) && isNull(ClientNumber)) ~> filterInterchangeNetworkTxnName\nfilterInterchangeNetworkTxnName, trimInterchangeCardEntry join(InterchangeID_master == InterchangeCardEntryID,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> joinCardEntry\njoinCardEntry, trimInterchangeAmountSettled join(InterchangeID_master == InterchangeID_amntsettled,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> joinAmountSettled\njoinAmountSettled, trimInterchangeBIN join(InterchangeID_master == InterchangeID_BIN,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> joinBIN\njoinBIN, pivotInterchangeMerchType join(InterchangeID_master == InterchangeID_merchtype,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> joinMerchType\nmapDrifted select(mapColumn(\n\t\tInterchangeID = InterchangeID_master,\n\t\tInterchangeRateName,\n\t\tInterchangeRateNameStartDate,\n\t\tInterchangeRateNameEndDate,\n\t\tFixedAmt,\n\t\tRequestedAmtPcnt,\n\t\tCompletedAmtPcnt,\n\t\tExceptionAmtPcnt,\n\t\tMinAmt,\n\t\tMaxAmt,\n\t\tRateStartDate,\n\t\tRateEndDate,\n\t\tNetwork,\n\t\tTransactionName,\n\t\tIsOurTerminal,\n\t\tIsInternational,\n\t\tOnPremise,\n\t\tCardEntryOperator,\n\t\tCardEntry,\n\t\tAmountSettledOperator,\n\t\tAmountSettled,\n\t\tBINNumberOperator,\n\t\tBINNumber,\n\t\tMerchTypeOperator1,\n\t\tMerchType1,\n\t\tMerchTypeOperator2,\n\t\tMerchType2,\n\t\tMerchTypeOperator3,\n\t\tMerchType3,\n\t\tProcessingOrder,\n\t\tover_column\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> selectInterchangePrep\njoinMerchType derive(MerchTypeOperator1 = toString(byName('MerchTypeOperator1')),\n\t\tMerchType1 = toString(byName('MerchType1')),\n\t\tMerchTypeOperator2 = toString(byName('MerchTypeOperator2')),\n\t\tMerchType2 = toString(byName('MerchType2')),\n\t\tMerchTypeOperator3 = toString(byName('MerchTypeOperator3')),\n\t\tMerchType3 = toString(byName('MerchType3'))) ~> mapDrifted\nselectInterchangePrep window(over(over_column),\n\tasc(case(isNull(ProcessingOrder),0,toInteger(ProcessingOrder)), true),\n\tNumber = rank()) ~> rankInterchange\nrankInterchange sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tInterchangeID as string,\n\t\tInterchangeRateName as string,\n\t\tInterchangeRateNameStartDate as string,\n\t\tInterchangeRateNameEndDate as string,\n\t\tFixedAmt as string,\n\t\tRequestedAmtPcnt as string,\n\t\tCompletedAmtPcnt as string,\n\t\tExceptionAmtPcnt as string,\n\t\tMinAmt as string,\n\t\tMaxAmt as string,\n\t\tRateStartDate as string,\n\t\tRateEndDate as string,\n\t\tNetwork as string,\n\t\tTransactionName as string,\n\t\tIsOurTerminal as string,\n\t\tIsInternational as string,\n\t\tOnPremise as string,\n\t\tCardEntryOperator as string,\n\t\tCardEntry as string,\n\t\tAmountSettledOperator as string,\n\t\tAmountSettled as string,\n\t\tBINNumberOperator as string,\n\t\tBINNumber as string,\n\t\tMerchTypeOperator1 as string,\n\t\tMerchType1 as string,\n\t\tMerchTypeOperator2 as string,\n\t\tMerchType2 as string,\n\t\tMerchTypeOperator3 as string,\n\t\tMerchType3 as string,\n\t\tProcessingOrder as string,\n\t\tNumber as string\n\t),\n\tpartitionFileNames:[(\r\n\r\n\r\n\"finalInterchange_\" + replace(toString(currentDate()),\"-\",\"\") + \".csv\")],\n\tumask: 0022,\n\tpreCommands: [],\n\tpostCommands: [],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tmapColumn(\n\t\tInterchangeID,\n\t\tInterchangeRateName,\n\t\tInterchangeRateNameStartDate,\n\t\tInterchangeRateNameEndDate,\n\t\tFixedAmt,\n\t\tRequestedAmtPcnt,\n\t\tCompletedAmtPcnt,\n\t\tExceptionAmtPcnt,\n\t\tMinAmt,\n\t\tMaxAmt,\n\t\tRateStartDate,\n\t\tRateEndDate,\n\t\tNetwork,\n\t\tTransactionName,\n\t\tIsOurTerminal,\n\t\tIsInternational,\n\t\tOnPremise,\n\t\tCardEntryOperator,\n\t\tCardEntry,\n\t\tAmountSettledOperator,\n\t\tAmountSettled,\n\t\tBINNumberOperator,\n\t\tBINNumber,\n\t\tMerchTypeOperator1,\n\t\tMerchType1,\n\t\tMerchTypeOperator2,\n\t\tMerchType2,\n\t\tMerchTypeOperator3,\n\t\tMerchType3,\n\t\tProcessingOrder,\n\t\tNumber\n\t),\n\tpartitionBy('hash', 1)) ~> finalInterchangeFile"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/DD031')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "FirstData"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "dropZoneTransactions_DD031",
                                "type": "DatasetReference"
                            },
                            "name": "DD31Source"
                        },
                        {
                            "dataset": {
                                "referenceName": "FDTransactionCriteria",
                                "type": "DatasetReference"
                            },
                            "name": "FDCriteria"
                        },
                        {
                            "dataset": {
                                "referenceName": "src_stgCCUMSTR",
                                "type": "DatasetReference"
                            },
                            "name": "CCUMSTR"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "snk_cnfmFISTransactions",
                                "type": "DatasetReference"
                            },
                            "name": "ConformedTransactions"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "BaseTransformations"
                        },
                        {
                            "name": "TrimDefault"
                        },
                        {
                            "name": "HashKey"
                        },
                        {
                            "name": "FilterHeader"
                        },
                        {
                            "name": "SelectCriteria"
                        },
                        {
                            "name": "JoinCCUMSTR"
                        },
                        {
                            "name": "JoinCriteria"
                        },
                        {
                            "name": "FilterCriteria"
                        },
                        {
                            "name": "Dedupe"
                        },
                        {
                            "name": "Join1"
                        },
                        {
                            "name": "TrimCriteria"
                        },
                        {
                            "name": "TrimCCUMSTR"
                        }
                    ],
                    "script": "parameters{\n\tfileName as string\n}\nsource(output(\n\t\tDD031ID as string,\n\t\tRoutingTransit as string,\n\t\tSYS as string,\n\t\tPRN as string,\n\t\tAGT as string,\n\t\tReportDate as string,\n\t\tCardNumber as string,\n\t\tAuthDate_old as string,\n\t\tCurrency as string,\n\t\tAdjustmentAmount as string,\n\t\tBinNumber as string,\n\t\tMerchantAcctNumber as string,\n\t\tMerchantStoreNumber as string,\n\t\tMerchantCurrencyCode as string,\n\t\tMerchantCurrencyCodeNumber as string,\n\t\tDuration as string,\n\t\tAuthorizationSource as string,\n\t\tExternalStatus as string,\n\t\tPinIndicator as string,\n\t\tAuthorizationAdviceFlag as string,\n\t\tPositiveAutCapacityMgmt as string,\n\t\tStrategyARNumber as string,\n\t\tFalconFraudScore as string,\n\t\tFalconNonreceiptSubNumber as string,\n\t\tCrossReferenceNumber as string,\n\t\tDateTime as string,\n\t\tGRAmountAvailable as string,\n\t\tMerchantName as string,\n\t\tMerchantCity as string,\n\t\tMerchantState_old as string,\n\t\tMerchantZip as string,\n\t\tVisaTranID as string,\n\t\tOperatorCode as string,\n\t\tAccountType as string,\n\t\tPOSDeviceModel as string,\n\t\tBalanceSource as string,\n\t\tICODE as string,\n\t\tMETHOD as string,\n\t\tPPILimit as string,\n\t\tCVVCode as string,\n\t\tBRNumber as string,\n\t\tFalconStrategyCode as string,\n\t\tFDRTraceNumber as string,\n\t\tTranCode as string,\n\t\tOutstandingAuthorizations as string,\n\t\tOriginationID as string,\n\t\tPOSEntryNumber as string,\n\t\tReasonNumber as string,\n\t\tLOCNumber as string,\n\t\tExpirationDate as string,\n\t\tAuthActivityID as string,\n\t\tAuthApprovalCode as string,\n\t\tStandInProcessingCode as string,\n\t\tMailPhoneCode as string,\n\t\tLRCODE as string,\n\t\tFraudDetectionWorkCenterCode as string,\n\t\tPaymentKitingStrategyCode as string,\n\t\tAuthResponse as string,\n\t\tAuthIDNumber as string,\n\t\tOutstandingTransactions as string,\n\t\tPOSEntryCapabililty as string,\n\t\tATMTerminalID as string,\n\t\tXFERCode as string,\n\t\tCCVErrorCode as string,\n\t\tMCBanknetDate as string,\n\t\tConsumerAccountStatusID as string,\n\t\tAuthCharacteristicCode as string,\n\t\tTranClass as string,\n\t\tTranResearchCode as string,\n\t\tFalconTranLine as string,\n\t\tTranIdentifier as string,\n\t\tTranDeclinedReasonCode as string,\n\t\tOutstandingCheckCode as string,\n\t\tAddressVerify as string,\n\t\tPreAuthTransaction as string,\n\t\tElectronicCommerceCode as string,\n\t\tAuthPlusLinkFeatureCode as string,\n\t\tCPUCode as string,\n\t\tClientAuthStrategyID as string,\n\t\tOutstandingDepositAmount as string,\n\t\tTotalPINAuth as string,\n\t\tLedgerBalanceAmount as string,\n\t\tTotalOutstandingDepositAmount as string,\n\t\tNetTransferAmount as string,\n\t\tOutstandingDepositCount as string,\n\t\tTransferToAccount as string,\n\t\tAvailableFundAmount as string,\n\t\tATMAvailableFundAmount as string,\n\t\tAvailableDepositAmount as string,\n\t\tDepositLimitAmountCountRate as string,\n\t\tAddAvailDepositToLedgerBalance as string,\n\t\tDepositAccount as string,\n\t\tAuthoirizationAmount as string,\n\t\tAuthorizationLimit as string,\n\t\tCalculatedFailedValues as string,\n\t\tAuthorizationType as string,\n\t\tTranAccountTypeCode as string,\n\t\tLimitReason as string,\n\t\tTranDescription as string,\n\t\tTransferFromAccountType as string,\n\t\tTransferToAccountType as string,\n\t\tDateImported as string,\n\t\tAPPR_AMT as string,\n\t\tCREDIT_UNION_ID as string,\n\t\tAuthDate as string,\n\t\tMerchantState as string,\n\t\tPI as string,\n\t\tOD as string,\n\t\tODFEE as string,\n\t\tDAT_TRAN_CTGR_IN as string,\n\t\tCASH_BACK_AMT as string,\n\t\tHC_IIAS as string,\n\t\tDAT_PYMT_TRAN_TYPE_IN as string,\n\t\tDAT_TIME_PRTH_LIMIT_ID as string,\n\t\tAGGR as string,\n\t\tCNTL_ID as string,\n\t\tDAT_WLLT_ID as string,\n\t\tNETWORK_ID as string,\n\t\tCHK_AMT as string,\n\t\tCSH_AMT as string,\n\t\tAMT_TRAN_FEE as string,\n\t\tFIN_ATH as string,\n\t\tDEV_TYPE as string,\n\t\tTR_TAG as string,\n\t\tSERV_NO as string,\n\t\tSID_NO as string,\n\t\tEMV_CODE as string,\n\t\tCARD_SEQ as string,\n\t\tSQI_CODE as string,\n\t\tPI_TYPE as string,\n\t\tSRV_CD as string,\n\t\tSP_CODE as string,\n\t\tAUTHN_CODE as string,\n\t\tFalconCounterfeitStrategyCode as string,\n\t\tMRP as string,\n\t\tTKREQID as string,\n\t\tTMGReportDate as string,\n\t\tOVRDAMT as string,\n\t\tCRTSAMT as string,\n\t\tAVLBAMT as string,\n\t\tOVRDCHGAM as string,\n\t\tCRTSCHGAM as string,\n\t\tOVRDTYP as string,\n\t\tTFC as string,\n\t\tTRNFEEAM as string,\n\t\tMINISTMT as string,\n\t\tTOKNPAN as string,\n\t\tSYSTRAC as string,\n\t\tMRCHLOC as string,\n\t\tWLLT_ID as string,\n\t\tCVM_1 as string,\n\t\tCVM_2 as string,\n\t\tPOSENV_CODE as string,\n\t\tSTIPRC_CODE as string,\n\t\tPOI_CODE as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> DD31Source\nsource(output(\n\t\tTransactionCriteriaID as string,\n\t\tFD_Source_System_Key as string,\n\t\tTransactionName as string,\n\t\tBINType as string,\n\t\tTransactionCode as string,\n\t\tResponseCodeOperator as string,\n\t\tResponseCode as string,\n\t\tMerchantTypeOperator as string,\n\t\tMerchantType as string,\n\t\tPOSEntryCode as string,\n\t\tNetworkID as string,\n\t\tReferenceNumberOperator as string,\n\t\tReferenceNumber as string,\n\t\tAuthorizationResponseOperator as string,\n\t\tAuthorizationResponse as string,\n\t\tAuthorizationType as string,\n\t\tReasonCodeOperator as string,\n\t\tReasonCode as string,\n\t\tCreateDate as string,\n\t\tAuthorizationTypeOperator as string,\n\t\tAcctNumMerchNumMatchInd as string,\n\t\tOperatorCodeOperator as string,\n\t\tOperatorCode as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> FDCriteria\nsource(output(\n\t\tSPAIdentifier as string,\n\t\tsys as string,\n\t\tprin as string,\n\t\tagent as string,\n\t\tcu_odindx as string,\n\t\tcardtyp as string,\n\t\tInterestRate as string,\n\t\tAnnualFee as string,\n\t\tOverlimitFee as string,\n\t\tLateFee as string,\n\t\tCwbFee as string,\n\t\tAutoDQFee as string,\n\t\tGroupNo as string,\n\t\tGroupDesc as string,\n\t\tItemizedPerAcct as string,\n\t\tPrimaryBillingSys as string,\n\t\tPlatform as string,\n\t\tSPA as string,\n\t\tDateProcessed as string,\n\t\tStatus as string,\n\t\tUniversalAddressing as string,\n\t\tSeparateEntityFlag as string,\n\t\tInternationalDateFormat as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> CCUMSTR\nTrimDefault derive(OriginDate_DateID = toDate(AuthDate,'MM/dd/yyyy'),\n\t\tOriginalDataTransmission_DateID = toDate(defaultdate,'yyyy-MM-dd'),\n\t\tAccountID = CardNumber,\n\t\tIssuer_ClientID = 'UNK',\n\t\tAcquirer_ClientID = 'UNK',\n\t\tBIN_ID = CardNumber,\n\t\tTransactionName_deprecated = case(left(POSEntryNumber,2) == '90','SIGNATURE'\r\n,case(left(POSEntryNumber,2) == '01','PINless'\r\n,case(left(POSEntryNumber,2) == '02','PIN'\r\n,case(left(POSEntryNumber,2) == '81', 'Internet','Others')))),\n\t\tProcessingCodeID = 'UNK',\n\t\tPOSConditionID = MailPhoneCode,\n\t\tMerchantType_trans = MerchantCurrencyCodeNumber,\n\t\tIssuerNetworkID = 'UNK',\n\t\tAcquirerNetworkID = case(NETWORK_ID!='',NETWORK_ID,'UNK'),\n\t\tTransactionTypeID = '251',\n\t\tAcquiringInstitution_CountryCodeID = 'UNK',\n\t\tTransaction_CountryCodeID = 'UNK',\n\t\tSettlement_CountryCodeID = 'UNK',\n\t\tCardEntryMethodID = POSEntryNumber,\n\t\tPaymentTokenRequestorID = iif(length(TKREQID)==11,TKREQID,toString(null())),\n\t\tMerchantID = MerchantName,\n\t\tMerchantTerminalGeographyID = 'UNK',\n\t\tResponseCodeID = concat(TranCode, AuthResponse),\n\t\tIndicatorID = 'UNK',\n\t\tTerminalID = 'UNK',\n\t\tAccountFrom = DepositAccount,\n\t\tAccountTo = TransferToAccount,\n\t\tTransactionCount = toInteger(1),\n\t\tInterchangeAmount = toFloat(0.00),\n\t\tCashBackAmount = CASH_BACK_AMT,\n\t\tSurchargeAmount = toFloat(AMT_TRAN_FEE),\n\t\tRequestAmount = AuthoirizationAmount,\n\t\tSettlementAmount = toFloat(AuthoirizationAmount),\n\t\tExceptionAmount = 'UNK',\n\t\tSwitchDate = toDate(defaultdate,'yyyy-MM-dd'),\n\t\tCardAcceptor = MerchantAcctNumber,\n\t\tIssuerRTN = RoutingTransit,\n\t\tcardpresence = case((left(POSEntryNumber,2) =='01'&&(MailPhoneCode!=''&& MailPhoneCode!='0'))||(left(POSEntryNumber,2) =='00'&&(MailPhoneCode!=''&& MailPhoneCode!='0'))||\r\n(left(POSEntryNumber,2) ==''&&(MailPhoneCode!=''&& MailPhoneCode!='0'))||left(POSEntryNumber,1)==('T')||left(POSEntryNumber,2) =='10'||left(POSEntryNumber,2) =='81'\r\n,'Card Not Present','Card Present'),\n\t\tsource = 'FD',\n\t\tMonetary = 0,\n\t\tOnUsDescription = 'UNK',\n\t\tRecurringDescription = case( left(CardNumber,1) =='4'&& MailPhoneCode == '2' , case((left(CardNumber,1) =='2'||left(CardNumber,1) =='5')&& MailPhoneCode == '4','Recurring'), 'Not Recurring'),\n\t\tResponseCode_trans = coalesce(TranCode,''),\n\t\tTermicalAddress = case(MerchantCurrencyCodeNumber =='6011'&&MerchantState !='',MRCHLOC,''),\n\t\tTerminalcity = MerchantCity,\n\t\tTermicalCountry = case(MerchantState=='AA'||MerchantState=='AE'||MerchantState=='AK'||MerchantState=='AL'||MerchantState=='AP'||MerchantState=='AR'||MerchantState=='AS'||MerchantState=='AZ'||MerchantState=='CA'||MerchantState=='CO'||MerchantState=='CT'||MerchantState=='DC'||MerchantState=='DE'||MerchantState=='FL'||MerchantState=='FM'||MerchantState=='GA'||MerchantState=='GU'||MerchantState=='HI'||MerchantState=='IA'||MerchantState=='ID'||MerchantState=='IL'||MerchantState=='IN'||MerchantState=='KS'||MerchantState=='KY'||MerchantState=='LA'||MerchantState=='MA'||MerchantState=='MD'||MerchantState=='ME'||MerchantState=='MH'||MerchantState=='MI'||MerchantState=='MN'||MerchantState=='MO'||MerchantState=='MP'||MerchantState=='MS'||MerchantState=='MT'||MerchantState=='NC'||MerchantState=='ND'||MerchantState=='NE'||MerchantState=='NH'||MerchantState=='NJ'||MerchantState=='NM'||MerchantState=='NV'||MerchantState=='NY'||MerchantState=='OH'||MerchantState=='OK'||MerchantState=='OR'||MerchantState=='PA'||MerchantState=='PR'||MerchantState=='PW'||MerchantState=='RI'||MerchantState=='SC'||MerchantState=='SD'||MerchantState=='TN'||MerchantState=='TX'||MerchantState=='UT'||MerchantState=='VI'||MerchantState=='VT'||MerchantState=='WA'||MerchantState=='WI'||MerchantState=='WV'||MerchantState=='WY'||MerchantState=='','USA',MerchantState),\n\t\tTerminalState = MerchantState,\n\t\tTerminalzipcode = MerchantZip,\n\t\tTransmissionDate = toDate(defaultdate,'yyyy-MM-dd'),\n\t\tTransmissionTime = 'UNK',\n\t\tTimeLocalTransaction = 'UNK',\n\t\tRetrievalReferenceNumber = 'UNK',\n\t\tSettlementDate = toDate(ReportDate,'yyyy-MM-dd'),\n\t\tBINISO = left(CardNumber,6),\n\t\tAgentNo = AGT,\n\t\tSystemNo = SYS,\n\t\tOperCode = 'UNK',\n\t\tPrincipalNo = PRN,\n\t\tAuthorizationNo = 'UNK',\n\t\tClientNo = 'UNK',\n\t\ttransaction_amount = toFloat(0.00),\n\t\tis_authorization = 1,\n\t\tAcquiringRTN = 'UNK',\n\t\tSettlementRTN = 'UNK',\n\t\tForwardingRTN = 'UNK',\n\t\tTraceNumber = FDRTraceNumber,\n\t\tAcqTraceNumber = 'UNK',\n\t\tVisaTransactionID = VisaTranID,\n\t\tMasterCardTransactionID = 'UNK',\n\t\tAuthorizationType = coalesce(left(AuthorizationType,3),'NaN'),\n\t\tAuthorizationResponse_trans = coalesce(AuthResponse,'NaN'),\n\t\tISOMessageType = 'UNK') ~> BaseTransformations\nFilterHeader derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null())))),\n\t\tImportFileDate = toDate(concat(substring($fileName,7,4),'-',substring($fileName,11,2),'-',substring($fileName,13,2)),'yyyy-MM-dd'),\n\t\tdefaultdate = '1900-01-01') ~> TrimDefault\nJoin1 derive(Transaction_Key = crc32(iif(isNull(AccountID),'',AccountID)\r\n, iif(isNull(OriginDate_DateID),'',toString(OriginDate_DateID))\r\n, iif(isNull(TimeLocalTransaction),'',TimeLocalTransaction)\r\n, iif(isNull(TransmissionDate),'',toString(TransmissionDate))\r\n, iif(isNull(TransmissionTime),'',TransmissionTime)\r\n, iif(isNull(SettlementAmount),0.00,SettlementAmount)\r\n, iif(isNull(TransactionTypeID),'',TransactionTypeID)\r\n, iif(isNull(RetrievalReferenceNumber),'',RetrievalReferenceNumber)\r\n, 2),\n\t\tTransactionName_final = iif(isNull(TransactionName),'Unknown', TransactionName)) ~> HashKey\nDD31Source filter(DD031ID!='Prop_0') ~> FilterHeader\nTrimCriteria select(mapColumn(\n\t\tTransactionCriteriaID,\n\t\tFD_Source_System_Key,\n\t\tTransactionName,\n\t\tBINType,\n\t\tTransactionCode,\n\t\tResponseCodeOperator,\n\t\tResponseCode_criteria = ResponseCode,\n\t\tMerchantTypeOperator,\n\t\tMerchantType,\n\t\tPOSEntryCode,\n\t\tNetworkID,\n\t\tReferenceNumberOperator,\n\t\tReferenceNumber,\n\t\tAuthorizationResponseOperator,\n\t\tAuthorizationResponse_criteria = AuthorizationResponse,\n\t\tAuthorizationType_criteria = AuthorizationType,\n\t\tReasonCodeOperator,\n\t\tReasonCode_criteria = ReasonCode,\n\t\tCreateDate,\n\t\tAuthorizationTypeOperator,\n\t\tAcctNumMerchNumMatchInd\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectCriteria\nBaseTransformations, TrimCCUMSTR join(TrimDefault@SYS == TrimCCUMSTR@sys\n\t&& PRN == prin\n\t&& AGT == agent,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinCCUMSTR\nJoinCCUMSTR, SelectCriteria join(Platform == BINType\n\t&& TransactionTypeID == TransactionCode,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinCriteria\nJoinCriteria filter(FD_Source_System_Key=='5'\r\n&&\r\n(isNull(ResponseCode_criteria)||ResponseCode_criteria=='NULL'\r\n||(ResponseCodeOperator=='='&&ResponseCode_trans==ResponseCode_criteria)\r\n||(ResponseCodeOperator=='<>'&&ResponseCode_trans!=ResponseCode_criteria)\r\n||(ResponseCodeOperator=='IN'&&iifNull(locate(ResponseCode_trans,ResponseCode_criteria),0)!=0)\r\n||(ResponseCodeOperator=='NOT IN'&&iifNull(locate(ResponseCode_trans,ResponseCode_criteria),0)==0))\r\n&&\r\n(MerchantType=='NULL'||isNull(MerchantType)\r\n||(MerchantTypeOperator=='='&&MerchantType_trans==MerchantType)\r\n||(MerchantTypeOperator=='<>'&&MerchantType_trans!=MerchantType)\r\n||(MerchantTypeOperator=='IN'&&iifNull(locate(MerchantType_trans,MerchantType),0)!=0)\r\n||(MerchantTypeOperator=='NOT IN'&&iifNull(locate(MerchantType_trans,MerchantType),0)==0))\r\n&&\r\n(AuthorizationResponse_criteria=='NULL'||isNull(AuthorizationResponse_criteria)\r\n||(AuthorizationResponseOperator=='='&&AuthResponse==AuthorizationResponse_criteria)\r\n||(AuthorizationResponseOperator=='<>'&&AuthResponse!=AuthorizationResponse_criteria)\r\n||(AuthorizationResponseOperator=='IN'&&iifNull(locate(AuthResponse,AuthorizationResponse_criteria),0)!=0)\r\n||(AuthorizationResponseOperator=='NOT IN'&&iifNull(locate(AuthResponse,AuthorizationResponse_criteria),0)==0))\r\n&&\r\n(ReasonCode_criteria=='NULL'||isNull(ReasonCode_criteria)\r\n||(ReasonCodeOperator=='='&&ReasonNumber==ReasonCode_criteria)\r\n||(ReasonCodeOperator=='<>'&&ReasonNumber!=ReasonCode_criteria)\r\n||(ReasonCodeOperator=='IN'&&iifNull(locate(ReasonNumber,ReasonCode_criteria),0)!=0)\r\n||(ReasonCodeOperator=='NOT IN'&&iifNull(locate(ReasonNumber,ReasonCode_criteria),0)==0))\r\n&&\r\n(AuthorizationType_criteria=='NULL'||isNull(AuthorizationType_criteria)\r\n||(AuthorizationTypeOperator=='='&&AuthorizationType==AuthorizationType_criteria)\r\n||(AuthorizationTypeOperator=='<>'&&AuthorizationType!=AuthorizationType_criteria))) ~> FilterCriteria\nFilterCriteria aggregate(groupBy(DD031ID),\n\tTransactionName = min(TransactionName)) ~> Dedupe\nJoinCCUMSTR, Dedupe join(TrimDefault@DD031ID == Dedupe@DD031ID,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> Join1\nFDCriteria derive(each(match(type=='string'), $$ = trim($$))) ~> TrimCriteria\nCCUMSTR derive(each(match(type=='string'), $$ = trim($$))) ~> TrimCCUMSTR\nHashKey sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tAccountNumber as string,\n\t\tAcquirerAccountNumber as string,\n\t\tAcquirerNetworkCode as string,\n\t\tBin_ISO as string,\n\t\tBin_EXT as string,\n\t\tCardEntryMethodCode as string,\n\t\tCardPresenceDescription as string,\n\t\tImportFileDate as date,\n\t\tSource as string,\n\t\tInterchangeAmount as float,\n\t\tIssuerAccountNumber as string,\n\t\tIssuerNetworkCode as string,\n\t\tMerchantName as string,\n\t\tMerchantType as string,\n\t\tMonetary as integer,\n\t\tOnUsDescription as string,\n\t\tOriginalDataTransmissionDate as date,\n\t\tOriginDate as date,\n\t\tRecurringDescription as string,\n\t\tResponseCode as string,\n\t\tSettlementAmount as float,\n\t\tSettlementDate as date,\n\t\tSurchargeAmount as float,\n\t\tTerminalAddress as string,\n\t\tTerminalCity as string,\n\t\tTerminalCountry as string,\n\t\tTerminalKey as string,\n\t\tTerminalState as string,\n\t\tTerminalZipCode as string,\n\t\tTokenRequestId as string,\n\t\tTransactionName as string,\n\t\tTransactionTypeCode as string,\n\t\tTransmissionDate as date,\n\t\tTransmissionTime as string,\n\t\tTimeLocalTransaction as string,\n\t\tRetrievalReferenceNumber as string,\n\t\tTransaction_Key as long,\n\t\tAgentNo as string,\n\t\tSystemNo as string,\n\t\tOperCode as string,\n\t\tPrincipalNo as string,\n\t\tAuthorizationNo as string,\n\t\tClientNo as string,\n\t\ttransaction_amount as float,\n\t\tis_authorization as integer,\n\t\tAcquiringRTN as string,\n\t\tSettlementRTN as string,\n\t\tTraceNumber as string,\n\t\tAcqTraceNumber as string,\n\t\tVisaTransactionID as string,\n\t\tMasterCardTransactionID as string,\n\t\tMerchantAccountNumber as string,\n\t\tISOMessageType as string,\n\t\tForwardingRTN as string\n\t),\n\tformat: 'parquet',\n\tpartitionFileNames:[($fileName)],\n\tumask: 0022,\n\tpreCommands: [],\n\tpostCommands: [],\n\tdateFormat:'MM/dd/yyyy',\n\ttimestampFormat:'MM/dd/yyyy HH:mm:ss',\n\tmapColumn(\n\t\tAccountNumber = AccountID,\n\t\tAcquirerAccountNumber = Acquirer_ClientID,\n\t\tAcquirerNetworkCode = AcquirerNetworkID,\n\t\tBin_ISO = BINISO,\n\t\tBin_EXT = BIN_ID,\n\t\tCardEntryMethodCode = CardEntryMethodID,\n\t\tCardPresenceDescription = cardpresence,\n\t\tImportFileDate,\n\t\tSource = source,\n\t\tInterchangeAmount,\n\t\tIssuerAccountNumber = Issuer_ClientID,\n\t\tIssuerNetworkCode = IssuerNetworkID,\n\t\tMerchantName,\n\t\tMerchantType = MerchantType_trans,\n\t\tMonetary,\n\t\tOnUsDescription,\n\t\tOriginalDataTransmissionDate = OriginalDataTransmission_DateID,\n\t\tOriginDate = OriginDate_DateID,\n\t\tRecurringDescription,\n\t\tResponseCode = ResponseCodeID,\n\t\tSettlementAmount,\n\t\tSettlementDate,\n\t\tSurchargeAmount,\n\t\tTerminalAddress = TermicalAddress,\n\t\tTerminalCity = Terminalcity,\n\t\tTerminalCountry = TermicalCountry,\n\t\tTerminalKey = TerminalID,\n\t\tTerminalState,\n\t\tTerminalZipCode = Terminalzipcode,\n\t\tTokenRequestId = PaymentTokenRequestorID,\n\t\tTransactionName = TransactionName_final,\n\t\tTransactionTypeCode = TransactionTypeID,\n\t\tTransmissionDate,\n\t\tTransmissionTime,\n\t\tTimeLocalTransaction,\n\t\tRetrievalReferenceNumber,\n\t\tTransaction_Key,\n\t\tAgentNo,\n\t\tSystemNo,\n\t\tOperCode,\n\t\tPrincipalNo,\n\t\tAuthorizationNo,\n\t\tClientNo,\n\t\ttransaction_amount,\n\t\tis_authorization,\n\t\tAcquiringRTN,\n\t\tSettlementRTN,\n\t\tTraceNumber,\n\t\tAcqTraceNumber,\n\t\tVisaTransactionID,\n\t\tMasterCardTransactionID,\n\t\tMerchantAccountNumber = MerchantAcctNumber,\n\t\tISOMessageType,\n\t\tForwardingRTN\n\t),\n\tpartitionBy('hash', 1)) ~> ConformedTransactions"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/DD031_WIP')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "Temporary Loads"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "dropZoneTransactions_DD031",
                                "type": "DatasetReference"
                            },
                            "name": "DD31Source"
                        },
                        {
                            "dataset": {
                                "referenceName": "FDTransactionCriteria",
                                "type": "DatasetReference"
                            },
                            "name": "FDCriteria"
                        },
                        {
                            "dataset": {
                                "referenceName": "CCUMSTR",
                                "type": "DatasetReference"
                            },
                            "name": "CCUMSTR"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "snk_cnfmFISTransactions",
                                "type": "DatasetReference"
                            },
                            "name": "sink1"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "CalculatedColumns"
                        },
                        {
                            "name": "TrimDefault"
                        },
                        {
                            "name": "SPAFilter"
                        },
                        {
                            "name": "Join1"
                        },
                        {
                            "name": "Join2"
                        },
                        {
                            "name": "Filters"
                        },
                        {
                            "name": "Filter3"
                        },
                        {
                            "name": "Aggregate1"
                        },
                        {
                            "name": "DerivedColumn1"
                        }
                    ],
                    "script": "source(output(\n\t\tDD031ID as string,\n\t\tRoutingTransit as string,\n\t\tSYS as string,\n\t\tPRN as string,\n\t\tAGT as string,\n\t\tReportDate as string,\n\t\tCardNumber as string,\n\t\tAuthDate_old as string,\n\t\tCurrency as string,\n\t\tAdjustmentAmount as string,\n\t\tBinNumber as string,\n\t\tMerchantAcctNumber as string,\n\t\tMerchantStoreNumber as string,\n\t\tMerchantCurrencyCode as string,\n\t\tMerchantCurrencyCodeNumber as string,\n\t\tDuration as string,\n\t\tAuthorizationSource as string,\n\t\tExternalStatus as string,\n\t\tPinIndicator as string,\n\t\tAuthorizationAdviceFlag as string,\n\t\tPositiveAutCapacityMgmt as string,\n\t\tStrategyARNumber as string,\n\t\tFalconFraudScore as string,\n\t\tFalconNonreceiptSubNumber as string,\n\t\tCrossReferenceNumber as string,\n\t\tDateTime as string,\n\t\tGRAmountAvailable as string,\n\t\tMerchantName as string,\n\t\tMerchantCity as string,\n\t\tMerchantState_old as string,\n\t\tMerchantZip as string,\n\t\tVisaTranID as string,\n\t\tOperatorCode as string,\n\t\tAccountType as string,\n\t\tPOSDeviceModel as string,\n\t\tBalanceSource as string,\n\t\tICODE as string,\n\t\tMETHOD as string,\n\t\tPPILimit as string,\n\t\tCVVCode as string,\n\t\tBRNumber as string,\n\t\tFalconStrategyCode as string,\n\t\tFDRTraceNumber as string,\n\t\tTranCode as string,\n\t\tOutstandingAuthorizations as string,\n\t\tOriginationID as string,\n\t\tPOSEntryNumber as string,\n\t\tReasonNumber as string,\n\t\tLOCNumber as string,\n\t\tExpirationDate as string,\n\t\tAuthActivityID as string,\n\t\tAuthApprovalCode as string,\n\t\tStandInProcessingCode as string,\n\t\tMailPhoneCode as string,\n\t\tLRCODE as string,\n\t\tFraudDetectionWorkCenterCode as string,\n\t\tPaymentKitingStrategyCode as string,\n\t\tAuthResponse as string,\n\t\tAuthIDNumber as string,\n\t\tOutstandingTransactions as string,\n\t\tPOSEntryCapabililty as string,\n\t\tATMTerminalID as string,\n\t\tXFERCode as string,\n\t\tCCVErrorCode as string,\n\t\tMCBanknetDate as string,\n\t\tConsumerAccountStatusID as string,\n\t\tAuthCharacteristicCode as string,\n\t\tTranClass as string,\n\t\tTranResearchCode as string,\n\t\tFalconTranLine as string,\n\t\tTranIdentifier as string,\n\t\tTranDeclinedReasonCode as string,\n\t\tOutstandingCheckCode as string,\n\t\tAddressVerify as string,\n\t\tPreAuthTransaction as string,\n\t\tElectronicCommerceCode as string,\n\t\tAuthPlusLinkFeatureCode as string,\n\t\tCPUCode as string,\n\t\tClientAuthStrategyID as string,\n\t\tOutstandingDepositAmount as string,\n\t\tTotalPINAuth as string,\n\t\tLedgerBalanceAmount as string,\n\t\tTotalOutstandingDepositAmount as string,\n\t\tNetTransferAmount as string,\n\t\tOutstandingDepositCount as string,\n\t\tTransferToAccount as string,\n\t\tAvailableFundAmount as string,\n\t\tATMAvailableFundAmount as string,\n\t\tAvailableDepositAmount as string,\n\t\tDepositLimitAmountCountRate as string,\n\t\tAddAvailDepositToLedgerBalance as string,\n\t\tDepositAccount as string,\n\t\tAuthoirizationAmount as string,\n\t\tAuthorizationLimit as string,\n\t\tCalculatedFailedValues as string,\n\t\tAuthorizationType as string,\n\t\tTranAccountTypeCode as string,\n\t\tLimitReason as string,\n\t\tTranDescription as string,\n\t\tTransferFromAccountType as string,\n\t\tTransferToAccountType as string,\n\t\tDateImported as string,\n\t\tAPPR_AMT as string,\n\t\tCREDIT_UNION_ID as string,\n\t\tAuthDate as string,\n\t\tMerchantState as string,\n\t\tPI as string,\n\t\tOD as string,\n\t\tODFEE as string,\n\t\tDAT_TRAN_CTGR_IN as string,\n\t\tCASH_BACK_AMT as string,\n\t\tHC_IIAS as string,\n\t\tDAT_PYMT_TRAN_TYPE_IN as string,\n\t\tDAT_TIME_PRTH_LIMIT_ID as string,\n\t\tAGGR as string,\n\t\tCNTL_ID as string,\n\t\tDAT_WLLT_ID as string,\n\t\tNETWORK_ID as string,\n\t\tCHK_AMT as string,\n\t\tCSH_AMT as string,\n\t\tAMT_TRAN_FEE as string,\n\t\tFIN_ATH as string,\n\t\tDEV_TYPE as string,\n\t\tTR_TAG as string,\n\t\tSERV_NO as string,\n\t\tSID_NO as string,\n\t\tEMV_CODE as string,\n\t\tCARD_SEQ as string,\n\t\tSQI_CODE as string,\n\t\tPI_TYPE as string,\n\t\tSRV_CD as string,\n\t\tSP_CODE as string,\n\t\tAUTHN_CODE as string,\n\t\tFalconCounterfeitStrategyCode as string,\n\t\tMRP as string,\n\t\tTKREQID as string,\n\t\tTMGReportDate as string,\n\t\tOVRDAMT as string,\n\t\tCRTSAMT as string,\n\t\tAVLBAMT as string,\n\t\tOVRDCHGAM as string,\n\t\tCRTSCHGAM as string,\n\t\tOVRDTYP as string,\n\t\tTFC as string,\n\t\tTRNFEEAM as string,\n\t\tMINISTMT as string,\n\t\tTOKNPAN as string,\n\t\tSYSTRAC as string,\n\t\tMRCHLOC as string,\n\t\tWLLT_ID as string,\n\t\tCVM_1 as string,\n\t\tCVM_2 as string,\n\t\tPOSENV_CODE as string,\n\t\tSTIPRC_CODE as string,\n\t\tPOI_CODE as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> DD31Source\nsource(output(\n\t\tTransactionCriteriaID as string,\n\t\tFD_Source_System_Key as string,\n\t\tTransactionName as string,\n\t\tBINType as string,\n\t\tTransactionCode as string,\n\t\tResponseCodeOperator as string,\n\t\tResponseCode as string,\n\t\tMerchantTypeOperator as string,\n\t\tMerchantType as string,\n\t\tPOSEntryCode as string,\n\t\tNetworkID as string,\n\t\tReferenceNumberOperator as string,\n\t\tReferenceNumber as string,\n\t\tAuthorizationResponseOperator as string,\n\t\tAuthorizationResponse as string,\n\t\tAuthorizationType as string,\n\t\tReasonCodeOperator as string,\n\t\tReasonCode as string,\n\t\tCreateDate as string,\n\t\tAuthorizationTypeOperator as string,\n\t\tAcctNumMerchNumMatchInd as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> FDCriteria\nsource(output(\n\t\tsys as string,\n\t\tprin as string,\n\t\tagent as string,\n\t\tPlatform as string,\n\t\tcu_odindx as string,\n\t\tCardCategory as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> CCUMSTR\nTrimDefault derive(OriginDate_DateID = toDate(AuthDate,'MM/dd/yyyy'),\n\t\tDateSettlement_DateID = toDate(TMGReportDate,'yyyy-MM-dd'),\n\t\tDateExpiration_DateID = toDate(TMGReportDate, 'yyyy-MM-dd'),\n\t\tOriginalDataTransmission_DateID = toDate(defaultdate,'yyyy-MM-dd'),\n\t\tFISDebitImportFileDate_DateID = toDate(TMGReportDate,'yyyy-MM-dd'),\n\t\tAccountID = CardNumber,\n\t\tIssuer_ClientID = 'UNK',\n\t\tAcquirer_ClientID = 'UNK',\n\t\tBIN_ID = BinNumber,\n\t\tTransactionNameID = 'UNK',\n\t\tProcessingCodeID = 'UNK',\n\t\tPOSConditionID = MailPhoneCode,\n\t\tMerchantTypeDD031 = MerchantCurrencyCodeNumber,\n\t\tIssuerNetworkID = 'UNK',\n\t\tAcquirerNetworkID = case(NETWORK_ID!='',NETWORK_ID,'UNK'),\n\t\tTransactionTypeID = 251,\n\t\tAcquiringInstitution_CountryCodeID = 'UNK',\n\t\tTransaction_CountryCodeID = 'UNK',\n\t\tSettlement_CountryCodeID = 'UNK',\n\t\tCardEntryMethodID = POSEntryNumber,\n\t\tPaymentTokenRequestorID = TKREQID,\n\t\tMerchantID = MerchantName,\n\t\tMerchantTerminalGeographyID = 'UNK',\n\t\tResponseCode = concat(TranCode, AuthResponse),\n\t\tIndicatorID = 'UNK',\n\t\tTerminalID = 'UNK',\n\t\tAccountFrom = DepositAccount,\n\t\tAccountTo = TransferToAccount,\n\t\tTransactionCount = toInteger(1),\n\t\tInterchangeAmount = toFloat(0.00),\n\t\tCashBackAmount = CASH_BACK_AMT,\n\t\tSurchargeAmount = toFloat(AMT_TRAN_FEE),\n\t\tRequestAmount = AuthoirizationAmount,\n\t\tSettlementAmount = toFloat(AuthoirizationAmount),\n\t\tExceptionAmount = 'UNK',\n\t\tSwitchDate = toDate(defaultdate,'yyyy-MM-dd'),\n\t\tCardAcceptor = MerchantAcctNumber,\n\t\tIssuerRTN = RoutingTransit,\n\t\tAcquirerRTN = 'UNK',\n\t\tcardpresence = case((left(POSEntryNumber,2) =='01'&&(MailPhoneCode!=''&& MailPhoneCode!='0'))||(left(POSEntryNumber,2) =='00'&&(MailPhoneCode!=''&& MailPhoneCode!='0'))||\n(left(POSEntryNumber,2) ==''&&(MailPhoneCode!=''&& MailPhoneCode!='0'))||left(POSEntryNumber,1)==('T')||left(POSEntryNumber,2) =='10'||left(POSEntryNumber,2) =='81','CNP','CP'),\n\t\tImport_File_Date = toDate(TMGReportDate, 'yyyy-MM-dd'),\n\t\tsource = 'FD',\n\t\tMonetary = 0,\n\t\tOnUsDescription = 'UNK',\n\t\tRecurringDescription = case( left(CardNumber,1) =='4'&& MailPhoneCode == '2' , case((left(CardNumber,1) =='2'||left(CardNumber,1) =='5')&& MailPhoneCode == '2','YES'), 'No'),\n\t\treponsecodeDD031 = TranCode,\n\t\tTermicalAddress = case(MerchantCurrencyCodeNumber =='6011'&&MerchantState !='',MRCHLOC,''),\n\t\tTerminalcity = MerchantCity,\n\t\tTermicalCountry = case(MerchantState=='AA'||MerchantState=='AE'||MerchantState=='AK'||MerchantState=='AL'||MerchantState=='AP'||MerchantState=='AR'||MerchantState=='AS'||MerchantState=='AZ'||MerchantState=='CA'||MerchantState=='CO'||MerchantState=='CT'||MerchantState=='DC'||MerchantState=='DE'||MerchantState=='FL'||MerchantState=='FM'||MerchantState=='GA'||MerchantState=='GU'||MerchantState=='HI'||MerchantState=='IA'||MerchantState=='ID'||MerchantState=='IL'||MerchantState=='IN'||MerchantState=='KS'||MerchantState=='KY'||MerchantState=='LA'||MerchantState=='MA'||MerchantState=='MD'||MerchantState=='ME'||MerchantState=='MH'||MerchantState=='MI'||MerchantState=='MN'||MerchantState=='MO'||MerchantState=='MP'||MerchantState=='MS'||MerchantState=='MT'||MerchantState=='NC'||MerchantState=='ND'||MerchantState=='NE'||MerchantState=='NH'||MerchantState=='NJ'||MerchantState=='NM'||MerchantState=='NV'||MerchantState=='NY'||MerchantState=='OH'||MerchantState=='OK'||MerchantState=='OR'||MerchantState=='PA'||MerchantState=='PR'||MerchantState=='PW'||MerchantState=='RI'||MerchantState=='SC'||MerchantState=='SD'||MerchantState=='TN'||MerchantState=='TX'||MerchantState=='UT'||MerchantState=='VI'||MerchantState=='VT'||MerchantState=='WA'||MerchantState=='WI'||MerchantState=='WV'||MerchantState=='WY'||MerchantState=='','USA',MerchantState),\n\t\tTerminalState = MerchantState,\n\t\tTerminalzipcode = MerchantZip,\n\t\tTransmissionDate = toDate(defaultdate,'yyyy-MM-dd'),\n\t\tTransmissionTime = 'UNK',\n\t\tTimeLocalTransaction = 'UNK',\n\t\tRetrievalReferenceNumber = 'UNK',\n\t\tSettlementDate = toDate(ReportDate,'yyyy-MM-dd'),\n\t\tBINISO = substring(BinNumber,1,6),\n\t\tReasonCodeDD031 = ReasonNumber,\n\t\tAuthorizationResponseDD031 = AuthResponse,\n\t\tAuthtypeDD031 = AuthorizationType) ~> CalculatedColumns\nDD31Source derive(each(match(type=='string'), $$ = ltrim(rtrim($$))),\n\t\ttransactiontypecode = '251',\n\t\tdefaultdate = '1900-01-01') ~> TrimDefault\nCCUMSTR filter(cu_odindx=='0008'||cu_odindx=='0014'||cu_odindx=='0035'||cu_odindx=='0037'||cu_odindx=='0040'||cu_odindx=='0062'||cu_odindx=='0064'||cu_odindx=='0065'||cu_odindx=='0067'||cu_odindx=='0072'||cu_odindx=='0090'||cu_odindx=='0104'||cu_odindx=='0142'||cu_odindx=='0172'||cu_odindx=='0213'||cu_odindx=='0216'||cu_odindx=='0231'||cu_odindx=='0238'||cu_odindx=='0247'||cu_odindx=='0258'||cu_odindx=='0261'||cu_odindx=='0265'\n||cu_odindx=='0276'||cu_odindx=='0289'||cu_odindx=='0301'||cu_odindx=='0309'||cu_odindx=='0355'||cu_odindx=='0370'||cu_odindx=='0371'||cu_odindx=='0386'||cu_odindx=='0412'||cu_odindx=='0419'||cu_odindx=='0484'||cu_odindx=='0508'||cu_odindx=='0546'||cu_odindx=='0575'||cu_odindx=='0580'||cu_odindx=='0593'||cu_odindx=='0595'||cu_odindx=='0601'||cu_odindx=='0628'||cu_odindx=='0642'||cu_odindx=='0649'||cu_odindx=='0708'||cu_odindx=='0714'||cu_odindx=='0736'||cu_odindx=='0739'||cu_odindx=='0765'||cu_odindx=='0780'\n||cu_odindx=='0858'||cu_odindx=='3364') ~> SPAFilter\nCalculatedColumns, SPAFilter join(TrimDefault@SYS == CCUMSTR@sys\n\t&& PRN == prin\n\t&& AGT == agent,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> Join1\nJoin1, FDCriteria join(CardCategory == BINType\n\t&& transactiontypecode == TransactionCode,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> Join2\nDerivedColumn1 filter(isNull(BINType)||\n(FD_Source_System_Key == '5'\n&&\n(isNull(FDCriteria@ResponseCode)||\n(ResponseCodeOperator=='IN' && iifNull(locate(reponsecodeDD031,FDCriteria@ResponseCode),0)!=0)|| \n(ResponseCodeOperator=='NOT IN' && iifNull(locate(reponsecodeDD031,FDCriteria@ResponseCode),0)==0))\n&&\n(isNull(MerchantType) \n    || (MerchantTypeOperator=='='&& MerchantTypeDD031==MerchantType)\n    || (MerchantTypeOperator=='<>'&& MerchantTypeDD031!=MerchantType)\n    || (MerchantTypeOperator=='IN' && iifNull(locate(MerchantTypeDD031,MerchantType),0)!=0) \n    || (MerchantTypeOperator=='NOT IN' && iifNull(locate(MerchantTypeDD031,MerchantType),0)==0))\n&&\n(isNull(AuthorizationResponse) \n||(AuthorizationResponseOperator=='IN' && iifNull(locate(AuthorizationResponseDD031,AuthorizationResponse),0)!=0) \n||(AuthorizationResponseOperator=='NOT IN' && iifNull(locate(AuthorizationResponseDD031,AuthorizationResponse),0)==0))\n&&\n(isNull(ReasonCode) \n    || (ReasonCodeOperator=='=' && ReasonCodeDD031==ReasonCode)\n    || (ReasonCodeOperator=='<>' && ReasonCodeDD031!=ReasonCode)\n    || (ReasonCodeOperator=='IN' && iifNull(locate(ReasonCodeDD031,ReasonCode),0)!=0) \n    || (ReasonCodeOperator=='NOT IN' && iifNull(locate(ReasonCodeDD031,ReasonCode),0)==0))\n&&\n(isNull(FDCriteria@AuthorizationType) \n    || (AuthorizationTypeOperator=='IN' && iifNull(locate( AuthtypeDD031 , FDCriteria@AuthorizationType ),0)!=0) \n    || (AuthorizationTypeOperator=='NOT IN' && iifNull(locate( AuthtypeDD031 , FDCriteria@AuthorizationType ),0)==0))\n\n)) ~> Filters\nSPAFilter filter(sys=='1024') ~> Filter3\nFDCriteria aggregate(groupBy(AuthorizationResponse),\n\ttest = min(ReasonCodeOperator)) ~> Aggregate1\nJoin2 derive(TransactionNamenew = TransactionName) ~> DerivedColumn1\nFilters sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tAccountNumber as string,\n\t\tAcquirerAccountNumber as string,\n\t\tAcquirerNetworkCode as string,\n\t\tBin_ISO as string,\n\t\tBin_EXT as string,\n\t\tCardEntryMethodCode as string,\n\t\tCardPresenceDescription as string,\n\t\tImportFileDate as date,\n\t\tSource as string,\n\t\tInterchangeAmount as float,\n\t\tIssuerAccountNumber as string,\n\t\tIssuerNetworkCode as string,\n\t\tMerchantName as string,\n\t\tMerchantType as string,\n\t\tMonetary as integer,\n\t\tOnUsDescription as string,\n\t\tOriginalDataTransmissionDate as date,\n\t\tOriginDate as date,\n\t\tRecurringDescription as string,\n\t\tResponseCode as string,\n\t\tSettlementAmount as float,\n\t\tSettlementDate as date,\n\t\tSurchargeAmount as float,\n\t\tTerminalAddress as string,\n\t\tTerminalCity as string,\n\t\tTerminalCountry as string,\n\t\tTerminalKey as string,\n\t\tTerminalState as string,\n\t\tTerminalZipCode as string,\n\t\tTokenRequestId as string,\n\t\tTransactionName as string,\n\t\tTransactionTypeCode as string,\n\t\tTransmissionDate as date,\n\t\tTransmissionTime as string,\n\t\tTimeLocalTransaction as string,\n\t\tRetrievalReferenceNumber as string,\n\t\tTransaction_Key as long,\n\t\tAgentNo as string,\n\t\tSystemNo as string,\n\t\tOperCode as string,\n\t\tPrincipalNo as string,\n\t\tAuthorizationNo as string,\n\t\tClientNo as string,\n\t\ttransaction_amount as float,\n\t\tis_authorization as integer,\n\t\tAcquiringRTN as string,\n\t\tSettlementRTN as string,\n\t\tTraceNumber as string,\n\t\tAcqTraceNumber as string,\n\t\tVisaTransactionID as string,\n\t\tMasterCardTransactionID as string,\n\t\tMerchantAccountNumber as string,\n\t\tISOMessageType as string,\n\t\tForwardingRTN as string\n\t),\n\tformat: 'parquet',\n\ttruncate: true,\n\tumask: 0022,\n\tpreCommands: [],\n\tpostCommands: [],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tmapColumn(\n\t\tAccountNumber = AccountID,\n\t\tAcquirerAccountNumber = Acquirer_ClientID,\n\t\tAcquirerNetworkCode = AcquirerNetworkID,\n\t\tBin_ISO = BINISO,\n\t\tBin_EXT = BIN_ID,\n\t\tCardEntryMethodCode = CardEntryMethodID,\n\t\tCardPresenceDescription = cardpresence,\n\t\tImportFileDate = Import_File_Date,\n\t\tSource = source,\n\t\tInterchangeAmount,\n\t\tIssuerAccountNumber = Issuer_ClientID,\n\t\tIssuerNetworkCode = IssuerNetworkID,\n\t\tMerchantName,\n\t\tMerchantType = MerchantTypeDD031,\n\t\tMonetary,\n\t\tOnUsDescription,\n\t\tOriginalDataTransmissionDate = OriginalDataTransmission_DateID,\n\t\tOriginDate = OriginDate_DateID,\n\t\tRecurringDescription,\n\t\tResponseCode = AuthorizationResponseDD031,\n\t\tSettlementAmount,\n\t\tSettlementDate,\n\t\tSurchargeAmount,\n\t\tTerminalAddress = TermicalAddress,\n\t\tTerminalCity = Terminalcity,\n\t\tTerminalCountry = TermicalCountry,\n\t\tTerminalKey = TerminalID,\n\t\tTerminalState,\n\t\tTerminalZipCode = Terminalzipcode,\n\t\tTokenRequestId = PaymentTokenRequestorID,\n\t\tTransactionName,\n\t\tTransactionTypeCode = transactiontypecode\n\t)) ~> sink1"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/populate_DimCardEntry')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "Dimensions"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "src_cnfmFISTransactions",
                                "type": "DatasetReference"
                            },
                            "name": "ConformedTransactions"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Card_Entry_Method",
                                "type": "DatasetReference"
                            },
                            "name": "srcDimCardEntry"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Source_System",
                                "type": "DatasetReference"
                            },
                            "name": "SourceSystem"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "dim_Card_Entry_Method",
                                "type": "DatasetReference"
                            },
                            "name": "DimCardEntry"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "CardEntryMethod"
                        },
                        {
                            "name": "DeDupeCardEntry"
                        },
                        {
                            "name": "notExistsCardEntry"
                        },
                        {
                            "name": "SourceSystemKeyTransform"
                        },
                        {
                            "name": "removenullCardEntry"
                        },
                        {
                            "name": "CreateCardEntryMethodHashkey"
                        },
                        {
                            "name": "GetCreateDate"
                        }
                    ],
                    "script": "parameters{\n\tfileName as string\n}\nsource(output(\n\t\tAccountNumber as string,\n\t\tAcquirerAccountNumber as string,\n\t\tAcquirerNetworkCode as string,\n\t\tBin_ISO as string,\n\t\tBin_EXT as string,\n\t\tCardEntryMethodCode as string,\n\t\tCardPresenceDescription as string,\n\t\tImportFileDate as date,\n\t\tSource as string,\n\t\tInterchangeAmount as float,\n\t\tIssuerAccountNumber as string,\n\t\tIssuerNetworkCode as string,\n\t\tMerchantName as string,\n\t\tMerchantType as string,\n\t\tMonetary as integer,\n\t\tOnUsDescription as string,\n\t\tOriginalDataTransmissionDate as date,\n\t\tOriginDate as date,\n\t\tRecurringDescription as string,\n\t\tResponseCode as string,\n\t\tSettlementAmount as float,\n\t\tSettlementDate as date,\n\t\tSurchargeAmount as float,\n\t\tTerminalAddress as string,\n\t\tTerminalCity as string,\n\t\tTerminalCountry as string,\n\t\tTerminalKey as string,\n\t\tTerminalState as string,\n\t\tTerminalZipCode as string,\n\t\tTokenRequestId as string,\n\t\tTransactionName as string,\n\t\tTransactionTypeCode as string,\n\t\tTransmissionDate as date,\n\t\tTransmissionTime as string,\n\t\tTimeLocalTransaction as string,\n\t\tRetrievalReferenceNumber as string,\n\t\tTransaction_Key as long,\n\t\tAgentNo as string,\n\t\tSystemNo as string,\n\t\tOperCode as string,\n\t\tPrincipalNo as string,\n\t\tAuthorizationNo as string,\n\t\tClientNo as string,\n\t\ttransaction_amount as float,\n\t\tis_authorization as integer,\n\t\tAcquiringRTN as string,\n\t\tSettlementRTN as string,\n\t\tTraceNumber as string,\n\t\tAcqTraceNumber as string,\n\t\tVisaTransactionID as string,\n\t\tMasterCardTransactionID as string,\n\t\tMerchantAccountNumber as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tformat: 'parquet') ~> ConformedTransactions\nsource(output(\n\t\tcard_entry_key as long,\n\t\tsource_system_key as integer,\n\t\tcard_entry_cde as string,\n\t\tcard_entry_name as string,\n\t\tcard_entry_type as string,\n\t\tload_date as date,\n\t\tcreate_date as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false,\n\tpartitionColumn: 'card_entry_key',\n\tpartitionBy('external', 2)) ~> srcDimCardEntry\nsource(output(\n\t\tsource_system_key as integer,\n\t\tsource_system_name as string,\n\t\tsource_system_description as string,\n\t\tsource_system_abbreviation as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false) ~> SourceSystem\nCreateCardEntryMethodHashkey select(mapColumn(\n\t\tCardEntryMethodCode,\n\t\tsource_system_key,\n\t\timportFileDate = ImportFileDate,\n\t\tCardEntryMethodHashkey\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> CardEntryMethod\nCardEntryMethod aggregate(groupBy(CardEntryMethodCode,\n\t\tCardEntryMethodHashkey,\n\t\tsource_system_key),\n\timportFileDate = min(iifNull(importFileDate,currentDate()))) ~> DeDupeCardEntry\nDeDupeCardEntry, srcDimCardEntry exists(CardEntryMethodHashkey == card_entry_key,\n\tnegate:true,\n\tbroadcast: 'auto')~> notExistsCardEntry\nConformedTransactions, SourceSystem lookup(Source == source_system_abbreviation,\n\tmultiple: true,\n\tbroadcast: 'right')~> SourceSystemKeyTransform\nnotExistsCardEntry filter(!isNull(CardEntryMethodCode)) ~> removenullCardEntry\nSourceSystemKeyTransform derive(CardEntryMethodHashkey = crc32(iif(isNull(CardEntryMethodCode),'',CardEntryMethodCode)\r\n, iif(isNull(source_system_key),0,source_system_key))) ~> CreateCardEntryMethodHashkey\nremovenullCardEntry derive(create_date = currentTimestamp()) ~> GetCreateDate\nGetCreateDate sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tcard_entry_key as long,\n\t\tsource_system_key as integer,\n\t\tcard_entry_cde as string,\n\t\tcard_entry_name as string,\n\t\tcard_entry_type as string,\n\t\tload_date as date,\n\t\tcreate_date as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tcard_entry_key = CardEntryMethodHashkey,\n\t\tsource_system_key,\n\t\tcard_entry_cde = CardEntryMethodCode,\n\t\tload_date = importFileDate,\n\t\tcreate_date\n\t)) ~> DimCardEntry"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/populate_FactTransactions')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "Facts"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "src_cnfmFISTransactions",
                                "type": "DatasetReference"
                            },
                            "name": "Transactions"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Source_System",
                                "type": "DatasetReference"
                            },
                            "name": "dimSourceSystem"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_BIN",
                                "type": "DatasetReference"
                            },
                            "name": "srcDimBin"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "fact_Transaction",
                                "type": "DatasetReference"
                            },
                            "name": "FactTransaction",
                            "description": "Need to fix the settltment date mapping"
                        },
                        {
                            "dataset": {
                                "referenceName": "populate_AuditTransactionsLog",
                                "type": "DatasetReference"
                            },
                            "name": "AuditLog"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "LookupSourceSystem"
                        },
                        {
                            "name": "HashKeys"
                        },
                        {
                            "name": "LoweredColumns"
                        },
                        {
                            "name": "AuditColumns"
                        },
                        {
                            "name": "Distinct"
                        },
                        {
                            "name": "FilterLoadDate"
                        },
                        {
                            "name": "RankImportDates"
                        },
                        {
                            "name": "JoinBIN"
                        },
                        {
                            "name": "SelectBin"
                        },
                        {
                            "name": "filterTopRankedBINs"
                        },
                        {
                            "name": "distinctAcctNum"
                        },
                        {
                            "name": "selectFinalBIN"
                        },
                        {
                            "name": "joinFinalBIN"
                        },
                        {
                            "name": "filterNullAcct"
                        },
                        {
                            "name": "RankTopBIN"
                        }
                    ],
                    "script": "parameters{\n\tfileName as string,\n\trun_id as string\n}\nsource(output(\n\t\tAccountNumber as string,\n\t\tAcquirerAccountNumber as string,\n\t\tAcquirerNetworkCode as string,\n\t\tBin_ISO as string,\n\t\tBin_EXT as string,\n\t\tCardEntryMethodCode as string,\n\t\tCardPresenceDescription as string,\n\t\tImportFileDate as date,\n\t\tSource as string,\n\t\tInterchangeAmount as float,\n\t\tIssuerAccountNumber as string,\n\t\tIssuerNetworkCode as string,\n\t\tMerchantName as string,\n\t\tMerchantType as string,\n\t\tMonetary as integer,\n\t\tOnUsDescription as string,\n\t\tOriginalDataTransmissionDate as date,\n\t\tOriginDate as date,\n\t\tRecurringDescription as string,\n\t\tResponseCode as string,\n\t\tSettlementAmount as float,\n\t\tSettlementDate as date,\n\t\tSurchargeAmount as float,\n\t\tTerminalAddress as string,\n\t\tTerminalCity as string,\n\t\tTerminalCountry as string,\n\t\tTerminalKey as string,\n\t\tTerminalState as string,\n\t\tTerminalZipCode as string,\n\t\tTokenRequestId as string,\n\t\tTransactionName as string,\n\t\tTransactionTypeCode as string,\n\t\tTransmissionDate as date,\n\t\tTransmissionTime as string,\n\t\tTimeLocalTransaction as string,\n\t\tRetrievalReferenceNumber as string,\n\t\tTransaction_Key as long,\n\t\tAgentNo as string,\n\t\tSystemNo as string,\n\t\tOperCode as string,\n\t\tPrincipalNo as string,\n\t\tAuthorizationNo as string,\n\t\tClientNo as string,\n\t\ttransaction_amount as float,\n\t\tis_authorization as integer,\n\t\tAcquiringRTN as string,\n\t\tSettlementRTN as string,\n\t\tTraceNumber as string,\n\t\tAcqTraceNumber as string,\n\t\tVisaTransactionID as string,\n\t\tMasterCardTransactionID as string,\n\t\tMerchantAccountNumber as string,\n\t\tISOMessageType as string,\n\t\tForwardingRTN as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\trowUrlColumn: 'file_path',\n\tformat: 'parquet') ~> Transactions\nsource(output(\n\t\tsource_system_key as integer,\n\t\tsource_system_name as string,\n\t\tsource_system_description as string,\n\t\tsource_system_abbreviation as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false) ~> dimSourceSystem\nsource(output(\n\t\tbin_key as long,\n\t\tsource_system_key as integer,\n\t\tsource_system_id as string,\n\t\tbankIdentificationNumberISO as string,\n\t\tbankIdentificationNumberEXT as string,\n\t\tbin_type as string,\n\t\tclient_key as long\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false) ~> srcDimBin\nLoweredColumns, dimSourceSystem lookup(Source == source_system_abbreviation,\n\tmultiple: true,\n\tbroadcast: 'right')~> LookupSourceSystem\nLookupSourceSystem derive(card_entry_hash_key = crc32(iif(isNull(CardEntryMethodCode),'',CardEntryMethodCode)\r\n, iif(isNull(source_system_key),0,source_system_key)),\n\t\tpayment_token_hash_key = crc32(iif(isNull(TokenRequestId),'',TokenRequestId)\r\n, iif(isNull(source_system_key),0,source_system_key)),\n\t\tresponse_code_hash_key = crc32(iif(isNull(ResponseCode),'',ResponseCode)\r\n, iif(isNull(source_system_key),0,source_system_key)),\n\t\ttransaction_name_hash_key = crc32(iif(isNull(TransactionName),'',TransactionName)\r\n, iif(isNull(source_system_key),0,source_system_key)),\n\t\tmerchant_type_hash_key = crc32(iif(isNull(MerchantType),'',MerchantType)),\n\t\tacquirer_network_hash_key = crc32(iif(isNull(AcquirerNetworkCode),'',AcquirerNetworkCode)\r\n, iif(isNull(source_system_key),0,source_system_key)),\n\t\tissuer_network_hash_key = crc32(iif(isNull(IssuerNetworkCode),'',IssuerNetworkCode)\r\n, iif(isNull(source_system_key),0,source_system_key)),\n\t\tterminal_hash_key = crc32(iif(isNull(TerminalKey),'',TerminalKey)\r\n, iif(isNull(source_system_key),0,source_system_key)),\n\t\tmerchant_termnial_georgraphy_hash_key = crc32(iif(isNull(TerminalCity),'',TerminalCity)\r\n, iif(isNull(TerminalState),'',TerminalState)\r\n, iif(isNull(TerminalZipCode),'',TerminalZipCode)\r\n, iif(isNull(TerminalCountry),'',TerminalCountry)\r\n, iif(isNull(source_system_key),0,source_system_key)),\n\t\tmerchant_hash_key = crc32(iif(isNull(MerchantName),'',MerchantName)\r\n, iif(isNull(TerminalAddress),'',TerminalAddress)\r\n, iif(isNull(source_system_key),0,source_system_key)),\n\t\trun_id = crc32($run_id)) ~> HashKeys\nTransactions derive(MerchantName = lower(MerchantName),\n\t\tTerminalAddress = lower(TerminalAddress),\n\t\tTerminalCity = lower(TerminalCity),\n\t\tTerminalState = lower(TerminalState),\n\t\tTerminalZipCode = lower(TerminalZipCode),\n\t\tTerminalCountry = lower(TerminalCountry)) ~> LoweredColumns\nHashKeys derive(create_date = currentTimestamp(),\n\t\tfile_name = substring(file_path,26),\n\t\tloaded_to_semantic = toBoolean('n')) ~> AuditColumns\nAuditColumns aggregate(groupBy(run_id,\n\t\tsource_system_key,\n\t\tfile_name,\n\t\tImportFileDate,\n\t\tloaded_to_semantic),\n\tcreate_date_max = max(create_date),\n\t\trecord_count = count()) ~> Distinct\nRankImportDates filter(ranking==1) ~> FilterLoadDate\nDistinct window(over(run_id),\n\tdesc(record_count, false),\n\tranking = rank()) ~> RankImportDates\nfilterNullAcct, SelectBin join(left(AccountNumber,6) == left(bankIdentificationNumberEXT,6)\r\n&&\r\nlike(AccountNumber,bankIdentificationNumberEXT + '%'),\n\tjoinType:'cross',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinBIN\nsrcDimBin select(mapColumn(\n\t\tbin_key,\n\t\tbankIdentificationNumberISO,\n\t\tbankIdentificationNumberEXT\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectBin\nRankTopBIN filter(rownumber_bin_client==1) ~> filterTopRankedBINs\nHashKeys aggregate(groupBy(AccountNumber),\n\tcount = count()) ~> distinctAcctNum\nfilterTopRankedBINs select(mapColumn(\n\t\tAccountNumber_bin = AccountNumber,\n\t\tbin_key\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> selectFinalBIN\nHashKeys, selectFinalBIN join(AccountNumber == AccountNumber_bin,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> joinFinalBIN\ndistinctAcctNum filter(!isNull(AccountNumber)) ~> filterNullAcct\nJoinBIN window(over(AccountNumber),\n\tdesc(bankIdentificationNumberEXT, true),\n\trownumber_bin_client = rowNumber()) ~> RankTopBIN\njoinFinalBIN sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\ttransaction_key as long,\n\t\tsource_system_key as integer,\n\t\tsource_system_id as string,\n\t\taccount_key as string,\n\t\tacquirer_key as long,\n\t\tAcquirer_Network_key as long,\n\t\tbin_key as long,\n\t\tcard_entry_method_code_key as long,\n\t\tcard_presence_desc as string,\n\t\timport_file_date_key as date,\n\t\tinterchange_amount as decimal(25,2),\n\t\tissuer_key as long,\n\t\tissuer_network_key as long,\n\t\tmerchant_key as long,\n\t\tmerchant_terminal_geography_key as long,\n\t\tmerchant_type_key as long,\n\t\tmonetary as boolean,\n\t\ton_us_desc as string,\n\t\ttransmission_date_key as date,\n\t\torigin_date_key as date,\n\t\trecurring_desc as string,\n\t\tresponse_code_key as long,\n\t\tsettlement_amount as decimal(25,2),\n\t\tsettlement_date_key as date,\n\t\tsurcharge_amount as decimal(25,2),\n\t\ttermnial_key as long,\n\t\ttoken_requestid as long,\n\t\ttransaction_name_key as long,\n\t\tTransaction_type_key as long,\n\t\trun_id as long,\n\t\tdigital_card_issued_ind as boolean,\n\t\tauthorization_ind as boolean,\n\t\tauthorization_no as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tsaveOrder: 0,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\ttransaction_key = Transaction_Key,\n\t\tsource_system_key,\n\t\taccount_key = AccountNumber,\n\t\tacquirer_key = AcquirerAccountNumber,\n\t\tAcquirer_Network_key = acquirer_network_hash_key,\n\t\tbin_key,\n\t\tcard_entry_method_code_key = card_entry_hash_key,\n\t\tcard_presence_desc = CardPresenceDescription,\n\t\timport_file_date_key = ImportFileDate,\n\t\tinterchange_amount = InterchangeAmount,\n\t\tissuer_key = IssuerAccountNumber,\n\t\tissuer_network_key = issuer_network_hash_key,\n\t\tmerchant_key = merchant_hash_key,\n\t\tmerchant_terminal_geography_key = merchant_termnial_georgraphy_hash_key,\n\t\tmerchant_type_key = merchant_type_hash_key,\n\t\tmonetary = Monetary,\n\t\ton_us_desc = OnUsDescription,\n\t\ttransmission_date_key = OriginalDataTransmissionDate,\n\t\torigin_date_key = OriginDate,\n\t\trecurring_desc = RecurringDescription,\n\t\tresponse_code_key = response_code_hash_key,\n\t\tsettlement_amount = SettlementAmount,\n\t\tsurcharge_amount = SurchargeAmount,\n\t\ttermnial_key = terminal_hash_key,\n\t\ttoken_requestid = payment_token_hash_key,\n\t\ttransaction_name_key = transaction_name_hash_key,\n\t\tTransaction_type_key = TransactionTypeCode,\n\t\tsettlement_date_key = SettlementDate,\n\t\trun_id,\n\t\tauthorization_ind = is_authorization,\n\t\tauthorization_num = AuthorizationNo\n\t)) ~> FactTransaction\nFilterLoadDate sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\trun_id as long,\n\t\tsource_system_key as integer,\n\t\tfile_name as string,\n\t\trecord_count as long,\n\t\tloaded_to_semantic as boolean,\n\t\tload_date as timestamp,\n\t\tcreate_date as timestamp,\n\t\tsem_start_date as timestamp,\n\t\tsem_end_date as timestamp,\n\t\tsf_loaded_to_semantic as boolean,\n\t\tsf_sem_start_date as timestamp,\n\t\tsf_sem_end_date as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 1,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\trun_id,\n\t\tsource_system_key,\n\t\tfile_name,\n\t\trecord_count,\n\t\tloaded_to_semantic,\n\t\tload_date = ImportFileDate,\n\t\tcreate_date = create_date_max\n\t)) ~> AuditLog"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/update_Interchange')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "Updates the Interchange Amounts in Fact Transactions using 3 days worth of Conformed Transactions and a single Interchange File.",
                "folder": {
                    "name": "Dimensions"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "src_rawInterchangeDaily_All",
                                "type": "DatasetReference"
                            },
                            "name": "srcInterchange"
                        },
                        {
                            "dataset": {
                                "referenceName": "src_cnfm_All",
                                "type": "DatasetReference"
                            },
                            "name": "srcFISConformedTransactions"
                        },
                        {
                            "dataset": {
                                "referenceName": "src_cnfm_All",
                                "type": "DatasetReference"
                            },
                            "name": "srcFISConformedTransactions1"
                        },
                        {
                            "dataset": {
                                "referenceName": "src_cnfm_All",
                                "type": "DatasetReference"
                            },
                            "name": "srcFISConformedTransactions2"
                        },
                        {
                            "dataset": {
                                "referenceName": "populate_AuditTransactionsLog",
                                "type": "DatasetReference"
                            },
                            "name": "dwTransactionAuditLog"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "fact_Transaction",
                                "type": "DatasetReference"
                            },
                            "name": "snkFactTransactions"
                        },
                        {
                            "dataset": {
                                "referenceName": "dwAuditUpdatedTransactions",
                                "type": "DatasetReference"
                            },
                            "name": "snkAuditInterchange"
                        },
                        {
                            "dataset": {
                                "referenceName": "populate_AuditInvalidInterchange",
                                "type": "DatasetReference"
                            },
                            "name": "snkAuditInvalidInterchange"
                        },
                        {
                            "dataset": {
                                "referenceName": "populate_AuditTransactionsLog",
                                "type": "DatasetReference"
                            },
                            "name": "snkAuditTransactionsLog"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "Trim"
                        },
                        {
                            "name": "FilterHeader"
                        },
                        {
                            "name": "LimitSelectInterchange"
                        },
                        {
                            "name": "Transformations"
                        },
                        {
                            "name": "toTimestampTransactions"
                        },
                        {
                            "name": "MarkUpdates"
                        },
                        {
                            "name": "Join"
                        },
                        {
                            "name": "DerivedColumn"
                        },
                        {
                            "name": "Filter2"
                        },
                        {
                            "name": "UnionTransactions"
                        },
                        {
                            "name": "DistinctLoadID"
                        },
                        {
                            "name": "Lookup1"
                        },
                        {
                            "name": "AlterRow1"
                        },
                        {
                            "name": "derivedTransactionLog"
                        }
                    ],
                    "script": "parameters{\n\tload_date as string (substring('FX08303.D200128.CUSA.INTGPULS.ZIP',10,6)),\n\tload_date_1 as string (concat(toString(year(addDays(toDate($load_date,'yyMMdd'),-1))),toString(case(in([10,11,12],month(addDays(toDate($load_date,'yyMMdd'),-1)))==true(),toString(month(addDays(toDate($load_date,'yyMMdd'),-1))),concat('0',toString(month(addDays(toDate($load_date,'yyMMdd'),-1)))))),toString(case(in([1,2,3,4,5,6,7,8,9],dayOfMonth(addDays(toDate($load_date,'yyMMdd'),-1)))==true(),concat('0',toString(dayOfMonth(addDays(toDate($load_date,'yyMMdd'),-1)))),toString(dayOfMonth(addDays(toDate($load_date,'yyMMdd'),-1))))))),\n\tload_date_2 as string (concat(toString(year(addDays(toDate($load_date,'yyMMdd'),-2))),toString(case(in([10,11,12],month(addDays(toDate($load_date,'yyMMdd'),-2)))==true(),toString(month(addDays(toDate($load_date,'yyMMdd'),-2))),concat('0',toString(month(addDays(toDate($load_date,'yyMMdd'),-2)))))),toString(case(in([1,2,3,4,5,6,7,8,9],dayOfMonth(addDays(toDate($load_date,'yyMMdd'),-2)))==true(),concat('0',toString(dayOfMonth(addDays(toDate($load_date,'yyMMdd'),-2)))),toString(dayOfMonth(addDays(toDate($load_date,'yyMMdd'),-2))))))),\n\tfile_name as string ('FX08303.D200128.CUSA.INTGPULS.ZIP')\n}\nsource(output(\n\t\tPAN as string,\n\t\t{SWITCH DATE} as string,\n\t\t{LOCAL DATE} as string,\n\t\t{DEBIT AMOUNT} as string,\n\t\t{CREDIT AMOUNT} as string,\n\t\t{MEMO AMOUNT} as string,\n\t\t{TERMINAL INTERCHANGE FEE} as string,\n\t\tSIGN7 as string,\n\t\t{CARDHOLDER INTERCHANGE FEE} as string,\n\t\tSIGN9 as string,\n\t\tACQ as string,\n\t\tISS as string,\n\t\t{TERM INST} as string,\n\t\t{CARD INST} as string,\n\t\t{TRAN TYPE} as string,\n\t\t{TRAN ID} as string,\n\t\tRRN as string,\n\t\t{SEQ NO} as string,\n\t\t{ACQ/ISS} as string,\n\t\t{ACTION CODE} as string,\n\t\t{TRANSACTION DESCRIPTION} as string,\n\t\t{REV REASON} as string,\n\t\t{REJ REASON} as string,\n\t\t{TRACE DATA} as string,\n\t\tProp_24 as string,\n\t\tProp_25 as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tmoveFiles: [(concat\r\n(\r\n'FIS/Interchange/current/'\r\n,$file_name\r\n,'/')),(concat('FIS/Interchange/20'\r\n, substring($load_date,0,2)\r\n,'/'\r\n,substring($load_date,3,2)\r\n,'/'\r\n,substring($load_date,5,2)\r\n,'/'\r\n,$file_name))],\n\trowUrlColumn: 'file_name',\n\twildcardPaths:[(concat\r\n(\r\n'FIS/Interchange/current/'\r\n,$file_name))]) ~> srcInterchange\nsource(output(\n\t\tAccountNumber as string,\n\t\tAcquirerAccountNumber as string,\n\t\tAcquirerNetworkCode as string,\n\t\tBin_ISO as string,\n\t\tBin_EXT as string,\n\t\tCardEntryMethodCode as string,\n\t\tCardPresenceDescription as string,\n\t\tImportFileDate as date,\n\t\tSource as string,\n\t\tInterchangeAmount as float,\n\t\tIssuerAccountNumber as string,\n\t\tIssuerNetworkCode as string,\n\t\tMerchantName as string,\n\t\tMerchantType as string,\n\t\tMonetary as integer,\n\t\tOnUsDescription as string,\n\t\tOriginalDataTransmissionDate as date,\n\t\tOriginDate as date,\n\t\tRecurringDescription as string,\n\t\tResponseCode as string,\n\t\tSettlementAmount as float,\n\t\tSettlementDate as date,\n\t\tSurchargeAmount as float,\n\t\tTerminalAddress as string,\n\t\tTerminalCity as string,\n\t\tTerminalCountry as string,\n\t\tTerminalKey as string,\n\t\tTerminalState as string,\n\t\tTerminalZipCode as string,\n\t\tTokenRequestId as string,\n\t\tTransactionName as string,\n\t\tTransactionTypeCode as string,\n\t\tTransmissionDate as date,\n\t\tTransmissionTime as string,\n\t\tTimeLocalTransaction as string,\n\t\tRetrievalReferenceNumber as string,\n\t\tTransaction_Key as long,\n\t\tAgentNo as string,\n\t\tAgentBank as string,\n\t\tSystemNo as string,\n\t\tOperCode as string,\n\t\tAuthorizationNo as string,\n\t\tClientNo as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tformat: 'parquet',\n\twildcardPaths:[(concat\r\n(\r\n'Transactions/20'\r\n, substring($load_date,0,2)\r\n,'/'\r\n,substring($load_date,3,2)\r\n,'/'\r\n,substring($load_date,5,2)\r\n,'/FISDebitTransaction_*'\r\n))],\n\tpartitionBy('hash', 15,\n\t\tTransaction_Key\n\t)) ~> srcFISConformedTransactions\nsource(output(\n\t\tAccountNumber as string,\n\t\tAcquirerAccountNumber as string,\n\t\tAcquirerNetworkCode as string,\n\t\tBin_ISO as string,\n\t\tBin_EXT as string,\n\t\tCardEntryMethodCode as string,\n\t\tCardPresenceDescription as string,\n\t\tImportFileDate as date,\n\t\tSource as string,\n\t\tInterchangeAmount as float,\n\t\tIssuerAccountNumber as string,\n\t\tIssuerNetworkCode as string,\n\t\tMerchantName as string,\n\t\tMerchantType as string,\n\t\tMonetary as integer,\n\t\tOnUsDescription as string,\n\t\tOriginalDataTransmissionDate as date,\n\t\tOriginDate as date,\n\t\tRecurringDescription as string,\n\t\tResponseCode as string,\n\t\tSettlementAmount as float,\n\t\tSettlementDate as date,\n\t\tSurchargeAmount as float,\n\t\tTerminalAddress as string,\n\t\tTerminalCity as string,\n\t\tTerminalCountry as string,\n\t\tTerminalKey as string,\n\t\tTerminalState as string,\n\t\tTerminalZipCode as string,\n\t\tTokenRequestId as string,\n\t\tTransactionName as string,\n\t\tTransactionTypeCode as string,\n\t\tTransmissionDate as date,\n\t\tTransmissionTime as string,\n\t\tTimeLocalTransaction as string,\n\t\tRetrievalReferenceNumber as string,\n\t\tTransaction_Key as long,\n\t\tAgentNo as string,\n\t\tAgentBank as string,\n\t\tSystemNo as string,\n\t\tOperCode as string,\n\t\tAuthorizationNo as string,\n\t\tClientNo as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tformat: 'parquet',\n\twildcardPaths:[(concat\r\n(\r\n'Transactions/20'\r\n, substring($load_date_1,3,2)\r\n,'/'\r\n,substring($load_date_1,5,2)\r\n,'/'\r\n,substring($load_date_1,7,2)\r\n)\r\n)],\n\tpartitionBy('hash', 15,\n\t\tTransaction_Key\n\t)) ~> srcFISConformedTransactions1\nsource(output(\n\t\tAccountNumber as string,\n\t\tAcquirerAccountNumber as string,\n\t\tAcquirerNetworkCode as string,\n\t\tBin_ISO as string,\n\t\tBin_EXT as string,\n\t\tCardEntryMethodCode as string,\n\t\tCardPresenceDescription as string,\n\t\tImportFileDate as date,\n\t\tSource as string,\n\t\tInterchangeAmount as float,\n\t\tIssuerAccountNumber as string,\n\t\tIssuerNetworkCode as string,\n\t\tMerchantName as string,\n\t\tMerchantType as string,\n\t\tMonetary as integer,\n\t\tOnUsDescription as string,\n\t\tOriginalDataTransmissionDate as date,\n\t\tOriginDate as date,\n\t\tRecurringDescription as string,\n\t\tResponseCode as string,\n\t\tSettlementAmount as float,\n\t\tSettlementDate as date,\n\t\tSurchargeAmount as float,\n\t\tTerminalAddress as string,\n\t\tTerminalCity as string,\n\t\tTerminalCountry as string,\n\t\tTerminalKey as string,\n\t\tTerminalState as string,\n\t\tTerminalZipCode as string,\n\t\tTokenRequestId as string,\n\t\tTransactionName as string,\n\t\tTransactionTypeCode as string,\n\t\tTransmissionDate as date,\n\t\tTransmissionTime as string,\n\t\tTimeLocalTransaction as string,\n\t\tRetrievalReferenceNumber as string,\n\t\tTransaction_Key as long,\n\t\tAgentNo as string,\n\t\tAgentBank as string,\n\t\tSystemNo as string,\n\t\tOperCode as string,\n\t\tAuthorizationNo as string,\n\t\tClientNo as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tformat: 'parquet',\n\twildcardPaths:[(concat\r\n(\r\n'Transactions/20'\r\n, substring($load_date_2,3,2)\r\n,'/'\r\n,substring($load_date_2,5,2)\r\n,'/'\r\n,substring($load_date_2,7,2)\r\n)\r\n)],\n\tpartitionBy('hash', 15,\n\t\tTransaction_Key\n\t)) ~> srcFISConformedTransactions2\nsource(output(\n\t\trun_id as long,\n\t\tload_date as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'SELECT run_id, load_date\\n  FROM [Audit].[transactions_log] a \\n  INNER JOIN (Select [file_name], max(create_date) as create_date from [Audit].[transactions_log] where source_system_key = 1 and [file_name] like \\'FISDebitTransaction%\\'\\ngroup by [file_name]) b\\n  on a.[file_name] = b.[file_name]\\n  and a.create_date = b.create_date',\n\tformat: 'query',\n\tstaged: false,\n\tpartitionColumn: 'run_id',\n\tpartitionBy('external', 2)) ~> dwTransactionAuditLog\nFilterHeader derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null()))))) ~> Trim\nsrcInterchange filter(PAN!='Prop_0' && PAN!='PAN') ~> FilterHeader\nTrim select(mapColumn(\n\t\tPAN,\n\t\t{SWITCH DATE},\n\t\t{LOCAL DATE},\n\t\t{DEBIT AMOUNT},\n\t\t{CREDIT AMOUNT},\n\t\t{TRAN TYPE},\n\t\tRRN,\n\t\t{TERMINAL INTERCHANGE FEE},\n\t\tSIGN7,\n\t\t{CARDHOLDER INTERCHANGE FEE},\n\t\tSIGN9,\n\t\tfile_name\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> LimitSelectInterchange\nLimitSelectInterchange derive(switch_date = toTimestamp({SWITCH DATE}, 'yyMMddHHmmssSS'),\n\t\tlocal_date = toTimestamp({SWITCH DATE}, 'yyMMddHHmmssSS'),\n\t\tinterchange_real = (iif(SIGN7=='DR', toDecimal(concat('-',{TERMINAL INTERCHANGE FEE})), toDecimal({TERMINAL INTERCHANGE FEE})))\r\n+\r\n(iif(SIGN9=='DR', toDecimal(concat('-',{CARDHOLDER INTERCHANGE FEE})), toDecimal({CARDHOLDER INTERCHANGE FEE}))),\n\t\tdebit_amount = toFloat({DEBIT AMOUNT}),\n\t\tcredit_amount = toFloat({CREDIT AMOUNT}),\n\t\ttran_type = {TRAN TYPE},\n\t\tcreate_date_interchange = currentTimestamp()) ~> Transformations\nUnionTransactions derive(TransmissionDate = toTimestamp(concat(toString(TransmissionDate),TransmissionTime), 'yyyy-MM-ddHH:mm:ss.SSS'),\n\t\tOriginDate = toTimestamp(concat(toString(OriginDate),TimeLocalTransaction), 'yyyy-MM-ddHH:mm:ss.SSS'),\n\t\tsource_system_key = 1) ~> toTimestampTransactions\nJoin alterRow(updateIf(true())) ~> MarkUpdates\ntoTimestampTransactions, Transformations join(PAN == AccountNumber\r\n&&\r\nlocal_date == OriginDate\r\n&&\r\nswitch_date == TransmissionDate\r\n&&\r\n(debit_amount == SettlementAmount || credit_amount == SettlementAmount)\r\n&&\r\ntran_type == TransactionTypeCode\r\n&&\r\nRRN == RetrievalReferenceNumber,\n\tjoinType:'cross',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> Join\nJoin derive(create_date = currentTimestamp(),\n\t\tcolumn_name = 'interchange_amount') ~> DerivedColumn\nTransformations filter(instr(PAN,'XXXX')>0) ~> Filter2\nsrcFISConformedTransactions, srcFISConformedTransactions1, srcFISConformedTransactions2 union(byName: true)~> UnionTransactions\nJoin aggregate(groupBy(ImportFileDate),\n\tcount = count()) ~> DistinctLoadID\nDistinctLoadID, derivedTransactionLog lookup(ImportFileDate == load_date,\n\tmultiple: false,\n\tpickup: 'any',\n\tbroadcast: 'auto')~> Lookup1\nLookup1 alterRow(updateIf(true())) ~> AlterRow1\ndwTransactionAuditLog derive(load_date = toDate(load_date),\n\t\tloaded_to_semantic = false(),\n\t\tsem_start_date = toTimestamp(toString(null())),\n\t\tsem_end_date = toTimestamp(toString(null()))) ~> derivedTransactionLog\nMarkUpdates sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\ttransaction_key as long,\n\t\tsource_system_key as integer,\n\t\tsource_system_id as string,\n\t\taccount_key as string,\n\t\tacquirer_key as long,\n\t\tAcquirer_Network_key as long,\n\t\tbin_key as long,\n\t\tcard_entry_method_code_key as long,\n\t\tcard_presence_desc as string,\n\t\timport_file_date_key as date,\n\t\tinterchange_amount as decimal(25,2),\n\t\tissuer_key as long,\n\t\tissuer_network_key as long,\n\t\tmerchant_key as long,\n\t\tmerchant_terminal_geography_key as long,\n\t\tmerchant_type_key as long,\n\t\tmonetary as boolean,\n\t\ton_us_desc as string,\n\t\ttransmission_date_key as date,\n\t\torigin_date_key as date,\n\t\trecurring_desc as string,\n\t\tresponse_code_key as long,\n\t\tsettlement_amount as decimal(25,2),\n\t\tsettlement_date_key as date,\n\t\tsurcharge_amount as decimal(25,2),\n\t\ttermnial_key as long,\n\t\ttoken_requestid as long,\n\t\ttransaction_name_key as long,\n\t\tTransaction_type_key as long,\n\t\trun_id as long,\n\t\tdigital_card_issued_ind as boolean,\n\t\tauthorization_ind as boolean,\n\t\tauthorization_no as string\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['transaction_key','source_system_key','origin_date_key'],\n\tskipKeyWrites:true,\n\tformat: 'table',\n\tstaged: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 2,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\ttransaction_key = Transaction_Key,\n\t\tsource_system_key,\n\t\torigin_date_key = OriginDate,\n\t\tinterchange_amount = interchange_real\n\t)) ~> snkFactTransactions\nDerivedColumn sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tsource_system_key as integer,\n\t\ttransaction_key as long,\n\t\tcolumn_name as string,\n\t\told_value as string,\n\t\tnew_value as string,\n\t\tload_date as timestamp,\n\t\tcreate_date as timestamp,\n\t\tfile_name as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tbatchSize: 5000,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 3,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tsource_system_key,\n\t\ttransaction_key = Transaction_Key,\n\t\tcolumn_name,\n\t\told_value = InterchangeAmount,\n\t\tnew_value = interchange_real,\n\t\tload_date = ImportFileDate,\n\t\tcreate_date,\n\t\tfile_name\n\t)) ~> snkAuditInterchange\nFilter2 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tROWID as long,\n\t\tPAN as string,\n\t\t{SWITCH DATE} as string,\n\t\t{LOCAL DATE} as string,\n\t\t{DEBIT AMOUNT} as string,\n\t\t{CREDIT AMOUNT} as string,\n\t\t{MEMO AMOUNT} as string,\n\t\t{TERMINAL INTERCHANGE FEE} as string,\n\t\tSIGN7 as string,\n\t\t{CARDHOLDER INTERCHANGE FEE} as string,\n\t\tSIGN9 as string,\n\t\tACQ as string,\n\t\tISS as string,\n\t\t{TERM INST} as string,\n\t\t{CARD INST} as string,\n\t\t{TRAN TYPE} as string,\n\t\t{TRAN ID} as string,\n\t\tRRN as string,\n\t\t{SEQ NO} as string,\n\t\t{ACQ/ISS} as string,\n\t\t{ACTION CODE} as string,\n\t\t{TRANSACTION DESCRIPTION} as string,\n\t\t{REV REASON} as string,\n\t\t{REJ REASON} as string,\n\t\t{TRACE DATA} as string,\n\t\tProp_24 as string,\n\t\tProp_25 as string,\n\t\tfile_name as string,\n\t\tcreate_date as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 1,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tPAN,\n\t\tswitch_date,\n\t\tlocal_date,\n\t\tdebit_amount,\n\t\tcredit_amount,\n\t\ttran_type,\n\t\tRRN,\n\t\tterminal_interchange_fee = {TERMINAL INTERCHANGE FEE},\n\t\tsign7 = SIGN7,\n\t\tcardholder_interchange_fee = {CARDHOLDER INTERCHANGE FEE},\n\t\tsign9 = SIGN9,\n\t\tcreate_date = create_date_interchange,\n\t\tfile_name\n\t)) ~> snkAuditInvalidInterchange\nAlterRow1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\trun_id as long,\n\t\tsource_system_key as integer,\n\t\tfile_name as string,\n\t\trecord_count as long,\n\t\tloaded_to_semantic as boolean,\n\t\tload_date as timestamp,\n\t\tcreate_date as timestamp,\n\t\tsem_start_date as timestamp,\n\t\tsem_end_date as timestamp,\n\t\tsf_loaded_to_semantic as boolean,\n\t\tsf_sem_start_date as timestamp,\n\t\tsf_sem_end_date as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['run_id'],\n\tskipKeyWrites:true,\n\tformat: 'table',\n\tstaged: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 4,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\trun_id,\n\t\tloaded_to_semantic,\n\t\tsem_start_date,\n\t\tsem_end_date\n\t)) ~> snkAuditTransactionsLog"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/FDTransactions')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "FirstData"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "dropZoneTransactions_FD",
                                "type": "DatasetReference"
                            },
                            "name": "MonetaryDetailTransactions"
                        },
                        {
                            "dataset": {
                                "referenceName": "src_stgCCUMSTR",
                                "type": "DatasetReference"
                            },
                            "name": "CCUMSTR"
                        },
                        {
                            "dataset": {
                                "referenceName": "FDTransactionCriteria",
                                "type": "DatasetReference"
                            },
                            "name": "FDCriteria"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "snk_cnfmFISTransactions",
                                "type": "DatasetReference"
                            },
                            "name": "sink1"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "BaseTransformations"
                        },
                        {
                            "name": "Trim"
                        },
                        {
                            "name": "Join1"
                        },
                        {
                            "name": "Join2"
                        },
                        {
                            "name": "Filter"
                        },
                        {
                            "name": "HashAndNullTxnName"
                        },
                        {
                            "name": "LimitSelect"
                        },
                        {
                            "name": "Dedupe"
                        },
                        {
                            "name": "Join3"
                        },
                        {
                            "name": "TrimCriteria"
                        },
                        {
                            "name": "TrimCCUMSTR"
                        }
                    ],
                    "script": "parameters{\n\tfileName as string\n}\nsource(output(\n\t\tTransactions_ID as string,\n\t\tReportDate as string,\n\t\tCreditUnion as string,\n\t\tRDT_CHD_ACCOUNT_NUMBER as string,\n\t\tRDT_ENTRY_TYPE as string,\n\t\tRDT_ENTRY_SYS_4 as string,\n\t\tRDT_ENTRY_SYS_2 as string,\n\t\tRDT_ENTRY_DATE as string,\n\t\tRDT_ENTRY_2 as string,\n\t\tRDT_ENTRY_LAST_6 as string,\n\t\tRDT_RUN_SEQ_NO as string,\n\t\tRTI_REG_INDUSTRY_TRAN_ID as string,\n\t\tRDT_TRANSACTION_AMOUNT as string,\n\t\tRDT_TRANSACTION_DATE as string,\n\t\tSQLDLOG_JobID as string,\n\t\tRDT_REC_CODE_KEY as string,\n\t\tRDT_REC_TYPE_CONTROL as string,\n\t\tRDT_NO_POST_REASON as string,\n\t\tRDT_SC_1 as string,\n\t\tRDT_SC_2 as string,\n\t\tRDT_SC_3 as string,\n\t\tRDT_SC_4 as string,\n\t\tRDT_SC_5 as string,\n\t\tRDT_SC_6 as string,\n\t\tRDT_SC_7 as string,\n\t\tRDT_SC_8 as string,\n\t\tRDT_CHD_SYSTEM_NO as string,\n\t\tRDT_CHD_PRIN_BANK as string,\n\t\tRDT_CHD_AGENT_BANK as string,\n\t\tRDT_TRANSACTION_CODE as string,\n\t\tRDT_MRCH_SYSTEM_NO as string,\n\t\tRDT_MRCH_PRIN_BANK as string,\n\t\tRDT_MRCH_AGENT_NO as string,\n\t\tRDT_MRCH_ACCOUNT_NUMBER as string,\n\t\tRDT_CHD_EXT_STATUS as string,\n\t\tRDT_CHD_INT_STATUS as string,\n\t\tRDT_TANI as string,\n\t\tRDT_TRANSFER_FLAG as string,\n\t\tRDT_ITEM_ASSES_CODE_NUM as string,\n\t\tRDT_MRCH_SIC_CODE as string,\n\t\tRDT_BATCH_TYPE as string,\n\t\tRDT_JULIAN_POST_DATE as string,\n\t\tRDT_BKDT_ADDITIONAL_INT as string,\n\t\tRDT_BACKDATED_TRAN_FLAG as string,\n\t\tRDT_CBRN_TRAN_ID as string,\n\t\tRDT_AUDIT_TRAIL_DATE as string,\n\t\tRDT_AUTHORIZATION_NO as string,\n\t\tRDT_MERCHANT_NAME as string,\n\t\tRDT_MERCHANT_CITY as string,\n\t\tRDT_MERCHANT_STATE as string,\n\t\tRDT_COFF_PRIN_PAID as string,\n\t\tRDT_COFF_INT_PAID as string,\n\t\tRDT_SSR_IN as string,\n\t\tRDT_ITEM_ADDITIONAL_AMT as string,\n\t\tRDT_BACK_PMT_ITEM_DATE as string,\n\t\tRDT_ADDTL_DESCRIPTION_FLAG as string,\n\t\tRDT_ENTERED_CHD_ACCT_NO as string,\n\t\tRDT_FLOAT_IND as string,\n\t\tRDT_REBATE_ADDITIONAL_AMT as string,\n\t\tRDT_REVERSAL_IND as string,\n\t\tRDT_FRGN_CURR_CODE as string,\n\t\tRDT_FGN_TRAN_AMT as string,\n\t\tRDT_VIC_PROC_DATE as string,\n\t\tRDT_ATM_FLAG as string,\n\t\tRDT_CARD_ACTV_TERM as string,\n\t\tRDT_AUTH_SOURCE as string,\n\t\tRDT_PREPAID_CARD_IND as string,\n\t\tRDT_BATCH_TYPE_FOR_SORT as string,\n\t\tRDT_AUTH_NUMBER as string,\n\t\tRDT_DEBIT_CARD_SWITCH as string,\n\t\tRDT_LOYALTY_MRCH_TYPE as string,\n\t\tRDT_BKDT_CTD_INT as string,\n\t\tRDT_RIS_IND as string,\n\t\tRDT_MRCH_RIS_IND as string,\n\t\tRDT_MAIL_PHONE_IND as string,\n\t\tRDT_FLOOR_LIMIT_IND as string,\n\t\tRDT_CWB_CRB_IND as string,\n\t\tRDT_LCS_IND as string,\n\t\tRDT_OVLMT_FEE_NET as string,\n\t\tRDT_NET_ITEM_CHG_CHNG as string,\n\t\tRDT_COFF_REASON as string,\n\t\tRDT_MEMBER_ID as string,\n\t\tRDT_DEBIT_PRODUCT_CODE as string,\n\t\tRDT_PROD_DATE as string,\n\t\tRDT_SEQ_NO as string,\n\t\tRDT_PLUS_ADJ_IND as string,\n\t\tRDT_TYPE_TRANS as string,\n\t\tRDT_RETAIL_SW as string,\n\t\tRDT_CARD_ACCEPTOR_CODE as string,\n\t\tRDT_YYMM_EXPIRE_DATE as string,\n\t\tRDT_RETAIL_FLAP_ID as string,\n\t\tRDT_AIRLINE_DATA_FLAG as string,\n\t\tRDT_TERM_ID as string,\n\t\tRDT_OPER_CODE as string,\n\t\tRDT_BATCH_TYPE2_FOR_SORT as string,\n\t\tRDT_MATCHING_AUTH_IND as string,\n\t\tRDT_BACKDATED_PYMT as string,\n\t\tRDT_USED_OTHR_RCRD as string,\n\t\tRDT_EMPL_ACCT_CD as string,\n\t\tRDT_USAV_OFFR_CD as string,\n\t\tRDT_TRMN_OWNR_ID as string,\n\t\tRDT_TRNS_PRCS_DATA_TX as string,\n\t\tRDT_TRN_286_SPCL_MRCH_DSCR_CD as string,\n\t\tRDT_RWRD_ID as string,\n\t\tRDT_HKBK_FMLY_CARD_CD as string,\n\t\tRDT_ANN_FEE_TRAN_CD as string,\n\t\tRDT_TOTL_DFP_AM as string,\n\t\tRDT_TRAN_GROUP_ID as string,\n\t\tRDT_IVA_TAX_AMOUNT as string,\n\t\tRDT_US_EQUIV_AMT as string,\n\t\tRDT_CURR_MARKUP_FEE as string,\n\t\tRDT_DETAIL_FLAP_DSPLY_IND as string,\n\t\tRDT_FLAP_DETAIL_DSPLY_IND as string,\n\t\tRDT_FLAP_PROMOTION_ID as string,\n\t\tRDT_TERMS_CODE as string,\n\t\tRDT_DEPT_CODE as string,\n\t\tRDT_BTCH_MTCH_CD as string,\n\t\tRDT_ACCT_MRKT_STRT_NM as string,\n\t\tRDT_SUB_ACCT_CD as string,\n\t\tRDT_ORGN_ACCT_NR as string,\n\t\tRDT_CONTROL_NUMBER as string,\n\t\tRDT_ADDL_SEGS_NO as string,\n\t\tRDT_ACCT_CARD_NUMBER as string,\n\t\tRDT_MRCH_SPEC_FLAG_CD as string,\n\t\tRDT_MRCH_DPST_CD as string,\n\t\tRDT_MULT_PURS_ID as string,\n\t\tRDT_TAX_EXMP_TOTL_AM as string,\n\t\tRDT_TDA_TRAN_CPTR_CD as string,\n\t\tRDT_PRCN_STGY_ID as string,\n\t\tRDT_CLNT_ID as string,\n\t\tRDT_LANG_CD as string,\n\t\tRDT_TRAN_ENTR_DT as string,\n\t\tRDT_TRAN_THRS_DT as string,\n\t\tRDT_CLNT_DFND_CARD_TYPE_ID as string,\n\t\tRDT_ITEM_FEE_TEXT_ID as string,\n\t\tRDT_PRMT_ITEM_FEE_MTHD_ID as string,\n\t\tRDT_MTP_DCRM_CD as string,\n\t\tRDT_DFP_CD as string,\n\t\tRDT_CENTURY_JULIAN_POST_DATE as string,\n\t\tRDT_LS_IVA_AM as string,\n\t\tRDT_TLF_MTHD_NM as string,\n\t\tRDT_ADJ_ORGN_TRAN_DT as string,\n\t\tREG_SEGMENT_CODE as string,\n\t\tRTI_REG_TRAN_ID_SOURCE as string,\n\t\tRTI_REG_MISC_AMOUNT as string,\n\t\tRTI_REG_TICKET_AUTH_AMOUNT as string,\n\t\tRTI_REG_BNK_RFRN_ID as string,\n\t\tRTI_REG_ORIG_TRAN_ID as string,\n\t\tRTI_REG_CARD_INPUT_MODE_CD as string,\n\t\tOTI_SEGMENT_CODE as string,\n\t\tOTI_ORIGINAL_REF_NO as string,\n\t\tOTI_ORIGINAL_POST_DATE as string,\n\t\tOTI_ORIGINAL_ADJ_TRAN_DT as string,\n\t\tAPR_SEGMENT_CODE as string,\n\t\tAPR_EAPR_CASH_INT as string,\n\t\tAPR_EAPR_MRCH_INT as string,\n\t\tAPR_EAPR_CASH_ITEM_CHG as string,\n\t\tAPR_EAPR_MRCH_ITEM_CHG as string,\n\t\tAPR_EAPR_LATE_CHG as string,\n\t\tAPR_EAPR_OVLM_CHG as string,\n\t\tAPR2_SEGMENT_CODE as string,\n\t\tAPR2_EAPR_MIN_CHG as string,\n\t\tAPR2_EAPR_STMT_CHG as string,\n\t\tAPR2_EAPR_CR_LIFE_CHG as string,\n\t\tAPR2_EAPR_REBATE_AMT as string,\n\t\tAPR2_EAPR_MIN_FINC_CASH_AM as string,\n\t\tAPR2_EAPR_MXCP_CRDT_AM as string,\n\t\tDFP_SEGMENT_CODE as string,\n\t\tRDT_DFP_FEE_NM as string,\n\t\tRDT_DFP_FEE_AM as string,\n\t\tRDT_DFP_PSTN_BCKT_ID as string,\n\t\tRDT_DFP_MMB_CD as string,\n\t\tRDT_DFP_RCUR_ID as string,\n\t\tRDT_DFP_LTTR_IN as string,\n\t\tRDT_DFP_MEMO_IN as string,\n\t\tRDT_DFP_BTCH_ALPH_CD as string,\n\t\tRDT_DFP_EMBD_IN as string,\n\t\tRDT_DFP_RESN_CD as string,\n\t\tRDT_DFP_STMT_PSTN_CD as string,\n\t\tRDT_DFP_RPT_CD as string,\n\t\tRDT_DFP_DYNM_FEE_GNRC_CD as string,\n\t\tRDT_DETL_ICHG_FEE_AM as string,\n\t\tRDT_POS_ENTR_MODE_CD as string,\n\t\tRDT_PI_TYPE_CD as string,\n\t\tRDT_ILR_IN as string,\n\t\tRDT_FEE_ATTRIBUTE as string,\n\t\tRDT_TKN_CDT as string,\n\t\tRDT_TKN_SRVC_NMBR_ID as string,\n\t\tRDT_WLLT_ID as string,\n\t\tRDT_TKN_RQST_ID as string,\n\t\tRDT_TKN_FILLER as string,\n\t\tRDT_GNRC_TRAN_FLD_SEG_CD as string,\n\t\tRDT_CARD_ACCP_TERM_ID as string,\n\t\tRDT_MRCH_FULL_ZIP_CD as string,\n\t\tRDT_GTF_FILLER as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> MonetaryDetailTransactions\nsource(output(\n\t\tSPAIdentifier as string,\n\t\tsys as string,\n\t\tprin as string,\n\t\tagent as string,\n\t\tcu_odindx as string,\n\t\tcardtyp as string,\n\t\tInterestRate as string,\n\t\tAnnualFee as string,\n\t\tOverlimitFee as string,\n\t\tLateFee as string,\n\t\tCwbFee as string,\n\t\tAutoDQFee as string,\n\t\tGroupNo as string,\n\t\tGroupDesc as string,\n\t\tItemizedPerAcct as string,\n\t\tPrimaryBillingSys as string,\n\t\tPlatform as string,\n\t\tSPA as string,\n\t\tDateProcessed as string,\n\t\tStatus as string,\n\t\tUniversalAddressing as string,\n\t\tSeparateEntityFlag as string,\n\t\tInternationalDateFormat as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> CCUMSTR\nsource(output(\n\t\tTransactionCriteriaID as string,\n\t\tFD_Source_System_Key as string,\n\t\tTransactionName as string,\n\t\tBINType as string,\n\t\tTransactionCode as string,\n\t\tResponseCodeOperator as string,\n\t\tResponseCode as string,\n\t\tMerchantTypeOperator as string,\n\t\tMerchantType as string,\n\t\tPOSEntryCode as string,\n\t\tNetworkID as string,\n\t\tReferenceNumberOperator as string,\n\t\tReferenceNumber as string,\n\t\tAuthorizationResponseOperator as string,\n\t\tAuthorizationResponse as string,\n\t\tAuthorizationType as string,\n\t\tReasonCodeOperator as string,\n\t\tReasonCode as string,\n\t\tCreateDate as string,\n\t\tAuthorizationTypeOperator as string,\n\t\tAcctNumMerchNumMatchInd as string,\n\t\tOperatorCodeOperator as string,\n\t\tOperatorCode as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> FDCriteria\nTrim derive(OriginDate_DateID = toDate(RDT_TRANSACTION_DATE,'yyMMdd'),\n\t\tDateExpiration_DateID = toDate(RDT_TRANSACTION_DATE),\n\t\tDateSettlement_DateID = toDate(ReportDate),\n\t\tOriginalDataTransmission_DateID = toDate(OriginalDataTransmission_DateID_S),\n\t\tAccountID = RDT_CHD_ACCOUNT_NUMBER,\n\t\tISOBIN = substring(RDT_CHD_ACCOUNT_NUMBER,1,6),\n\t\tIssuer_ClientID = 'UNK',\n\t\tTransactionNameID = RDT_TRANSACTION_CODE,\n\t\tPOSConditionID = case(left(RDT_CHD_ACCOUNT_NUMBER,1)=='2'||left(RDT_CHD_ACCOUNT_NUMBER,1)=='4'||left(RDT_CHD_ACCOUNT_NUMBER,1)=='5',RDT_MAIL_PHONE_IND,''),\n\t\tAcquirerNetworkID = 'UNK',\n\t\tTransactionTypeID = RDT_TRANSACTION_CODE,\n\t\tCardEntryMethodID = RDT_POS_ENTR_MODE_CD,\n\t\tMerchantID = RDT_MERCHANT_NAME,\n\t\tTerminalCity = RDT_MERCHANT_CITY,\n\t\tTerminalState = RDT_MERCHANT_STATE,\n\t\tTerminalZipCode = '',\n\t\tTerminalCountry = case(RDT_MERCHANT_STATE=='AA'||RDT_MERCHANT_STATE=='AE'||RDT_MERCHANT_STATE=='AK'||RDT_MERCHANT_STATE=='AL'||RDT_MERCHANT_STATE=='AP'||RDT_MERCHANT_STATE=='AR'||RDT_MERCHANT_STATE=='AS'||RDT_MERCHANT_STATE=='AZ'||RDT_MERCHANT_STATE=='CA'||RDT_MERCHANT_STATE=='CO'||RDT_MERCHANT_STATE=='CT'||RDT_MERCHANT_STATE=='DC'||RDT_MERCHANT_STATE=='DE'||RDT_MERCHANT_STATE=='FL'||RDT_MERCHANT_STATE=='FM'||RDT_MERCHANT_STATE=='GA'||RDT_MERCHANT_STATE=='GU'||RDT_MERCHANT_STATE=='HI'||RDT_MERCHANT_STATE=='IA'||RDT_MERCHANT_STATE=='ID'||RDT_MERCHANT_STATE=='IL'||RDT_MERCHANT_STATE=='IN'||RDT_MERCHANT_STATE=='KS'||RDT_MERCHANT_STATE=='KY'||RDT_MERCHANT_STATE=='LA'||RDT_MERCHANT_STATE=='MA'||RDT_MERCHANT_STATE=='MD'||RDT_MERCHANT_STATE=='ME'||RDT_MERCHANT_STATE=='MH'||RDT_MERCHANT_STATE=='MI'||RDT_MERCHANT_STATE=='MN'||RDT_MERCHANT_STATE=='MO'||RDT_MERCHANT_STATE=='MP'||RDT_MERCHANT_STATE=='MS'||RDT_MERCHANT_STATE=='MT'||RDT_MERCHANT_STATE=='NC'||RDT_MERCHANT_STATE=='ND'||RDT_MERCHANT_STATE=='NE'||RDT_MERCHANT_STATE=='NH'||RDT_MERCHANT_STATE=='NJ'||RDT_MERCHANT_STATE=='NM'||RDT_MERCHANT_STATE=='NV'||RDT_MERCHANT_STATE=='NY'||RDT_MERCHANT_STATE=='OH'||RDT_MERCHANT_STATE=='OK'||RDT_MERCHANT_STATE=='OR'||RDT_MERCHANT_STATE=='PA'||RDT_MERCHANT_STATE=='PR'||RDT_MERCHANT_STATE=='PW'||RDT_MERCHANT_STATE=='RI'||RDT_MERCHANT_STATE=='SC'||RDT_MERCHANT_STATE=='SD'||RDT_MERCHANT_STATE=='TN'||RDT_MERCHANT_STATE=='TX'||RDT_MERCHANT_STATE=='UT'||RDT_MERCHANT_STATE=='VI'||RDT_MERCHANT_STATE=='VT'||RDT_MERCHANT_STATE=='WA'||RDT_MERCHANT_STATE=='WI'||RDT_MERCHANT_STATE=='WV'||RDT_MERCHANT_STATE=='WY'||RDT_MERCHANT_STATE=='','USA',RDT_MERCHANT_STATE),\n\t\tResponseCodeID = '00',\n\t\tTransactionCount = 1,\n\t\tInterchangeAmount = toFloat(RDT_DETL_ICHG_FEE_AM)*-1.00,\n\t\tCashBackAmount = 0.00,\n\t\tSurchargeAmount = toFloat(0.00),\n\t\tSettlementAmount = toFloat(RDT_TRANSACTION_AMOUNT),\n\t\tExceptionAmount = '',\n\t\tSwitchDate = toDate(OriginalDataTransmission_DateID_S),\n\t\tCardAcceptor = RDT_CARD_ACCEPTOR_CODE,\n\t\tIssuerRTN = '',\n\t\tAcquirer_ClientID = 'UNK',\n\t\tBINEXT = RDT_CHD_ACCOUNT_NUMBER,\n\t\tCardPrescenceDescription = case(RDT_MRCH_SIC_CODE=='6011'\r\n||(RDT_MRCH_SIC_CODE=='6010'&& RDT_TRANSACTION_CODE=='271')\r\n||(RDT_POS_ENTR_MODE_CD == '00'&& left(RDT_CHD_ACCOUNT_NUMBER,1) == '4'&&(RDT_MAIL_PHONE_IND==''||RDT_MAIL_PHONE_IND=='0'))\r\n||(RDT_POS_ENTR_MODE_CD == '01'&& left(RDT_CHD_ACCOUNT_NUMBER,1) == '4'&&(RDT_MAIL_PHONE_IND==''||RDT_MAIL_PHONE_IND=='0'))\r\n||(RDT_POS_ENTR_MODE_CD == ''&& left(RDT_CHD_ACCOUNT_NUMBER,1) == '4'&&(RDT_MAIL_PHONE_IND==''||RDT_MAIL_PHONE_IND=='0'))\r\n||(RDT_POS_ENTR_MODE_CD == '00'&& (left(RDT_CHD_ACCOUNT_NUMBER,1) == '5'||left(RDT_CHD_ACCOUNT_NUMBER,1) == '2')&&(RTI_REG_CARD_INPUT_MODE_CD==''||RTI_REG_CARD_INPUT_MODE_CD=='0'||RTI_REG_CARD_INPUT_MODE_CD=='B'||RTI_REG_CARD_INPUT_MODE_CD=='A'))\r\n||(RDT_POS_ENTR_MODE_CD == '01'&& (left(RDT_CHD_ACCOUNT_NUMBER,1) == '5'||left(RDT_CHD_ACCOUNT_NUMBER,1) == '2')&&(RTI_REG_CARD_INPUT_MODE_CD==''||RTI_REG_CARD_INPUT_MODE_CD=='0'||RTI_REG_CARD_INPUT_MODE_CD=='B'||RTI_REG_CARD_INPUT_MODE_CD=='A'))\r\n||(RDT_POS_ENTR_MODE_CD == ''&& (left(RDT_CHD_ACCOUNT_NUMBER,1) == '5'||left(RDT_CHD_ACCOUNT_NUMBER,1) == '2')&&(RTI_REG_CARD_INPUT_MODE_CD==''||RTI_REG_CARD_INPUT_MODE_CD=='0'||RTI_REG_CARD_INPUT_MODE_CD=='B'||RTI_REG_CARD_INPUT_MODE_CD=='A'))\r\n||(RDT_POS_ENTR_MODE_CD=='02'||RDT_POS_ENTR_MODE_CD=='05'||RDT_POS_ENTR_MODE_CD=='07'||RDT_POS_ENTR_MODE_CD=='79'||RDT_POS_ENTR_MODE_CD=='80'||RDT_POS_ENTR_MODE_CD=='82'||RDT_POS_ENTR_MODE_CD=='90'||RDT_POS_ENTR_MODE_CD=='91')\r\n,'Card Present','Card Not Present'),\n\t\tsource = 'FD',\n\t\tissuenetwork = 'UNK',\n\t\tmonetary = 1,\n\t\tOnUsDescription = iif(and(RDT_CHD_SYSTEM_NO==RDT_MRCH_SYSTEM_NO, and(RDT_CHD_PRIN_BANK==RDT_MRCH_PRIN_BANK, RDT_CHD_AGENT_BANK==RDT_MRCH_AGENT_NO)),'On Us','Foreign'),\n\t\tRecurringDescription = case(left(RDT_CHD_ACCOUNT_NUMBER,1) == '4'&&RDT_MAIL_PHONE_IND =='2','Recurring','Not Recurring' ),\n\t\tTerminalAddress = case(RDT_MRCH_SIC_CODE =='6011',RDT_MERCHANT_NAME,''),\n\t\tterminalkey = 'UNK',\n\t\tTokenRequestId = iif(length(RDT_TKN_RQST_ID)==11,RDT_TKN_RQST_ID,toString(null())),\n\t\tTransmissionDate = toDate(OriginalDataTransmission_DateID_S),\n\t\tReferenceNumber_tran = RDT_ENTRY_TYPE + RDT_ENTRY_SYS_4 + RDT_ENTRY_SYS_2 + RDT_ENTRY_DATE + RDT_ENTRY_2 + RDT_ENTRY_LAST_6,\n\t\tMerchantType_tran = right('000' + RDT_MRCH_SIC_CODE,4),\n\t\tTransmissionTime = 'UNK',\n\t\tTimeLocalTransaction = 'UNK',\n\t\tis_authorization = 0,\n\t\tAcquiringRTN = 'UNK',\n\t\tSettlementRTN = 'UNK',\n\t\tForwardingRTN = 'UNK',\n\t\tTraceNumber = 'UNK',\n\t\tAcqTraceNumber = 'UNK',\n\t\tVisaTransactionID = 'UNK',\n\t\tMasterCardTransactionID = 'UNK',\n\t\tISOMessageType = 'UNK',\n\t\tOperCode = iif(RDT_OPER_CODE=='',toString(null()),RDT_OPER_CODE)) ~> BaseTransformations\nLimitSelect derive(OriginalDataTransmission_DateID_S = '1900-01-01',\n\t\tImportFileDate = toDate(\r\n     concat(\r\n        iif(substring($fileName,12,1)=='s',substring($fileName,14,4),substring($fileName,13,4))\r\n        ,'-'\r\n        ,iif(substring($fileName,12,1)=='s',substring($fileName,18,2),substring($fileName,17,2))\r\n        ,'-'\r\n        ,iif(substring($fileName,12,1)=='s',substring($fileName,20,2),substring($fileName,19,2))\r\n    )\r\n, 'yyyy-MM-dd'),\n\t\teach(match(type=='string'), $$ = rtrim(ltrim($$)))) ~> Trim\nBaseTransformations, TrimCCUMSTR join(RDT_CHD_SYSTEM_NO == sys\n\t&& RDT_CHD_PRIN_BANK == prin\n\t&& RDT_CHD_AGENT_BANK == agent,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> Join1\nJoin1, TrimCriteria join(Platform == BINType\n\t&& RDT_TRANSACTION_CODE == TransactionCode,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> Join2\nJoin2 filter(FD_Source_System_Key=='3'\r\n&&\r\n(isNull(MerchantType)||MerchantType=='NULL'||\r\n(MerchantTypeOperator=='IN'&&iifNull(locate(MerchantType_tran,MerchantType),0)!=0)||\r\n(MerchantTypeOperator=='NOT IN'&&iifNull(locate(MerchantType_tran,MerchantType),0)==0))\r\n&&\r\n(ReferenceNumber=='NULL'||isNull(ReferenceNumber)\r\n||(ReferenceNumberOperator=='='&&substring(ReferenceNumber_tran,12,2)==ReferenceNumber)\r\n||(ReferenceNumberOperator=='<>'&&substring( ReferenceNumber_tran ,12,2)!=ReferenceNumber))\r\n&&\r\n(isNull(AcctNumMerchNumMatchInd)||AcctNumMerchNumMatchInd=='NULL'\r\n||(AcctNumMerchNumMatchInd=='Y'&&left(RDT_CHD_ACCOUNT_NUMBER,6)==left(RDT_MRCH_ACCOUNT_NUMBER ,6))\r\n||(AcctNumMerchNumMatchInd=='N'&&left(RDT_CHD_ACCOUNT_NUMBER,6)!=left(RDT_MRCH_ACCOUNT_NUMBER ,6)))\r\n&&\r\n(isNull(OperatorCode)||OperatorCode=='NULL'\r\n||(OperatorCodeOperator=='IN'&&iifNull(locate(OperCode,OperatorCode),0)!=0)||\r\n(OperatorCodeOperator=='NOT IN'&&iifNull(locate(OperCode,OperatorCode),0)==0))) ~> Filter\nJoin3 derive(Transaction_Key = crc32(iif(isNull(AccountID),'',AccountID)\r\n, iif(isNull(OriginDate_DateID),'',toString(OriginDate_DateID))\r\n, iif(isNull(DateSettlement_DateID),'',toString(DateSettlement_DateID))\r\n, iif(isNull(RDT_AUTHORIZATION_NO),'',RDT_AUTHORIZATION_NO)\r\n, iif(isNull(TerminalCity),'',TerminalCity)\r\n, iif(isNull(TerminalState),'',TerminalState)\r\n, iif(isNull(RDT_CLNT_ID),'',RDT_CLNT_ID)\r\n, iif(isNull(SettlementAmount),0.00,SettlementAmount)\r\n, 2),\n\t\tTransactionName_final = iif(isNull(TransactionName),'Unknown', TransactionName)) ~> HashAndNullTxnName\nMonetaryDetailTransactions select(mapColumn(\n\t\tTransactions_ID,\n\t\tReportDate,\n\t\tRDT_CHD_ACCOUNT_NUMBER,\n\t\tRDT_ENTRY_TYPE,\n\t\tRDT_ENTRY_SYS_4,\n\t\tRDT_ENTRY_SYS_2,\n\t\tRDT_ENTRY_DATE,\n\t\tRDT_ENTRY_2,\n\t\tRDT_ENTRY_LAST_6,\n\t\tRDT_TRANSACTION_AMOUNT,\n\t\tRDT_TRANSACTION_DATE,\n\t\tRDT_CHD_SYSTEM_NO,\n\t\tRDT_CHD_PRIN_BANK,\n\t\tRDT_CHD_AGENT_BANK,\n\t\tRDT_TRANSACTION_CODE,\n\t\tRDT_MRCH_SYSTEM_NO,\n\t\tRDT_MRCH_PRIN_BANK,\n\t\tRDT_MRCH_AGENT_NO,\n\t\tRDT_MRCH_ACCOUNT_NUMBER,\n\t\tRDT_MRCH_SIC_CODE,\n\t\tRDT_MERCHANT_NAME,\n\t\tRDT_MERCHANT_CITY,\n\t\tRDT_MERCHANT_STATE,\n\t\tRDT_MAIL_PHONE_IND,\n\t\tRDT_POS_ENTR_MODE_CD,\n\t\tRDT_DETL_ICHG_FEE_AM,\n\t\tRDT_CARD_ACCEPTOR_CODE,\n\t\tRTI_REG_CARD_INPUT_MODE_CD,\n\t\tRDT_OPER_CODE,\n\t\tRDT_AUTHORIZATION_NO,\n\t\tRDT_CLNT_ID,\n\t\tRDT_TKN_RQST_ID\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> LimitSelect\nFilter aggregate(groupBy(Transactions_ID),\n\tTransactionName = max(TransactionName)) ~> Dedupe\nJoin1, Dedupe join(Trim@Transactions_ID == Dedupe@Transactions_ID,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> Join3\nFDCriteria derive(each(match(type=='string'), $$ = trim($$))) ~> TrimCriteria\nCCUMSTR derive(each(match(type=='string'), $$ = trim($$))) ~> TrimCCUMSTR\nHashAndNullTxnName sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tAccountNumber as string,\n\t\tAcquirerAccountNumber as string,\n\t\tAcquirerNetworkCode as string,\n\t\tBin_ISO as string,\n\t\tBin_EXT as string,\n\t\tCardEntryMethodCode as string,\n\t\tCardPresenceDescription as string,\n\t\tImportFileDate as date,\n\t\tSource as string,\n\t\tInterchangeAmount as float,\n\t\tIssuerAccountNumber as string,\n\t\tIssuerNetworkCode as string,\n\t\tMerchantName as string,\n\t\tMerchantType as string,\n\t\tMonetary as integer,\n\t\tOnUsDescription as string,\n\t\tOriginalDataTransmissionDate as date,\n\t\tOriginDate as date,\n\t\tRecurringDescription as string,\n\t\tResponseCode as string,\n\t\tSettlementAmount as float,\n\t\tSettlementDate as date,\n\t\tSurchargeAmount as float,\n\t\tTerminalAddress as string,\n\t\tTerminalCity as string,\n\t\tTerminalCountry as string,\n\t\tTerminalKey as string,\n\t\tTerminalState as string,\n\t\tTerminalZipCode as string,\n\t\tTokenRequestId as string,\n\t\tTransactionName as string,\n\t\tTransactionTypeCode as string,\n\t\tTransmissionDate as date,\n\t\tTransmissionTime as string,\n\t\tTimeLocalTransaction as string,\n\t\tRetrievalReferenceNumber as string,\n\t\tTransaction_Key as long,\n\t\tAgentNo as string,\n\t\tSystemNo as string,\n\t\tOperCode as string,\n\t\tPrincipalNo as string,\n\t\tAuthorizationNo as string,\n\t\tClientNo as string,\n\t\ttransaction_amount as float,\n\t\tis_authorization as integer,\n\t\tAcquiringRTN as string,\n\t\tSettlementRTN as string,\n\t\tTraceNumber as string,\n\t\tAcqTraceNumber as string,\n\t\tVisaTransactionID as string,\n\t\tMasterCardTransactionID as string,\n\t\tMerchantAccountNumber as string,\n\t\tISOMessageType as string,\n\t\tForwardingRTN as string\n\t),\n\tformat: 'parquet',\n\tpartitionFileNames:[($fileName)],\n\tumask: 0022,\n\tpreCommands: [],\n\tpostCommands: [],\n\tmapColumn(\n\t\tAccountNumber = AccountID,\n\t\tAcquirerAccountNumber = Acquirer_ClientID,\n\t\tAcquirerNetworkCode = AcquirerNetworkID,\n\t\tBin_ISO = ISOBIN,\n\t\tBin_EXT = BINEXT,\n\t\tCardEntryMethodCode = RDT_POS_ENTR_MODE_CD,\n\t\tCardPresenceDescription = CardPrescenceDescription,\n\t\tImportFileDate,\n\t\tSource = source,\n\t\tInterchangeAmount,\n\t\tIssuerAccountNumber = Issuer_ClientID,\n\t\tIssuerNetworkCode = issuenetwork,\n\t\tMerchantName = RDT_MERCHANT_NAME,\n\t\tMerchantType = MerchantType_tran,\n\t\tMonetary = monetary,\n\t\tOnUsDescription,\n\t\tOriginalDataTransmissionDate = OriginalDataTransmission_DateID,\n\t\tOriginDate = OriginDate_DateID,\n\t\tRecurringDescription,\n\t\tResponseCode = ResponseCodeID,\n\t\tSettlementAmount,\n\t\tSettlementDate = DateSettlement_DateID,\n\t\tSurchargeAmount,\n\t\tTerminalAddress,\n\t\tTerminalCity,\n\t\tTerminalCountry,\n\t\tTerminalKey = terminalkey,\n\t\tTerminalState,\n\t\tTerminalZipCode,\n\t\tTokenRequestId,\n\t\tTransactionName = TransactionName_final,\n\t\tTransactionTypeCode = TransactionTypeID,\n\t\tTransmissionDate,\n\t\tTransmissionTime,\n\t\tTimeLocalTransaction,\n\t\tRetrievalReferenceNumber = ReferenceNumber_tran,\n\t\tTransaction_Key,\n\t\tAgentNo = RDT_CHD_AGENT_BANK,\n\t\tSystemNo = RDT_CHD_SYSTEM_NO,\n\t\tOperCode,\n\t\tPrincipalNo = RDT_CHD_PRIN_BANK,\n\t\tAuthorizationNo = RDT_AUTHORIZATION_NO,\n\t\tClientNo = RDT_CLNT_ID,\n\t\ttransaction_amount = RDT_TRANSACTION_AMOUNT,\n\t\tis_authorization,\n\t\tTraceNumber,\n\t\tAcqTraceNumber,\n\t\tVisaTransactionID,\n\t\tMasterCardTransactionID,\n\t\tMerchantAccountNumber = RDT_MRCH_ACCOUNT_NUMBER,\n\t\tISOMessageType,\n\t\tForwardingRTN\n\t),\n\tpartitionBy('hash', 1)) ~> sink1"
                }
            },
            "dependsOn": []
        }
    ]
}