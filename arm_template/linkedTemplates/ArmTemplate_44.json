{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "factoryName": {
            "type": "string",
            "metadata": "Data Factory name",
            "defaultValue": "EnterpriseDataSourceProdDF"
        }
    },
    "variables": {
        "factoryId": "[concat('Microsoft.DataFactory/factories/', parameters('factoryName'))]"
    },
    "resources": [
        {
            "name": "[concat(parameters('factoryName'), '/MEMBERS')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "Zelle/DropToDW"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "dropZoneTransactions_ZelleMembers",
                                "type": "DatasetReference"
                            },
                            "name": "MEMBERSSource"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "zelle_memebr_raw",
                                "type": "DatasetReference"
                            },
                            "name": "memberraw"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "AddingFilenameColumn"
                        }
                    ],
                    "script": "parameters{\n\tfileName as string\n}\nsource(output(\n\t\tBR_ID as string,\n\t\tMEM_ID as string,\n\t\tBRMEMTYP_SHORT_NAME as string,\n\t\tSEC_LOGIN_ID as string,\n\t\tMEM_LAST_NAME as string,\n\t\tMEM_FIRST_NAME as string,\n\t\tMEM_MID_NAME as string,\n\t\tMEM_ADDR1 as string,\n\t\tMEM_ADDR2 as string,\n\t\tMEM_CITY as string,\n\t\tMEM_STATE as string,\n\t\tMEM_ZIP as string,\n\t\tCT_3CHAR_NAME as string,\n\t\tBRSVC_SHORT_NAME as string,\n\t\tMKTPR_SHORT_NAME as string,\n\t\tMKTPR_KEY as string,\n\t\tMEMSTA_SHORT_NAME as string,\n\t\tMEDIA_SHORT_NAME as string,\n\t\tTRACK_DESC as string,\n\t\tMEM_CREATE_DATE as string,\n\t\tREW_PR_STRING2 as string,\n\t\tMEM_MODIFIED_DATE as string,\n\t\tMEM_DATEOFBIRTH as string,\n\t\tEMAIL_FORMAT as string,\n\t\tMEM_TC_ACCEPTED_DATE as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> MEMBERSSource\nMEMBERSSource derive(File_Name = $fileName) ~> AddingFilenameColumn\nAddingFilenameColumn sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tBR_ID as integer,\n\t\tMEM_ID as integer,\n\t\tBRMEMTYP_SHORT_NAME as string,\n\t\tSEC_LOGIN_ID as string,\n\t\tMEM_LAST_NAME as string,\n\t\tMEM_FIRST_NAME as string,\n\t\tMEM_MID_NAME as string,\n\t\tMEM_ADDR1 as string,\n\t\tMEM_ADDR2 as string,\n\t\tMEM_CITY as string,\n\t\tMEM_STATE as string,\n\t\tMEM_ZIP as string,\n\t\tCT_3CHAR_NAME as string,\n\t\tBRSVC_SHORT_NAME as string,\n\t\tMKTPR_SHORT_NAME as string,\n\t\tMKTPR_KEY as string,\n\t\tMEMSTA_SHORT_NAME as string,\n\t\tMEDIA_SHORT_NAME as string,\n\t\tTRACK_DESC as string,\n\t\tMEM_CREATE_DATE as string,\n\t\tREW_PR_STRING2 as string,\n\t\tMEM_MODIFIED_DATE as string,\n\t\tMEM_DATEOFBIRTH as string,\n\t\tEMAIL_FORMAT as string,\n\t\tMEM_TC_ACCEPTED_DATE as string,\n\t\tFile_Name as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tBR_ID,\n\t\tMEM_ID,\n\t\tBRMEMTYP_SHORT_NAME,\n\t\tSEC_LOGIN_ID,\n\t\tMEM_LAST_NAME,\n\t\tMEM_FIRST_NAME,\n\t\tMEM_MID_NAME,\n\t\tMEM_ADDR1,\n\t\tMEM_ADDR2,\n\t\tMEM_CITY,\n\t\tMEM_STATE,\n\t\tMEM_ZIP,\n\t\tCT_3CHAR_NAME,\n\t\tBRSVC_SHORT_NAME,\n\t\tMKTPR_SHORT_NAME,\n\t\tMKTPR_KEY,\n\t\tMEMSTA_SHORT_NAME,\n\t\tMEDIA_SHORT_NAME,\n\t\tTRACK_DESC,\n\t\tMEM_CREATE_DATE,\n\t\tREW_PR_STRING2,\n\t\tMEM_MODIFIED_DATE,\n\t\tMEM_DATEOFBIRTH,\n\t\tEMAIL_FORMAT,\n\t\tMEM_TC_ACCEPTED_DATE,\n\t\tFile_Name\n\t)) ~> memberraw"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/Shared_Branch')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "Shared Branch/DropToDW"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "Raw_Transactions_meta_SharedBranch_parameter",
                                "type": "DatasetReference"
                            },
                            "name": "SBSource"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "shared_branch_raw",
                                "type": "DatasetReference"
                            },
                            "name": "SBDWRaw"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "AddingColumn"
                        }
                    ],
                    "script": "parameters{\n\tfileName as string\n}\nsource(output(\n\t\tColumn_1 as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> SBSource\nSBSource derive(File_name = $fileName) ~> AddingColumn\nAddingColumn sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tFile_name as string,\n\t\tData_f as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tFile_name,\n\t\tData_f = Column_1\n\t),\n\tpartitionBy('hash', 1)) ~> SBDWRaw"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/OracleDynamicTables')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "FIS/SharedBranch"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "src_Copy_Oracle",
                                "type": "DatasetReference"
                            },
                            "name": "OracleDataFile"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "AzureSqlTable_AutoCreate",
                                "type": "DatasetReference"
                            },
                            "name": "AutoCreateTable"
                        }
                    ],
                    "transformations": [],
                    "script": "source(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> OracleDataFile\nOracleDataFile sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError') ~> AutoCreateTable"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/SharedBranch_LoadFisDataRaw1')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "FIS/SharedBranch"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "all_dzOracleSBTransactions1",
                                "type": "DatasetReference"
                            },
                            "name": "SharedBranchDailyFile"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "FIS_DATA_RAW1",
                                "type": "DatasetReference"
                            },
                            "name": "FisDataRaw"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "GetRawData"
                        },
                        {
                            "name": "SortDataBeforeInsert"
                        },
                        {
                            "name": "OnlyPassColumnForInsert"
                        }
                    ],
                    "script": "source(output(\n\t\tColumn_1 as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\trowUrlColumn: 'FileName',\n\tskipLines: 1) ~> SharedBranchDailyFile\nSharedBranchDailyFile derive(ID = substring(Column_1,1,2),\n\t\tTRX_COUNT = substring(Column_1,3,7),\n\t\tDATA = substring(Column_1,10,80),\n\t\tFileName = FileName,\n\t\tFileDate = substring(FileName,22,2)+'20'+'/'+substring(FileName,24,2)+'/'+substring(FileName,26,2)) ~> GetRawData\nOnlyPassColumnForInsert sort(asc(TRX_COUNT, false),\n\tasc(ID, false)) ~> SortDataBeforeInsert\nGetRawData select(mapColumn(\n\t\tTRX_COUNT,\n\t\tID,\n\t\tDATA,\n\t\tFileName,\n\t\tFileDate\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> OnlyPassColumnForInsert\nSortDataBeforeInsert sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tID as string,\n\t\tTRX_COUNT as string,\n\t\tDATA as string,\n\t\tFILENAME as string,\n\t\tFILEDATE as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\ttruncate:true,\n\tformat: 'table',\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 1,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tID,\n\t\tTRX_COUNT,\n\t\tDATA,\n\t\tFILENAME = FileName,\n\t\tFILEDATE = FileDate\n\t)) ~> FisDataRaw"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/SharedBranch_LoadFisDataRaw2')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "FIS/SharedBranch"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "all_dzOracleSBTransactions2",
                                "type": "DatasetReference"
                            },
                            "name": "SharedBranchDailyFile"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "FIS_DATA_RAW2",
                                "type": "DatasetReference"
                            },
                            "name": "FisDataRaw"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "GetRawData"
                        },
                        {
                            "name": "SortDataBeforeInsert"
                        },
                        {
                            "name": "OnlyPassColumnForInsert"
                        }
                    ],
                    "script": "source(output(\n\t\tColumn_1 as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\trowUrlColumn: 'FileName',\n\tskipLines: 1) ~> SharedBranchDailyFile\nSharedBranchDailyFile derive(ID = substring(Column_1,1,2),\n\t\tTRX_COUNT = substring(Column_1,3,7),\n\t\tDATA = substring(Column_1,10,80),\n\t\tFileName = FileName,\n\t\tFileDate = substring(FileName,22,2)+'20'+'/'+substring(FileName,24,2)+'/'+substring(FileName,26,2)) ~> GetRawData\nOnlyPassColumnForInsert sort(asc(TRX_COUNT, false),\n\tasc(ID, false)) ~> SortDataBeforeInsert\nGetRawData select(mapColumn(\n\t\tTRX_COUNT,\n\t\tID,\n\t\tDATA,\n\t\tFileName,\n\t\tFileDate\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> OnlyPassColumnForInsert\nSortDataBeforeInsert sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tID as string,\n\t\tTRX_COUNT as string,\n\t\tDATA as string,\n\t\tFILENAME as string,\n\t\tFILEDATE as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\ttruncate:true,\n\tformat: 'table',\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 1,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tID,\n\t\tTRX_COUNT,\n\t\tDATA,\n\t\tFILENAME = FileName,\n\t\tFILEDATE = FileDate\n\t)) ~> FisDataRaw"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/populate_DD553RawtoDW')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "FirstData"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "src_drpDD553",
                                "type": "DatasetReference"
                            },
                            "name": "srcDD553Drop"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "DD553_RAW",
                                "type": "DatasetReference"
                            },
                            "name": "snkDD553Raw"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "SurrogateKey1"
                        }
                    ],
                    "script": "source(output(\n\t\tColumn_1 as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\trowUrlColumn: 'file_name',\n\tpartitionBy('hash', 1)) ~> srcDD553Drop\nsrcDD553Drop keyGenerate(output(ROWID as long),\n\tstartAt: 1L,\n\tstepValue: 1L) ~> SurrogateKey1\nSurrogateKey1 sink(allowSchemaDrift: true,\n\tvalidateSchema: true,\n\tinput(\n\t\tRowId as integer,\n\t\tmessage as string,\n\t\tFileName as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\ttruncate:true,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tRowId = ROWID,\n\t\tmessage = Column_1,\n\t\tFileName = file_name\n\t),\n\tpartitionBy('hash', 1)) ~> snkDD553Raw"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/SharedBranch_LoadFisDataRaw')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "FIS/SharedBranch"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "all_dzOracleSBTransactions",
                                "type": "DatasetReference"
                            },
                            "name": "SharedBranchDailyFile"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "FIS_DATA_RAW",
                                "type": "DatasetReference"
                            },
                            "name": "FisDataRaw"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "GetRawData"
                        },
                        {
                            "name": "SortDataBeforeInsert"
                        },
                        {
                            "name": "OnlyPassColumnForInsert"
                        }
                    ],
                    "script": "source(output(\n\t\tColumn_1 as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\trowUrlColumn: 'FileName',\n\tskipLines: 1) ~> SharedBranchDailyFile\nSharedBranchDailyFile derive(ID = substring(Column_1,1,2),\n\t\tTRX_COUNT = substring(Column_1,3,7),\n\t\tDATA = substring(Column_1,10,80),\n\t\tFileName = FileName,\n\t\tFileDate = '20'+substring(FileName,22,2)+'/'+substring(FileName,24,2)+'/'+substring(FileName,26,2)) ~> GetRawData\nOnlyPassColumnForInsert sort(asc(TRX_COUNT, false),\n\tasc(ID, false)) ~> SortDataBeforeInsert\nGetRawData select(mapColumn(\n\t\tTRX_COUNT,\n\t\tID,\n\t\tDATA,\n\t\tFileName,\n\t\tFileDate\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> OnlyPassColumnForInsert\nSortDataBeforeInsert sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tID as string,\n\t\tTRX_COUNT as string,\n\t\tDATA as string,\n\t\tFILENAME as string,\n\t\tFILEDATE as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\ttruncate:true,\n\tformat: 'table',\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 1,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tID,\n\t\tTRX_COUNT,\n\t\tDATA,\n\t\tFILENAME = FileName,\n\t\tFILEDATE = FileDate\n\t)) ~> FisDataRaw"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/update_DD553Mapping')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "FirstData"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "DD553_FORMATTED",
                                "type": "DatasetReference"
                            },
                            "name": "DD553F"
                        },
                        {
                            "dataset": {
                                "referenceName": "src_cnfm_All",
                                "type": "DatasetReference"
                            },
                            "name": "Transactions1"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Merchant_Type",
                                "type": "DatasetReference"
                            },
                            "name": "dwDimMerchantType"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Network",
                                "type": "DatasetReference"
                            },
                            "name": "dwDimNetwork"
                        },
                        {
                            "dataset": {
                                "referenceName": "src_cnfm_All",
                                "type": "DatasetReference"
                            },
                            "name": "Transactions2"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Card_Entry_Method",
                                "type": "DatasetReference"
                            },
                            "name": "dwDimCardEntry"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Terminal",
                                "type": "DatasetReference"
                            },
                            "name": "dwDimTerminal"
                        },
                        {
                            "dataset": {
                                "referenceName": "populate_AuditTransactionsLog",
                                "type": "DatasetReference"
                            },
                            "name": "TransactionsLog"
                        },
                        {
                            "dataset": {
                                "referenceName": "src_stgCCUMSTR",
                                "type": "DatasetReference"
                            },
                            "name": "CCUMSTR"
                        },
                        {
                            "dataset": {
                                "referenceName": "FDTransactionCriteria",
                                "type": "DatasetReference"
                            },
                            "name": "FDCriteria"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "fact_Transaction",
                                "type": "DatasetReference"
                            },
                            "name": "snkFactTransactions"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Merchant_Type",
                                "type": "DatasetReference"
                            },
                            "name": "snkNewMerchantType"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Network",
                                "type": "DatasetReference"
                            },
                            "name": "snkNewNetworks"
                        },
                        {
                            "dataset": {
                                "referenceName": "DD553_FORMATTED",
                                "type": "DatasetReference"
                            },
                            "name": "snkDD553Processed"
                        },
                        {
                            "dataset": {
                                "referenceName": "dwAuditUpdatedTransactions",
                                "type": "DatasetReference"
                            },
                            "name": "snkAuditUpdatedTransactions"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Card_Entry_Method",
                                "type": "DatasetReference"
                            },
                            "name": "snkNewCardEntry"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Terminal",
                                "type": "DatasetReference"
                            },
                            "name": "snkNewTerminalKey"
                        },
                        {
                            "dataset": {
                                "referenceName": "populate_AuditTransactionsLog",
                                "type": "DatasetReference"
                            },
                            "name": "snkTransactionLog"
                        },
                        {
                            "dataset": {
                                "referenceName": "dwAuditUpdatedTransactions",
                                "type": "DatasetReference"
                            },
                            "name": "snkAuditUpdatedTransactions2"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "LimitSelectTransactions1"
                        },
                        {
                            "name": "LimitSelectDD553"
                        },
                        {
                            "name": "BaseTransformation"
                        },
                        {
                            "name": "JoinTransactions"
                        },
                        {
                            "name": "Trim"
                        },
                        {
                            "name": "SelectUpdate"
                        },
                        {
                            "name": "HashKeysAndDates"
                        },
                        {
                            "name": "Update1"
                        },
                        {
                            "name": "Exists1"
                        },
                        {
                            "name": "Exists2"
                        },
                        {
                            "name": "Select1"
                        },
                        {
                            "name": "Unpivot1"
                        },
                        {
                            "name": "LimitSelectTransactions2"
                        },
                        {
                            "name": "UnionTransactions"
                        },
                        {
                            "name": "DerivedColumn2"
                        },
                        {
                            "name": "Exists3"
                        },
                        {
                            "name": "Exists4"
                        },
                        {
                            "name": "DistinctLoadDate"
                        },
                        {
                            "name": "Lookup1"
                        },
                        {
                            "name": "DerivedTransactionsLog"
                        },
                        {
                            "name": "AlterRow1"
                        },
                        {
                            "name": "DistinctTerminals"
                        },
                        {
                            "name": "DistinctCardEntry"
                        },
                        {
                            "name": "DistinctAcqNetworks"
                        },
                        {
                            "name": "DistinctMerchantType"
                        },
                        {
                            "name": "FinalTransactions"
                        },
                        {
                            "name": "Filter"
                        },
                        {
                            "name": "TrimCCUMSTR"
                        },
                        {
                            "name": "TrimCriteria"
                        },
                        {
                            "name": "JoinCCUMSTR"
                        },
                        {
                            "name": "JoinCriteria"
                        },
                        {
                            "name": "FilterCriteria"
                        },
                        {
                            "name": "DedupeTxnName"
                        },
                        {
                            "name": "JoinDedupeTxnName"
                        },
                        {
                            "name": "HashTxnName"
                        },
                        {
                            "name": "SelectTxnName"
                        },
                        {
                            "name": "Select2"
                        },
                        {
                            "name": "DerivedColumn3"
                        },
                        {
                            "name": "deriveATMIndicator"
                        }
                    ],
                    "script": "parameters{\n\tfile_name as string\n}\nsource(output(\n\t\tHDR_RDF_RCRD_ID as string,\n\t\tHDR_RDF_CLNT_N as integer,\n\t\tHDR_RDF_CYCL_DT as integer,\n\t\tHDR_RDF_RUN_DT as integer,\n\t\tHDR_RDF_RUN_TM as integer,\n\t\tRDF_RCRD_ID as string,\n\t\tRDF_ENTERED_ID as string,\n\t\tRDF_TRAN_DT as string,\n\t\tRDF_TRAN_AMT as string,\n\t\tRDF_TRAN_CUR as string,\n\t\tRDF_BIN_NO as string,\n\t\tRDF_MERCH_ACCT_NO as string,\n\t\tRDF_MCC as string,\n\t\tRDF_ACQR_FRDAB as string,\n\t\tRDF_ATERM_ID as string,\n\t\tRDF_TERM_SEQ_NO as string,\n\t\tRDF_FDR_TRAN_ID as string,\n\t\tRDF_TRAN_TM as string,\n\t\tRDF_STTL_AM as string,\n\t\tRDF_STTL_CUR as string,\n\t\tRDF_MRCH_NM as string,\n\t\tRDF_ACQR_NTWK_ID as string,\n\t\tRDF_ISSR_FRDABA as string,\n\t\tRDF_STERM_ID as string,\n\t\tRDF_SWTC_SEQ_NO as integer,\n\t\tRDF_REF_NO as string,\n\t\tRDF_STTL_DT as string,\n\t\tRDF_SURCHARGE_AM as string,\n\t\tRDF_STTL_CNVR_RT as string,\n\t\tRDF_MRCH_ADDR as string,\n\t\tRDF_ISS_NTWK_ID as string,\n\t\tRDF_POS_ENTRY_MD as string,\n\t\tRDF_PRCSR_ID as string,\n\t\tRDF_POS_CNDN_CD as string,\n\t\tRDF_FROM_ACCT_NO as string,\n\t\tRDF_FROM_ACCT_TYPE as string,\n\t\tRDF_MSSG_CD as string,\n\t\tRDF_PRCS_CD as string,\n\t\tRDF_AUTH_CD as string,\n\t\tRDF_MRCH_CITY as string,\n\t\tRDF_MRCH_ST as string,\n\t\tRDF_ADJ_TRAN_AMT as string,\n\t\tRDF_PIN_VRFY_RSPN_CD as string,\n\t\tRDF_ADJ_TRAN_FEE as string,\n\t\tRDF_TO_ACCT_NO as string,\n\t\tRDF_TO_ACCT_TYPE as string,\n\t\tRDF_ADVC_RVRS_RSN_CD as string,\n\t\tRDF_LINE_ID as string,\n\t\tRDF_FDR_TRAC_NO as string,\n\t\tRDF_ADJ_STTL_AMT as string,\n\t\tRDF_ADJ_STTL_FEE as string,\n\t\tRDF_ACCT_TYP_CD_1 as string,\n\t\tRDF_AM_TYP_CD_1 as string,\n\t\tRDF_CRRN_CD_1 as string,\n\t\tRDF_ADDT_AM_CD_1 as string,\n\t\tRDF_ADDT_AM_1 as string,\n\t\tRDF_ACCT_TYP_CD_2 as string,\n\t\tRDF_AM_TYP_CD_2 as string,\n\t\tRDF_CRRN_CD_2 as string,\n\t\tRDF_ADDT_AM_CD_2 as string,\n\t\tRDF_ADDT_AM_2 as string,\n\t\tRDF_ACCT_TYP_CD_3 as string,\n\t\tRDF_AM_TYP_CD_3 as string,\n\t\tRDF_CRRN_CD_3 as string,\n\t\tRDF_ADDT_AM_CD_3 as string,\n\t\tRDF_ADDT_AM_3 as string,\n\t\tRDF_ACCT_TYP_CD_4 as string,\n\t\tRDF_AM_TYP_CD_4 as string,\n\t\tRDF_CRRN_CD_4 as string,\n\t\tRDF_ADDT_AM_CD_4 as string,\n\t\tRDF_ADDT_AM_4 as string,\n\t\tRDF_ACCT_TYP_CD_5 as string,\n\t\tRDF_AM_TYP_CD_5 as string,\n\t\tRDF_CRRN_CD_5 as string,\n\t\tRDF_ADDT_AM_CD_5 as string,\n\t\tRDF_ADDT_AM_5 as string,\n\t\tRDF_ACCT_TYP_CD_6 as string,\n\t\tRDF_AM_TYP_CD_6 as string,\n\t\tRDF_CRRN_CD_6 as string,\n\t\tRDF_ADDT_AM_CD_6 as string,\n\t\tRDF_ADDT_AM_6 as string,\n\t\tRDF_LOG_TM as string,\n\t\tRDF_SYS_TM as string,\n\t\tRDF_LOG_DT as string,\n\t\tRDF_EXP_DT as string,\n\t\tRDF_SETTL_FEE_AM as string,\n\t\tFileName as string,\n\t\tProcessed as boolean,\n\t\tROWID as long\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'Select * FROM [Staging].[DD553_FORMATTED] where Processed = 0',\n\tformat: 'query',\n\tstaged: false) ~> DD553F\nsource(output(\n\t\tAccountNumber as string,\n\t\tAcquirerAccountNumber as string,\n\t\tAcquirerNetworkCode as string,\n\t\tBin_ISO as string,\n\t\tBin_EXT as string,\n\t\tCardEntryMethodCode as string,\n\t\tCardPresenceDescription as string,\n\t\tImportFileDate as date,\n\t\tSource as string,\n\t\tInterchangeAmount as float,\n\t\tIssuerAccountNumber as string,\n\t\tIssuerNetworkCode as string,\n\t\tMerchantName as string,\n\t\tMerchantType as string,\n\t\tMonetary as integer,\n\t\tOnUsDescription as string,\n\t\tOriginalDataTransmissionDate as date,\n\t\tOriginDate as date,\n\t\tRecurringDescription as string,\n\t\tResponseCode as string,\n\t\tSettlementAmount as float,\n\t\tSettlementDate as date,\n\t\tSurchargeAmount as float,\n\t\tTerminalAddress as string,\n\t\tTerminalCity as string,\n\t\tTerminalCountry as string,\n\t\tTerminalKey as string,\n\t\tTerminalState as string,\n\t\tTerminalZipCode as string,\n\t\tTokenRequestId as string,\n\t\tTransactionName as string,\n\t\tTransactionTypeCode as string,\n\t\tTransmissionDate as date,\n\t\tTransmissionTime as string,\n\t\tTimeLocalTransaction as string,\n\t\tRetrievalReferenceNumber as string,\n\t\tTransaction_Key as long,\n\t\tAgentNo as string,\n\t\tSystemNo as string,\n\t\tOperCode as string,\n\t\tPrincipalNo as string,\n\t\tAuthorizationNo as string,\n\t\tClientNo as string,\n\t\ttransaction_amount as float,\n\t\tis_authorization as integer,\n\t\tAcquiringRTN as string,\n\t\tSettlementRTN as string,\n\t\tTraceNumber as string,\n\t\tAcqTraceNumber as string,\n\t\tVisaTransactionID as string,\n\t\tMasterCardTransactionID as string,\n\t\tMerchantAccountNumber as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tformat: 'parquet',\n\twildcardPaths:[(concat('Transactions/20',substring($file_name,14,2),'/',substring($file_name,10,2),'/*/Transactions_*')\r\n)]) ~> Transactions1\nsource(output(\n\t\tmerchant_type_key as long,\n\t\tmerchant_type as string,\n\t\tmerchant_group as string,\n\t\tmerchant_category_code_name as string,\n\t\tmerchant_category_group as string,\n\t\ttransaction_type as string,\n\t\tload_date as date,\n\t\tcreate_date as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false,\n\tpartitionColumn: 'merchant_type_key',\n\tpartitionBy('external', 5)) ~> dwDimMerchantType\nsource(output(\n\t\tnetwork_key as long,\n\t\tsource_system_key as integer,\n\t\tnetwork_id as string,\n\t\tnetwork_desc as string,\n\t\tnetwork_name_normalized as string,\n\t\tload_date as date,\n\t\tcreate_date as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false,\n\tpartitionColumn: 'network_key',\n\tpartitionBy('external', 2)) ~> dwDimNetwork\nsource(output(\n\t\tAccountNumber as string,\n\t\tAcquirerAccountNumber as string,\n\t\tAcquirerNetworkCode as string,\n\t\tBin_ISO as string,\n\t\tBin_EXT as string,\n\t\tCardEntryMethodCode as string,\n\t\tCardPresenceDescription as string,\n\t\tImportFileDate as date,\n\t\tSource as string,\n\t\tInterchangeAmount as float,\n\t\tIssuerAccountNumber as string,\n\t\tIssuerNetworkCode as string,\n\t\tMerchantName as string,\n\t\tMerchantType as string,\n\t\tMonetary as integer,\n\t\tOnUsDescription as string,\n\t\tOriginalDataTransmissionDate as date,\n\t\tOriginDate as date,\n\t\tRecurringDescription as string,\n\t\tResponseCode as string,\n\t\tSettlementAmount as float,\n\t\tSettlementDate as date,\n\t\tSurchargeAmount as float,\n\t\tTerminalAddress as string,\n\t\tTerminalCity as string,\n\t\tTerminalCountry as string,\n\t\tTerminalKey as string,\n\t\tTerminalState as string,\n\t\tTerminalZipCode as string,\n\t\tTokenRequestId as string,\n\t\tTransactionName as string,\n\t\tTransactionTypeCode as string,\n\t\tTransmissionDate as date,\n\t\tTransmissionTime as string,\n\t\tTimeLocalTransaction as string,\n\t\tRetrievalReferenceNumber as string,\n\t\tTransaction_Key as long,\n\t\tAgentNo as string,\n\t\tSystemNo as string,\n\t\tOperCode as string,\n\t\tPrincipalNo as string,\n\t\tAuthorizationNo as string,\n\t\tClientNo as string,\n\t\ttransaction_amount as float,\n\t\tis_authorization as integer,\n\t\tAcquiringRTN as string,\n\t\tSettlementRTN as string,\n\t\tTraceNumber as string,\n\t\tAcqTraceNumber as string,\n\t\tVisaTransactionID as string,\n\t\tMasterCardTransactionID as string,\n\t\tMerchantAccountNumber as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tformat: 'parquet',\n\twildcardPaths:[(concat('Transactions/20'\r\n,case(substring($file_name,10,2)=='01',toString(toInteger(substring($file_name,14,2))-1),substring($file_name,14,2))\r\n,'/'\r\n,substring(toString(addMonths(toDate(substring($file_name,10),'MMddyy'),-1)),6,2)\r\n,'/*/Transactions_*'))]) ~> Transactions2\nsource(output(\n\t\tcard_entry_key as long,\n\t\tsource_system_key as integer,\n\t\tcard_entry_cde as string,\n\t\tcard_entry_name as string,\n\t\tcard_entry_type as string,\n\t\tload_date as date,\n\t\tcreate_date as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false,\n\tpartitionColumn: 'card_entry_key',\n\tpartitionBy('external', 2)) ~> dwDimCardEntry\nsource(output(\n\t\tatm_terminal_key as long,\n\t\tsource_system_key as integer,\n\t\tterminal_key as string,\n\t\tclient_key as long,\n\t\tcoop_atm_indicator as boolean,\n\t\ton_premise_indicator as boolean,\n\t\tload_date as date,\n\t\tmodified_date as date,\n\t\tcreate_date as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false,\n\tpartitionColumn: 'atm_terminal_key',\n\tpartitionBy('external', 10)) ~> dwDimTerminal\nsource(output(\n\t\trun_id as long,\n\t\tload_date as timestamp,\n\t\tsf_loaded_to_semantic as boolean,\n\t\tsf_sem_start_date as timestamp,\n\t\tsf_sem_end_date as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'SELECT run_id, load_date, sf_loaded_to_semantic, sf_sem_start_date, sf_sem_end_date\\n  FROM [Audit].[transactions_log] a \\n  INNER JOIN (Select [file_name], max(create_date) as create_date from [Audit].[transactions_log] where source_system_key = 2 and [file_name] like \\'Transaction%\\'\\ngroup by [file_name]) b\\n  on a.[file_name] = b.[file_name]\\n  and a.create_date = b.create_date',\n\tformat: 'query',\n\tstaged: false) ~> TransactionsLog\nsource(output(\n\t\tSPAIdentifier as string,\n\t\tsys as string,\n\t\tprin as string,\n\t\tagent as string,\n\t\tcu_odindx as string,\n\t\tcardtyp as string,\n\t\tInterestRate as string,\n\t\tAnnualFee as string,\n\t\tOverlimitFee as string,\n\t\tLateFee as string,\n\t\tCwbFee as string,\n\t\tAutoDQFee as string,\n\t\tGroupNo as string,\n\t\tGroupDesc as string,\n\t\tItemizedPerAcct as string,\n\t\tPrimaryBillingSys as string,\n\t\tPlatform as string,\n\t\tSPA as string,\n\t\tDateProcessed as string,\n\t\tStatus as string,\n\t\tUniversalAddressing as string,\n\t\tSeparateEntityFlag as string,\n\t\tInternationalDateFormat as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> CCUMSTR\nsource(output(\n\t\tTransactionCriteriaID as string,\n\t\tFD_Source_System_Key as string,\n\t\tTransactionName as string,\n\t\tBINType as string,\n\t\tTransactionCode as string,\n\t\tResponseCodeOperator as string,\n\t\tResponseCode as string,\n\t\tMerchantTypeOperator as string,\n\t\tMerchantType as string,\n\t\tPOSEntryCode as string,\n\t\tNetworkID as string,\n\t\tReferenceNumberOperator as string,\n\t\tReferenceNumber as string,\n\t\tAuthorizationResponseOperator as string,\n\t\tAuthorizationResponse as string,\n\t\tAuthorizationType as string,\n\t\tReasonCodeOperator as string,\n\t\tReasonCode as string,\n\t\tCreateDate as string,\n\t\tAuthorizationTypeOperator as string,\n\t\tAcctNumMerchNumMatchInd as string,\n\t\tOperatorCodeOperator as string,\n\t\tOperatorCode as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> FDCriteria\nTransactions1 select(mapColumn(\n\t\tTransaction_Key,\n\t\tAccountNumber,\n\t\tSettlementAmount,\n\t\tOriginDate,\n\t\tSettlementDate,\n\t\tImportFileDate,\n\t\tTerminalCity,\n\t\tTerminalState,\n\t\tAuthorizationNo,\n\t\tClientNo,\n\t\tTransactionTypeCode,\n\t\tSystemNo,\n\t\tPrincipalNo,\n\t\tAgentNo,\n\t\tRetrievalReferenceNumber,\n\t\tMerchantAccountNumber,\n\t\tTransactionName_original = TransactionName,\n\t\tOperCode\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> LimitSelectTransactions1\nTrim select(mapColumn(\n\t\tHDR_RDF_CYCL_DT,\n\t\tRDF_ENTERED_ID,\n\t\tRDF_TRAN_AMT,\n\t\tRDF_TRAN_DT,\n\t\tRDF_AUTH_CD,\n\t\tRDF_MRCH_CITY,\n\t\tRDF_MRCH_ST,\n\t\tHDR_RDF_CLNT_N,\n\t\tRDF_ACQR_NTWK_ID,\n\t\tRDF_MCC,\n\t\tRDF_POS_ENTRY_MD,\n\t\tRDF_ATERM_ID,\n\t\tRDF_MRCH_ADDR,\n\t\tROWID,\n\t\tFileName\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> LimitSelectDD553\nLimitSelectDD553 derive(RDF_TRAN_AMT = toFloat(concat(left(RDF_TRAN_AMT,1),substring(RDF_TRAN_AMT,2,11),'.',substring(RDF_TRAN_AMT,13,2))),\n\t\tRDF_TRAN_DT = toDate(RDF_TRAN_DT,'MM/dd/yy'),\n\t\tHDR_RDF_CLNT_N = toString(HDR_RDF_CLNT_N),\n\t\tHDR_RDF_CYCL_DT = toDate(toString(HDR_RDF_CYCL_DT),'yyyyMMdd'),\n\t\tsource_system_key = 2,\n\t\tRDF_MRCH_CITY = upper(RDF_MRCH_CITY),\n\t\tRDF_MRCH_ST = upper(RDF_MRCH_ST)) ~> BaseTransformation\nBaseTransformation, FinalTransactions join(RDF_ENTERED_ID==AccountNumber\r\n&&\r\n(RDF_TRAN_DT==OriginDate || HDR_RDF_CYCL_DT==OriginDate||HDR_RDF_CYCL_DT==ImportFileDate)\r\n&&\r\nRDF_TRAN_AMT==SettlementAmount\r\n&&\r\niif(RDF_MRCH_CITY==TerminalCity,RDF_MRCH_CITY==TerminalCity,true())\r\n&&\r\niif(RDF_MRCH_ST==TerminalState,RDF_MRCH_ST==TerminalState,true())\r\n&&\r\nHDR_RDF_CLNT_N==ClientNo,\n\tjoinType:'cross',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinTransactions\nDD553F derive(each(match(type=='string'), $$ = trim($$))) ~> Trim\nFilter select(mapColumn(\n\t\tAccountNumber,\n\t\tRDF_ACQR_NTWK_ID,\n\t\tRDF_MCC,\n\t\tRDF_POS_ENTRY_MD,\n\t\tRDF_ATERM_ID,\n\t\tRDF_MRCH_ADDR,\n\t\tTransaction_Key,\n\t\tsource_system_key,\n\t\tOriginDate,\n\t\tHDR_RDF_CYCL_DT,\n\t\tROWID,\n\t\tFileName,\n\t\tRDF_TRAN_DT,\n\t\tTransactionTypeCode,\n\t\tSystemNo,\n\t\tPrincipalNo,\n\t\tAgentNo,\n\t\tRetrievalReferenceNumber,\n\t\tMerchantAccountNumber,\n\t\tTransactionName_original,\n\t\tOperCode\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectUpdate\nSelectUpdate derive(acquirer_network_hash = crc32(iif(isNull(RDF_ACQR_NTWK_ID),'',RDF_ACQR_NTWK_ID)\r\n, iif(isNull(source_system_key),0,source_system_key)),\n\t\tmerchant_type_hash = crc32(iif(isNull(RDF_MCC),'',RDF_MCC)),\n\t\tcard_entry_code_hash = crc32(iif(isNull(RDF_POS_ENTRY_MD),'',RDF_POS_ENTRY_MD)\r\n, iif(isNull(source_system_key),0,source_system_key)),\n\t\tterminal_key_hash = crc32(iif(isNull(RDF_ATERM_ID),'',RDF_ATERM_ID)\r\n, iif(isNull(source_system_key),0,source_system_key)),\n\t\tcreate_date = currentTimestamp(),\n\t\tprocessed = toBoolean('y')) ~> HashKeysAndDates\nHashTxnName alterRow(updateIf(true())) ~> Update1\nDistinctMerchantType, dwDimMerchantType exists(merchant_type_hash == merchant_type_key,\n\tnegate:true,\n\tbroadcast: 'auto')~> Exists1\nDistinctAcqNetworks, dwDimNetwork exists(acquirer_network_hash == network_key\n\t&& DistinctAcqNetworks@source_system_key == dwDimNetwork@source_system_key,\n\tnegate:true,\n\tbroadcast: 'auto')~> Exists2\nHashKeysAndDates select(mapColumn(\n\t\tacqr_network_code = RDF_ACQR_NTWK_ID,\n\t\tmerchant_type_code = RDF_MCC,\n\t\tterminal_key = RDF_ATERM_ID,\n\t\tcard_entry_method_code = RDF_POS_ENTRY_MD,\n\t\tTransaction_Key,\n\t\tsource_system_key,\n\t\tHDR_RDF_CYCL_DT,\n\t\tFileName\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select1\nSelect1 unpivot(output(\n\t\tColumn_Name as string,\n\t\tnew_value as string\n\t),\n\tungroupBy(Transaction_Key,\n\t\tsource_system_key,\n\t\tHDR_RDF_CYCL_DT,\n\t\tFileName),\n\tlateral: false,\n\tignoreNullPivots: false) ~> Unpivot1\nTransactions2 select(mapColumn(\n\t\tTransaction_Key,\n\t\tAccountNumber,\n\t\tSettlementAmount,\n\t\tOriginDate,\n\t\tSettlementDate,\n\t\tImportFileDate,\n\t\tTerminalCity,\n\t\tTerminalState,\n\t\tAuthorizationNo,\n\t\tClientNo,\n\t\tTransactionTypeCode,\n\t\tSystemNo,\n\t\tPrincipalNo,\n\t\tAgentNo,\n\t\tRetrievalReferenceNumber,\n\t\tMerchantAccountNumber,\n\t\tTransactionName_original = TransactionName,\n\t\tOperCode\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> LimitSelectTransactions2\nLimitSelectTransactions1, LimitSelectTransactions2 union(byName: true)~> UnionTransactions\nUnpivot1 derive(old_value = toString(null()),\n\t\tcreate_date = currentTimestamp()) ~> DerivedColumn2\nDistinctCardEntry, dwDimCardEntry exists(card_entry_code_hash == card_entry_key\n\t&& DistinctCardEntry@source_system_key == dwDimCardEntry@source_system_key,\n\tnegate:true,\n\tbroadcast: 'auto')~> Exists3\nDistinctTerminals, dwDimTerminal exists(terminal_key_hash == atm_terminal_key\n\t&& RDF_ATERM_ID == terminal_key\n\t&& DistinctTerminals@source_system_key == dwDimTerminal@source_system_key,\n\tnegate:true,\n\tbroadcast: 'auto')~> Exists4\nHashKeysAndDates aggregate(groupBy(RDF_TRAN_DT),\n\tcount = count()) ~> DistinctLoadDate\nDistinctLoadDate, DerivedTransactionsLog lookup(RDF_TRAN_DT == load_date,\n\tmultiple: false,\n\tpickup: 'any',\n\tbroadcast: 'auto')~> Lookup1\nTransactionsLog derive(load_date = toDate(load_date),\n\t\tloaded_to_semantic = false(),\n\t\tsem_start_date = toTimestamp(toString(null())),\n\t\tsem_end_date = toTimestamp(toString(null())),\n\t\tsf_loaded_to_semantic = false(),\n\t\tsf_sem_start_date = toTimestamp(toString(null())),\n\t\tsf_sem_end_date = toTimestamp(toString(null()))) ~> DerivedTransactionsLog\nLookup1 alterRow(updateIf(true())) ~> AlterRow1\nderiveATMIndicator aggregate(groupBy(RDF_ATERM_ID,\n\t\tterminal_key_hash,\n\t\tsource_system_key,\n\t\tHDR_RDF_CYCL_DT,\n\t\tcreate_date),\n\tatm_indicator = max(atm_indicator)) ~> DistinctTerminals\nHashKeysAndDates aggregate(groupBy(RDF_POS_ENTRY_MD,\n\t\tcard_entry_code_hash,\n\t\tsource_system_key,\n\t\tHDR_RDF_CYCL_DT,\n\t\tcreate_date),\n\tcount = count()) ~> DistinctCardEntry\nHashKeysAndDates aggregate(groupBy(RDF_ACQR_NTWK_ID,\n\t\tacquirer_network_hash,\n\t\tsource_system_key,\n\t\tHDR_RDF_CYCL_DT,\n\t\tcreate_date),\n\tcount = count()) ~> DistinctAcqNetworks\nHashKeysAndDates aggregate(groupBy(RDF_MCC,\n\t\tmerchant_type_hash,\n\t\tHDR_RDF_CYCL_DT,\n\t\tcreate_date),\n\tcount = count()) ~> DistinctMerchantType\nUnionTransactions derive(TerminalCity = upper(TerminalCity),\n\t\tTerminalState = upper(TerminalState)) ~> FinalTransactions\nJoinTransactions filter(RDF_MRCH_CITY==TerminalCity\r\n&&\r\nRDF_MRCH_ST==TerminalState\r\n||\r\nin(['4829','6011'],RDF_MCC)) ~> Filter\nCCUMSTR derive(each(match(type=='string'), $$ = trim($$))) ~> TrimCCUMSTR\nFDCriteria derive(each(match(type=='string'), $$ = trim($$))) ~> TrimCriteria\nHashKeysAndDates, TrimCCUMSTR join(SystemNo == sys\n\t&& PrincipalNo == prin\n\t&& AgentNo == agent,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinCCUMSTR\nJoinCCUMSTR, TrimCriteria join(Platform == BINType\n\t&& TransactionTypeCode == TransactionCode,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinCriteria\nJoinCriteria filter(FD_Source_System_Key=='3'\r\n&&\r\n(isNull(MerchantType)||MerchantType=='NULL'||\r\n(MerchantTypeOperator=='IN'&&iifNull(locate(RDF_MCC,MerchantType),0)!=0)||\r\n(MerchantTypeOperator=='NOT IN'&&iifNull(locate(RDF_MCC,MerchantType),0)==0))\r\n&&\r\n(ReferenceNumber=='NULL'||isNull(ReferenceNumber)\r\n||(ReferenceNumberOperator=='='&&substring(RetrievalReferenceNumber,12,2)==ReferenceNumber)\r\n||(ReferenceNumberOperator=='<>'&&substring( RetrievalReferenceNumber ,12,2)!=ReferenceNumber))\r\n&&\r\n(isNull(AcctNumMerchNumMatchInd)||AcctNumMerchNumMatchInd=='NULL'\r\n||(AcctNumMerchNumMatchInd=='Y'&&left(AccountNumber,6)==left(MerchantAccountNumber ,6))\r\n||(AcctNumMerchNumMatchInd=='N'&&left(AccountNumber,6)!=left(MerchantAccountNumber ,6)))\r\n&&\r\n(isNull(OperatorCode)||OperatorCode=='NULL'\r\n||(OperatorCodeOperator=='IN'&&iifNull(locate(OperCode,OperatorCode),0)!=0)||\r\n(OperatorCodeOperator=='NOT IN'&&iifNull(locate(OperCode,OperatorCode),0)==0))) ~> FilterCriteria\nFilterCriteria aggregate(groupBy(ROWID),\n\tTransactionName = max(TransactionName)) ~> DedupeTxnName\nHashKeysAndDates, SelectTxnName join(ROWID == ROWID_txnName,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinDedupeTxnName\nJoinDedupeTxnName derive(transaction_name_key = crc32(iif(isNull(TransactionName),'Unknown', TransactionName), iif(isNull(source_system_key),0,source_system_key))) ~> HashTxnName\nDedupeTxnName select(mapColumn(\n\t\tROWID_txnName = ROWID,\n\t\tTransactionName\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectTxnName\nJoinDedupeTxnName select(mapColumn(\n\t\tsource_system_key,\n\t\tTransaction_Key,\n\t\tHDR_RDF_CYCL_DT,\n\t\tFileName,\n\t\ttransaction_name = TransactionName,\n\t\tTransactionName_original\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select2\nSelect2 derive(create_date = currentTimestamp(),\n\t\tColumn_Name = 'tranasction_name') ~> DerivedColumn3\nHashKeysAndDates derive(atm_indicator = case(RDF_MCC=='6011',toBoolean('1'),toBoolean('0'))) ~> deriveATMIndicator\nUpdate1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\ttransaction_key as long,\n\t\tsource_system_key as integer,\n\t\tsource_system_id as string,\n\t\taccount_key as string,\n\t\tacquirer_key as long,\n\t\tAcquirer_Network_key as long,\n\t\tbin_key as long,\n\t\tcard_entry_method_code_key as long,\n\t\tcard_presence_desc as string,\n\t\timport_file_date_key as date,\n\t\tinterchange_amount as decimal(25,2),\n\t\tissuer_key as long,\n\t\tissuer_network_key as long,\n\t\tmerchant_key as long,\n\t\tmerchant_terminal_geography_key as long,\n\t\tmerchant_type_key as long,\n\t\tmonetary as boolean,\n\t\ton_us_desc as string,\n\t\ttransmission_date_key as date,\n\t\torigin_date_key as date,\n\t\trecurring_desc as string,\n\t\tresponse_code_key as long,\n\t\tsettlement_amount as decimal(25,2),\n\t\tsettlement_date_key as date,\n\t\tsurcharge_amount as decimal(25,2),\n\t\ttermnial_key as long,\n\t\ttoken_requestid as long,\n\t\ttransaction_name_key as long,\n\t\tTransaction_type_key as long,\n\t\trun_id as long,\n\t\tdigital_card_issued_ind as boolean,\n\t\tauthorization_ind as boolean,\n\t\tauthorization_no as string\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['transaction_key','source_system_key','origin_date_key'],\n\tskipKeyWrites:true,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 5,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\ttransaction_key = Transaction_Key,\n\t\tsource_system_key,\n\t\torigin_date_key = OriginDate,\n\t\tAcquirer_Network_key = acquirer_network_hash,\n\t\tmerchant_type_key = merchant_type_hash,\n\t\tcard_entry_method_code_key = card_entry_code_hash,\n\t\ttermnial_key = terminal_key_hash,\n\t\ttransaction_name_key\n\t)) ~> snkFactTransactions\nExists1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tmerchant_type_key as long,\n\t\tmerchant_type as string,\n\t\tmerchant_group as string,\n\t\tmerchant_category_code_name as string,\n\t\tmerchant_category_group as string,\n\t\ttransaction_type as string,\n\t\tload_date as date,\n\t\tcreate_date as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 1,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tmerchant_type_key = merchant_type_hash,\n\t\tmerchant_type = RDF_MCC,\n\t\tload_date = HDR_RDF_CYCL_DT,\n\t\tcreate_date\n\t)) ~> snkNewMerchantType\nExists2 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tnetwork_key as long,\n\t\tsource_system_key as integer,\n\t\tnetwork_id as string,\n\t\tnetwork_desc as string,\n\t\tnetwork_name_normalized as string,\n\t\tload_date as date,\n\t\tcreate_date as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 1,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tnetwork_key = acquirer_network_hash,\n\t\tsource_system_key,\n\t\tnetwork_id = RDF_ACQR_NTWK_ID,\n\t\tload_date = HDR_RDF_CYCL_DT,\n\t\tcreate_date\n\t)) ~> snkNewNetworks\nUpdate1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tHDR_RDF_RCRD_ID as string,\n\t\tHDR_RDF_CLNT_N as integer,\n\t\tHDR_RDF_CYCL_DT as integer,\n\t\tHDR_RDF_RUN_DT as integer,\n\t\tHDR_RDF_RUN_TM as integer,\n\t\tRDF_RCRD_ID as string,\n\t\tRDF_ENTERED_ID as string,\n\t\tRDF_TRAN_DT as string,\n\t\tRDF_TRAN_AMT as string,\n\t\tRDF_TRAN_CUR as string,\n\t\tRDF_BIN_NO as string,\n\t\tRDF_MERCH_ACCT_NO as string,\n\t\tRDF_MCC as string,\n\t\tRDF_ACQR_FRDAB as string,\n\t\tRDF_ATERM_ID as string,\n\t\tRDF_TERM_SEQ_NO as string,\n\t\tRDF_FDR_TRAN_ID as string,\n\t\tRDF_TRAN_TM as string,\n\t\tRDF_STTL_AM as string,\n\t\tRDF_STTL_CUR as string,\n\t\tRDF_MRCH_NM as string,\n\t\tRDF_ACQR_NTWK_ID as string,\n\t\tRDF_ISSR_FRDABA as string,\n\t\tRDF_STERM_ID as string,\n\t\tRDF_SWTC_SEQ_NO as integer,\n\t\tRDF_REF_NO as string,\n\t\tRDF_STTL_DT as string,\n\t\tRDF_SURCHARGE_AM as string,\n\t\tRDF_STTL_CNVR_RT as string,\n\t\tRDF_MRCH_ADDR as string,\n\t\tRDF_ISS_NTWK_ID as string,\n\t\tRDF_POS_ENTRY_MD as string,\n\t\tRDF_PRCSR_ID as string,\n\t\tRDF_POS_CNDN_CD as string,\n\t\tRDF_FROM_ACCT_NO as string,\n\t\tRDF_FROM_ACCT_TYPE as string,\n\t\tRDF_MSSG_CD as string,\n\t\tRDF_PRCS_CD as string,\n\t\tRDF_AUTH_CD as string,\n\t\tRDF_MRCH_CITY as string,\n\t\tRDF_MRCH_ST as string,\n\t\tRDF_ADJ_TRAN_AMT as string,\n\t\tRDF_PIN_VRFY_RSPN_CD as string,\n\t\tRDF_ADJ_TRAN_FEE as string,\n\t\tRDF_TO_ACCT_NO as string,\n\t\tRDF_TO_ACCT_TYPE as string,\n\t\tRDF_ADVC_RVRS_RSN_CD as string,\n\t\tRDF_LINE_ID as string,\n\t\tRDF_FDR_TRAC_NO as string,\n\t\tRDF_ADJ_STTL_AMT as string,\n\t\tRDF_ADJ_STTL_FEE as string,\n\t\tRDF_ACCT_TYP_CD_1 as string,\n\t\tRDF_AM_TYP_CD_1 as string,\n\t\tRDF_CRRN_CD_1 as string,\n\t\tRDF_ADDT_AM_CD_1 as string,\n\t\tRDF_ADDT_AM_1 as string,\n\t\tRDF_ACCT_TYP_CD_2 as string,\n\t\tRDF_AM_TYP_CD_2 as string,\n\t\tRDF_CRRN_CD_2 as string,\n\t\tRDF_ADDT_AM_CD_2 as string,\n\t\tRDF_ADDT_AM_2 as string,\n\t\tRDF_ACCT_TYP_CD_3 as string,\n\t\tRDF_AM_TYP_CD_3 as string,\n\t\tRDF_CRRN_CD_3 as string,\n\t\tRDF_ADDT_AM_CD_3 as string,\n\t\tRDF_ADDT_AM_3 as string,\n\t\tRDF_ACCT_TYP_CD_4 as string,\n\t\tRDF_AM_TYP_CD_4 as string,\n\t\tRDF_CRRN_CD_4 as string,\n\t\tRDF_ADDT_AM_CD_4 as string,\n\t\tRDF_ADDT_AM_4 as string,\n\t\tRDF_ACCT_TYP_CD_5 as string,\n\t\tRDF_AM_TYP_CD_5 as string,\n\t\tRDF_CRRN_CD_5 as string,\n\t\tRDF_ADDT_AM_CD_5 as string,\n\t\tRDF_ADDT_AM_5 as string,\n\t\tRDF_ACCT_TYP_CD_6 as string,\n\t\tRDF_AM_TYP_CD_6 as string,\n\t\tRDF_CRRN_CD_6 as string,\n\t\tRDF_ADDT_AM_CD_6 as string,\n\t\tRDF_ADDT_AM_6 as string,\n\t\tRDF_LOG_TM as string,\n\t\tRDF_SYS_TM as string,\n\t\tRDF_LOG_DT as string,\n\t\tRDF_EXP_DT as string,\n\t\tRDF_SETTL_FEE_AM as string,\n\t\tFileName as string,\n\t\tProcessed as boolean,\n\t\tROWID as long\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['ROWID'],\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 6,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tProcessed = processed,\n\t\tROWID\n\t)) ~> snkDD553Processed\nDerivedColumn2 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tsource_system_key as integer,\n\t\ttransaction_key as long,\n\t\tcolumn_name as string,\n\t\told_value as string,\n\t\tnew_value as string,\n\t\tload_date as timestamp,\n\t\tcreate_date as timestamp,\n\t\tfile_name as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 3,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tsource_system_key,\n\t\ttransaction_key = Transaction_Key,\n\t\tcolumn_name = Column_Name,\n\t\told_value,\n\t\tnew_value,\n\t\tload_date = HDR_RDF_CYCL_DT,\n\t\tcreate_date,\n\t\tfile_name = FileName\n\t)) ~> snkAuditUpdatedTransactions\nExists3 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tcard_entry_key as long,\n\t\tsource_system_key as integer,\n\t\tcard_entry_cde as string,\n\t\tcard_entry_name as string,\n\t\tcard_entry_type as string,\n\t\tload_date as date,\n\t\tcreate_date as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 1,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tcard_entry_key = card_entry_code_hash,\n\t\tsource_system_key,\n\t\tcard_entry_cde = RDF_POS_ENTRY_MD,\n\t\tload_date = HDR_RDF_CYCL_DT,\n\t\tcreate_date\n\t)) ~> snkNewCardEntry\nExists4 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tatm_terminal_key as long,\n\t\tsource_system_key as integer,\n\t\tterminal_key as string,\n\t\tclient_key as long,\n\t\tcoop_atm_indicator as boolean,\n\t\ton_premise_indicator as boolean,\n\t\tatm_indicator as boolean,\n\t\tload_date as date,\n\t\tmodified_date as date,\n\t\tcreate_date as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 1,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tatm_terminal_key = terminal_key_hash,\n\t\tsource_system_key,\n\t\tterminal_key = RDF_ATERM_ID,\n\t\tatm_indicator,\n\t\tload_date = HDR_RDF_CYCL_DT,\n\t\tmodified_date = HDR_RDF_CYCL_DT,\n\t\tcreate_date\n\t)) ~> snkNewTerminalKey\nAlterRow1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\trun_id as long,\n\t\tsource_system_key as integer,\n\t\tfile_name as string,\n\t\trecord_count as long,\n\t\tloaded_to_semantic as boolean,\n\t\tload_date as timestamp,\n\t\tcreate_date as timestamp,\n\t\tsem_start_date as timestamp,\n\t\tsem_end_date as timestamp,\n\t\tsf_loaded_to_semantic as boolean,\n\t\tsf_sem_start_date as timestamp,\n\t\tsf_sem_end_date as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['run_id'],\n\tskipKeyWrites:true,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 2,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\trun_id,\n\t\tloaded_to_semantic,\n\t\tsem_start_date,\n\t\tsem_end_date,\n\t\tsf_loaded_to_semantic,\n\t\tsf_sem_start_date,\n\t\tsf_sem_end_date\n\t)) ~> snkTransactionLog\nDerivedColumn3 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tsource_system_key as integer,\n\t\ttransaction_key as long,\n\t\tcolumn_name as string,\n\t\told_value as string,\n\t\tnew_value as string,\n\t\tload_date as timestamp,\n\t\tcreate_date as timestamp,\n\t\tfile_name as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 4,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tsource_system_key,\n\t\ttransaction_key = Transaction_Key,\n\t\tcolumn_name = Column_Name,\n\t\told_value = TransactionName_original,\n\t\tnew_value = transaction_name,\n\t\tload_date = HDR_RDF_CYCL_DT,\n\t\tcreate_date,\n\t\tfile_name = FileName\n\t)) ~> snkAuditUpdatedTransactions2"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/FISDataHistory')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "FIS/SharedBranch"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "FIS_data_hist",
                                "type": "DatasetReference"
                            },
                            "name": "FISdatafile"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "FIS_Data_HistTble",
                                "type": "DatasetReference"
                            },
                            "name": "FISDataHistorytbl"
                        },
                        {
                            "dataset": {
                                "referenceName": "HistoricalLoadErrors",
                                "type": "DatasetReference"
                            },
                            "name": "HistoricalLoadErrorTbl"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "FormatLoadDate"
                        },
                        {
                            "name": "ErrorControl"
                        }
                    ],
                    "script": "source(output(\n\t\tload_date as string,\n\t\ttran_count as string,\n\t\tmsgtype as string,\n\t\tpan as string,\n\t\tpcode as string,\n\t\tamount as string,\n\t\tsettlement_amt as string,\n\t\ttrandatetime as string,\n\t\ttrans_conv_rate as string,\n\t\ttrace as string,\n\t\tlocal_time as string,\n\t\tlocal_date as string,\n\t\texp_date as string,\n\t\tsettlement_date as string,\n\t\ttrans_conv_date as string,\n\t\tcap_date as string,\n\t\tacq_cntry_code as string,\n\t\tpan_cntry_code as string,\n\t\tfwd_cntry_code as string,\n\t\tpos_entry_code as string,\n\t\tacq_inst_id as string,\n\t\tfwd_inst_id as string,\n\t\tresp_code as string,\n\t\tref_no as string,\n\t\tterminal_id as string,\n\t\tacceptor_id as string,\n\t\tacceptor_name as string,\n\t\tpos_condition_code as string,\n\t\tacceptor_name_loc as string,\n\t\ttrans_curr_code as string,\n\t\trev_reason_code as string,\n\t\tcredits as string,\n\t\tcredit_reversal as string,\n\t\tadl_amt_part1 as string,\n\t\tadl_amt_part2 as string,\n\t\tdebits as string,\n\t\tdebit_reversal as string,\n\t\tmerchant_type as string,\n\t\tngn_data as string,\n\t\tcredit_amt as string,\n\t\tcredit_rev_amt as string,\n\t\tdebit_amt as string,\n\t\tdebit_rev_amt as string,\n\t\tauth_agent_id as string,\n\t\tqualifier as string,\n\t\tacct_id1 as string,\n\t\tacct_id2 as string,\n\t\tiss_trace as string,\n\t\tacq_trace as string,\n\t\ttrans_type as string,\n\t\tdrank as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> FISdatafile\nFISdatafile derive(load_date = toDate(concat(substring(load_date,7,4),\"-\",substring(load_date,4,2),\"-\",substring(load_date,1,2)))) ~> FormatLoadDate\nFormatLoadDate split(length(toString(load_date)) == 10\r\n&& (length(tran_count) <= 11 || isNull(tran_count))\r\n&& (length(msgtype) <= 4 || isNull(msgtype))\r\n&& (length(pan) <= 19 || isNull(pan))\r\n&& (length(pcode) <= 6 || isNull(pcode))\r\n&& (like(amount, '%.%') || isNull(amount) || toInteger(amount)>=0)\r\n&& (like(settlement_amt, '%.%') || isNull(settlement_amt)|| toInteger(settlement_amt)>=0)\r\n&& (length(trandatetime) == 10 || isNull(trandatetime))\r\n&& (toInteger(trans_conv_rate)>=0 || isNull(trans_conv_rate))\r\n&& (toInteger(trace)>=0 || isNull(trace))\r\n&& (length(local_time) <= 6 || isNull(local_time))\r\n&& (length(local_date) <= 8 || isNull(local_date))\r\n&& (length(exp_date) <= 8 || isNull(exp_date))\r\n&& (length(settlement_date) <= 8 || isNull(settlement_date))\r\n&& (length(trans_conv_date) <= 8 || isNull(trans_conv_date))\r\n&& (length(cap_date) <= 8 || isNull(cap_date))\r\n&& (length(acq_cntry_code) <= 3 || isNull(acq_cntry_code))\r\n&& (length(pan_cntry_code) <= 3 || isNull(pan_cntry_code))\r\n&& (length(fwd_cntry_code) <= 3 || isNull(fwd_cntry_code))\r\n&& (length(pos_entry_code) <= 3 || isNull(pos_entry_code))\r\n&& (length(acq_inst_id) <= 11 || isNull(acq_inst_id))\r\n&& (length(fwd_inst_id) <= 11 || isNull(fwd_inst_id))\r\n&& (length(resp_code) <= 2 || isNull(resp_code))\r\n&& (length(ref_no) <= 12 || isNull(ref_no))\r\n&& (length(terminal_id) <= 8 || isNull(terminal_id))\r\n&& (length(acceptor_id) <= 15 || isNull(acceptor_id))\r\n&& (length(acceptor_name) <= 25 || isNull(acceptor_name))\r\n&& (length(pos_condition_code) <= 10 || isNull(pos_condition_code))\r\n&& (length(acceptor_name_loc) <= 50 || isNull(acceptor_name_loc))\r\n&& (length(trans_curr_code) <= 3 || isNull(trans_curr_code))\r\n&& (length(rev_reason_code) <= 6 || isNull(rev_reason_code))\r\n&& (like(credits, '%.%') || isNull(credits)|| toInteger(credits)>=0)\r\n&& (like(credit_reversal, '%.%') || isNull(credit_reversal)|| toInteger(credit_reversal)>=0)\r\n&& (length(adl_amt_part1) <= 100 || isNull(adl_amt_part1))\r\n&& (length(adl_amt_part2) <= 50 || isNull(adl_amt_part2))\r\n&& (like(debits, '%.%') || isNull(debits)|| toInteger(debits)>=0)\r\n&& (like(debit_reversal, '%.%') || isNull(debit_reversal)|| toInteger(debit_reversal)>=0)\r\n&& (length(merchant_type) <= 4 || isNull(merchant_type))\r\n&& (length(ngn_data) <= 50 || isNull(ngn_data))\r\n&& (like(credit_amt, '%.%') || isNull(credit_amt)|| toInteger(credit_amt)>=0)\r\n&& (like(credit_rev_amt, '%.%') || isNull(credit_rev_amt)|| toInteger(credit_rev_amt)>=0)\r\n&& (like(debit_amt, '%.%') || isNull(debit_amt)|| toInteger(debit_amt)>=0)\r\n&& (like(debit_rev_amt, '%.%') || isNull(debit_rev_amt)|| toInteger(debit_rev_amt)>=0)\r\n&& (length(auth_agent_id) <= 11 || isNull(auth_agent_id))\r\n&& (length(qualifier) <= 8 || isNull(qualifier))\r\n&& (length(acct_id1) <= 28 || isNull(acct_id1))\r\n&& (length(acct_id2) <= 28 || isNull(acct_id2))\r\n&& (length(iss_trace) <= 32 || isNull(iss_trace))\r\n&& (length(acq_trace) <= 32 || isNull(acq_trace))\r\n&& (length(trans_type) <= 2 || isNull(trans_type))\r\n&& (toInteger(drank) >= 0 || isNull(drank)),\n\tdisjoint: false) ~> ErrorControl@(GoodRows, ErrorRows)\nErrorControl@GoodRows sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tLOAD_DATE as date,\n\t\tTRAN_COUNT as string,\n\t\tMSGTYPE as string,\n\t\tPAN as string,\n\t\tPCODE as string,\n\t\tAMOUNT as decimal(18,6),\n\t\tSETTLEMENT_AMT as decimal(18,6),\n\t\tTRANDATETIME as string,\n\t\tTRANS_CONV_RATE as decimal(18,0),\n\t\tTRACE as decimal(18,0),\n\t\tLOCAL_TIME as string,\n\t\tLOCAL_DATE as string,\n\t\tEXP_DATE as string,\n\t\tSETTLEMENT_DATE as string,\n\t\tTRANS_CONV_DATE as string,\n\t\tCAP_DATE as string,\n\t\tACQ_CNTRY_CODE as string,\n\t\tPAN_CNTRY_CODE as string,\n\t\tFWD_CNTRY_CODE as string,\n\t\tPOS_ENTRY_CODE as string,\n\t\tACQ_INST_ID as string,\n\t\tFWD_INST_ID as string,\n\t\tRESP_CODE as string,\n\t\tREF_NO as string,\n\t\tTERMINAL_ID as string,\n\t\tACCEPTOR_ID as string,\n\t\tACCEPTOR_NAME as string,\n\t\tPOS_CONDITION_CODE as string,\n\t\tACCEPTOR_NAME_LOC as string,\n\t\tTRANS_CURR_CODE as string,\n\t\tREV_REASON_CODE as string,\n\t\tCREDITS as decimal(26,6),\n\t\tCREDIT_REVERSAL as decimal(26,6),\n\t\tADL_AMT_PART1 as string,\n\t\tADL_AMT_PART2 as string,\n\t\tDEBITS as decimal(26,6),\n\t\tDEBIT_REVERSAL as decimal(26,6),\n\t\tMERCHANT_TYPE as string,\n\t\tNGN_DATA as string,\n\t\tCREDIT_AMT as decimal(26,6),\n\t\tCREDIT_REV_AMT as decimal(26,6),\n\t\tDEBIT_AMT as decimal(26,6),\n\t\tDEBIT_REV_AMT as decimal(26,6),\n\t\tAUTH_AGENT_ID as string,\n\t\tQUALIFIER as string,\n\t\tACCT_ID1 as string,\n\t\tACCT_ID2 as string,\n\t\tISS_TRACE as string,\n\t\tACQ_TRACE as string,\n\t\tTRANS_TYPE as string,\n\t\tDRANK as decimal(18,0)\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tLOAD_DATE = load_date,\n\t\tTRAN_COUNT = tran_count,\n\t\tMSGTYPE = msgtype,\n\t\tPAN = pan,\n\t\tPCODE = pcode,\n\t\tAMOUNT = amount,\n\t\tSETTLEMENT_AMT = settlement_amt,\n\t\tTRANDATETIME = trandatetime,\n\t\tTRANS_CONV_RATE = trans_conv_rate,\n\t\tTRACE = trace,\n\t\tLOCAL_TIME = local_time,\n\t\tLOCAL_DATE = local_date,\n\t\tEXP_DATE = exp_date,\n\t\tSETTLEMENT_DATE = settlement_date,\n\t\tTRANS_CONV_DATE = trans_conv_date,\n\t\tCAP_DATE = cap_date,\n\t\tACQ_CNTRY_CODE = acq_cntry_code,\n\t\tPAN_CNTRY_CODE = pan_cntry_code,\n\t\tFWD_CNTRY_CODE = fwd_cntry_code,\n\t\tPOS_ENTRY_CODE = pos_entry_code,\n\t\tACQ_INST_ID = acq_inst_id,\n\t\tFWD_INST_ID = fwd_inst_id,\n\t\tRESP_CODE = resp_code,\n\t\tREF_NO = ref_no,\n\t\tTERMINAL_ID = terminal_id,\n\t\tACCEPTOR_ID = acceptor_id,\n\t\tACCEPTOR_NAME = acceptor_name,\n\t\tPOS_CONDITION_CODE = pos_condition_code,\n\t\tACCEPTOR_NAME_LOC = acceptor_name_loc,\n\t\tTRANS_CURR_CODE = trans_curr_code,\n\t\tREV_REASON_CODE = rev_reason_code,\n\t\tCREDITS = credits,\n\t\tCREDIT_REVERSAL = credit_reversal,\n\t\tADL_AMT_PART1 = adl_amt_part1,\n\t\tADL_AMT_PART2 = adl_amt_part2,\n\t\tDEBITS = debits,\n\t\tDEBIT_REVERSAL = debit_reversal,\n\t\tMERCHANT_TYPE = merchant_type,\n\t\tNGN_DATA = ngn_data,\n\t\tCREDIT_AMT = credit_amt,\n\t\tCREDIT_REV_AMT = credit_rev_amt,\n\t\tDEBIT_AMT = debit_amt,\n\t\tDEBIT_REV_AMT = debit_rev_amt,\n\t\tAUTH_AGENT_ID = auth_agent_id,\n\t\tQUALIFIER = qualifier,\n\t\tACCT_ID1 = acct_id1,\n\t\tACCT_ID2 = acct_id2,\n\t\tISS_TRACE = iss_trace,\n\t\tACQ_TRACE = acq_trace,\n\t\tTRANS_TYPE = trans_type,\n\t\tDRANK = drank\n\t)) ~> FISDataHistorytbl\nErrorControl@ErrorRows sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError') ~> HistoricalLoadErrorTbl"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/populate_DimAccountGeography_NEW')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "This will populate DimAccountGeograpy in the member schema in Azure SQ DW.",
                "folder": {
                    "name": "Dimensions"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "all_dzDemographics",
                                "type": "DatasetReference"
                            },
                            "name": "FISDebitDemographic"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Account_Geography",
                                "type": "DatasetReference"
                            },
                            "name": "dimAccountGeography"
                        },
                        {
                            "dataset": {
                                "referenceName": "AccountRegionReference",
                                "type": "DatasetReference"
                            },
                            "name": "RefAccountRegionReference"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "dim_Account_Geography",
                                "type": "DatasetReference"
                            },
                            "name": "SnkdimAccountGeography"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "GetDimAccountAttributes"
                        },
                        {
                            "name": "GetDistinctAccountGeography"
                        },
                        {
                            "name": "TrimSpaces"
                        },
                        {
                            "name": "GetRegionDivisionLabels"
                        },
                        {
                            "name": "FormatAttributes"
                        },
                        {
                            "name": "GetHashkey"
                        },
                        {
                            "name": "LowerAttributesForLookup"
                        },
                        {
                            "name": "JoinDimAccountGeography"
                        },
                        {
                            "name": "AlterRow1"
                        }
                    ],
                    "script": "source(output(\n\t\tFISDebitDemographicID as string,\n\t\tAccountNumber as string,\n\t\tPlasticNumber as string,\n\t\tGreetingName as string,\n\t\tFinancialInstitutionRouteTransit as string,\n\t\tCardStatus as string,\n\t\tLastUsedDate as string,\n\t\tAuthorizationLimitGroup as string,\n\t\tPINOffset as string,\n\t\tTrackTwoDate as string,\n\t\tDDAAccountNumber as string,\n\t\tSavingsAccountNumber as string,\n\t\tAdditionalDDAAccountNumberOne as string,\n\t\tAdditionalDDAAccountNumberTwo as string,\n\t\tAdditionalDDAAccountNumberThree as string,\n\t\tAdditionalDDAAccountNumberFour as string,\n\t\tAdditionalDDAAccountNumberFive as string,\n\t\tAdditionalSavingsAccountNumberOne as string,\n\t\tAdditionalSavingsAccountNumberTwo as string,\n\t\tAdditionalSavingsAccountNumberThree as string,\n\t\tAdditionalSavingsAccountNumberFour as string,\n\t\tAdditionalSavingsAccountNumberFive as string,\n\t\tAdditionalCreditAccountNumberOne as string,\n\t\tAdditionalCreditAccountNumberTwo as string,\n\t\tAdditionalCreditAccountNumberThree as string,\n\t\tAdditionalCreditAccountNumberFour as string,\n\t\tAdditionalOtherAccountNumberOne as string,\n\t\tAdditionalOtherAccountNumberTwo as string,\n\t\tAdditionalOtherAccountNumberThree as string,\n\t\tAdditionalOtherAccountNumberFour as string,\n\t\tCardholderAddressLineOne as string,\n\t\tCardholderAddressLineTwo as string,\n\t\tCardholderAddressCity as string,\n\t\tCardholderAddressState as string,\n\t\tCardholderAddressZip as string,\n\t\tCardholderFirstName as string,\n\t\tCardholderLastName as string,\n\t\tCardholderMiddleInitial as string,\n\t\tCardActivationFlag as string,\n\t\tOriginalIssueDate as string,\n\t\tLastIssueDate as string,\n\t\tNationalIdentifier as string,\n\t\tMothersMaidenName as string,\n\t\tHomePhone as string,\n\t\tWorkPhone as string,\n\t\tUserValidation as string,\n\t\tVRUCounter as string,\n\t\tBirthDate as string,\n\t\tCardActivationMethod as string,\n\t\tCardActivationDate as string,\n\t\tCardActivationTime as string,\n\t\tPreviousExpirationDate as string,\n\t\tPreviousCardActivationStatus as string,\n\t\tCardStatusTwo as string,\n\t\tFISDebitImportFileName as string,\n\t\tCreateDate as string,\n\t\tBINNumber as string,\n\t\tClientNumberIssuer as string,\n\t\tHashFullRecord as string,\n\t\tLastUpdatedDate as string,\n\t\tReportDate as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\trowUrlColumn: 'file_name') ~> FISDebitDemographic\nsource(output(\n\t\taccount_geography_key as string,\n\t\tsource_system_key as integer,\n\t\tregion as string,\n\t\tdivision as string,\n\t\taccount_address_line_one as string,\n\t\taccount_address_line_two as string,\n\t\taccount_city as string,\n\t\taccount_state_province_code as string,\n\t\taccount_postal_code as string,\n\t\taccount_country_code as string,\n\t\tload_date as date,\n\t\tcreate_date as timestamp,\n\t\tmodified_date as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false,\n\tpartitionColumn: 'account_geography_key',\n\tpartitionBy('external', 30)) ~> dimAccountGeography\nsource(output(\n\t\tRegion as string,\n\t\tRegionName as string,\n\t\tDivision as string,\n\t\tDivisionName as string,\n\t\tState as string,\n\t\tStateCode as string,\n\t\tCountryCode as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> RefAccountRegionReference\nFISDebitDemographic select(mapColumn(\n\t\tCardholderAddressLineOne,\n\t\tCardholderAddressLineTwo,\n\t\tCardholderAddressState,\n\t\tCardholderAddressCity,\n\t\tCardholderAddressZip,\n\t\tReportDate\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> GetDimAccountAttributes\nLowerAttributesForLookup aggregate(groupBy(lower_account_city,\n\t\tlower_account_state,\n\t\tSource_System_Key_FIS,\n\t\tCardholderAddressZip,\n\t\tlower_addresslineOne,\n\t\tlower_addresslineTwo,\n\t\tReportDate),\n\teach(match(name==\"removedups\"), $$ = first($$))) ~> GetDistinctAccountGeography\nGetDimAccountAttributes derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null())))),\n\t\tSource_System_Key_FIS = 1) ~> TrimSpaces\nGetHashkey, RefAccountRegionReference lookup(lower_account_state == lower(StateCode),\n\tmultiple: false,\n\tpickup: 'any',\n\tbroadcast: 'auto')~> GetRegionDivisionLabels\nJoinDimAccountGeography derive(CreateDate = coalesce(create_date, currentTimestamp()),\n\t\tmodify_date = currentTimestamp(),\n\t\tTitle_account_addresslineOne = initCap(lower_addresslineOne),\n\t\tTitle_account_addresslineTwo = initCap(lower_addresslineTwo),\n\t\tTitle_account_city = initCap(lower_account_city),\n\t\tReportDate = toDate(ReportDate, 'yyyy-mm-dd')) ~> FormatAttributes\nGetDistinctAccountGeography derive(AccountGeographyHashkey = sha1\r\n(\r\n  iif(isNull(lower_addresslineOne),'',lower_addresslineOne)\r\n, iif(isNull(lower_addresslineTwo),'',lower_addresslineTwo)\r\n, iif(isNull(lower_account_city),'',lower_account_city)\r\n, iif(isNull(lower_account_state),'',lower_account_state)\r\n, iif(isNull(CardholderAddressZip),'',CardholderAddressZip)\r\n, iif(isNull(Source_System_Key_FIS),0,Source_System_Key_FIS)\r\n)) ~> GetHashkey\nTrimSpaces derive(lower_account_city = lower(CardholderAddressCity),\n\t\tlower_account_state = lower(CardholderAddressState),\n\t\tlower_addresslineOne = lower(CardholderAddressLineOne),\n\t\tlower_addresslineTwo = lower(CardholderAddressLineTwo)) ~> LowerAttributesForLookup\nGetRegionDivisionLabels, dimAccountGeography join(AccountGeographyHashkey == account_geography_key\n\t&& Source_System_Key_FIS == source_system_key,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinDimAccountGeography\nFormatAttributes alterRow(upsertIf(true())) ~> AlterRow1\nAlterRow1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\taccount_geography_key as string,\n\t\tsource_system_key as integer,\n\t\tregion as string,\n\t\tdivision as string,\n\t\taccount_address_line_one as string,\n\t\taccount_address_line_two as string,\n\t\taccount_city as string,\n\t\taccount_state_province_code as string,\n\t\taccount_postal_code as string,\n\t\taccount_country_code as string,\n\t\tload_date as date,\n\t\tcreate_date as timestamp,\n\t\tmodified_date as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:false,\n\tupsertable:true,\n\tkeys:['source_system_key','account_geography_key'],\n\tformat: 'table',\n\tstaged: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\taccount_geography_key = AccountGeographyHashkey,\n\t\tsource_system_key = Source_System_Key_FIS,\n\t\tregion = RegionName,\n\t\tdivision = DivisionName,\n\t\taccount_address_line_one = Title_account_addresslineOne,\n\t\taccount_address_line_two = Title_account_addresslineTwo,\n\t\taccount_city = Title_account_city,\n\t\taccount_state_province_code = StateCode,\n\t\taccount_postal_code = CardholderAddressZip,\n\t\taccount_country_code = CountryCode,\n\t\tload_date = ReportDate,\n\t\tcreate_date = CreateDate,\n\t\tmodified_date = modify_date\n\t)) ~> SnkdimAccountGeography"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/populate_XrefMember')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "This is to populate Dim Account to the Azure DW.",
                "folder": {
                    "name": "Dimensions"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "src_stgFISDemographics",
                                "type": "DatasetReference"
                            },
                            "name": "FISDebitDemographic"
                        },
                        {
                            "dataset": {
                                "referenceName": "xref_Member",
                                "type": "DatasetReference"
                            },
                            "name": "XrefMember"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "xref_Member",
                                "type": "DatasetReference"
                            },
                            "name": "SnkXrefMember"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "SelectAccountAttributes"
                        },
                        {
                            "name": "ConvertAttributesAndApplyLogic"
                        },
                        {
                            "name": "TrimSpaces"
                        },
                        {
                            "name": "CreateHashkeys"
                        },
                        {
                            "name": "FormatAttributes"
                        },
                        {
                            "name": "SelectDistinctAccountsAttributes"
                        },
                        {
                            "name": "SortBeforeInsert"
                        },
                        {
                            "name": "JoinXrefMember"
                        },
                        {
                            "name": "AlterRow1"
                        },
                        {
                            "name": "GetDistinctRecords"
                        },
                        {
                            "name": "FilterHeader"
                        }
                    ],
                    "script": "source(output(\n\t\tFISDebitDemographicID as string,\n\t\tAccountNumber as string,\n\t\tPlasticNumber as string,\n\t\tGreetingName as string,\n\t\tFinancialInstitutionRouteTransit as string,\n\t\tCardStatus as string,\n\t\tLastUsedDate as string,\n\t\tAuthorizationLimitGroup as string,\n\t\tPINOffset as string,\n\t\tTrackTwoDate as string,\n\t\tDDAAccountNumber as string,\n\t\tSavingsAccountNumber as string,\n\t\tAdditionalDDAAccountNumberOne as string,\n\t\tAdditionalDDAAccountNumberTwo as string,\n\t\tAdditionalDDAAccountNumberThree as string,\n\t\tAdditionalDDAAccountNumberFour as string,\n\t\tAdditionalDDAAccountNumberFive as string,\n\t\tAdditionalSavingsAccountNumberOne as string,\n\t\tAdditionalSavingsAccountNumberTwo as string,\n\t\tAdditionalSavingsAccountNumberThree as string,\n\t\tAdditionalSavingsAccountNumberFour as string,\n\t\tAdditionalSavingsAccountNumberFive as string,\n\t\tAdditionalCreditAccountNumberOne as string,\n\t\tAdditionalCreditAccountNumberTwo as string,\n\t\tAdditionalCreditAccountNumberThree as string,\n\t\tAdditionalCreditAccountNumberFour as string,\n\t\tAdditionalOtherAccountNumberOne as string,\n\t\tAdditionalOtherAccountNumberTwo as string,\n\t\tAdditionalOtherAccountNumberThree as string,\n\t\tAdditionalOtherAccountNumberFour as string,\n\t\tCardholderAddressLineOne as string,\n\t\tCardholderAddressLineTwo as string,\n\t\tCardholderAddressCity as string,\n\t\tCardholderAddressState as string,\n\t\tCardholderAddressZip as string,\n\t\tCardholderFirstName as string,\n\t\tCardholderLastName as string,\n\t\tCardholderMiddleInitial as string,\n\t\tCardActivationFlag as string,\n\t\tOriginalIssueDate as string,\n\t\tLastIssueDate as string,\n\t\tNationalIdentifier as string,\n\t\tMothersMaidenName as string,\n\t\tHomePhone as string,\n\t\tWorkPhone as string,\n\t\tUserValidation as string,\n\t\tVRUCounter as string,\n\t\tBirthDate as string,\n\t\tCardActivationMethod as string,\n\t\tCardActivationDate as string,\n\t\tCardActivationTime as string,\n\t\tPreviousExpirationDate as string,\n\t\tPreviousCardActivationStatus as string,\n\t\tCardStatusTwo as string,\n\t\tFISDebitImportFileName as string,\n\t\tCreateDate as string,\n\t\tBINNumber as string,\n\t\tClientNumberIssuer as string,\n\t\tHashFullRecord as string,\n\t\tLastUpdatedDate as string,\n\t\tReportDate as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> FISDebitDemographic\nsource(output(\n\t\tsource_system_key as integer,\n\t\taccount_key as string,\n\t\tcustomer_key as string,\n\t\taccount_geography_key as string,\n\t\tload_date as timestamp,\n\t\tcreate_date as timestamp,\n\t\tmodified_date as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false) ~> XrefMember\nFilterHeader select(mapColumn(\n\t\tCardholderCity = CardholderAddressCity,\n\t\tCardholderAddressLineOne,\n\t\tCardholderAddressLineTwo,\n\t\tCardholderState = CardholderAddressState,\n\t\tCardholderZip = CardholderAddressZip,\n\t\tAccountNumber,\n\t\tReportDate,\n\t\tCardholderLastName,\n\t\tCardholderFirstName,\n\t\tCardholderMiddleInitial,\n\t\tGreetingName\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectAccountAttributes\nTrimSpaces derive(CardholderCity = lower(CardholderCity),\n\t\tCardholderAddressLineOne = lower(CardholderAddressLineOne),\n\t\tCardholderAddressLineTwo = lower(CardholderAddressLineTwo),\n\t\tCardholderState = lower(CardholderState),\n\t\tCardholderFirstName = lower(CardholderFirstName),\n\t\tCardholderLastName = lower(CardholderLastName),\n\t\tCardholderMiddleInitial = lower(CardholderMiddleInitial),\n\t\tGreetingName = lower(GreetingName),\n\t\tReportDate = toDate(ReportDate, 'yyyy-MM-dd'),\n\t\tsource_system_key_FIS = 1) ~> ConvertAttributesAndApplyLogic\nSelectAccountAttributes derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null()))))) ~> TrimSpaces\nSelectDistinctAccountsAttributes derive(AccountGeographyHashkey = md5\n(\n  iif(isNull(Lower_CardholderAddressLineOne),'',Lower_CardholderAddressLineOne)\n, iif(isNull(Lower_CardholderAddressLineTwo),'',Lower_CardholderAddressLineTwo)\n, iif(isNull(Lower_Account_City),'',Lower_Account_City)\n, iif(isNull(Lower_Account_State),'',Lower_Account_State)\n, iif(isNull(CardholderZip),'',CardholderZip)\n, iif(isNull(source_system_key_FIS),0,source_system_key_FIS)\n),\n\t\tAccountHashkey = md5(iif(isNull(AccountNumber),'',AccountNumber)\n, iif(isNull(source_system_key_FIS),0,source_system_key_FIS)),\n\t\tCustomerHashkey = md5(iif(isNull(Lower_CardholderFirstName),'',Lower_CardholderFirstName)\n, iif(isNull(Lower_CardholderMiddleInitial),'',Lower_CardholderMiddleInitial)\n, iif(isNull(Lower_CardholderLastName),'',Lower_CardholderLastName)\n, iif(isNull(Lower_GreetingName),'',Lower_GreetingName)\n, iif(isNull(source_system_key_FIS),0,source_system_key_FIS))) ~> CreateHashkeys\nJoinXrefMember derive(create_date_new = coalesce(create_date, currentTimestamp()),\n\t\tModifiedDate_new = currentTimestamp(),\n\t\tload_date_new = toTimestamp(ReportDate)) ~> FormatAttributes\nConvertAttributesAndApplyLogic select(mapColumn(\n\t\tAccountNumber,\n\t\tLower_CardholderAddressLineOne = CardholderAddressLineOne,\n\t\tLower_CardholderAddressLineTwo = CardholderAddressLineTwo,\n\t\tLower_Account_City = CardholderCity,\n\t\tLower_Account_State = CardholderState,\n\t\tCardholderZip,\n\t\tLower_CardholderFirstName = CardholderFirstName,\n\t\tLower_CardholderLastName = CardholderLastName,\n\t\tLower_CardholderMiddleInitial = CardholderMiddleInitial,\n\t\tLower_GreetingName = GreetingName,\n\t\tReportDate,\n\t\tsource_system_key_FIS\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectDistinctAccountsAttributes\nFormatAttributes sort(asc(AccountHashkey, true),\n\tasc(CustomerHashkey, true),\n\tasc(AccountGeographyHashkey, true),\n\tpartitionLevel: true) ~> SortBeforeInsert\nGetDistinctRecords, XrefMember join(source_system_key_FIS == source_system_key\n\t&& AccountHashkey == account_key\n\t&& CustomerHashkey == customer_key\n\t&& AccountGeographyHashkey == account_geography_key,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinXrefMember\nSortBeforeInsert alterRow(upsertIf(true())) ~> AlterRow1\nCreateHashkeys aggregate(groupBy(source_system_key_FIS,\n\t\tAccountHashkey,\n\t\tCustomerHashkey,\n\t\tAccountGeographyHashkey,\n\t\tReportDate),\n\tDistinctRecord = count(CustomerHashkey)) ~> GetDistinctRecords\nFISDebitDemographic filter(FISDebitDemographicID!='FISDebitDemographicID') ~> FilterHeader\nAlterRow1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tsource_system_key as integer,\n\t\taccount_key as string,\n\t\tcustomer_key as string,\n\t\taccount_geography_key as string,\n\t\tload_date as timestamp,\n\t\tcreate_date as timestamp,\n\t\tmodified_date as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:false,\n\tupsertable:true,\n\tkeys:['source_system_key','account_key','customer_key','account_geography_key'],\n\tformat: 'table',\n\tstaged: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tsource_system_key = source_system_key_FIS,\n\t\taccount_key = AccountHashkey,\n\t\tcustomer_key = CustomerHashkey,\n\t\taccount_geography_key = AccountGeographyHashkey,\n\t\tload_date = load_date_new,\n\t\tcreate_date = create_date_new,\n\t\tmodified_date = ModifiedDate_new\n\t)) ~> SnkXrefMember"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/FISDataHistory1')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "FIS/SharedBranch"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "FIS_data_hist1",
                                "type": "DatasetReference"
                            },
                            "name": "FISdatafile"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "FIS_Data_HistTble1",
                                "type": "DatasetReference"
                            },
                            "name": "FISDataHistorytbl"
                        },
                        {
                            "dataset": {
                                "referenceName": "HistoricalLoadErrors",
                                "type": "DatasetReference"
                            },
                            "name": "HistoricalLoadErrorTbl"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "FormatLoadDate"
                        },
                        {
                            "name": "ErrorControl"
                        }
                    ],
                    "script": "source(output(\n\t\tload_date as string,\n\t\ttran_count as string,\n\t\tmsgtype as string,\n\t\tpan as string,\n\t\tpcode as string,\n\t\tamount as string,\n\t\tsettlement_amt as string,\n\t\ttrandatetime as string,\n\t\ttrans_conv_rate as string,\n\t\ttrace as string,\n\t\tlocal_time as string,\n\t\tlocal_date as string,\n\t\texp_date as string,\n\t\tsettlement_date as string,\n\t\ttrans_conv_date as string,\n\t\tcap_date as string,\n\t\tacq_cntry_code as string,\n\t\tpan_cntry_code as string,\n\t\tfwd_cntry_code as string,\n\t\tpos_entry_code as string,\n\t\tacq_inst_id as string,\n\t\tfwd_inst_id as string,\n\t\tresp_code as string,\n\t\tref_no as string,\n\t\tterminal_id as string,\n\t\tacceptor_id as string,\n\t\tacceptor_name as string,\n\t\tpos_condition_code as string,\n\t\tacceptor_name_loc as string,\n\t\ttrans_curr_code as string,\n\t\trev_reason_code as string,\n\t\tcredits as string,\n\t\tcredit_reversal as string,\n\t\tadl_amt_part1 as string,\n\t\tadl_amt_part2 as string,\n\t\tdebits as string,\n\t\tdebit_reversal as string,\n\t\tmerchant_type as string,\n\t\tngn_data as string,\n\t\tcredit_amt as string,\n\t\tcredit_rev_amt as string,\n\t\tdebit_amt as string,\n\t\tdebit_rev_amt as string,\n\t\tauth_agent_id as string,\n\t\tqualifier as string,\n\t\tacct_id1 as string,\n\t\tacct_id2 as string,\n\t\tiss_trace as string,\n\t\tacq_trace as string,\n\t\ttrans_type as string,\n\t\tdrank as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> FISdatafile\nFISdatafile derive(load_date = toDate(concat(substring(load_date,7,4),\"-\",substring(load_date,4,2),\"-\",substring(load_date,1,2)))) ~> FormatLoadDate\nFormatLoadDate split(length(toString(load_date)) == 10\r\n&& (length(tran_count) <= 11 || isNull(tran_count))\r\n&& (length(msgtype) <= 4 || isNull(msgtype))\r\n&& (length(pan) <= 19 || isNull(pan))\r\n&& (length(pcode) <= 6 || isNull(pcode))\r\n&& (like(amount, '%.%') || isNull(amount) || toInteger(amount)>=0)\r\n&& (like(settlement_amt, '%.%') || isNull(settlement_amt)|| toInteger(settlement_amt)>=0)\r\n&& (length(trandatetime) == 10 || isNull(trandatetime))\r\n&& (toInteger(trans_conv_rate)>=0 || isNull(trans_conv_rate))\r\n&& (toInteger(trace)>=0 || isNull(trace))\r\n&& (length(local_time) <= 6 || isNull(local_time))\r\n&& (length(local_date) <= 8 || isNull(local_date))\r\n&& (length(exp_date) <= 8 || isNull(exp_date))\r\n&& (length(settlement_date) <= 8 || isNull(settlement_date))\r\n&& (length(trans_conv_date) <= 8 || isNull(trans_conv_date))\r\n&& (length(cap_date) <= 8 || isNull(cap_date))\r\n&& (length(acq_cntry_code) <= 3 || isNull(acq_cntry_code))\r\n&& (length(pan_cntry_code) <= 3 || isNull(pan_cntry_code))\r\n&& (length(fwd_cntry_code) <= 3 || isNull(fwd_cntry_code))\r\n&& (length(pos_entry_code) <= 3 || isNull(pos_entry_code))\r\n&& (length(acq_inst_id) <= 11 || isNull(acq_inst_id))\r\n&& (length(fwd_inst_id) <= 11 || isNull(fwd_inst_id))\r\n&& (length(resp_code) <= 2 || isNull(resp_code))\r\n&& (length(ref_no) <= 12 || isNull(ref_no))\r\n&& (length(terminal_id) <= 8 || isNull(terminal_id))\r\n&& (length(acceptor_id) <= 15 || isNull(acceptor_id))\r\n&& (length(acceptor_name) <= 25 || isNull(acceptor_name))\r\n&& (length(pos_condition_code) <= 10 || isNull(pos_condition_code))\r\n&& (length(acceptor_name_loc) <= 50 || isNull(acceptor_name_loc))\r\n&& (length(trans_curr_code) <= 3 || isNull(trans_curr_code))\r\n&& (length(rev_reason_code) <= 6 || isNull(rev_reason_code))\r\n&& (like(credits, '%.%') || isNull(credits)|| toInteger(credits)>=0)\r\n&& (like(credit_reversal, '%.%') || isNull(credit_reversal)|| toInteger(credit_reversal)>=0)\r\n&& (length(adl_amt_part1) <= 100 || isNull(adl_amt_part1))\r\n&& (length(adl_amt_part2) <= 50 || isNull(adl_amt_part2))\r\n&& (like(debits, '%.%') || isNull(debits)|| toInteger(debits)>=0)\r\n&& (like(debit_reversal, '%.%') || isNull(debit_reversal)|| toInteger(debit_reversal)>=0)\r\n&& (length(merchant_type) <= 4 || isNull(merchant_type))\r\n&& (length(ngn_data) <= 50 || isNull(ngn_data))\r\n&& (like(credit_amt, '%.%') || isNull(credit_amt)|| toInteger(credit_amt)>=0)\r\n&& (like(credit_rev_amt, '%.%') || isNull(credit_rev_amt)|| toInteger(credit_rev_amt)>=0)\r\n&& (like(debit_amt, '%.%') || isNull(debit_amt)|| toInteger(debit_amt)>=0)\r\n&& (like(debit_rev_amt, '%.%') || isNull(debit_rev_amt)|| toInteger(debit_rev_amt)>=0)\r\n&& (length(auth_agent_id) <= 11 || isNull(auth_agent_id))\r\n&& (length(qualifier) <= 8 || isNull(qualifier))\r\n&& (length(acct_id1) <= 28 || isNull(acct_id1))\r\n&& (length(acct_id2) <= 28 || isNull(acct_id2))\r\n&& (length(iss_trace) <= 32 || isNull(iss_trace))\r\n&& (length(acq_trace) <= 32 || isNull(acq_trace))\r\n&& (length(trans_type) <= 2 || isNull(trans_type))\r\n&& (toInteger(drank) >= 0 || isNull(drank)),\n\tdisjoint: false) ~> ErrorControl@(GoodRows, ErrorRows)\nErrorControl@GoodRows sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tLOAD_DATE as date,\n\t\tTRAN_COUNT as string,\n\t\tMSGTYPE as string,\n\t\tPAN as string,\n\t\tPCODE as string,\n\t\tAMOUNT as decimal(18,6),\n\t\tSETTLEMENT_AMT as decimal(18,6),\n\t\tTRANDATETIME as string,\n\t\tTRANS_CONV_RATE as decimal(18,0),\n\t\tTRACE as decimal(18,0),\n\t\tLOCAL_TIME as string,\n\t\tLOCAL_DATE as string,\n\t\tEXP_DATE as string,\n\t\tSETTLEMENT_DATE as string,\n\t\tTRANS_CONV_DATE as string,\n\t\tCAP_DATE as string,\n\t\tACQ_CNTRY_CODE as string,\n\t\tPAN_CNTRY_CODE as string,\n\t\tFWD_CNTRY_CODE as string,\n\t\tPOS_ENTRY_CODE as string,\n\t\tACQ_INST_ID as string,\n\t\tFWD_INST_ID as string,\n\t\tRESP_CODE as string,\n\t\tREF_NO as string,\n\t\tTERMINAL_ID as string,\n\t\tACCEPTOR_ID as string,\n\t\tACCEPTOR_NAME as string,\n\t\tPOS_CONDITION_CODE as string,\n\t\tACCEPTOR_NAME_LOC as string,\n\t\tTRANS_CURR_CODE as string,\n\t\tREV_REASON_CODE as string,\n\t\tCREDITS as decimal(26,6),\n\t\tCREDIT_REVERSAL as decimal(26,6),\n\t\tADL_AMT_PART1 as string,\n\t\tADL_AMT_PART2 as string,\n\t\tDEBITS as decimal(26,6),\n\t\tDEBIT_REVERSAL as decimal(26,6),\n\t\tMERCHANT_TYPE as string,\n\t\tNGN_DATA as string,\n\t\tCREDIT_AMT as decimal(26,6),\n\t\tCREDIT_REV_AMT as decimal(26,6),\n\t\tDEBIT_AMT as decimal(26,6),\n\t\tDEBIT_REV_AMT as decimal(26,6),\n\t\tAUTH_AGENT_ID as string,\n\t\tQUALIFIER as string,\n\t\tACCT_ID1 as string,\n\t\tACCT_ID2 as string,\n\t\tISS_TRACE as string,\n\t\tACQ_TRACE as string,\n\t\tTRANS_TYPE as string,\n\t\tDRANK as decimal(18,0)\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tLOAD_DATE = load_date,\n\t\tTRAN_COUNT = tran_count,\n\t\tMSGTYPE = msgtype,\n\t\tPAN = pan,\n\t\tPCODE = pcode,\n\t\tAMOUNT = amount,\n\t\tSETTLEMENT_AMT = settlement_amt,\n\t\tTRANDATETIME = trandatetime,\n\t\tTRANS_CONV_RATE = trans_conv_rate,\n\t\tTRACE = trace,\n\t\tLOCAL_TIME = local_time,\n\t\tLOCAL_DATE = local_date,\n\t\tEXP_DATE = exp_date,\n\t\tSETTLEMENT_DATE = settlement_date,\n\t\tTRANS_CONV_DATE = trans_conv_date,\n\t\tCAP_DATE = cap_date,\n\t\tACQ_CNTRY_CODE = acq_cntry_code,\n\t\tPAN_CNTRY_CODE = pan_cntry_code,\n\t\tFWD_CNTRY_CODE = fwd_cntry_code,\n\t\tPOS_ENTRY_CODE = pos_entry_code,\n\t\tACQ_INST_ID = acq_inst_id,\n\t\tFWD_INST_ID = fwd_inst_id,\n\t\tRESP_CODE = resp_code,\n\t\tREF_NO = ref_no,\n\t\tTERMINAL_ID = terminal_id,\n\t\tACCEPTOR_ID = acceptor_id,\n\t\tACCEPTOR_NAME = acceptor_name,\n\t\tPOS_CONDITION_CODE = pos_condition_code,\n\t\tACCEPTOR_NAME_LOC = acceptor_name_loc,\n\t\tTRANS_CURR_CODE = trans_curr_code,\n\t\tREV_REASON_CODE = rev_reason_code,\n\t\tCREDITS = credits,\n\t\tCREDIT_REVERSAL = credit_reversal,\n\t\tADL_AMT_PART1 = adl_amt_part1,\n\t\tADL_AMT_PART2 = adl_amt_part2,\n\t\tDEBITS = debits,\n\t\tDEBIT_REVERSAL = debit_reversal,\n\t\tMERCHANT_TYPE = merchant_type,\n\t\tNGN_DATA = ngn_data,\n\t\tCREDIT_AMT = credit_amt,\n\t\tCREDIT_REV_AMT = credit_rev_amt,\n\t\tDEBIT_AMT = debit_amt,\n\t\tDEBIT_REV_AMT = debit_rev_amt,\n\t\tAUTH_AGENT_ID = auth_agent_id,\n\t\tQUALIFIER = qualifier,\n\t\tACCT_ID1 = acct_id1,\n\t\tACCT_ID2 = acct_id2,\n\t\tISS_TRACE = iss_trace,\n\t\tACQ_TRACE = acq_trace,\n\t\tTRANS_TYPE = trans_type,\n\t\tDRANK = drank\n\t)) ~> FISDataHistorytbl\nErrorControl@ErrorRows sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError') ~> HistoricalLoadErrorTbl"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/populate_DimAccountGeography_FD_NEW')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "This will populate DimAccountGeograpy in the member schema in Azure SQ DW.",
                "folder": {
                    "name": "Dimensions"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "all_stgFDCustomerData",
                                "type": "DatasetReference"
                            },
                            "name": "FDCustomerData"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Account_Geography",
                                "type": "DatasetReference"
                            },
                            "name": "dimAccountGeography"
                        },
                        {
                            "dataset": {
                                "referenceName": "AccountRegionReference",
                                "type": "DatasetReference"
                            },
                            "name": "RefAccountRegionReference"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "dim_Account_Geography",
                                "type": "DatasetReference"
                            },
                            "name": "SnkdimAccountGeography"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "GetDimAccountAttributes"
                        },
                        {
                            "name": "GetDistinctAccountGeography"
                        },
                        {
                            "name": "TrimSpacesAndSetSourceSystem"
                        },
                        {
                            "name": "GetRegionDivisionLabels"
                        },
                        {
                            "name": "FormatAttributes"
                        },
                        {
                            "name": "GetHashkey"
                        },
                        {
                            "name": "LowerAttributesForLookup"
                        },
                        {
                            "name": "JoinDimAccountGeography"
                        },
                        {
                            "name": "AlterRow1"
                        },
                        {
                            "name": "SortBeforeInsert"
                        }
                    ],
                    "script": "source(output(\n\t\tCustomerDataID as string,\n\t\t{      CHD_ACCOUNT_NUMBER} as string,\n\t\t{      CHD_PRINCIPAL_NAME} as string,\n\t\t{      CHD_SPOUSE_NAME} as string,\n\t\t{      CHD_ADDR_LINE_1} as string,\n\t\t{      CHD_ADDR_LINE_2} as string,\n\t\t{      CHD_CITY} as string,\n\t\t{      CHD_STATE} as string,\n\t\t{      CHD_NUMERIC_STATE} as string,\n\t\t{      CHD_DELIVERY_POINT} as string,\n\t\t{      CHD_PD_PREFIX} as string,\n\t\t{      CHD_PD_SUFFIX} as string,\n\t\t{      CHD_PD_ADDRESS_FORMAT} as string,\n\t\t{      CHD_PD_ADDR_LINE_3} as string,\n\t\t{      CHD_PD_COUNTY} as string,\n\t\t{      CHD_PD_POSTCODE} as string,\n\t\t{      CHD_SD_PREFIX} as string,\n\t\t{      CHD_SD_SUFFIX} as string,\n\t\t{      CHD_SEX_CODE} as string,\n\t\t{      CHD_SOC_SECURITY_NO} as string,\n\t\t{      CHD_TELEPHONE_NUMBER} as string,\n\t\t{      CHD_SECOND_TELEPHONE_NUMBER} as string,\n\t\t{      CHD_HOME_PHONE_FORMAT} as string,\n\t\t{      CHD_BUS_PHONE_FORMAT} as string,\n\t\t{      CHD_MOTHERS_MAIDEN_NAME} as string,\n\t\t{      CHD_SECONDARY_SOC_SEC_NO} as string,\n\t\t{      CHD_DATE_LAST_ADDR_CHANGE} as string,\n\t\t{      CHD_NAME_ADDR_CHG} as string,\n\t\t{      CHD_ADDRESS_FLAG} as string,\n\t\t{      CHD_HOME_PHONE_FLAG} as string,\n\t\t{      CHD_BUSINESS_PHONE_FLAG} as string,\n\t\t{      CHD_DECEASED_FLAG} as string,\n\t\t{      CHD_SOLICITATION_FLAG} as string,\n\t\t{      CHD_EMPL_ACCT_CD} as string,\n\t\t{      CHD_ALT_CUSTOMER_NO} as string,\n\t\t{      CHD_DATE_OF_BIRTH} as string,\n\t\t{      CHD_SECONDARY_DATE_OF_BIRTH} as string,\n\t\t{      FDR_Date_Processed} as string,\n\t\t{      ExtractDate} as string,\n\t\t{      DateProcessed} as string,\n\t\t{      ReportDate} as string,\n\t\t{      CHD_FIXD_MPD_USAG_CD} as string,\n\t\t{      CHD_MPW_APR_OVRR_USAG_CD} as string,\n\t\t{      CHD_MPW_APR_OVRR_USAG_DT} as string,\n\t\t{      CHD_FIXD_MPD_OVRR_AM1} as string,\n\t\t{      CHD_FIXD_MPD_OVRR_DT1} as string,\n\t\t{      CHD_FIXD_MPD_OVRR_AM2} as string,\n\t\t{      CHD_FIXD_MPD_OVRR_DT2} as string,\n\t\t{      CHD_FIXD_MPD_OVRR_AM3} as string,\n\t\t{      CHD_FIXD_MPD_OVRR_DT3} as string,\n\t\t{      CHD_FIXD_MPD_OVRR_AM4} as string,\n\t\t{      CHD_FIXD_MPD_OVRR_DT4} as string,\n\t\t{      CHD_TSM_PRTC_IN} as string,\n\t\t{      CHD_ZIP_CODE} as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\trowUrlColumn: 'file_name') ~> FDCustomerData\nsource(output(\n\t\taccount_geography_key as string,\n\t\tsource_system_key as integer,\n\t\tregion as string,\n\t\tdivision as string,\n\t\taccount_address_line_one as string,\n\t\taccount_address_line_two as string,\n\t\taccount_city as string,\n\t\taccount_state_province_code as string,\n\t\taccount_postal_code as string,\n\t\taccount_country_code as string,\n\t\tload_date as date,\n\t\tcreate_date as timestamp,\n\t\tmodified_date as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false,\n\tpartitionColumn: 'account_geography_key',\n\tpartitionBy('external', 50)) ~> dimAccountGeography\nsource(output(\n\t\tRegion as string,\n\t\tRegionName as string,\n\t\tDivision as string,\n\t\tDivisionName as string,\n\t\tState as string,\n\t\tStateCode as string,\n\t\tCountryCode as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> RefAccountRegionReference\nFDCustomerData select(mapColumn(\n\t\tCardholderAddressState = {      CHD_STATE},\n\t\tCardholderAddressCity = {      CHD_CITY},\n\t\tCardholderAddressZip = {      CHD_PD_POSTCODE},\n\t\tReportDate = {      ReportDate},\n\t\tCHD_ADDR_LINE_1 = {      CHD_ADDR_LINE_1},\n\t\tCHD_ADDR_LINE_2 = {      CHD_ADDR_LINE_2}\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> GetDimAccountAttributes\nLowerAttributesForLookup aggregate(groupBy(Source_System_Key_AccountData,\n\t\tCardholderAddressLineOne,\n\t\tCardholderAddressLineTwo,\n\t\tCardholderAddressCity,\n\t\tCardholderAddressState,\n\t\tCardholderAddressZip,\n\t\tReportDate),\n\teach(match(name==\"removedups\"), $$ = first($$))) ~> GetDistinctAccountGeography\nGetDimAccountAttributes derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null())))),\n\t\tSource_System_Key_AccountData = 2) ~> TrimSpacesAndSetSourceSystem\nGetHashkey, RefAccountRegionReference lookup(CardholderAddressState == lower(StateCode),\n\tmultiple: false,\n\tpickup: 'any',\n\tbroadcast: 'auto')~> GetRegionDivisionLabels\nJoinDimAccountGeography derive(CreateDate = coalesce(create_date, currentTimestamp()),\n\t\tModifiedDateNew = currentTimestamp(),\n\t\tReportDate = toDate(ReportDate, 'yyyy-mm-dd'),\n\t\tTitle_account_city = initCap(CardholderAddressCity),\n\t\tTitle_CardholderAddressLineOne = initCap(CardholderAddressLineOne),\n\t\tTitle_CardholderAddressLineTwo = initCap(CardholderAddressLineTwo)) ~> FormatAttributes\nGetDistinctAccountGeography derive(AccountGeographyHashkey = sha1\r\n(iif(isNull(CardholderAddressLineOne),'',CardholderAddressLineOne)\r\n, iif(isNull(CardholderAddressLineTwo),'',CardholderAddressLineTwo)\r\n, iif(isNull(CardholderAddressCity),'',CardholderAddressCity)\r\n, iif(isNull(CardholderAddressState),'',CardholderAddressState)\r\n, iif(isNull(CardholderAddressZip),'',CardholderAddressZip)\r\n, iif(isNull(Source_System_Key_AccountData),0,Source_System_Key_AccountData)\r\n)) ~> GetHashkey\nTrimSpacesAndSetSourceSystem derive(CardholderAddressCity = lower(CardholderAddressCity),\n\t\tCardholderAddressState = lower(CardholderAddressState),\n\t\tCardholderAddressLineOne = lower(CHD_ADDR_LINE_1),\n\t\tCardholderAddressLineTwo = lower(CHD_ADDR_LINE_2)) ~> LowerAttributesForLookup\nGetRegionDivisionLabels, dimAccountGeography join(Source_System_Key_AccountData == source_system_key\n\t&& AccountGeographyHashkey == account_geography_key,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinDimAccountGeography\nFormatAttributes alterRow(upsertIf(true())) ~> AlterRow1\nAlterRow1 sort(asc(Source_System_Key_AccountData, true),\n\tasc(AccountGeographyHashkey, true)) ~> SortBeforeInsert\nSortBeforeInsert sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\taccount_geography_key as string,\n\t\tsource_system_key as integer,\n\t\tregion as string,\n\t\tdivision as string,\n\t\taccount_address_line_one as string,\n\t\taccount_address_line_two as string,\n\t\taccount_city as string,\n\t\taccount_state_province_code as string,\n\t\taccount_postal_code as string,\n\t\taccount_country_code as string,\n\t\tload_date as date,\n\t\tcreate_date as timestamp,\n\t\tmodified_date as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:false,\n\tupsertable:true,\n\tkeys:['source_system_key','account_geography_key'],\n\tformat: 'table',\n\tstaged: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tsource_system_key = Source_System_Key_AccountData,\n\t\taccount_geography_key = AccountGeographyHashkey,\n\t\tregion = RegionName,\n\t\tdivision = DivisionName,\n\t\taccount_address_line_one = Title_CardholderAddressLineOne,\n\t\taccount_address_line_two = Title_CardholderAddressLineTwo,\n\t\taccount_city = Title_account_city,\n\t\taccount_state_province_code = StateCode,\n\t\taccount_postal_code = CardholderAddressZip,\n\t\taccount_country_code = CountryCode,\n\t\tload_date = ReportDate,\n\t\tcreate_date = CreateDate,\n\t\tmodified_date = ModifiedDateNew\n\t)) ~> SnkdimAccountGeography"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/populate_XrefMember_FD')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "This is to populate Dim Account to the Azure DW.",
                "folder": {
                    "name": "Dimensions"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "all_stgFDCustomerData",
                                "type": "DatasetReference"
                            },
                            "name": "FDCustomerData"
                        },
                        {
                            "dataset": {
                                "referenceName": "xref_Member",
                                "type": "DatasetReference"
                            },
                            "name": "DwXrefMember"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "xref_Member",
                                "type": "DatasetReference"
                            },
                            "name": "SnkXrefMember"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "CreateHashkeys"
                        },
                        {
                            "name": "FormatAttributes"
                        },
                        {
                            "name": "SelectDistinctAttributes"
                        },
                        {
                            "name": "SelectCustomerAttributes"
                        },
                        {
                            "name": "ConvertDataAndApplyLogic"
                        },
                        {
                            "name": "DistinctAccounts"
                        },
                        {
                            "name": "AlterRow1"
                        },
                        {
                            "name": "TrimSpaces"
                        },
                        {
                            "name": "FilterNullAcctNums"
                        },
                        {
                            "name": "SortBeforeInsert"
                        },
                        {
                            "name": "ApplyAdditionalLogicToCardHolderName"
                        },
                        {
                            "name": "JoinXrefMember"
                        }
                    ],
                    "script": "source(output(\n\t\tCustomerDataID as string,\n\t\t{      CHD_ACCOUNT_NUMBER} as string,\n\t\t{      CHD_PRINCIPAL_NAME} as string,\n\t\t{      CHD_SPOUSE_NAME} as string,\n\t\t{      CHD_ADDR_LINE_1} as string,\n\t\t{      CHD_ADDR_LINE_2} as string,\n\t\t{      CHD_CITY} as string,\n\t\t{      CHD_STATE} as string,\n\t\t{      CHD_NUMERIC_STATE} as string,\n\t\t{      CHD_DELIVERY_POINT} as string,\n\t\t{      CHD_PD_PREFIX} as string,\n\t\t{      CHD_PD_SUFFIX} as string,\n\t\t{      CHD_PD_ADDRESS_FORMAT} as string,\n\t\t{      CHD_PD_ADDR_LINE_3} as string,\n\t\t{      CHD_PD_COUNTY} as string,\n\t\t{      CHD_PD_POSTCODE} as string,\n\t\t{      CHD_SD_PREFIX} as string,\n\t\t{      CHD_SD_SUFFIX} as string,\n\t\t{      CHD_SEX_CODE} as string,\n\t\t{      CHD_SOC_SECURITY_NO} as string,\n\t\t{      CHD_TELEPHONE_NUMBER} as string,\n\t\t{      CHD_SECOND_TELEPHONE_NUMBER} as string,\n\t\t{      CHD_HOME_PHONE_FORMAT} as string,\n\t\t{      CHD_BUS_PHONE_FORMAT} as string,\n\t\t{      CHD_MOTHERS_MAIDEN_NAME} as string,\n\t\t{      CHD_SECONDARY_SOC_SEC_NO} as string,\n\t\t{      CHD_DATE_LAST_ADDR_CHANGE} as string,\n\t\t{      CHD_NAME_ADDR_CHG} as string,\n\t\t{      CHD_ADDRESS_FLAG} as string,\n\t\t{      CHD_HOME_PHONE_FLAG} as string,\n\t\t{      CHD_BUSINESS_PHONE_FLAG} as string,\n\t\t{      CHD_DECEASED_FLAG} as string,\n\t\t{      CHD_SOLICITATION_FLAG} as string,\n\t\t{      CHD_EMPL_ACCT_CD} as string,\n\t\t{      CHD_ALT_CUSTOMER_NO} as string,\n\t\t{      CHD_DATE_OF_BIRTH} as string,\n\t\t{      CHD_SECONDARY_DATE_OF_BIRTH} as string,\n\t\t{      FDR_Date_Processed} as string,\n\t\t{      ExtractDate} as string,\n\t\t{      DateProcessed} as string,\n\t\t{      ReportDate} as string,\n\t\t{      CHD_FIXD_MPD_USAG_CD} as string,\n\t\t{      CHD_MPW_APR_OVRR_USAG_CD} as string,\n\t\t{      CHD_MPW_APR_OVRR_USAG_DT} as string,\n\t\t{      CHD_FIXD_MPD_OVRR_AM1} as string,\n\t\t{      CHD_FIXD_MPD_OVRR_DT1} as string,\n\t\t{      CHD_FIXD_MPD_OVRR_AM2} as string,\n\t\t{      CHD_FIXD_MPD_OVRR_DT2} as string,\n\t\t{      CHD_FIXD_MPD_OVRR_AM3} as string,\n\t\t{      CHD_FIXD_MPD_OVRR_DT3} as string,\n\t\t{      CHD_FIXD_MPD_OVRR_AM4} as string,\n\t\t{      CHD_FIXD_MPD_OVRR_DT4} as string,\n\t\t{      CHD_TSM_PRTC_IN} as string,\n\t\t{      CHD_ZIP_CODE} as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> FDCustomerData\nsource(output(\n\t\tsource_system_key as integer,\n\t\taccount_key as string,\n\t\tcustomer_key as string,\n\t\taccount_geography_key as string,\n\t\tload_date as timestamp,\n\t\tcreate_date as timestamp,\n\t\tmodified_date as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false) ~> DwXrefMember\nSelectDistinctAttributes derive(AccountGeographyHashkey = md5(\r\niif(isNull(Lower_CardholderAddressLineOne),'',Lower_CardholderAddressLineOne)\r\n, iif(isNull(Lower_CardholderAddressLineTwo),'',Lower_CardholderAddressLineTwo)    \r\n, iif(isNull(Lower_Account_City),'',Lower_Account_City)\r\n, iif(isNull(Lower_Account_State),'',Lower_Account_State)\r\n, iif(isNull(CardholderZip),'',CardholderZip)\r\n, iif(isNull(source_system_key_AccountData),0,source_system_key_AccountData)),\n\t\tAccountHashkey = md5(iif(isNull(AccountNumber_CustomerData),'',AccountNumber_CustomerData)\r\n, iif(isNull(source_system_key_AccountData),0,source_system_key_AccountData)),\n\t\tCustomerHashkey = md5(iif(isNull(Lower_CardholderFirstName),'',Lower_CardholderFirstName)\r\n, iif(isNull(Lower_CardholderMiddleInitial),'',Lower_CardholderMiddleInitial)\r\n, iif(isNull(Lower_CardholderLastName),'',Lower_CardholderLastName)\r\n, iif(isNull(Lower_GreetingName),'',Lower_GreetingName)\r\n, iif(isNull(source_system_key_AccountData),0,source_system_key_AccountData))) ~> CreateHashkeys\nJoinXrefMember derive(create_date_new = coalesce(create_date, currentTimestamp()),\n\t\tmodified_date_new = currentTimestamp(),\n\t\treport_date_modified = toTimestamp(ReportDate)) ~> FormatAttributes\nApplyAdditionalLogicToCardHolderName select(mapColumn(\n\t\tAccountNumber_CustomerData,\n\t\tReportDate,\n\t\tsource_system_key_AccountData = source_system_key_CustomerData,\n\t\tLower_CardholderAddressLineOne = CardholderAddressLineOne,\n\t\tLower_CardholderAddressLineTwo = CardholderAddressLineTwo,\n\t\tLower_Account_City = CardholderCity,\n\t\tLower_Account_State = CardholderState,\n\t\tCardholderZip = CHD_PD_POSTCODE,\n\t\tLower_CardholderFirstName = CardholderFirstName,\n\t\tLower_CardholderLastName = CardholderLastName,\n\t\tLower_CardholderMiddleInitial = CardholderMiddleInitial,\n\t\tLower_GreetingName = CardholderGreetingName\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectDistinctAttributes\nFDCustomerData select(mapColumn(\n\t\tAccountNumber_CustomerData = {      CHD_ACCOUNT_NUMBER},\n\t\tCHD_PRINCIPAL_NAME = {      CHD_PRINCIPAL_NAME},\n\t\tCHD_ADDR_LINE_1 = {      CHD_ADDR_LINE_1},\n\t\tCHD_ADDR_LINE_2 = {      CHD_ADDR_LINE_2},\n\t\tCHD_CITY = {      CHD_CITY},\n\t\tCHD_STATE = {      CHD_STATE},\n\t\tCHD_PD_POSTCODE = {      CHD_PD_POSTCODE},\n\t\tReportDate = {      ReportDate}\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectCustomerAttributes\nDistinctAccounts derive(CardholderFirstName = lower(substring(CHD_PRINCIPAL_NAME,(locate(',',CHD_PRINCIPAL_NAME)+1), 50)),\n\t\tCardholderLastName = lower(left(CHD_PRINCIPAL_NAME,\r\n(locate(',',CHD_PRINCIPAL_NAME)-1))),\n\t\tCardholderMiddleInitial = '',\n\t\tCardholderGreetingName = lower(CHD_PRINCIPAL_NAME),\n\t\tsource_system_key_CustomerData = 2,\n\t\tReportDate = toDate(ReportDate,'yyyy-MM-dd'),\n\t\tCardholderAddressLineOne = lower(CHD_ADDR_LINE_1),\n\t\tCardholderAddressLineTwo = lower(CHD_ADDR_LINE_2),\n\t\tCardholderCity = lower(CHD_CITY),\n\t\tCardholderState = lower(CHD_STATE)) ~> ConvertDataAndApplyLogic\nTrimSpaces aggregate(groupBy(AccountNumber_CustomerData,\n\t\tCHD_PRINCIPAL_NAME,\n\t\tCHD_ADDR_LINE_1,\n\t\tCHD_ADDR_LINE_2,\n\t\tCHD_CITY,\n\t\tCHD_STATE,\n\t\tCHD_PD_POSTCODE,\n\t\tReportDate),\n\tCountAccountNumber = count(AccountNumber_CustomerData)) ~> DistinctAccounts\nSortBeforeInsert alterRow(upsertIf(true())) ~> AlterRow1\nFilterNullAcctNums derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null()))))) ~> TrimSpaces\nSelectCustomerAttributes filter(!isNull(AccountNumber_CustomerData)) ~> FilterNullAcctNums\nFormatAttributes sort(asc(source_system_key_AccountData, true),\n\tasc(AccountHashkey, true),\n\tasc(CustomerHashkey, true),\n\tasc(AccountGeographyHashkey, true),\n\tpartitionLevel: true) ~> SortBeforeInsert\nConvertDataAndApplyLogic derive(CardholderFirstName = lower(substring(trim(substring(CardholderFirstName,(locate(',',CardholderFirstName)+1), length(CardholderFirstName)))\r\n,1,iif(locate(' ',trim(substring(CardholderFirstName,(locate(',',CardholderFirstName)+1), length(CardholderFirstName))))==0,100,locate(' ',trim(substring(CardholderFirstName,(locate(',',CardholderFirstName)+1), length(CardholderFirstName))))))),\n\t\tCardholderMiddleInitial = lower(substring(trim(substring(CardholderFirstName,(locate(',',CardholderFirstName)+1), length(CardholderFirstName)))\r\n,iif(locate(' ',trim(substring(CardholderFirstName,(locate(',',CardholderFirstName)+1), length(CardholderFirstName))))==0,100,locate(' ',trim(substring(CardholderFirstName,(locate(',',CardholderFirstName)+1), length(CardholderFirstName))))+1),1))) ~> ApplyAdditionalLogicToCardHolderName\nCreateHashkeys, DwXrefMember join(source_system_key_AccountData == source_system_key\n\t&& AccountHashkey == account_key\n\t&& CustomerHashkey == customer_key\n\t&& AccountGeographyHashkey == account_geography_key,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinXrefMember\nAlterRow1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tsource_system_key as integer,\n\t\taccount_key as string,\n\t\tcustomer_key as string,\n\t\taccount_geography_key as string,\n\t\tload_date as timestamp,\n\t\tcreate_date as timestamp,\n\t\tmodified_date as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:false,\n\tupsertable:true,\n\tkeys:['source_system_key','account_key','customer_key','account_geography_key'],\n\tformat: 'table',\n\tstaged: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tsource_system_key = source_system_key_AccountData,\n\t\taccount_key = AccountHashkey,\n\t\tcustomer_key = CustomerHashkey,\n\t\taccount_geography_key = AccountGeographyHashkey,\n\t\tload_date = report_date_modified,\n\t\tcreate_date = create_date_new,\n\t\tmodified_date = modified_date_new\n\t)) ~> SnkXrefMember"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/InsightCenter_DCI')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "DCI"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "ApplicationODS",
                                "type": "DatasetReference"
                            },
                            "name": "DigitalCardIssuance"
                        },
                        {
                            "dataset": {
                                "referenceName": "DS_ASDW_sbe_vw_cardholder",
                                "type": "DatasetReference"
                            },
                            "name": "CardHolder"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "snkDatawarehouse_DCI",
                                "type": "DatasetReference"
                            },
                            "name": "sinkConsolidated"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "LookupCardHolder"
                        },
                        {
                            "name": "Select"
                        }
                    ],
                    "script": "source(output(\n\t\tDigitalCardIssuanceId as integer,\n\t\tClientNum as string,\n\t\tCreateDte as timestamp,\n\t\tsource_system_key as integer,\n\t\tIssueDte as timestamp,\n\t\tCardNum as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table') ~> DigitalCardIssuance\nsource(output(\n\t\tCardHolderId as long,\n\t\tCardHolderGuid as string,\n\t\tsourceId as string,\n\t\tsourcesystemkey as integer,\n\t\tCardHolderType as string,\n\t\tAccountNumber as string,\n\t\tAccountKey as string,\n\t\tClientNumber as string,\n\t\tCCCID as string,\n\t\tExternalStatus as string,\n\t\tFirstName as string,\n\t\tLastName as string,\n\t\tMIDDLENAME as string,\n\t\tNationalidentifier as string,\n\t\tCardNumber as string,\n\t\tAddressLine1 as string,\n\t\tAddressLine2 as string,\n\t\tCity as string,\n\t\tState as string,\n\t\tCountry as string,\n\t\tZipcode as string,\n\t\tPIID as string,\n\t\tBIN as string,\n\t\tcardtype as string,\n\t\tCardStatus as string,\n\t\tBirthDate as date,\n\t\tHomePhone as string,\n\t\tCellPhone as string,\n\t\tWorkPhone as string,\n\t\tSSNLast4 as string,\n\t\tCheckingAccountNum as string,\n\t\tSavingsAccountNum as string,\n\t\tPersonalEmail as string,\n\t\tWorkEmail as string,\n\t\tCardHolderTypeCd as string,\n\t\tCardHolderPositionCd as string,\n\t\tMothersMaiden as string,\n\t\tDeceased as string,\n\t\tExpirationDate as date,\n\t\tCardHolderEntity as string,\n\t\tCardProgram as string,\n\t\tCrossReferenceAccountNum1 as string,\n\t\tCrossReferenceAccountNum2 as string,\n\t\tCrossReferenceAccountNum3 as string,\n\t\tSpaSystemBank as string,\n\t\tSpaPrincipalBank as string,\n\t\tSpaAgentBank as string,\n\t\tCreditBureauFlag as string,\n\t\tCardStatusChangeDate as date,\n\t\tInternalStatus as string,\n\t\tSrcReportDate as date,\n\t\tSrcCreateDate as timestamp,\n\t\tSrcModifiedDate as timestamp,\n\t\tLastmodifiedon as timestamp,\n\t\tCreatedon as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false) ~> CardHolder\nDigitalCardIssuance, CardHolder lookup(CardNum == CardNumber,\n\tmultiple: false,\n\tpickup: 'any',\n\tbroadcast: 'auto')~> LookupCardHolder\nLookupCardHolder select(mapColumn(\n\t\tDigitalCardIssuanceId,\n\t\tClientNum,\n\t\tsource_system_key,\n\t\tIssueDte,\n\t\tCardNum,\n\t\tAccountNum = AccountNumber\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select\nSelect sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tdigitalcardissuanceid as integer,\n\t\tclientnum as string,\n\t\tsource_system_key as integer,\n\t\tissuedte as timestamp,\n\t\tcardnum as string,\n\t\taccountnum as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\ttruncate:true,\n\tformat: 'table',\n\tstaged: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tdigitalcardissuanceid = DigitalCardIssuanceId,\n\t\tclientnum = ClientNum,\n\t\tsource_system_key,\n\t\tissuedte = IssueDte,\n\t\tcardnum = CardNum,\n\t\taccountnum = AccountNum\n\t)) ~> sinkConsolidated"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/update_Interchange_MSTR_IPM')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "Updates Interchange Values for MSTR using  7 days worth of dates from Interchange Raw which surround a single day of FIS Transactions from Conformed.",
                "folder": {
                    "name": "FIS"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "src_cnfm_All",
                                "type": "DatasetReference"
                            },
                            "name": "srcFISConformedTransactions"
                        },
                        {
                            "dataset": {
                                "referenceName": "populate_AuditTransactionsLog",
                                "type": "DatasetReference"
                            },
                            "name": "dwTransactionAuditLog"
                        },
                        {
                            "dataset": {
                                "referenceName": "dw_FISInterchangeRaw",
                                "type": "DatasetReference"
                            },
                            "name": "srcInterchangeRaw"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "fact_Transaction",
                                "type": "DatasetReference"
                            },
                            "name": "snkFactTransactions"
                        },
                        {
                            "dataset": {
                                "referenceName": "dwAuditUpdatedTransactions",
                                "type": "DatasetReference"
                            },
                            "name": "snkAuditInterchange"
                        },
                        {
                            "dataset": {
                                "referenceName": "populate_AuditTransactionsLog",
                                "type": "DatasetReference"
                            },
                            "name": "snkAuditTransactionsLog"
                        },
                        {
                            "dataset": {
                                "referenceName": "dw_FISInterchangeRaw",
                                "type": "DatasetReference"
                            },
                            "name": "snkInterchangeRaw"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "Trim"
                        },
                        {
                            "name": "LimitSelectInterchange"
                        },
                        {
                            "name": "derivedInterchange"
                        },
                        {
                            "name": "MarkUpdates"
                        },
                        {
                            "name": "DerivedColumn"
                        },
                        {
                            "name": "DistinctLoadID"
                        },
                        {
                            "name": "Lookup1"
                        },
                        {
                            "name": "AlterRow1"
                        },
                        {
                            "name": "derivedTransactionLog"
                        },
                        {
                            "name": "LimitSelectTransactions"
                        },
                        {
                            "name": "JoinMSTRIPM"
                        },
                        {
                            "name": "SelectFinal"
                        },
                        {
                            "name": "TrimConformed"
                        },
                        {
                            "name": "FilterAuthorizations"
                        },
                        {
                            "name": "FilterIPM"
                        },
                        {
                            "name": "FilterCard"
                        },
                        {
                            "name": "derivedTransactions"
                        }
                    ],
                    "script": "parameters{\n\tload_date as string ('20200118'),\n\tcard as string ('MSTR')\n}\nsource(output(\n\t\tAccountNumber as string,\n\t\tAcquirerAccountNumber as string,\n\t\tAcquirerNetworkCode as string,\n\t\tBin_ISO as string,\n\t\tBin_EXT as string,\n\t\tCardEntryMethodCode as string,\n\t\tCardPresenceDescription as string,\n\t\tImportFileDate as date,\n\t\tSource as string,\n\t\tInterchangeAmount as float,\n\t\tIssuerAccountNumber as string,\n\t\tIssuerNetworkCode as string,\n\t\tMerchantName as string,\n\t\tMerchantType as string,\n\t\tMonetary as integer,\n\t\tOnUsDescription as string,\n\t\tOriginalDataTransmissionDate as date,\n\t\tOriginDate as date,\n\t\tRecurringDescription as string,\n\t\tResponseCode as string,\n\t\tSettlementAmount as float,\n\t\tSettlementDate as date,\n\t\tSurchargeAmount as float,\n\t\tTerminalAddress as string,\n\t\tTerminalCity as string,\n\t\tTerminalCountry as string,\n\t\tTerminalKey as string,\n\t\tTerminalState as string,\n\t\tTerminalZipCode as string,\n\t\tTokenRequestId as string,\n\t\tTransactionName as string,\n\t\tTransactionTypeCode as string,\n\t\tTransmissionDate as date,\n\t\tTransmissionTime as string,\n\t\tTimeLocalTransaction as string,\n\t\tRetrievalReferenceNumber as string,\n\t\tTransaction_Key as long,\n\t\tAgentNo as string,\n\t\tSystemNo as string,\n\t\tOperCode as string,\n\t\tPrincipalNo as string,\n\t\tAuthorizationNo as string,\n\t\tClientNo as string,\n\t\ttransaction_amount as float,\n\t\tis_authorization as integer,\n\t\tAcquiringRTN as string,\n\t\tSettlementRTN as string,\n\t\tTraceNumber as string,\n\t\tAcqTraceNumber as string,\n\t\tVisaTransactionID as string,\n\t\tMasterCardTransactionID as string,\n\t\tMerchantAccountNumber as string\n\t),\n\tallowSchemaDrift: false,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tformat: 'parquet',\n\twildcardPaths:[(concat\r\n(\r\n'Transactions/'\r\n, substring($load_date,0,4)\r\n,'/'\r\n,substring($load_date,5,2)\r\n,'/'\r\n,substring($load_date,7,2)\r\n,'/FISDebitTransaction_*'\r\n))]) ~> srcFISConformedTransactions\nsource(output(\n\t\trun_id as long,\n\t\tload_date as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'SELECT run_id, load_date\\n  FROM [Audit].[transactions_log] a \\n  INNER JOIN (Select [file_name], max(create_date) as create_date from [Audit].[transactions_log] where source_system_key = 1 and [file_name] like \\'FISDebitTransaction%\\'\\ngroup by [file_name]) b\\n  on a.[file_name] = b.[file_name]\\n  and a.create_date = b.create_date',\n\tformat: 'query',\n\tstaged: false) ~> dwTransactionAuditLog\nsource(output(\n\t\tROWID as long,\n\t\tPAN as string,\n\t\t{SWITCH DATE} as string,\n\t\t{LOCAL DATE} as string,\n\t\t{DEBIT AMOUNT} as string,\n\t\t{CREDIT AMOUNT} as string,\n\t\t{MEMO AMOUNT} as string,\n\t\t{TERMINAL INTERCHANGE FEE} as string,\n\t\tSIGN7 as string,\n\t\t{CARDHOLDER INTERCHANGE FEE} as string,\n\t\tSIGN9 as string,\n\t\tACQ as string,\n\t\tISS as string,\n\t\t{TERM INST} as string,\n\t\t{CARD INST} as string,\n\t\t{TRAN TYPE} as string,\n\t\t{TRAN ID} as string,\n\t\tRRN as string,\n\t\t{SEQ NO} as string,\n\t\t{ACQ/ISS} as string,\n\t\t{ACTION CODE} as string,\n\t\t{TRANSACTION DESCRIPTION} as string,\n\t\t{REV REASON} as string,\n\t\t{REJ REASON} as string,\n\t\t{TRACE DATA} as string,\n\t\tProp_24 as string,\n\t\tProp_25 as string,\n\t\tfile_name as string,\n\t\tprocessed as boolean,\n\t\tcreate_date as string,\n\t\tmodified_date as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: (concat('Select * from [Staging].[FIS_Interchange_RAW] where processed = 0 and substring([LOCAL DATE],1,6)<= substring(convert(varchar(8),DATEADD(DAY,2,convert(date,',toString('\\''+ right($load_date,6)+ '\\''),')),112),3,6) and substring([LOCAL DATE],1,6) >= substring(convert(varchar(8),DATEADD(DAY,-7,convert(date,',toString('\\''+ right($load_date,6)+ '\\''),')),112),3,6) and cast([create_date] as datetime) > DATEADD(DAY,-7,GETUTCDATE())')),\n\tformat: 'query',\n\tstaged: false,\n\tpartitionColumn: 'ROWID',\n\tpartitionBy('external', 8)) ~> srcInterchangeRaw\nFilterCard derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null()))))) ~> Trim\nTrim select(mapColumn(\n\t\tROWID,\n\t\tPAN,\n\t\t{TRAN ID},\n\t\t{TRACE DATA},\n\t\t{TERMINAL INTERCHANGE FEE},\n\t\tSIGN7,\n\t\t{CARDHOLDER INTERCHANGE FEE},\n\t\tSIGN9,\n\t\t{CARD INST},\n\t\t{ACQ/ISS},\n\t\tACQ,\n\t\tISS,\n\t\tfile_name\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> LimitSelectInterchange\nLimitSelectInterchange derive(interchange_real = (iif(SIGN7=='DR', toDecimal(concat('-',{TERMINAL INTERCHANGE FEE})), toDecimal({TERMINAL INTERCHANGE FEE})))\r\n+\r\n(iif(SIGN9=='DR', toDecimal(concat('-',{CARDHOLDER INTERCHANGE FEE})), toDecimal({CARDHOLDER INTERCHANGE FEE}))),\n\t\tPAN = left(PAN,16),\n\t\tmodified_date = toString(currentUTC()),\n\t\tcard_inst = iif({ACQ/ISS}=='A',{CARD INST},'unknown'),\n\t\ttran_trace_id = left({TRAN ID},9),\n\t\tprocessed = 1) ~> derivedInterchange\nSelectFinal alterRow(updateIf(true())) ~> MarkUpdates\nSelectFinal derive(column_name = 'interchange_amount',\n\t\tcreate_date = toTimestamp(modified_date)) ~> DerivedColumn\nSelectFinal aggregate(groupBy(ImportFileDate),\n\tcount = count()) ~> DistinctLoadID\nDistinctLoadID, derivedTransactionLog lookup(ImportFileDate == load_date,\n\tmultiple: true,\n\tbroadcast: 'auto',\n\tpickup: 'any')~> Lookup1\nLookup1 alterRow(updateIf(true())) ~> AlterRow1\ndwTransactionAuditLog derive(load_date = toDate(load_date),\n\t\tloaded_to_semantic = false(),\n\t\tsem_start_date = toTimestamp(toString(null())),\n\t\tsem_end_date = toTimestamp(toString(null()))) ~> derivedTransactionLog\nTrimConformed select(mapColumn(\n\t\tAccountNumber,\n\t\tImportFileDate,\n\t\tSource,\n\t\tInterchangeAmount,\n\t\tOriginDate,\n\t\tTransaction_Key,\n\t\tSettlementRTN,\n\t\tAcqTraceNumber,\n\t\tMasterCardTransactionID\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> LimitSelectTransactions\nderivedTransactions, FilterIPM join(AccountNumber==PAN\r\n&&\r\nSettlementRTN==card_inst\r\n&&\r\n(AcqTraceNumber==tran_trace_id || MasterCardTransactionID==tran_trace_id),\n\tjoinType:'cross',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinMSTRIPM\nJoinMSTRIPM select(mapColumn(\n\t\tAccountNumber,\n\t\tImportFileDate,\n\t\tSource,\n\t\tInterchangeAmount,\n\t\tOriginDate,\n\t\tTransaction_Key,\n\t\tsource_system_key,\n\t\tROWID,\n\t\tfile_name,\n\t\tinterchange_real,\n\t\tmodified_date,\n\t\tprocessed\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectFinal\nFilterAuthorizations derive(each(match(type=='string'), $$ = trim($$))) ~> TrimConformed\nsrcFISConformedTransactions filter(is_authorization==0) ~> FilterAuthorizations\nderivedInterchange filter(like(ACQ,'CL%')) ~> FilterIPM\nsrcInterchangeRaw filter(instr(file_name,$card) > 0) ~> FilterCard\nLimitSelectTransactions derive(AccountNumber = left(AccountNumber,16),\n\t\tsource_system_key = 1,\n\t\tAcqTraceNumber = left(right(AcqTraceNumber,10),9),\n\t\tMasterCardTransactionID = left(MasterCardTransactionID,9)) ~> derivedTransactions\nMarkUpdates sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\ttransaction_key as long,\n\t\tsource_system_key as integer,\n\t\tsource_system_id as string,\n\t\taccount_key as string,\n\t\tacquirer_key as long,\n\t\tAcquirer_Network_key as long,\n\t\tbin_key as long,\n\t\tcard_entry_method_code_key as long,\n\t\tcard_presence_desc as string,\n\t\timport_file_date_key as date,\n\t\tinterchange_amount as decimal(25,2),\n\t\tissuer_key as long,\n\t\tissuer_network_key as long,\n\t\tmerchant_key as long,\n\t\tmerchant_terminal_geography_key as long,\n\t\tmerchant_type_key as long,\n\t\tmonetary as boolean,\n\t\ton_us_desc as string,\n\t\ttransmission_date_key as date,\n\t\torigin_date_key as date,\n\t\trecurring_desc as string,\n\t\tresponse_code_key as long,\n\t\tsettlement_amount as decimal(25,2),\n\t\tsettlement_date_key as date,\n\t\tsurcharge_amount as decimal(25,2),\n\t\ttermnial_key as long,\n\t\ttoken_requestid as long,\n\t\ttransaction_name_key as long,\n\t\tTransaction_type_key as long,\n\t\trun_id as long,\n\t\tdigital_card_issued_ind as boolean,\n\t\tauthorization_ind as boolean,\n\t\tauthorization_no as string\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['transaction_key','source_system_key','origin_date_key'],\n\tskipKeyWrites:true,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 1,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\ttransaction_key = Transaction_Key,\n\t\tsource_system_key,\n\t\torigin_date_key = OriginDate,\n\t\tinterchange_amount = interchange_real\n\t)) ~> snkFactTransactions\nDerivedColumn sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tsource_system_key as integer,\n\t\ttransaction_key as long,\n\t\tcolumn_name as string,\n\t\told_value as string,\n\t\tnew_value as string,\n\t\tload_date as timestamp,\n\t\tcreate_date as timestamp,\n\t\tfile_name as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tbatchSize: 5000,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 4,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tsource_system_key,\n\t\ttransaction_key = Transaction_Key,\n\t\tcolumn_name,\n\t\told_value = InterchangeAmount,\n\t\tnew_value = interchange_real,\n\t\tload_date = ImportFileDate,\n\t\tcreate_date,\n\t\tfile_name\n\t)) ~> snkAuditInterchange\nAlterRow1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\trun_id as long,\n\t\tsource_system_key as integer,\n\t\tfile_name as string,\n\t\trecord_count as long,\n\t\tloaded_to_semantic as boolean,\n\t\tload_date as timestamp,\n\t\tcreate_date as timestamp,\n\t\tsem_start_date as timestamp,\n\t\tsem_end_date as timestamp,\n\t\tsf_loaded_to_semantic as boolean,\n\t\tsf_sem_start_date as timestamp,\n\t\tsf_sem_end_date as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['run_id'],\n\tskipKeyWrites:true,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 3,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\trun_id,\n\t\tloaded_to_semantic,\n\t\tsem_start_date,\n\t\tsem_end_date,\n\t\tsf_loaded_to_semantic = loaded_to_semantic,\n\t\tsf_sem_start_date = sem_start_date,\n\t\tsf_sem_end_date = sem_end_date\n\t)) ~> snkAuditTransactionsLog\nMarkUpdates sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tROWID as long,\n\t\tPAN as string,\n\t\t{SWITCH DATE} as string,\n\t\t{LOCAL DATE} as string,\n\t\t{DEBIT AMOUNT} as string,\n\t\t{CREDIT AMOUNT} as string,\n\t\t{MEMO AMOUNT} as string,\n\t\t{TERMINAL INTERCHANGE FEE} as string,\n\t\tSIGN7 as string,\n\t\t{CARDHOLDER INTERCHANGE FEE} as string,\n\t\tSIGN9 as string,\n\t\tACQ as string,\n\t\tISS as string,\n\t\t{TERM INST} as string,\n\t\t{CARD INST} as string,\n\t\t{TRAN TYPE} as string,\n\t\t{TRAN ID} as string,\n\t\tRRN as string,\n\t\t{SEQ NO} as string,\n\t\t{ACQ/ISS} as string,\n\t\t{ACTION CODE} as string,\n\t\t{TRANSACTION DESCRIPTION} as string,\n\t\t{REV REASON} as string,\n\t\t{REJ REASON} as string,\n\t\t{TRACE DATA} as string,\n\t\tProp_24 as string,\n\t\tProp_25 as string,\n\t\tfile_name as string,\n\t\tprocessed as boolean,\n\t\tcreate_date as string,\n\t\tmodified_date as string\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['ROWID'],\n\tskipKeyWrites:true,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tpostSQLs:['Update Statistics [Staging].[FIS_Interchange_RAW] '],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 2,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tROWID,\n\t\tprocessed,\n\t\tmodified_date\n\t)) ~> snkInterchangeRaw"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/update_Interchange_MSTR_Cirrus')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "Updates Interchange Values for MSTR using  7 days worth of dates from Interchange Raw which surround a single day of FIS Transactions from Conformed.",
                "folder": {
                    "name": "FIS"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "src_cnfm_All",
                                "type": "DatasetReference"
                            },
                            "name": "srcFISConformedTransactions"
                        },
                        {
                            "dataset": {
                                "referenceName": "populate_AuditTransactionsLog",
                                "type": "DatasetReference"
                            },
                            "name": "dwTransactionAuditLog"
                        },
                        {
                            "dataset": {
                                "referenceName": "dw_FISInterchangeRaw",
                                "type": "DatasetReference"
                            },
                            "name": "srcInterchangeRaw"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "fact_Transaction",
                                "type": "DatasetReference"
                            },
                            "name": "snkFactTransactions"
                        },
                        {
                            "dataset": {
                                "referenceName": "dwAuditUpdatedTransactions",
                                "type": "DatasetReference"
                            },
                            "name": "snkAuditInterchange"
                        },
                        {
                            "dataset": {
                                "referenceName": "populate_AuditTransactionsLog",
                                "type": "DatasetReference"
                            },
                            "name": "snkAuditTransactionsLog"
                        },
                        {
                            "dataset": {
                                "referenceName": "dw_FISInterchangeRaw",
                                "type": "DatasetReference"
                            },
                            "name": "snkInterchangeRaw"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "Trim"
                        },
                        {
                            "name": "LimitSelectInterchange"
                        },
                        {
                            "name": "derivedInterchange"
                        },
                        {
                            "name": "MarkUpdates"
                        },
                        {
                            "name": "DerivedColumn"
                        },
                        {
                            "name": "DistinctLoadID"
                        },
                        {
                            "name": "Lookup1"
                        },
                        {
                            "name": "AlterRow1"
                        },
                        {
                            "name": "derivedTransactionLog"
                        },
                        {
                            "name": "JoinMSTRCirrus"
                        },
                        {
                            "name": "LimitSelectTransactions"
                        },
                        {
                            "name": "SelectFinal"
                        },
                        {
                            "name": "TrimConformed"
                        },
                        {
                            "name": "FilterAuthorizations"
                        },
                        {
                            "name": "FilterCirrus"
                        },
                        {
                            "name": "FilterCard"
                        },
                        {
                            "name": "derivedTransactions"
                        }
                    ],
                    "script": "parameters{\n\tload_date as string ('20200118'),\n\tcard as string ('MSTR')\n}\nsource(output(\n\t\tAccountNumber as string,\n\t\tAcquirerAccountNumber as string,\n\t\tAcquirerNetworkCode as string,\n\t\tBin_ISO as string,\n\t\tBin_EXT as string,\n\t\tCardEntryMethodCode as string,\n\t\tCardPresenceDescription as string,\n\t\tImportFileDate as date,\n\t\tSource as string,\n\t\tInterchangeAmount as float,\n\t\tIssuerAccountNumber as string,\n\t\tIssuerNetworkCode as string,\n\t\tMerchantName as string,\n\t\tMerchantType as string,\n\t\tMonetary as integer,\n\t\tOnUsDescription as string,\n\t\tOriginalDataTransmissionDate as date,\n\t\tOriginDate as date,\n\t\tRecurringDescription as string,\n\t\tResponseCode as string,\n\t\tSettlementAmount as float,\n\t\tSettlementDate as date,\n\t\tSurchargeAmount as float,\n\t\tTerminalAddress as string,\n\t\tTerminalCity as string,\n\t\tTerminalCountry as string,\n\t\tTerminalKey as string,\n\t\tTerminalState as string,\n\t\tTerminalZipCode as string,\n\t\tTokenRequestId as string,\n\t\tTransactionName as string,\n\t\tTransactionTypeCode as string,\n\t\tTransmissionDate as date,\n\t\tTransmissionTime as string,\n\t\tTimeLocalTransaction as string,\n\t\tRetrievalReferenceNumber as string,\n\t\tTransaction_Key as long,\n\t\tAgentNo as string,\n\t\tSystemNo as string,\n\t\tOperCode as string,\n\t\tPrincipalNo as string,\n\t\tAuthorizationNo as string,\n\t\tClientNo as string,\n\t\ttransaction_amount as float,\n\t\tis_authorization as integer,\n\t\tAcquiringRTN as string,\n\t\tSettlementRTN as string,\n\t\tTraceNumber as string,\n\t\tAcqTraceNumber as string,\n\t\tVisaTransactionID as string,\n\t\tMasterCardTransactionID as string,\n\t\tMerchantAccountNumber as string\n\t),\n\tallowSchemaDrift: false,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tformat: 'parquet',\n\twildcardPaths:[(concat\r\n(\r\n'Transactions/'\r\n, substring($load_date,0,4)\r\n,'/'\r\n,substring($load_date,5,2)\r\n,'/'\r\n,substring($load_date,7,2)\r\n,'/FISDebitTransaction_*'\r\n))]) ~> srcFISConformedTransactions\nsource(output(\n\t\trun_id as long,\n\t\tload_date as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'SELECT run_id, load_date\\n  FROM [Audit].[transactions_log] a \\n  INNER JOIN (Select [file_name], max(create_date) as create_date from [Audit].[transactions_log] where source_system_key = 1 and [file_name] like \\'FISDebitTransaction%\\'\\ngroup by [file_name]) b\\n  on a.[file_name] = b.[file_name]\\n  and a.create_date = b.create_date',\n\tformat: 'query',\n\tstaged: false) ~> dwTransactionAuditLog\nsource(output(\n\t\tROWID as long,\n\t\tPAN as string,\n\t\t{SWITCH DATE} as string,\n\t\t{LOCAL DATE} as string,\n\t\t{DEBIT AMOUNT} as string,\n\t\t{CREDIT AMOUNT} as string,\n\t\t{MEMO AMOUNT} as string,\n\t\t{TERMINAL INTERCHANGE FEE} as string,\n\t\tSIGN7 as string,\n\t\t{CARDHOLDER INTERCHANGE FEE} as string,\n\t\tSIGN9 as string,\n\t\tACQ as string,\n\t\tISS as string,\n\t\t{TERM INST} as string,\n\t\t{CARD INST} as string,\n\t\t{TRAN TYPE} as string,\n\t\t{TRAN ID} as string,\n\t\tRRN as string,\n\t\t{SEQ NO} as string,\n\t\t{ACQ/ISS} as string,\n\t\t{ACTION CODE} as string,\n\t\t{TRANSACTION DESCRIPTION} as string,\n\t\t{REV REASON} as string,\n\t\t{REJ REASON} as string,\n\t\t{TRACE DATA} as string,\n\t\tProp_24 as string,\n\t\tProp_25 as string,\n\t\tfile_name as string,\n\t\tprocessed as boolean,\n\t\tcreate_date as string,\n\t\tmodified_date as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: (concat('Select * from [Staging].[FIS_Interchange_RAW] where processed = 0 and substring([LOCAL DATE],1,6)<= substring(convert(varchar(8),DATEADD(DAY,2,convert(date,',toString('\\''+ right($load_date,6)+ '\\''),')),112),3,6) and substring([LOCAL DATE],1,6) >= substring(convert(varchar(8),DATEADD(DAY,-7,convert(date,',toString('\\''+ right($load_date,6)+ '\\''),')),112),3,6) and cast([create_date] as datetime) > DATEADD(DAY,-7,GETUTCDATE())')),\n\tformat: 'query',\n\tstaged: false,\n\tpartitionColumn: 'ROWID',\n\tpartitionBy('external', 8)) ~> srcInterchangeRaw\nFilterCard derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null()))))) ~> Trim\nTrim select(mapColumn(\n\t\tROWID,\n\t\tPAN,\n\t\t{LOCAL DATE},\n\t\t{TRACE DATA},\n\t\t{TRAN ID},\n\t\t{TERMINAL INTERCHANGE FEE},\n\t\tSIGN7,\n\t\t{CARDHOLDER INTERCHANGE FEE},\n\t\tSIGN9,\n\t\tACQ,\n\t\tRRN,\n\t\tfile_name\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> LimitSelectInterchange\nLimitSelectInterchange derive(interchange_real = (iif(SIGN7=='DR', toDecimal(concat('-',{TERMINAL INTERCHANGE FEE})), toDecimal({TERMINAL INTERCHANGE FEE})))\r\n+\r\n(iif(SIGN9=='DR', toDecimal(concat('-',{CARDHOLDER INTERCHANGE FEE})), toDecimal({CARDHOLDER INTERCHANGE FEE}))),\n\t\tPAN_masked = iif(like(PAN,'%XXXXXX%'),concat(left(PAN,6),right(PAN,4)),left(PAN,16)),\n\t\tmodified_date = toString(currentUTC()),\n\t\ttran_trace_id = iif({TRACE DATA}=='',iif({TRAN ID}=='','XXXXXX',left({TRAN ID},6)),left({TRACE DATA},6)),\n\t\t{TRACE DATA} = left({TRACE DATA},6),\n\t\tprocessed = 1,\n\t\tlocal_date_timestamp = right(left({LOCAL DATE},12),6),\n\t\tRRN = left(RRN,12)) ~> derivedInterchange\nSelectFinal alterRow(updateIf(true())) ~> MarkUpdates\nSelectFinal derive(create_date = toTimestamp(modified_date),\n\t\tcolumn_name = 'interchange_amount') ~> DerivedColumn\nSelectFinal aggregate(groupBy(ImportFileDate),\n\tcount = count()) ~> DistinctLoadID\nDistinctLoadID, derivedTransactionLog lookup(ImportFileDate == load_date,\n\tmultiple: true,\n\tbroadcast: 'auto',\n\tpickup: 'any')~> Lookup1\nLookup1 alterRow(updateIf(true())) ~> AlterRow1\ndwTransactionAuditLog derive(load_date = toDate(load_date),\n\t\tloaded_to_semantic = false(),\n\t\tsem_start_date = toTimestamp(toString(null())),\n\t\tsem_end_date = toTimestamp(toString(null()))) ~> derivedTransactionLog\nderivedTransactions, FilterCirrus join((PAN_masked==AccountNumber||PAN_masked==masked_acctnum)\r\n&&\r\norigin_date_timestamp==local_date_timestamp\r\n&&\r\nTraceNumber=={TRACE DATA},\n\tjoinType:'cross',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinMSTRCirrus\nTrimConformed select(mapColumn(\n\t\tAccountNumber,\n\t\tImportFileDate,\n\t\tSource,\n\t\tInterchangeAmount,\n\t\tOriginDate,\n\t\tTimeLocalTransaction,\n\t\tTransaction_Key,\n\t\tTraceNumber,\n\t\tRetrievalReferenceNumber\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> LimitSelectTransactions\nJoinMSTRCirrus select(mapColumn(\n\t\tAccountNumber,\n\t\tImportFileDate,\n\t\tSource,\n\t\tInterchangeAmount,\n\t\tOriginDate,\n\t\tTransaction_Key,\n\t\tsource_system_key,\n\t\tROWID,\n\t\tfile_name,\n\t\tinterchange_real,\n\t\tmodified_date,\n\t\tprocessed\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectFinal\nFilterAuthorizations derive(each(match(type=='string'), $$ = trim($$))) ~> TrimConformed\nsrcFISConformedTransactions filter(is_authorization==0) ~> FilterAuthorizations\nderivedInterchange filter((like(ACQ,'CI%') || like(ACQ,'MC%') || like(ACQ,'MS%') || like(ACQ,'VI%') || like(ACQ,'CS%'))) ~> FilterCirrus\nsrcInterchangeRaw filter(instr(file_name,$card) > 0) ~> FilterCard\nLimitSelectTransactions derive(masked_acctnum = concat(left(AccountNumber,6),right(left(AccountNumber,16),4)),\n\t\tAccountNumber = left(AccountNumber,16),\n\t\tsource_system_key = 1,\n\t\torigin_date_timestamp = replace(left(TimeLocalTransaction,8),':',''),\n\t\tRetrievalReferenceNumber = left(RetrievalReferenceNumber,12),\n\t\tTraceNumber = left(TraceNumber,6)) ~> derivedTransactions\nMarkUpdates sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\ttransaction_key as long,\n\t\tsource_system_key as integer,\n\t\tsource_system_id as string,\n\t\taccount_key as string,\n\t\tacquirer_key as long,\n\t\tAcquirer_Network_key as long,\n\t\tbin_key as long,\n\t\tcard_entry_method_code_key as long,\n\t\tcard_presence_desc as string,\n\t\timport_file_date_key as date,\n\t\tinterchange_amount as decimal(25,2),\n\t\tissuer_key as long,\n\t\tissuer_network_key as long,\n\t\tmerchant_key as long,\n\t\tmerchant_terminal_geography_key as long,\n\t\tmerchant_type_key as long,\n\t\tmonetary as boolean,\n\t\ton_us_desc as string,\n\t\ttransmission_date_key as date,\n\t\torigin_date_key as date,\n\t\trecurring_desc as string,\n\t\tresponse_code_key as long,\n\t\tsettlement_amount as decimal(25,2),\n\t\tsettlement_date_key as date,\n\t\tsurcharge_amount as decimal(25,2),\n\t\ttermnial_key as long,\n\t\ttoken_requestid as long,\n\t\ttransaction_name_key as long,\n\t\tTransaction_type_key as long,\n\t\trun_id as long,\n\t\tdigital_card_issued_ind as boolean,\n\t\tauthorization_ind as boolean,\n\t\tauthorization_no as string\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['transaction_key','source_system_key','origin_date_key'],\n\tskipKeyWrites:true,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 1,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\ttransaction_key = Transaction_Key,\n\t\tsource_system_key,\n\t\torigin_date_key = OriginDate,\n\t\tinterchange_amount = interchange_real\n\t)) ~> snkFactTransactions\nDerivedColumn sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tsource_system_key as integer,\n\t\ttransaction_key as long,\n\t\tcolumn_name as string,\n\t\told_value as string,\n\t\tnew_value as string,\n\t\tload_date as timestamp,\n\t\tcreate_date as timestamp,\n\t\tfile_name as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tbatchSize: 5000,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 4,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tsource_system_key,\n\t\ttransaction_key = Transaction_Key,\n\t\tcolumn_name,\n\t\told_value = InterchangeAmount,\n\t\tnew_value = interchange_real,\n\t\tload_date = ImportFileDate,\n\t\tcreate_date,\n\t\tfile_name\n\t)) ~> snkAuditInterchange\nAlterRow1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\trun_id as long,\n\t\tsource_system_key as integer,\n\t\tfile_name as string,\n\t\trecord_count as long,\n\t\tloaded_to_semantic as boolean,\n\t\tload_date as timestamp,\n\t\tcreate_date as timestamp,\n\t\tsem_start_date as timestamp,\n\t\tsem_end_date as timestamp,\n\t\tsf_loaded_to_semantic as boolean,\n\t\tsf_sem_start_date as timestamp,\n\t\tsf_sem_end_date as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['run_id'],\n\tskipKeyWrites:true,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 3,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\trun_id,\n\t\tloaded_to_semantic,\n\t\tsem_start_date,\n\t\tsem_end_date,\n\t\tsf_loaded_to_semantic = loaded_to_semantic,\n\t\tsf_sem_start_date = sem_start_date,\n\t\tsf_sem_end_date = sem_end_date\n\t)) ~> snkAuditTransactionsLog\nMarkUpdates sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tROWID as long,\n\t\tPAN as string,\n\t\t{SWITCH DATE} as string,\n\t\t{LOCAL DATE} as string,\n\t\t{DEBIT AMOUNT} as string,\n\t\t{CREDIT AMOUNT} as string,\n\t\t{MEMO AMOUNT} as string,\n\t\t{TERMINAL INTERCHANGE FEE} as string,\n\t\tSIGN7 as string,\n\t\t{CARDHOLDER INTERCHANGE FEE} as string,\n\t\tSIGN9 as string,\n\t\tACQ as string,\n\t\tISS as string,\n\t\t{TERM INST} as string,\n\t\t{CARD INST} as string,\n\t\t{TRAN TYPE} as string,\n\t\t{TRAN ID} as string,\n\t\tRRN as string,\n\t\t{SEQ NO} as string,\n\t\t{ACQ/ISS} as string,\n\t\t{ACTION CODE} as string,\n\t\t{TRANSACTION DESCRIPTION} as string,\n\t\t{REV REASON} as string,\n\t\t{REJ REASON} as string,\n\t\t{TRACE DATA} as string,\n\t\tProp_24 as string,\n\t\tProp_25 as string,\n\t\tfile_name as string,\n\t\tprocessed as boolean,\n\t\tcreate_date as string,\n\t\tmodified_date as string\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['ROWID'],\n\tskipKeyWrites:true,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tpostSQLs:['Update Statistics [Staging].[FIS_Interchange_RAW] '],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 2,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tROWID,\n\t\tprocessed,\n\t\tmodified_date\n\t)) ~> snkInterchangeRaw"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/update_Interchange_VISA')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "Updates Interchange Values for VISA using  7 days worth of dates from Interchange Raw which surround a single day of FIS Transactions from Conformed.",
                "folder": {
                    "name": "FIS"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "src_cnfm_All",
                                "type": "DatasetReference"
                            },
                            "name": "srcFISConformedTransactions"
                        },
                        {
                            "dataset": {
                                "referenceName": "populate_AuditTransactionsLog",
                                "type": "DatasetReference"
                            },
                            "name": "dwTransactionAuditLog"
                        },
                        {
                            "dataset": {
                                "referenceName": "dw_FISInterchangeRaw",
                                "type": "DatasetReference"
                            },
                            "name": "srcInterchangeRaw"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "fact_Transaction",
                                "type": "DatasetReference"
                            },
                            "name": "snkFactTransactions"
                        },
                        {
                            "dataset": {
                                "referenceName": "dwAuditUpdatedTransactions",
                                "type": "DatasetReference"
                            },
                            "name": "snkAuditInterchange"
                        },
                        {
                            "dataset": {
                                "referenceName": "populate_AuditTransactionsLog",
                                "type": "DatasetReference"
                            },
                            "name": "snkAuditTransactionsLog"
                        },
                        {
                            "dataset": {
                                "referenceName": "dw_FISInterchangeRaw",
                                "type": "DatasetReference"
                            },
                            "name": "snkInterchangeRaw"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "Trim"
                        },
                        {
                            "name": "LimitSelectInterchange"
                        },
                        {
                            "name": "Transformations"
                        },
                        {
                            "name": "MarkUpdates"
                        },
                        {
                            "name": "DerivedColumn"
                        },
                        {
                            "name": "DistinctLoadID"
                        },
                        {
                            "name": "Lookup1"
                        },
                        {
                            "name": "AlterRow1"
                        },
                        {
                            "name": "derivedTransactionLog"
                        },
                        {
                            "name": "LimitSelectTransactions"
                        },
                        {
                            "name": "JoinVISA"
                        },
                        {
                            "name": "SelectFinal"
                        },
                        {
                            "name": "TrimConformed"
                        },
                        {
                            "name": "FilterAuthorizations"
                        },
                        {
                            "name": "FilterCard"
                        },
                        {
                            "name": "DerivedTransactions"
                        },
                        {
                            "name": "DerivedInterchange"
                        }
                    ],
                    "script": "parameters{\n\tload_date as string ('20200118'),\n\tcard as string ('VISA')\n}\nsource(output(\n\t\tAccountNumber as string,\n\t\tAcquirerAccountNumber as string,\n\t\tAcquirerNetworkCode as string,\n\t\tBin_ISO as string,\n\t\tBin_EXT as string,\n\t\tCardEntryMethodCode as string,\n\t\tCardPresenceDescription as string,\n\t\tImportFileDate as date,\n\t\tSource as string,\n\t\tInterchangeAmount as float,\n\t\tIssuerAccountNumber as string,\n\t\tIssuerNetworkCode as string,\n\t\tMerchantName as string,\n\t\tMerchantType as string,\n\t\tMonetary as integer,\n\t\tOnUsDescription as string,\n\t\tOriginalDataTransmissionDate as date,\n\t\tOriginDate as date,\n\t\tRecurringDescription as string,\n\t\tResponseCode as string,\n\t\tSettlementAmount as float,\n\t\tSettlementDate as date,\n\t\tSurchargeAmount as float,\n\t\tTerminalAddress as string,\n\t\tTerminalCity as string,\n\t\tTerminalCountry as string,\n\t\tTerminalKey as string,\n\t\tTerminalState as string,\n\t\tTerminalZipCode as string,\n\t\tTokenRequestId as string,\n\t\tTransactionName as string,\n\t\tTransactionTypeCode as string,\n\t\tTransmissionDate as date,\n\t\tTransmissionTime as string,\n\t\tTimeLocalTransaction as string,\n\t\tRetrievalReferenceNumber as string,\n\t\tTransaction_Key as long,\n\t\tAgentNo as string,\n\t\tSystemNo as string,\n\t\tOperCode as string,\n\t\tPrincipalNo as string,\n\t\tAuthorizationNo as string,\n\t\tClientNo as string,\n\t\ttransaction_amount as float,\n\t\tis_authorization as integer,\n\t\tAcquiringRTN as string,\n\t\tSettlementRTN as string,\n\t\tTraceNumber as string,\n\t\tAcqTraceNumber as string,\n\t\tVisaTransactionID as string,\n\t\tMasterCardTransactionID as string,\n\t\tMerchantAccountNumber as string\n\t),\n\tallowSchemaDrift: false,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tformat: 'parquet',\n\twildcardPaths:[(concat\r\n(\r\n'Transactions/'\r\n, substring($load_date,0,4)\r\n,'/'\r\n,substring($load_date,5,2)\r\n,'/'\r\n,substring($load_date,7,2)\r\n,'/FISDebitTransaction_*'\r\n))]) ~> srcFISConformedTransactions\nsource(output(\n\t\trun_id as long,\n\t\tload_date as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'SELECT run_id, load_date\\n  FROM [Audit].[transactions_log] a \\n  INNER JOIN (Select [file_name], max(create_date) as create_date from [Audit].[transactions_log] where source_system_key = 1 and [file_name] like \\'FISDebitTransaction%\\'\\ngroup by [file_name]) b\\n  on a.[file_name] = b.[file_name]\\n  and a.create_date = b.create_date',\n\tformat: 'query',\n\tstaged: false) ~> dwTransactionAuditLog\nsource(output(\n\t\tROWID as long,\n\t\tPAN as string,\n\t\t{SWITCH DATE} as string,\n\t\t{LOCAL DATE} as string,\n\t\t{DEBIT AMOUNT} as string,\n\t\t{CREDIT AMOUNT} as string,\n\t\t{MEMO AMOUNT} as string,\n\t\t{TERMINAL INTERCHANGE FEE} as string,\n\t\tSIGN7 as string,\n\t\t{CARDHOLDER INTERCHANGE FEE} as string,\n\t\tSIGN9 as string,\n\t\tACQ as string,\n\t\tISS as string,\n\t\t{TERM INST} as string,\n\t\t{CARD INST} as string,\n\t\t{TRAN TYPE} as string,\n\t\t{TRAN ID} as string,\n\t\tRRN as string,\n\t\t{SEQ NO} as string,\n\t\t{ACQ/ISS} as string,\n\t\t{ACTION CODE} as string,\n\t\t{TRANSACTION DESCRIPTION} as string,\n\t\t{REV REASON} as string,\n\t\t{REJ REASON} as string,\n\t\t{TRACE DATA} as string,\n\t\tProp_24 as string,\n\t\tProp_25 as string,\n\t\tfile_name as string,\n\t\tprocessed as boolean,\n\t\tcreate_date as string,\n\t\tmodified_date as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: (concat('Select * from [Staging].[FIS_Interchange_RAW] where processed = 0 and substring([LOCAL DATE],1,6)<= substring(convert(varchar(8),DATEADD(DAY,2,convert(date,',toString('\\''+ right($load_date,6)+ '\\''),')),112),3,6) and substring([LOCAL DATE],1,6) >= substring(convert(varchar(8),DATEADD(DAY,-7,convert(date,',toString('\\''+ right($load_date,6)+ '\\''),')),112),3,6) and cast([create_date] as datetime) > DATEADD(DAY,-7,GETUTCDATE())')),\n\tformat: 'query',\n\tstaged: false,\n\tpartitionColumn: 'ROWID',\n\tpartitionBy('external', 8)) ~> srcInterchangeRaw\nFilterCard derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null()))))) ~> Trim\nTrim select(mapColumn(\n\t\tROWID,\n\t\tPAN,\n\t\t{LOCAL DATE},\n\t\t{DEBIT AMOUNT},\n\t\t{CREDIT AMOUNT},\n\t\t{MEMO AMOUNT},\n\t\t{TRAN TYPE},\n\t\t{TRAN ID},\n\t\tRRN,\n\t\t{TERMINAL INTERCHANGE FEE},\n\t\tSIGN7,\n\t\t{CARDHOLDER INTERCHANGE FEE},\n\t\tSIGN9,\n\t\t{TERM INST},\n\t\t{CARD INST},\n\t\t{ACQ/ISS},\n\t\tACQ,\n\t\tISS,\n\t\t{TRACE DATA},\n\t\tfile_name\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> LimitSelectInterchange\nLimitSelectInterchange derive(local_date_timestamp = toTimestamp(left({LOCAL DATE},12), 'yyMMddHHmmss'),\n\t\tinterchange_real = (iif(SIGN7=='DR', toDecimal(concat('-',{TERMINAL INTERCHANGE FEE})), toDecimal({TERMINAL INTERCHANGE FEE})))\r\n+\r\n(iif(SIGN9=='DR', toDecimal(concat('-',{CARDHOLDER INTERCHANGE FEE})), toDecimal({CARDHOLDER INTERCHANGE FEE}))),\n\t\tdebit_amount = toFloat(replace({DEBIT AMOUNT},',')),\n\t\tcredit_amount = toFloat(replace({CREDIT AMOUNT},',')),\n\t\tmemo_amount = toFloat(replace({MEMO AMOUNT},',')),\n\t\tmodified_date = toString(currentUTC()),\n\t\tprocessed = 1) ~> Transformations\nSelectFinal alterRow(updateIf(true())) ~> MarkUpdates\nSelectFinal derive(create_date = toTimestamp(modified_date),\n\t\tcolumn_name = 'interchange_amount') ~> DerivedColumn\nSelectFinal aggregate(groupBy(ImportFileDate),\n\tcount = count()) ~> DistinctLoadID\nDistinctLoadID, derivedTransactionLog lookup(ImportFileDate == load_date,\n\tmultiple: true,\n\tbroadcast: 'auto',\n\tpickup: 'any')~> Lookup1\nLookup1 alterRow(updateIf(true())) ~> AlterRow1\ndwTransactionAuditLog derive(load_date = toDate(load_date),\n\t\tloaded_to_semantic = false(),\n\t\tsem_start_date = toTimestamp(toString(null())),\n\t\tsem_end_date = toTimestamp(toString(null()))) ~> derivedTransactionLog\nTrimConformed select(mapColumn(\n\t\tAccountNumber,\n\t\tImportFileDate,\n\t\tSource,\n\t\tInterchangeAmount,\n\t\tOriginDate,\n\t\tSettlementAmount,\n\t\tSurchargeAmount,\n\t\tTransactionTypeCode,\n\t\tTimeLocalTransaction,\n\t\tRetrievalReferenceNumber,\n\t\tTransaction_Key,\n\t\tAcquiringRTN,\n\t\tSettlementRTN,\n\t\tTraceNumber,\n\t\tAcqTraceNumber,\n\t\tVisaTransactionID,\n\t\tMasterCardTransactionID\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> LimitSelectTransactions\nDerivedTransactions, DerivedInterchange join((PAN_masked==AccountNumber||PAN_masked==masked_acctnum)\r\n&&\r\nlocal_date_date==OriginDate\r\n&&\r\nsum_amounts==TransactionAmount\r\n&&\r\ntran_id==VisaTransactionID,\n\tjoinType:'cross',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinVISA\nJoinVISA select(mapColumn(\n\t\tAccountNumber,\n\t\tImportFileDate,\n\t\tSource,\n\t\tInterchangeAmount,\n\t\tOriginDate,\n\t\tTransaction_Key,\n\t\tsource_system_key,\n\t\tROWID,\n\t\tfile_name,\n\t\tinterchange_real,\n\t\tmodified_date,\n\t\tprocessed\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectFinal\nFilterAuthorizations derive(each(match(type=='string'), $$ = trim($$))) ~> TrimConformed\nsrcFISConformedTransactions filter(is_authorization==0) ~> FilterAuthorizations\nsrcInterchangeRaw filter(instr(file_name,$card) > 0) ~> FilterCard\nLimitSelectTransactions derive(masked_acctnum = concat(left(AccountNumber,6),right(left(AccountNumber,16),4)),\n\t\tAccountNumber = left(AccountNumber,16),\n\t\tTransactionAmount = SettlementAmount+SurchargeAmount,\n\t\tsource_system_key = 1) ~> DerivedTransactions\nTransformations derive(PAN_masked = iif(like(PAN,'%XXXXXX%'),concat(left(PAN,6),right(PAN,4)),left(PAN,16)),\n\t\tlocal_date_date = toDate(left(toString(local_date_timestamp),10)),\n\t\tsum_amounts = debit_amount+credit_amount+memo_amount,\n\t\ttran_id = {TRAN ID}) ~> DerivedInterchange\nMarkUpdates sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\ttransaction_key as long,\n\t\tsource_system_key as integer,\n\t\tsource_system_id as string,\n\t\taccount_key as string,\n\t\tacquirer_key as long,\n\t\tAcquirer_Network_key as long,\n\t\tbin_key as long,\n\t\tcard_entry_method_code_key as long,\n\t\tcard_presence_desc as string,\n\t\timport_file_date_key as date,\n\t\tinterchange_amount as decimal(25,2),\n\t\tissuer_key as long,\n\t\tissuer_network_key as long,\n\t\tmerchant_key as long,\n\t\tmerchant_terminal_geography_key as long,\n\t\tmerchant_type_key as long,\n\t\tmonetary as boolean,\n\t\ton_us_desc as string,\n\t\ttransmission_date_key as date,\n\t\torigin_date_key as date,\n\t\trecurring_desc as string,\n\t\tresponse_code_key as long,\n\t\tsettlement_amount as decimal(25,2),\n\t\tsettlement_date_key as date,\n\t\tsurcharge_amount as decimal(25,2),\n\t\ttermnial_key as long,\n\t\ttoken_requestid as long,\n\t\ttransaction_name_key as long,\n\t\tTransaction_type_key as long,\n\t\trun_id as long,\n\t\tdigital_card_issued_ind as boolean,\n\t\tauthorization_ind as boolean,\n\t\tauthorization_no as string\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['transaction_key','source_system_key','origin_date_key'],\n\tskipKeyWrites:true,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 1,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\ttransaction_key = Transaction_Key,\n\t\tsource_system_key,\n\t\torigin_date_key = OriginDate,\n\t\tinterchange_amount = interchange_real\n\t)) ~> snkFactTransactions\nDerivedColumn sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tsource_system_key as integer,\n\t\ttransaction_key as long,\n\t\tcolumn_name as string,\n\t\told_value as string,\n\t\tnew_value as string,\n\t\tload_date as timestamp,\n\t\tcreate_date as timestamp,\n\t\tfile_name as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tbatchSize: 5000,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 4,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tsource_system_key,\n\t\ttransaction_key = Transaction_Key,\n\t\tcolumn_name,\n\t\told_value = InterchangeAmount,\n\t\tnew_value = interchange_real,\n\t\tload_date = ImportFileDate,\n\t\tcreate_date,\n\t\tfile_name\n\t)) ~> snkAuditInterchange\nAlterRow1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\trun_id as long,\n\t\tsource_system_key as integer,\n\t\tfile_name as string,\n\t\trecord_count as long,\n\t\tloaded_to_semantic as boolean,\n\t\tload_date as timestamp,\n\t\tcreate_date as timestamp,\n\t\tsem_start_date as timestamp,\n\t\tsem_end_date as timestamp,\n\t\tsf_loaded_to_semantic as boolean,\n\t\tsf_sem_start_date as timestamp,\n\t\tsf_sem_end_date as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['run_id'],\n\tskipKeyWrites:true,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 3,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\trun_id,\n\t\tloaded_to_semantic,\n\t\tsem_start_date,\n\t\tsem_end_date,\n\t\tsf_loaded_to_semantic = loaded_to_semantic,\n\t\tsf_sem_start_date = sem_start_date,\n\t\tsf_sem_end_date = sem_end_date\n\t)) ~> snkAuditTransactionsLog\nMarkUpdates sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tROWID as long,\n\t\tPAN as string,\n\t\t{SWITCH DATE} as string,\n\t\t{LOCAL DATE} as string,\n\t\t{DEBIT AMOUNT} as string,\n\t\t{CREDIT AMOUNT} as string,\n\t\t{MEMO AMOUNT} as string,\n\t\t{TERMINAL INTERCHANGE FEE} as string,\n\t\tSIGN7 as string,\n\t\t{CARDHOLDER INTERCHANGE FEE} as string,\n\t\tSIGN9 as string,\n\t\tACQ as string,\n\t\tISS as string,\n\t\t{TERM INST} as string,\n\t\t{CARD INST} as string,\n\t\t{TRAN TYPE} as string,\n\t\t{TRAN ID} as string,\n\t\tRRN as string,\n\t\t{SEQ NO} as string,\n\t\t{ACQ/ISS} as string,\n\t\t{ACTION CODE} as string,\n\t\t{TRANSACTION DESCRIPTION} as string,\n\t\t{REV REASON} as string,\n\t\t{REJ REASON} as string,\n\t\t{TRACE DATA} as string,\n\t\tProp_24 as string,\n\t\tProp_25 as string,\n\t\tfile_name as string,\n\t\tprocessed as boolean,\n\t\tcreate_date as string,\n\t\tmodified_date as string\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['ROWID'],\n\tskipKeyWrites:true,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tpostSQLs:['Update Statistics [Staging].[FIS_Interchange_RAW] '],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 2,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tROWID,\n\t\tprocessed,\n\t\tmodified_date\n\t)) ~> snkInterchangeRaw"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/update_Interchange_PULSE')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "Updates Interchange Values for PUSLE using  7 days worth of dates from Interchange Raw which surround a single day of FIS Transactions from Conformed.",
                "folder": {
                    "name": "FIS"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "src_cnfm_All",
                                "type": "DatasetReference"
                            },
                            "name": "srcFISConformedTransactions"
                        },
                        {
                            "dataset": {
                                "referenceName": "populate_AuditTransactionsLog",
                                "type": "DatasetReference"
                            },
                            "name": "dwTransactionAuditLog"
                        },
                        {
                            "dataset": {
                                "referenceName": "dw_FISInterchangeRaw",
                                "type": "DatasetReference"
                            },
                            "name": "srcInterchangeRaw"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "fact_Transaction",
                                "type": "DatasetReference"
                            },
                            "name": "snkFactTransactions"
                        },
                        {
                            "dataset": {
                                "referenceName": "dwAuditUpdatedTransactions",
                                "type": "DatasetReference"
                            },
                            "name": "snkAuditInterchange"
                        },
                        {
                            "dataset": {
                                "referenceName": "populate_AuditTransactionsLog",
                                "type": "DatasetReference"
                            },
                            "name": "snkAuditTransactionsLog"
                        },
                        {
                            "dataset": {
                                "referenceName": "dw_FISInterchangeRaw",
                                "type": "DatasetReference"
                            },
                            "name": "snkInterchangeRaw"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "Trim"
                        },
                        {
                            "name": "LimitSelectInterchange"
                        },
                        {
                            "name": "DerivedInterchange"
                        },
                        {
                            "name": "toTimestampTransactions"
                        },
                        {
                            "name": "MarkUpdates"
                        },
                        {
                            "name": "DerivedColumn"
                        },
                        {
                            "name": "DistinctLoadID"
                        },
                        {
                            "name": "Lookup1"
                        },
                        {
                            "name": "AlterRow1"
                        },
                        {
                            "name": "derivedTransactionLog"
                        },
                        {
                            "name": "JoinPULSE"
                        },
                        {
                            "name": "LimitSelectTransactions"
                        },
                        {
                            "name": "SelectFinal"
                        },
                        {
                            "name": "TrimConformed"
                        },
                        {
                            "name": "FilterAuthorizations"
                        },
                        {
                            "name": "DerivedTransactions"
                        },
                        {
                            "name": "FilterCard"
                        }
                    ],
                    "script": "parameters{\n\tload_date as string ('20200118'),\n\tcard as string ('PULS')\n}\nsource(output(\n\t\tAccountNumber as string,\n\t\tAcquirerAccountNumber as string,\n\t\tAcquirerNetworkCode as string,\n\t\tBin_ISO as string,\n\t\tBin_EXT as string,\n\t\tCardEntryMethodCode as string,\n\t\tCardPresenceDescription as string,\n\t\tImportFileDate as date,\n\t\tSource as string,\n\t\tInterchangeAmount as float,\n\t\tIssuerAccountNumber as string,\n\t\tIssuerNetworkCode as string,\n\t\tMerchantName as string,\n\t\tMerchantType as string,\n\t\tMonetary as integer,\n\t\tOnUsDescription as string,\n\t\tOriginalDataTransmissionDate as date,\n\t\tOriginDate as date,\n\t\tRecurringDescription as string,\n\t\tResponseCode as string,\n\t\tSettlementAmount as float,\n\t\tSettlementDate as date,\n\t\tSurchargeAmount as float,\n\t\tTerminalAddress as string,\n\t\tTerminalCity as string,\n\t\tTerminalCountry as string,\n\t\tTerminalKey as string,\n\t\tTerminalState as string,\n\t\tTerminalZipCode as string,\n\t\tTokenRequestId as string,\n\t\tTransactionName as string,\n\t\tTransactionTypeCode as string,\n\t\tTransmissionDate as date,\n\t\tTransmissionTime as string,\n\t\tTimeLocalTransaction as string,\n\t\tRetrievalReferenceNumber as string,\n\t\tTransaction_Key as long,\n\t\tAgentNo as string,\n\t\tSystemNo as string,\n\t\tOperCode as string,\n\t\tPrincipalNo as string,\n\t\tAuthorizationNo as string,\n\t\tClientNo as string,\n\t\ttransaction_amount as float,\n\t\tis_authorization as integer,\n\t\tAcquiringRTN as string,\n\t\tSettlementRTN as string,\n\t\tTraceNumber as string,\n\t\tAcqTraceNumber as string,\n\t\tVisaTransactionID as string,\n\t\tMasterCardTransactionID as string,\n\t\tMerchantAccountNumber as string\n\t),\n\tallowSchemaDrift: false,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tformat: 'parquet',\n\twildcardPaths:[(concat\r\n(\r\n'Transactions/'\r\n, substring($load_date,0,4)\r\n,'/'\r\n,substring($load_date,5,2)\r\n,'/'\r\n,substring($load_date,7,2)\r\n,'/FISDebitTransaction_*'\r\n))]) ~> srcFISConformedTransactions\nsource(output(\n\t\trun_id as long,\n\t\tload_date as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'SELECT run_id, load_date\\n  FROM [Audit].[transactions_log] a \\n  INNER JOIN (Select [file_name], max(create_date) as create_date from [Audit].[transactions_log] where source_system_key = 1 and [file_name] like \\'FISDebitTransaction%\\'\\ngroup by [file_name]) b\\n  on a.[file_name] = b.[file_name]\\n  and a.create_date = b.create_date',\n\tformat: 'query',\n\tstaged: false) ~> dwTransactionAuditLog\nsource(output(\n\t\tROWID as long,\n\t\tPAN as string,\n\t\t{SWITCH DATE} as string,\n\t\t{LOCAL DATE} as string,\n\t\t{DEBIT AMOUNT} as string,\n\t\t{CREDIT AMOUNT} as string,\n\t\t{MEMO AMOUNT} as string,\n\t\t{TERMINAL INTERCHANGE FEE} as string,\n\t\tSIGN7 as string,\n\t\t{CARDHOLDER INTERCHANGE FEE} as string,\n\t\tSIGN9 as string,\n\t\tACQ as string,\n\t\tISS as string,\n\t\t{TERM INST} as string,\n\t\t{CARD INST} as string,\n\t\t{TRAN TYPE} as string,\n\t\t{TRAN ID} as string,\n\t\tRRN as string,\n\t\t{SEQ NO} as string,\n\t\t{ACQ/ISS} as string,\n\t\t{ACTION CODE} as string,\n\t\t{TRANSACTION DESCRIPTION} as string,\n\t\t{REV REASON} as string,\n\t\t{REJ REASON} as string,\n\t\t{TRACE DATA} as string,\n\t\tProp_24 as string,\n\t\tProp_25 as string,\n\t\tfile_name as string,\n\t\tprocessed as boolean,\n\t\tcreate_date as string,\n\t\tmodified_date as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: (concat('Select * from [Staging].[FIS_Interchange_RAW] where processed = 0 and substring([LOCAL DATE],1,6)<= substring(convert(varchar(8),DATEADD(DAY,2,convert(date,',toString('\\''+ right($load_date,6)+ '\\''),')),112),3,6) and substring([LOCAL DATE],1,6) >= substring(convert(varchar(8),DATEADD(DAY,-7,convert(date,',toString('\\''+ right($load_date,6)+ '\\''),')),112),3,6) and cast([create_date] as datetime) > DATEADD(DAY,-7,GETUTCDATE())')),\n\tformat: 'query',\n\tstaged: false,\n\tpartitionColumn: 'ROWID',\n\tpartitionBy('external', 8)) ~> srcInterchangeRaw\nFilterCard derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null()))))) ~> Trim\nTrim select(mapColumn(\n\t\tROWID,\n\t\tPAN,\n\t\t{LOCAL DATE},\n\t\t{TRAN TYPE},\n\t\t{TRAN ID},\n\t\tRRN,\n\t\t{TERMINAL INTERCHANGE FEE},\n\t\tSIGN7,\n\t\t{CARDHOLDER INTERCHANGE FEE},\n\t\tSIGN9,\n\t\t{TERM INST},\n\t\t{CARD INST},\n\t\t{ACQ/ISS},\n\t\tACQ,\n\t\tISS,\n\t\t{TRACE DATA},\n\t\tfile_name\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> LimitSelectInterchange\nLimitSelectInterchange derive(local_date_timestamp = right(left({LOCAL DATE},12),6),\n\t\tPAN = left(PAN,16),\n\t\tinterchange_real = (iif(SIGN7=='DR', toDecimal(concat('-',{TERMINAL INTERCHANGE FEE})), toDecimal({TERMINAL INTERCHANGE FEE})))\r\n+\r\n(iif(SIGN9=='DR', toDecimal(concat('-',{CARDHOLDER INTERCHANGE FEE})), toDecimal({CARDHOLDER INTERCHANGE FEE}))),\n\t\tmodified_date = toString(currentUTC()),\n\t\tprocessed = 1,\n\t\tPAN_masked = iif(like(PAN,'%XXXX%'),concat(left(PAN,6),right(left(PAN,16),4)),left(PAN,16)),\n\t\tRRN = left(RRN,8)) ~> DerivedInterchange\nLimitSelectTransactions derive(OriginDate_timestamp = replace(left(TimeLocalTransaction,8),':',''),\n\t\tsource_system_key = 1) ~> toTimestampTransactions\nSelectFinal alterRow(updateIf(true())) ~> MarkUpdates\nSelectFinal derive(create_date = toTimestamp(modified_date),\n\t\tcolumn_name = 'interchange_amount') ~> DerivedColumn\nSelectFinal aggregate(groupBy(ImportFileDate),\n\tcount = count()) ~> DistinctLoadID\nDistinctLoadID, derivedTransactionLog lookup(ImportFileDate == load_date,\n\tmultiple: true,\n\tbroadcast: 'auto',\n\tpickup: 'any')~> Lookup1\nLookup1 alterRow(updateIf(true())) ~> AlterRow1\ndwTransactionAuditLog derive(load_date = toDate(load_date),\n\t\tloaded_to_semantic = false(),\n\t\tsem_start_date = toTimestamp(toString(null())),\n\t\tsem_end_date = toTimestamp(toString(null()))) ~> derivedTransactionLog\nDerivedTransactions, DerivedInterchange join((PAN_masked==AccountNumber||PAN_masked==masked_acctnum)\r\n&&\r\nlocal_date_timestamp==OriginDate_timestamp\r\n&&\r\nRRN==RetrievalReferenceNumber,\n\tjoinType:'cross',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinPULSE\nTrimConformed select(mapColumn(\n\t\tAccountNumber,\n\t\tImportFileDate,\n\t\tSource,\n\t\tInterchangeAmount,\n\t\tOriginDate,\n\t\tSettlementAmount,\n\t\tSurchargeAmount,\n\t\tTransactionTypeCode,\n\t\tTimeLocalTransaction,\n\t\tRetrievalReferenceNumber,\n\t\tTransaction_Key,\n\t\tAcquiringRTN,\n\t\tSettlementRTN,\n\t\tTraceNumber,\n\t\tAcqTraceNumber,\n\t\tVisaTransactionID,\n\t\tMasterCardTransactionID\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> LimitSelectTransactions\nJoinPULSE select(mapColumn(\n\t\tAccountNumber,\n\t\tImportFileDate,\n\t\tSource,\n\t\tInterchangeAmount,\n\t\tOriginDate,\n\t\tTransaction_Key,\n\t\tsource_system_key,\n\t\tROWID,\n\t\tfile_name,\n\t\tinterchange_real,\n\t\tmodified_date,\n\t\tprocessed\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectFinal\nFilterAuthorizations derive(each(match(type=='string'), $$ = trim($$))) ~> TrimConformed\nsrcFISConformedTransactions filter(is_authorization==0) ~> FilterAuthorizations\ntoTimestampTransactions derive(AccountNumber = left(AccountNumber,16),\n\t\tmasked_acctnum = concat(left(AccountNumber,6),right(left(AccountNumber,16),4)),\n\t\tRetrievalReferenceNumber = left(RetrievalReferenceNumber,8)) ~> DerivedTransactions\nsrcInterchangeRaw filter(instr(file_name,$card) > 0) ~> FilterCard\nMarkUpdates sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\ttransaction_key as long,\n\t\tsource_system_key as integer,\n\t\tsource_system_id as string,\n\t\taccount_key as string,\n\t\tacquirer_key as long,\n\t\tAcquirer_Network_key as long,\n\t\tbin_key as long,\n\t\tcard_entry_method_code_key as long,\n\t\tcard_presence_desc as string,\n\t\timport_file_date_key as date,\n\t\tinterchange_amount as decimal(25,2),\n\t\tissuer_key as long,\n\t\tissuer_network_key as long,\n\t\tmerchant_key as long,\n\t\tmerchant_terminal_geography_key as long,\n\t\tmerchant_type_key as long,\n\t\tmonetary as boolean,\n\t\ton_us_desc as string,\n\t\ttransmission_date_key as date,\n\t\torigin_date_key as date,\n\t\trecurring_desc as string,\n\t\tresponse_code_key as long,\n\t\tsettlement_amount as decimal(25,2),\n\t\tsettlement_date_key as date,\n\t\tsurcharge_amount as decimal(25,2),\n\t\ttermnial_key as long,\n\t\ttoken_requestid as long,\n\t\ttransaction_name_key as long,\n\t\tTransaction_type_key as long,\n\t\trun_id as long,\n\t\tdigital_card_issued_ind as boolean,\n\t\tauthorization_ind as boolean,\n\t\tauthorization_no as string\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['transaction_key','source_system_key','origin_date_key'],\n\tskipKeyWrites:true,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 1,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\ttransaction_key = Transaction_Key,\n\t\tsource_system_key,\n\t\torigin_date_key = OriginDate,\n\t\tinterchange_amount = interchange_real\n\t)) ~> snkFactTransactions\nDerivedColumn sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tsource_system_key as integer,\n\t\ttransaction_key as long,\n\t\tcolumn_name as string,\n\t\told_value as string,\n\t\tnew_value as string,\n\t\tload_date as timestamp,\n\t\tcreate_date as timestamp,\n\t\tfile_name as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tbatchSize: 5000,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 4,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tsource_system_key,\n\t\ttransaction_key = Transaction_Key,\n\t\tcolumn_name,\n\t\told_value = InterchangeAmount,\n\t\tnew_value = interchange_real,\n\t\tload_date = ImportFileDate,\n\t\tcreate_date,\n\t\tfile_name\n\t)) ~> snkAuditInterchange\nAlterRow1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\trun_id as long,\n\t\tsource_system_key as integer,\n\t\tfile_name as string,\n\t\trecord_count as long,\n\t\tloaded_to_semantic as boolean,\n\t\tload_date as timestamp,\n\t\tcreate_date as timestamp,\n\t\tsem_start_date as timestamp,\n\t\tsem_end_date as timestamp,\n\t\tsf_loaded_to_semantic as boolean,\n\t\tsf_sem_start_date as timestamp,\n\t\tsf_sem_end_date as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['run_id'],\n\tskipKeyWrites:true,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 3,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\trun_id,\n\t\tloaded_to_semantic,\n\t\tsem_start_date,\n\t\tsem_end_date,\n\t\tsf_loaded_to_semantic = loaded_to_semantic,\n\t\tsf_sem_start_date = sem_start_date,\n\t\tsf_sem_end_date = sem_end_date\n\t)) ~> snkAuditTransactionsLog\nMarkUpdates sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tROWID as long,\n\t\tPAN as string,\n\t\t{SWITCH DATE} as string,\n\t\t{LOCAL DATE} as string,\n\t\t{DEBIT AMOUNT} as string,\n\t\t{CREDIT AMOUNT} as string,\n\t\t{MEMO AMOUNT} as string,\n\t\t{TERMINAL INTERCHANGE FEE} as string,\n\t\tSIGN7 as string,\n\t\t{CARDHOLDER INTERCHANGE FEE} as string,\n\t\tSIGN9 as string,\n\t\tACQ as string,\n\t\tISS as string,\n\t\t{TERM INST} as string,\n\t\t{CARD INST} as string,\n\t\t{TRAN TYPE} as string,\n\t\t{TRAN ID} as string,\n\t\tRRN as string,\n\t\t{SEQ NO} as string,\n\t\t{ACQ/ISS} as string,\n\t\t{ACTION CODE} as string,\n\t\t{TRANSACTION DESCRIPTION} as string,\n\t\t{REV REASON} as string,\n\t\t{REJ REASON} as string,\n\t\t{TRACE DATA} as string,\n\t\tProp_24 as string,\n\t\tProp_25 as string,\n\t\tfile_name as string,\n\t\tprocessed as boolean,\n\t\tcreate_date as string,\n\t\tmodified_date as string\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['ROWID'],\n\tskipKeyWrites:true,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tpostSQLs:['Update Statistics [Staging].[FIS_Interchange_RAW] '],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 2,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tROWID,\n\t\tprocessed,\n\t\tmodified_date\n\t)) ~> snkInterchangeRaw"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/populate_CardHolderFIS')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "FIS"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "src_stgFISDebitDemographic_CH",
                                "type": "DatasetReference"
                            },
                            "name": "srcFISDebitDemographic"
                        },
                        {
                            "dataset": {
                                "referenceName": "src_stgCountryCode",
                                "type": "DatasetReference"
                            },
                            "name": "srcCountryCode"
                        },
                        {
                            "dataset": {
                                "referenceName": "src_stgCountryCodeSubdivision",
                                "type": "DatasetReference"
                            },
                            "name": "srcCountryCodeSubdivision"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_BIN",
                                "type": "DatasetReference"
                            },
                            "name": "dwDimBin"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Client",
                                "type": "DatasetReference"
                            },
                            "name": "dwDimClient"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "dst_MemberCardHolder_staging",
                                "type": "DatasetReference"
                            },
                            "name": "snkCardHolderStaging"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "trimBlankSpacesFISDebitDemographic"
                        },
                        {
                            "name": "SelectFISDebitDemographic"
                        },
                        {
                            "name": "dcFISDebitDemographic"
                        },
                        {
                            "name": "SelectCountry"
                        },
                        {
                            "name": "trimBlankSpaceCountry"
                        },
                        {
                            "name": "SelectSubdivision"
                        },
                        {
                            "name": "trimBlankSpaceSubdivision"
                        },
                        {
                            "name": "ijCountrySubdivision"
                        },
                        {
                            "name": "dcCountrySubdivision"
                        },
                        {
                            "name": "SelectCountryAll"
                        },
                        {
                            "name": "LookupSubdivisionFISCountry"
                        },
                        {
                            "name": "SelectFinal"
                        },
                        {
                            "name": "SelectDerivedColumns"
                        },
                        {
                            "name": "ijClient"
                        },
                        {
                            "name": "SelectBinClient"
                        },
                        {
                            "name": "distinctAccounts"
                        },
                        {
                            "name": "cjBinClient"
                        },
                        {
                            "name": "windowClientBin"
                        },
                        {
                            "name": "filterClientBin"
                        },
                        {
                            "name": "selectBinClientFISDebit"
                        },
                        {
                            "name": "ljBinClientFISDebit"
                        },
                        {
                            "name": "SelectFISDebitClientBin"
                        },
                        {
                            "name": "FilterOutBadAccountNumbers"
                        },
                        {
                            "name": "FilterOutHeadingsIfExists"
                        },
                        {
                            "name": "SelectDerivedColumns1"
                        },
                        {
                            "name": "DeDup1"
                        }
                    ],
                    "script": "source(output(\n\t\tFISDebitDemographicID as string,\n\t\tAccountNumber as string,\n\t\tPlasticNumber as string,\n\t\tGreetingName as string,\n\t\tFinancialInstitutionRouteTransit as string,\n\t\tCardStatus as string,\n\t\tLastUsedDate as date,\n\t\tAuthorizationLimitGroup as string,\n\t\tPINOffset as string,\n\t\tTrackTwoDate as string,\n\t\tDDAAccountNumber as string,\n\t\tSavingsAccountNumber as string,\n\t\tAdditionalDDAAccountNumberOne as string,\n\t\tAdditionalDDAAccountNumberTwo as string,\n\t\tAdditionalDDAAccountNumberThree as string,\n\t\tAdditionalDDAAccountNumberFour as string,\n\t\tAdditionalDDAAccountNumberFive as string,\n\t\tAdditionalSavingsAccountNumberOne as string,\n\t\tAdditionalSavingsAccountNumberTwo as string,\n\t\tAdditionalSavingsAccountNumberThree as string,\n\t\tAdditionalSavingsAccountNumberFour as string,\n\t\tAdditionalSavingsAccountNumberFive as string,\n\t\tAdditionalCreditAccountNumberOne as string,\n\t\tAdditionalCreditAccountNumberTwo as string,\n\t\tAdditionalCreditAccountNumberThree as string,\n\t\tAdditionalCreditAccountNumberFour as string,\n\t\tAdditionalOtherAccountNumberOne as string,\n\t\tAdditionalOtherAccountNumberTwo as string,\n\t\tAdditionalOtherAccountNumberThree as string,\n\t\tAdditionalOtherAccountNumberFour as string,\n\t\tCardholderAddressLineOne as string,\n\t\tCardholderAddressLineTwo as string,\n\t\tCardholderAddressCity as string,\n\t\tCardholderAddressState as string,\n\t\tCardholderAddressZip as string,\n\t\tCardholderFirstName as string,\n\t\tCardholderLastName as string,\n\t\tCardholderMiddleInitial as string,\n\t\tCardActivationFlag as string,\n\t\tOriginalIssueDate as date,\n\t\tLastIssueDate as date,\n\t\tNationalIdentifier as string,\n\t\tMothersMaidenName as string,\n\t\tHomePhone as string,\n\t\tWorkPhone as string,\n\t\tUserValidation as string,\n\t\tVRUCounter as string,\n\t\tBirthDate as date,\n\t\tCardActivationMethod as string,\n\t\tCardActivationDate as string,\n\t\tCardActivationTime as date,\n\t\tPreviousExpirationDate as string,\n\t\tPreviousCardActivationStatus as string,\n\t\tCardStatusTwo as string,\n\t\tFISDebitImportFileName as string,\n\t\tCreateDate as string,\n\t\tBINNumber as string,\n\t\tClientNumberIssuer as string,\n\t\tHashFullRecord as string,\n\t\tLastUpdatedDate as date,\n\t\tReportDate as date\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcFISDebitDemographic\nsource(output(\n\t\tAlpha2Code as string,\n\t\tShortName as string,\n\t\tShortNameLowerCase as string,\n\t\tFullName as string,\n\t\tAlpha3Code as string,\n\t\tNumericCode as string,\n\t\tDialCode as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcCountryCode\nsource(output(\n\t\tAlpha2Code as string,\n\t\tSubdivision as string,\n\t\tSubdivisionCategory as string,\n\t\t{3166_2code} as string,\n\t\tSubdivisionName as string,\n\t\tLocalVariant as string,\n\t\tLanguageCode as string,\n\t\tRoaniationSystem as string,\n\t\tParentSubdivision as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcCountryCodeSubdivision\nsource(output(\n\t\tdw_binkey as long,\n\t\tdw_clientkey as long,\n\t\tbankIdentificationNumberISO as string,\n\t\tbankIdentificationNumberEXT as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'select distinct bin_key as dw_binkey, client_key as dw_clientkey, bankIdentificationNumberISO, bankIdentificationNumberEXT from [financialinstitution].[dim_bin] with (nolock)',\n\tformat: 'query',\n\tstaged: false) ~> dwDimBin\nsource(output(\n\t\tclient_key as long,\n\t\tclient_name as string,\n\t\tclient_number as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'SELECT DISTINCT client_key, client_name, client_number FROM FinancialInstitution.dim_client With(NoLock)',\n\tformat: 'query',\n\tstaged: false) ~> dwDimClient\nSelectFISDebitDemographic derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null()))))) ~> trimBlankSpacesFISDebitDemographic\nFilterOutHeadingsIfExists select(mapColumn(\n\t\tClientNum = ClientNumberIssuer,\n\t\tAccountNum = AccountNumber,\n\t\tCardNum = AccountNumber,\n\t\tMothersMaidenName,\n\t\tExpirationDate = TrackTwoDate,\n\t\tCardholderFirstName,\n\t\tCardholderMiddleInitial,\n\t\tCardholderLastName,\n\t\tSocialSecurityNum = NationalIdentifier,\n\t\tBirthDate,\n\t\tAddress1LineOne = CardholderAddressLineOne,\n\t\tAddress1LineTwo = CardholderAddressLineTwo,\n\t\tAddress1City = CardholderAddressCity,\n\t\tAddress1State = CardholderAddressState,\n\t\tAddress1ZipCode = CardholderAddressZip,\n\t\tHomePhone,\n\t\tBusinessPhone = WorkPhone,\n\t\tTransitRoutingNum = FinancialInstitutionRouteTransit,\n\t\tCheckingAccountNum = DDAAccountNumber,\n\t\tSavingsAccountNum = SavingsAccountNumber,\n\t\tAccountSystemEntryDate = CardActivationDate,\n\t\tExternalStatus = CardStatusTwo,\n\t\tCardStatus,\n\t\tReportDate,\n\t\tPlasticNumber,\n\t\tLastUpdatedDate,\n\t\tLastIssueDate\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectFISDebitDemographic\ntrimBlankSpacesFISDebitDemographic derive(SourceId_dc = toString('FIS'),\n\t\tCardHolder_Type_Cd_dc = toString('01'),\n\t\tCardHolderPositionCd_dc = toString('001'),\n\t\tBusinessPhone_dc = case(BusinessPhone == '0000000000', toString(null()), BusinessPhone),\n\t\tCardholderLastName_dc = coalesce(CardholderLastName,'UNKNOWN'),\n\t\tAddressSource_dc = iif(isNull(Address1State), 'NoAddr', 'FISDebit'),\n\t\tReportDate_dc = coalesce(ReportDate, toDate('1901-01-01')),\n\t\tAccountNum_dc = iif(isNull(AccountNum)||length(AccountNum)<16||regexMatch(AccountNum,'[^0-9.]')==true(),'99999',AccountNum),\n\t\tCardNum_dc = iif(isNull(AccountNum),'99999',AccountNum),\n\t\tCardTypeCd_dc = 'D',\n\t\tCreateDate_dc = currentUTC(),\n\t\tTransitRoutingNum_dc = right(ltrim(rtrim(TransitRoutingNum)),9),\n\t\tExpirationDate = case(toString(toDate(case(\r\nExpirationDate == ''\r\n||ExpirationDate == 'NULL'\r\n||ExpirationDate == '0000'\r\n||substring(ExpirationDate,3,2) == '0000'\r\n||toInteger(substring(ExpirationDate,3,2)) < 01\r\n||toInteger(substring(ExpirationDate,3,2))  > 12\r\n,'1900-01-01' , concat('20',substring(ExpirationDate,1,2),'-',substring(ExpirationDate,3,2),'-01')\r\n))) != '1900-01-01',\r\n(addMonths(addDays(toDate(case(\r\nExpirationDate == ''\r\n||ExpirationDate == 'NULL'\r\n||ExpirationDate == '0000'\r\n||substring(ExpirationDate,3,2) == '0000'\r\n||toInteger(substring(ExpirationDate,3,2)) < 01\r\n||toInteger(substring(ExpirationDate,3,2))  > 12\r\n,'1900-01-01' , concat('20',substring(ExpirationDate,1,2),'-',substring(ExpirationDate,3,2),'-01')\r\n)), -1), 1))\r\n,toDate(case(\r\nExpirationDate == ''\r\n||ExpirationDate == 'NULL'\r\n||ExpirationDate == '0000'\r\n||substring(ExpirationDate,3,2) == '0000'\r\n||toInteger(substring(ExpirationDate,3,2)) < 01\r\n||toInteger(substring(ExpirationDate,3,2))  > 12\r\n,'1900-01-01' , concat('20',substring(ExpirationDate,1,2),'-',substring(ExpirationDate,3,2),'-01')\r\n)))) ~> dcFISDebitDemographic\nsrcCountryCode select(mapColumn(\n\t\tAlpha2Code_SelectCountry = Alpha2Code,\n\t\tAlpha3Code_SelectCountry = Alpha3Code,\n\t\tNumericCode_SelectCountry = NumericCode,\n\t\tDialCode_SelectCountry = DialCode\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectCountry\nSelectCountry derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',toString($$),toString(null()))))) ~> trimBlankSpaceCountry\nsrcCountryCodeSubdivision select(mapColumn(\n\t\tAlpha2Code_SelectSubdivision = Alpha2Code,\n\t\tAlpha2Code_Subdivision_SelectSubdivision = {3166_2code},\n\t\tSubdivision_SelectSubdivision = Subdivision\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectSubdivision\nSelectSubdivision derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',toString($$),toString(null()))))) ~> trimBlankSpaceSubdivision\ntrimBlankSpaceCountry, trimBlankSpaceSubdivision join(Alpha2Code_SelectCountry == Alpha2Code_SelectSubdivision,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> ijCountrySubdivision\nijCountrySubdivision derive(NumericCode_SelectCountry = toShort(NumericCode_SelectCountry)) ~> dcCountrySubdivision\ndcCountrySubdivision select(mapColumn(\n\t\tAddress1CountryAlpha3_SelectCountryAll = Alpha3Code_SelectCountry,\n\t\tAddress1CountryNumeric_SelectCountryAll = NumericCode_SelectCountry,\n\t\tSubdivision_SelectCountryAll = Subdivision_SelectSubdivision\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectCountryAll\nSelectFISDebitClientBin, SelectCountryAll lookup(Address1State == Subdivision_SelectCountryAll,\n\tmultiple: false,\n\tpickup: 'any',\n\tbroadcast: 'auto')~> LookupSubdivisionFISCountry\nLookupSubdivisionFISCountry select(mapColumn(\n\t\tClientNum_SelectFinal = client_number,\n\t\tAccountNum_SelectFinal = AccountNum_dc,\n\t\tMothersMaidenName_SelectFinal = MothersMaidenName,\n\t\tCardHolder_Type_Cd_SelectFinal = CardHolder_Type_Cd_dc,\n\t\tCardHolderPositionCd_SelectFinal = CardHolderPositionCd_dc,\n\t\tExpirationDate_SelectFinal = ExpirationDate,\n\t\tCardNum_dc_SelectFinal = CardNum_dc,\n\t\tCardTypeCd_SelectFinal = CardTypeCd_dc,\n\t\tCardholderFirstName_SelectFinal = CardholderFirstName,\n\t\tCardholderMiddleInitial_SelectFinal = CardholderMiddleInitial,\n\t\tCardholderLastName_SelectFinal = CardholderLastName,\n\t\tSocialSecurityNum_SelectFinal = SocialSecurityNum,\n\t\tBirthDate_SelectFinal = BirthDate,\n\t\tAddress1LineOne_SelectFinal = Address1LineOne,\n\t\tAddress1LineTwo_SelectFinal = Address1LineTwo,\n\t\tAddress1City_SelectFinal = Address1City,\n\t\tAddress1State_SelectFinal = Address1State,\n\t\tAddress1ZipCode_SelectFinal = Address1ZipCode,\n\t\tAddress1CountryAlpha3_SelectFinal = Address1CountryAlpha3_SelectCountryAll,\n\t\tAddress1CountryNumeric_SelectFinal = Address1CountryNumeric_SelectCountryAll,\n\t\tAddressSource_SelectFinal = AddressSource_dc,\n\t\tHomePhone_SelectFinal = HomePhone,\n\t\tBusinessPhone_SelectFinal = BusinessPhone,\n\t\tTransitRoutingNum_SelectFinal = TransitRoutingNum,\n\t\tCheckingAccountNum_SelectFinal = CheckingAccountNum,\n\t\tSavingsAccountNum_SelectFinal = SavingsAccountNum,\n\t\tAccountSystemEntryDate_SelectFinal = AccountSystemEntryDate_dc,\n\t\tExternalStatus_SelectFinal = ExternalStatus,\n\t\tCardStatus_SelectFinal = CardStatus,\n\t\tSourceId_SelectFinal = SourceId_dc,\n\t\tReportDate_SelectFinal = ReportDate_dc,\n\t\tCreateDate_SelectFinal = CreateDate_dc,\n\t\tCardStatusChangeDate_SelectFinal = LastUpdatedDate\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectFinal\nFilterOutBadAccountNumbers select(mapColumn(\n\t\tClientNum,\n\t\tCardholderFirstName,\n\t\tMothersMaidenName,\n\t\tCardholderMiddleInitial,\n\t\tCardholderLastName,\n\t\tExpirationDate,\n\t\tSocialSecurityNum,\n\t\tBirthDate,\n\t\tAddress1LineOne,\n\t\tAddress1LineTwo,\n\t\tAddress1City,\n\t\tAddress1State,\n\t\tAddress1ZipCode,\n\t\tHomePhone,\n\t\tBusinessPhone,\n\t\tTransitRoutingNum,\n\t\tCheckingAccountNum,\n\t\tSavingsAccountNum,\n\t\tAccountSystemEntryDate,\n\t\tExternalStatus,\n\t\tCardStatus,\n\t\tReportDate,\n\t\tPlasticNumber,\n\t\tLastUpdatedDate,\n\t\tLastIssueDate,\n\t\tSourceId_dc,\n\t\tCardHolder_Type_Cd_dc,\n\t\tCardHolderPositionCd_dc,\n\t\tBusinessPhone_dc,\n\t\tCardholderLastName_dc,\n\t\tAddressSource_dc,\n\t\tReportDate_dc,\n\t\tAccountNum_dc,\n\t\tCardNum_dc,\n\t\tCardTypeCd_dc,\n\t\tCreateDate_dc,\n\t\tTransitRoutingNum_dc\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectDerivedColumns\ndwDimBin, dwDimClient join(dw_clientkey == client_key,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> ijClient\nijClient select(mapColumn(\n\t\tdw_binkey,\n\t\tdw_clientkey,\n\t\tbankIdentificationNumberISO,\n\t\tbankIdentificationNumberEXT,\n\t\tclient_number\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectBinClient\nSelectDerivedColumns aggregate(groupBy(AccountNum_dc),\n\tcount = count()) ~> distinctAccounts\ndistinctAccounts, SelectBinClient join(left(AccountNum_dc,6) == left(bankIdentificationNumberEXT,6) && like (AccountNum_dc, bankIdentificationNumberEXT+'%'),\n\tjoinType:'cross',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'off')~> cjBinClient\ncjBinClient window(over(AccountNum_dc),\n\tdesc(bankIdentificationNumberEXT, true),\n\trow_num = rowNumber()) ~> windowClientBin\nwindowClientBin filter(row_num==1) ~> filterClientBin\nfilterClientBin select(mapColumn(\n\t\tAccountNum_dc,\n\t\tclient_number\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> selectBinClientFISDebit\nSelectDerivedColumns, selectBinClientFISDebit join(SelectDerivedColumns@AccountNum_dc == selectBinClientFISDebit@AccountNum_dc,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> ljBinClientFISDebit\nljBinClientFISDebit select(mapColumn(\n\t\tCardholderFirstName,\n\t\tMothersMaidenName,\n\t\tCardholderMiddleInitial,\n\t\tCardholderLastName = CardholderLastName_dc,\n\t\tExpirationDate,\n\t\tSocialSecurityNum,\n\t\tBirthDate,\n\t\tAddress1LineOne,\n\t\tAddress1LineTwo,\n\t\tAddress1City,\n\t\tAddress1State,\n\t\tAddress1ZipCode,\n\t\tHomePhone,\n\t\tBusinessPhone,\n\t\tTransitRoutingNum = TransitRoutingNum_dc,\n\t\tCheckingAccountNum,\n\t\tSavingsAccountNum,\n\t\tAccountSystemEntryDate_dc = AccountSystemEntryDate,\n\t\tExternalStatus,\n\t\tCardStatus,\n\t\tReportDate_dc,\n\t\tPlasticNumber,\n\t\tLastUpdatedDate,\n\t\tLastIssueDate,\n\t\tSourceId_dc,\n\t\tCardHolder_Type_Cd_dc,\n\t\tCardHolderPositionCd_dc,\n\t\tBusinessPhone_dc,\n\t\tCardholderLastName_dc,\n\t\tAddressSource_dc,\n\t\tReportDate_dc,\n\t\tAccountNum_dc = SelectDerivedColumns@AccountNum_dc,\n\t\tCardNum_dc,\n\t\tCardTypeCd_dc,\n\t\tCreateDate_dc,\n\t\tTransitRoutingNum_dc,\n\t\tAccountNum_dc = selectBinClientFISDebit@AccountNum_dc,\n\t\tclient_number\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectFISDebitClientBin\nDeDup1 filter(AccountNum_dc!='99999') ~> FilterOutBadAccountNumbers\nsrcFISDebitDemographic filter(FISDebitDemographicID != 'FISDebitDemographicID') ~> FilterOutHeadingsIfExists\ndcFISDebitDemographic select(mapColumn(\n\t\tClientNum,\n\t\tMothersMaidenName,\n\t\tExpirationDate,\n\t\tCardholderFirstName,\n\t\tCardholderMiddleInitial,\n\t\tCardholderLastName,\n\t\tSocialSecurityNum,\n\t\tBirthDate,\n\t\tAddress1LineOne,\n\t\tAddress1LineTwo,\n\t\tAddress1City,\n\t\tAddress1State,\n\t\tAddress1ZipCode,\n\t\tHomePhone,\n\t\tBusinessPhone,\n\t\tTransitRoutingNum,\n\t\tCheckingAccountNum,\n\t\tSavingsAccountNum,\n\t\tAccountSystemEntryDate,\n\t\tExternalStatus,\n\t\tCardStatus,\n\t\tReportDate,\n\t\tPlasticNumber,\n\t\tLastUpdatedDate,\n\t\tLastIssueDate,\n\t\tSourceId_dc,\n\t\tCardHolder_Type_Cd_dc,\n\t\tCardHolderPositionCd_dc,\n\t\tBusinessPhone_dc,\n\t\tCardholderLastName_dc,\n\t\tAddressSource_dc,\n\t\tReportDate_dc,\n\t\tAccountNum_dc,\n\t\tCardNum_dc,\n\t\tCardTypeCd_dc,\n\t\tCreateDate_dc,\n\t\tTransitRoutingNum_dc\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectDerivedColumns1\nSelectDerivedColumns1 aggregate(groupBy(AccountNum_dc,\n\t\tCardHolder_Type_Cd_dc,\n\t\tCardHolderPositionCd_dc),\n\teach(match(name!='AccountNum_dc'&&name!='CardHolder_Type_Cd_dc'&&name!='CardHolderPositionCd_dc'), $$ = first($$))) ~> DeDup1\nSelectFinal sink(allowSchemaDrift: false,\n\tvalidateSchema: false,\n\tinput(\n\t\tCardHolderId as long,\n\t\tClientNum as string,\n\t\tAccountNum as string,\n\t\tCardHolder_Type_Cd as string,\n\t\tCardHolderPositionCd as string,\n\t\tCardNum as string,\n\t\tCardTypeCd as string,\n\t\tCardProgram as string,\n\t\tSeperateEntityInd as boolean,\n\t\tPersonUniqueId as integer,\n\t\tCardHolderNamePrefix as string,\n\t\tCardHolderFirstName as string,\n\t\tCardHolderMiddleName as string,\n\t\tCardHolderLastName as string,\n\t\tCardHolderNameSuffix as string,\n\t\tSocialSecurityNum as string,\n\t\tCustomerControlId as string,\n\t\tMothersMadenName as string,\n\t\tBirthDate as date,\n\t\tDeceasedCd as string,\n\t\tAddress1LineOne as string,\n\t\tAddress1LineTwo as string,\n\t\tAddress1City as string,\n\t\tAddress1State as string,\n\t\tAddress1ZipCode as string,\n\t\tAddress1CountryAlpha3 as string,\n\t\tAddress1CountryNumeric as integer,\n\t\tAddressSource as string,\n\t\tCardHolderSex as string,\n\t\tDriversLicenseNum as string,\n\t\tDriversLicenseState as string,\n\t\tHomePhone as string,\n\t\tBusinessPhone as string,\n\t\tMobilePhone as string,\n\t\tTransitRoutingNum as string,\n\t\tCheckingAccountNum as string,\n\t\tSavingsAccountNum as string,\n\t\tAccountSystemEntryDate as date,\n\t\tExpirationDate as date,\n\t\tCardsIssuedCnt as string,\n\t\tStatementCycleCd as string,\n\t\tCrossReferenceAccountNum1 as string,\n\t\tCrossReferenceAccountNum2 as string,\n\t\tCrossReferenceAccountNum3 as string,\n\t\tAccountBalance as decimal(19,4),\n\t\tExternalStatus as string,\n\t\tInternalStatus as string,\n\t\tCardStatus as string,\n\t\tCardStatusChangeDate as date,\n\t\tCreditBureauReportCode as string,\n\t\tDoNotSolicitInd as boolean,\n\t\tSpaSystemBank as string,\n\t\tSpaPrincipalBank as string,\n\t\tSpaAgentBank as string,\n\t\tSourceId as string,\n\t\tReportDate as date,\n\t\tCreateDate as timestamp,\n\t\tModifiedDate as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tClientNum = ClientNum_SelectFinal,\n\t\tAccountNum = AccountNum_SelectFinal,\n\t\tCardHolder_Type_Cd = CardHolder_Type_Cd_SelectFinal,\n\t\tCardHolderPositionCd = CardHolderPositionCd_SelectFinal,\n\t\tExpirationDate = ExpirationDate_SelectFinal,\n\t\tMothersMadenName = MothersMaidenName_SelectFinal,\n\t\tCardNum = CardNum_dc_SelectFinal,\n\t\tCardTypeCd = CardTypeCd_SelectFinal,\n\t\tCardHolderFirstName = CardholderFirstName_SelectFinal,\n\t\tCardHolderMiddleName = CardholderMiddleInitial_SelectFinal,\n\t\tCardHolderLastName = CardholderLastName_SelectFinal,\n\t\tSocialSecurityNum = SocialSecurityNum_SelectFinal,\n\t\tBirthDate = BirthDate_SelectFinal,\n\t\tAddress1LineOne = Address1LineOne_SelectFinal,\n\t\tAddress1LineTwo = Address1LineTwo_SelectFinal,\n\t\tAddress1City = Address1City_SelectFinal,\n\t\tAddress1State = Address1State_SelectFinal,\n\t\tAddress1ZipCode = Address1ZipCode_SelectFinal,\n\t\tAddress1CountryAlpha3 = Address1CountryAlpha3_SelectFinal,\n\t\tAddress1CountryNumeric = Address1CountryNumeric_SelectFinal,\n\t\tAddressSource = AddressSource_SelectFinal,\n\t\tHomePhone = HomePhone_SelectFinal,\n\t\tBusinessPhone = BusinessPhone_SelectFinal,\n\t\tTransitRoutingNum = TransitRoutingNum_SelectFinal,\n\t\tCheckingAccountNum = CheckingAccountNum_SelectFinal,\n\t\tSavingsAccountNum = SavingsAccountNum_SelectFinal,\n\t\tAccountSystemEntryDate = AccountSystemEntryDate_SelectFinal,\n\t\tExternalStatus = ExternalStatus_SelectFinal,\n\t\tCardStatus = CardStatus_SelectFinal,\n\t\tSourceId = SourceId_SelectFinal,\n\t\tReportDate = ReportDate_SelectFinal,\n\t\tCreateDate = CreateDate_SelectFinal,\n\t\tCardStatusChangeDate = CardStatusChangeDate_SelectFinal\n\t)) ~> snkCardHolderStaging"
                }
            },
            "dependsOn": []
        }
    ]
}