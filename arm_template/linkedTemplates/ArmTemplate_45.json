{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "factoryName": {
            "type": "string",
            "metadata": "Data Factory name",
            "defaultValue": "EnterpriseDataSourceProdDF"
        }
    },
    "variables": {
        "factoryId": "[concat('Microsoft.DataFactory/factories/', parameters('factoryName'))]"
    },
    "resources": [
        {
            "name": "[concat(parameters('factoryName'), '/populate_Chargebacks_FISMembers')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "FIS"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "src_stgFISDebitDemographic",
                                "type": "DatasetReference"
                            },
                            "name": "srcFISDebitDemographic"
                        },
                        {
                            "dataset": {
                                "referenceName": "src_stgCountryCode",
                                "type": "DatasetReference"
                            },
                            "name": "srcCountryCode"
                        },
                        {
                            "dataset": {
                                "referenceName": "src_stgCountryCodeSubdivision",
                                "type": "DatasetReference"
                            },
                            "name": "srcCountryCodeSubdivision"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "dst_CardHolderFIS_staging",
                                "type": "DatasetReference"
                            },
                            "name": "snkCardHolder"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "trimBlankSpacesFISDebitDemographic"
                        },
                        {
                            "name": "SelectFISDebitDemographic"
                        },
                        {
                            "name": "dcFISDebitDemographic"
                        },
                        {
                            "name": "SelectCountry"
                        },
                        {
                            "name": "trimBlankSpaceCountry"
                        },
                        {
                            "name": "SelectSubdivision"
                        },
                        {
                            "name": "trimBlankSpaceSubdivision"
                        },
                        {
                            "name": "ijCountrySubdivision"
                        },
                        {
                            "name": "dcCountrySubdivision"
                        },
                        {
                            "name": "SelectCountryAll"
                        },
                        {
                            "name": "LookupSubdivisionFISCountry"
                        },
                        {
                            "name": "SelectFinal"
                        },
                        {
                            "name": "WindowByRowNumber"
                        },
                        {
                            "name": "DeDup1"
                        }
                    ],
                    "script": "source(output(\n\t\tFISDebitDemographicID as string,\n\t\tAccountNumber as string,\n\t\tPlasticNumber as string,\n\t\tGreetingName as string,\n\t\tFinancialInstitutionRouteTransit as string,\n\t\tCardStatus as string,\n\t\tLastUsedDate as date,\n\t\tAuthorizationLimitGroup as string,\n\t\tPINOffset as string,\n\t\tTrackTwoDate as string,\n\t\tDDAAccountNumber as string,\n\t\tSavingsAccountNumber as string,\n\t\tAdditionalDDAAccountNumberOne as string,\n\t\tAdditionalDDAAccountNumberTwo as string,\n\t\tAdditionalDDAAccountNumberThree as string,\n\t\tAdditionalDDAAccountNumberFour as string,\n\t\tAdditionalDDAAccountNumberFive as string,\n\t\tAdditionalSavingsAccountNumberOne as string,\n\t\tAdditionalSavingsAccountNumberTwo as string,\n\t\tAdditionalSavingsAccountNumberThree as string,\n\t\tAdditionalSavingsAccountNumberFour as string,\n\t\tAdditionalSavingsAccountNumberFive as string,\n\t\tAdditionalCreditAccountNumberOne as string,\n\t\tAdditionalCreditAccountNumberTwo as string,\n\t\tAdditionalCreditAccountNumberThree as string,\n\t\tAdditionalCreditAccountNumberFour as string,\n\t\tAdditionalOtherAccountNumberOne as string,\n\t\tAdditionalOtherAccountNumberTwo as string,\n\t\tAdditionalOtherAccountNumberThree as string,\n\t\tAdditionalOtherAccountNumberFour as string,\n\t\tCardholderAddressLineOne as string,\n\t\tCardholderAddressLineTwo as string,\n\t\tCardholderAddressCity as string,\n\t\tCardholderAddressState as string,\n\t\tCardholderAddressZip as string,\n\t\tCardholderFirstName as string,\n\t\tCardholderLastName as string,\n\t\tCardholderMiddleInitial as string,\n\t\tCardActivationFlag as string,\n\t\tOriginalIssueDate as date,\n\t\tLastIssueDate as date,\n\t\tNationalIdentifier as string,\n\t\tMothersMaidenName as string,\n\t\tHomePhone as string,\n\t\tWorkPhone as string,\n\t\tUserValidation as string,\n\t\tVRUCounter as string,\n\t\tBirthDate as date,\n\t\tCardActivationMethod as string,\n\t\tCardActivationDate as date,\n\t\tCardActivationTime as string,\n\t\tPreviousExpirationDate as string,\n\t\tPreviousCardActivationStatus as string,\n\t\tCardStatusTwo as string,\n\t\tFISDebitImportFileName as string,\n\t\tCreateDate as string,\n\t\tBINNumber as string,\n\t\tClientNumberIssuer as string,\n\t\tHashFullRecord as string,\n\t\tLastUpdatedDate as date,\n\t\tReportDate as date\n\t),\n\tallowSchemaDrift: false,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcFISDebitDemographic\nsource(output(\n\t\tAlpha2Code as string,\n\t\tShortName as string,\n\t\tShortNameLowerCase as string,\n\t\tFullName as string,\n\t\tAlpha3Code as string,\n\t\tNumericCode as string,\n\t\tDialCode as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcCountryCode\nsource(output(\n\t\tAlpha2Code as string,\n\t\tSubdivision as string,\n\t\tSubdivisionCategory as string,\n\t\t{3166_2code} as string,\n\t\tSubdivisionName as string,\n\t\tLocalVariant as string,\n\t\tLanguageCode as string,\n\t\tRoaniationSystem as string,\n\t\tParentSubdivision as string\n\t),\n\tallowSchemaDrift: false,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcCountryCodeSubdivision\nSelectFISDebitDemographic derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null()))))) ~> trimBlankSpacesFISDebitDemographic\nsrcFISDebitDemographic select(mapColumn(\n\t\tCardholderLastName,\n\t\tCardholderFirstName,\n\t\tSocialSecurtyNum = NationalIdentifier,\n\t\tBirthDate,\n\t\tAddress1LineOne = CardholderAddressLineOne,\n\t\tAddress1LineTwo = CardholderAddressLineTwo,\n\t\tAddress1City = CardholderAddressCity,\n\t\tAddress1State = CardholderAddressState,\n\t\tAddress1ZipCode = CardholderAddressZip,\n\t\tHomePhone,\n\t\tBusinessPhone = WorkPhone,\n\t\tCheckingAccountNum = DDAAccountNumber,\n\t\tSavingsAccountNum = SavingsAccountNumber,\n\t\tAccountNum = AccountNumber,\n\t\tAccountSystemEntryDate = CardActivationDate,\n\t\tReportDate,\n\t\tPlasticNumber,\n\t\tLastUpdatedDate,\n\t\tLastIssueDate\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectFISDebitDemographic\ntrimBlankSpacesFISDebitDemographic derive(SourceId_dc = toString('FIS'),\n\t\tCardHolder_Type_Cd_dc = toString('01'),\n\t\tCardHolderPositionCd_dc = toString('001'),\n\t\tBusinessPhone_dc = case(BusinessPhone == '0000000000', toString(null()), BusinessPhone),\n\t\tCardNum_dc = AccountNum,\n\t\tCardholderLastName_dc = coalesce(CardholderLastName,'UNKNOWN'),\n\t\tCardholderFirstName_dc = coalesce(CardholderFirstName,'UNKNOWN'),\n\t\tAddressSource_dc = iif(isNull(Address1State), 'NoAddr', 'FISDebit'),\n\t\tReportDate_dc = coalesce(ReportDate, toDate('1900-01-01')),\n\t\tAccountNum_dc = iif(isNull(AccountNum),'99999',AccountNum)) ~> dcFISDebitDemographic\nsrcCountryCode select(mapColumn(\n\t\tAlpha2Code_SelectCountry = Alpha2Code,\n\t\tAlpha3Code_SelectCountry = Alpha3Code,\n\t\tNumericCode_SelectCountry = NumericCode\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectCountry\nSelectCountry derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',toString($$),toString(null()))))) ~> trimBlankSpaceCountry\nsrcCountryCodeSubdivision select(mapColumn(\n\t\tAlpha2Code_SelectSubdivision = Alpha2Code,\n\t\tSubdivision_SelectSubdivision = Subdivision\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectSubdivision\nSelectSubdivision derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',toString($$),toString(null()))))) ~> trimBlankSpaceSubdivision\ntrimBlankSpaceCountry, trimBlankSpaceSubdivision join(Alpha2Code_SelectCountry == Alpha2Code_SelectSubdivision,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> ijCountrySubdivision\nijCountrySubdivision derive(NumericCode_SelectCountry = toShort(NumericCode_SelectCountry)) ~> dcCountrySubdivision\ndcCountrySubdivision select(mapColumn(\n\t\tAddress1CountryAlpha3_SelectCountryAll = Alpha3Code_SelectCountry,\n\t\tAddress1CountryNumeric_SelectCountryAll = NumericCode_SelectCountry,\n\t\tSubdivision_SelectCountryAll = Subdivision_SelectSubdivision\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectCountryAll\nWindowByRowNumber, SelectCountryAll lookup(Address1State == Subdivision_SelectCountryAll,\n\tmultiple: false,\n\tpickup: 'any',\n\tbroadcast: 'auto')~> LookupSubdivisionFISCountry\nLookupSubdivisionFISCountry select(mapColumn(\n\t\tCardholderLastName_SelectFinal = CardholderLastName_dc,\n\t\tCardholderFirstName_SelectFinal = CardholderFirstName_dc,\n\t\tSocialSecurtyNum_SelectFinal = SocialSecurtyNum,\n\t\tBirthDate_SelectFinal = BirthDate,\n\t\tAddress1LineOne_SelectFinal = Address1LineOne,\n\t\tAddress1LineTwo_SelectFinal = Address1LineTwo,\n\t\tAddress1City_SelectFinal = Address1City,\n\t\tAddress1State_SelectFinal = Address1State,\n\t\tAddress1ZipCode_SelectFinal = Address1ZipCode,\n\t\tHomePhone_SelectFinal = HomePhone,\n\t\tBusinessPhone_SelectFinal = BusinessPhone_dc,\n\t\tCheckingAccountNum_SelectFinal = CheckingAccountNum,\n\t\tSavingsAccountNum_SelectFinal = SavingsAccountNum,\n\t\tCardNum_SelectFinal = CardNum_dc,\n\t\tAccountNum_SelectFinal = AccountNum_dc,\n\t\tCardHolder_Type_Cd_SelectFinal = CardHolder_Type_Cd_dc,\n\t\tCardHolderPositionCd_SelectFinal = CardHolderPositionCd_dc,\n\t\tAccountSystemEntryDate_SelectFinal = AccountSystemEntryDate,\n\t\tSourceId_SelectFinal = SourceId_dc,\n\t\tReportDate_SelectFinal = ReportDate_dc,\n\t\tAddress1CountryAlpha3_SelectFinal = Address1CountryAlpha3_SelectCountryAll,\n\t\tAddress1CountryNumeric_SelectFinal = Address1CountryNumeric_SelectCountryAll,\n\t\tAddressSource_SelectFinal = AddressSource_dc\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectFinal\nDeDup1 window(over(AccountNum_dc),\n\tdesc(LastUpdatedDate, true),\n\tdesc(LastIssueDate, true),\n\tRanking = rank() == 1) ~> WindowByRowNumber\ndcFISDebitDemographic aggregate(groupBy(AccountNum_dc,\n\t\tCardHolder_Type_Cd_dc,\n\t\tCardHolderPositionCd_dc),\n\teach(match(name!='AccountNum_dc'&&name!='CardHolder_Type_Cd_dc'&&name!='CardHolderPositionCd_dc'), $$ = first($$))) ~> DeDup1\nSelectFinal sink(allowSchemaDrift: false,\n\tvalidateSchema: true,\n\tinput(\n\t\tCardHolderFISId as long,\n\t\tCardHolderLastName as string,\n\t\tCardHolderFirstName as string,\n\t\tSocialSecurtyNum as string,\n\t\tBirthDate as date,\n\t\tAddress1LineOne as string,\n\t\tAddress1LineTwo as string,\n\t\tAddress1City as string,\n\t\tAddress1State as string,\n\t\tAddress1ZipCode as string,\n\t\tHomePhone as string,\n\t\tBusinessPhone as string,\n\t\tCheckingAccountNum as string,\n\t\tSavingsAccountNum as string,\n\t\tCardNum as string,\n\t\tAccountNum as string,\n\t\tCardHolder_Type_Cd as string,\n\t\tCardHolderPositionCd as string,\n\t\tAccountSystemEntryDate as date,\n\t\tExpirationDate as date,\n\t\tCardsIssuedCnt as string,\n\t\tStatementCycleCd as string,\n\t\tCrossReferenceAccountNum1 as string,\n\t\tCrossReferenceAccountNum2 as string,\n\t\tCrossReferenceAccountNum3 as string,\n\t\tAccountBalance as decimal(19,4),\n\t\tExternalStatus as string,\n\t\tInternalStatus as string,\n\t\tCardStatus as string,\n\t\tCardStatusChangeDate as date,\n\t\tSourceId as string,\n\t\tReportDate as date,\n\t\tLoadDate as timestamp,\n\t\tAddress1CountryAlpha3 as string,\n\t\tAddress1CountryNumeric as integer,\n\t\tAddressSource as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\ttruncate:true,\n\tformat: 'table',\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tCardHolderLastName = CardholderLastName_SelectFinal,\n\t\tCardHolderFirstName = CardholderFirstName_SelectFinal,\n\t\tSocialSecurtyNum = SocialSecurtyNum_SelectFinal,\n\t\tBirthDate = BirthDate_SelectFinal,\n\t\tAddress1LineOne = Address1LineOne_SelectFinal,\n\t\tAddress1LineTwo = Address1LineTwo_SelectFinal,\n\t\tAddress1City = Address1City_SelectFinal,\n\t\tAddress1State = Address1State_SelectFinal,\n\t\tAddress1ZipCode = Address1ZipCode_SelectFinal,\n\t\tHomePhone = HomePhone_SelectFinal,\n\t\tBusinessPhone = BusinessPhone_SelectFinal,\n\t\tCheckingAccountNum = CheckingAccountNum_SelectFinal,\n\t\tSavingsAccountNum = SavingsAccountNum_SelectFinal,\n\t\tCardNum = CardNum_SelectFinal,\n\t\tAccountNum = AccountNum_SelectFinal,\n\t\tCardHolder_Type_Cd = CardHolder_Type_Cd_SelectFinal,\n\t\tCardHolderPositionCd = CardHolderPositionCd_SelectFinal,\n\t\tAccountSystemEntryDate = AccountSystemEntryDate_SelectFinal,\n\t\tSourceId = SourceId_SelectFinal,\n\t\tReportDate = ReportDate_SelectFinal,\n\t\tAddress1CountryAlpha3 = Address1CountryAlpha3_SelectFinal,\n\t\tAddress1CountryNumeric = Address1CountryNumeric_SelectFinal,\n\t\tAddressSource = AddressSource_SelectFinal\n\t)) ~> snkCardHolder"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/populate_CardHolderFD')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "FirstData"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "src_stgPIRecord",
                                "type": "DatasetReference"
                            },
                            "name": "srcPIRecord"
                        },
                        {
                            "dataset": {
                                "referenceName": "DS_ADLS_stage_BalanceStatus",
                                "type": "DatasetReference"
                            },
                            "name": "srcBalanceStatus"
                        },
                        {
                            "dataset": {
                                "referenceName": "src_stgCustExpanded",
                                "type": "DatasetReference"
                            },
                            "name": "scrCustExpanded"
                        },
                        {
                            "dataset": {
                                "referenceName": "src_stgAltCustIdentification",
                                "type": "DatasetReference"
                            },
                            "name": "srcAltCustIdentification"
                        },
                        {
                            "dataset": {
                                "referenceName": "src_stgExpAddr",
                                "type": "DatasetReference"
                            },
                            "name": "srcExpAddr"
                        },
                        {
                            "dataset": {
                                "referenceName": "src_stgPI_Status",
                                "type": "DatasetReference"
                            },
                            "name": "srcPIStatus"
                        },
                        {
                            "dataset": {
                                "referenceName": "src_stgEmail",
                                "type": "DatasetReference"
                            },
                            "name": "srcEmail"
                        },
                        {
                            "dataset": {
                                "referenceName": "src_stgCountryCode",
                                "type": "DatasetReference"
                            },
                            "name": "srcCountryCode"
                        },
                        {
                            "dataset": {
                                "referenceName": "src_stgCountryCodeSubdivision",
                                "type": "DatasetReference"
                            },
                            "name": "srcCountryCodeSubdivision"
                        },
                        {
                            "dataset": {
                                "referenceName": "all_stgFDBaseData",
                                "type": "DatasetReference"
                            },
                            "name": "srcBaseData"
                        },
                        {
                            "dataset": {
                                "referenceName": "src_stgCustRole",
                                "type": "DatasetReference"
                            },
                            "name": "srcCustRole"
                        },
                        {
                            "dataset": {
                                "referenceName": "src_stgPhone",
                                "type": "DatasetReference"
                            },
                            "name": "srcPhone"
                        },
                        {
                            "dataset": {
                                "referenceName": "src_stgCCUMSTR",
                                "type": "DatasetReference"
                            },
                            "name": "srcCCUMSTR"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_BIN",
                                "type": "DatasetReference"
                            },
                            "name": "dwDimBin"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Client",
                                "type": "DatasetReference"
                            },
                            "name": "dwDimClient"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "dst_MemberCardHolder_staging",
                                "type": "DatasetReference"
                            },
                            "name": "snkCardHolderWithBASTAddr"
                        },
                        {
                            "dataset": {
                                "referenceName": "dst_MemberCardHolderEmail_staging",
                                "type": "DatasetReference"
                            },
                            "name": "snkMemberCardHolderEmail"
                        },
                        {
                            "dataset": {
                                "referenceName": "dst_MemberCardHolder_staging",
                                "type": "DatasetReference"
                            },
                            "name": "snkCardHolderWithExpAddr"
                        },
                        {
                            "dataset": {
                                "referenceName": "dst_MemberCardHolder_staging",
                                "type": "DatasetReference"
                            },
                            "name": "snkNoAddr"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "dcPIRecord"
                        },
                        {
                            "name": "dcBalanceStatus"
                        },
                        {
                            "name": "dcPIStatus"
                        },
                        {
                            "name": "selectPIRecord"
                        },
                        {
                            "name": "SelectBalanceStatus"
                        },
                        {
                            "name": "ijBalanceStatus"
                        },
                        {
                            "name": "SelectCustExpanded"
                        },
                        {
                            "name": "ijCustExpanded"
                        },
                        {
                            "name": "SelectAltCustIdentification"
                        },
                        {
                            "name": "SelectExpAddr"
                        },
                        {
                            "name": "SelectPIStatus"
                        },
                        {
                            "name": "lojPIStatus"
                        },
                        {
                            "name": "SelectPIRecordForEmail"
                        },
                        {
                            "name": "DistinctPIRecordAccount"
                        },
                        {
                            "name": "SelectEmail"
                        },
                        {
                            "name": "ijEmail"
                        },
                        {
                            "name": "trimBlankSpacesPIRecord"
                        },
                        {
                            "name": "trimBlankSpacesEmail"
                        },
                        {
                            "name": "trimBlankSpacesBalanceStatus"
                        },
                        {
                            "name": "trimBlankSpacesAltCustIdentification"
                        },
                        {
                            "name": "trimBlankSpacesExpAddr"
                        },
                        {
                            "name": "lojAltCustIdentification"
                        },
                        {
                            "name": "FilterExpAddr"
                        },
                        {
                            "name": "dcExpAddr"
                        },
                        {
                            "name": "BASTAddrPrimaryOnly"
                        },
                        {
                            "name": "FilterBASTAddrPrimaryOnly"
                        },
                        {
                            "name": "NotExistsExpAddrPrimary"
                        },
                        {
                            "name": "ExpAddrFinal"
                        },
                        {
                            "name": "ijExpAddr"
                        },
                        {
                            "name": "FilterNoAddr"
                        },
                        {
                            "name": "NoAddr"
                        },
                        {
                            "name": "dcCustExpanded"
                        },
                        {
                            "name": "LookupExpAddrCountry"
                        },
                        {
                            "name": "SelectCountry"
                        },
                        {
                            "name": "trimBlankSpaceCountry"
                        },
                        {
                            "name": "dcCountrySubdivision"
                        },
                        {
                            "name": "LookupSubdivisionBalanceStatus"
                        },
                        {
                            "name": "trimBlankSpaceSubdivision"
                        },
                        {
                            "name": "SelectSubdivision"
                        },
                        {
                            "name": "ijCountrySubdivision"
                        },
                        {
                            "name": "SelectCountryAll"
                        },
                        {
                            "name": "SelectExpAddrAll"
                        },
                        {
                            "name": "SelectBalanceStatusAll"
                        },
                        {
                            "name": "FilterOutHeadingsIfExists"
                        },
                        {
                            "name": "dcAddressExpAddr"
                        },
                        {
                            "name": "dcAddressNoAddr"
                        },
                        {
                            "name": "dcAddressBAST"
                        },
                        {
                            "name": "SelectBaseData"
                        },
                        {
                            "name": "dcBaseData"
                        },
                        {
                            "name": "lojBaseData"
                        },
                        {
                            "name": "dcEmail"
                        },
                        {
                            "name": "SelectCustRole"
                        },
                        {
                            "name": "trimBlankSpaceCustRole"
                        },
                        {
                            "name": "lojCustRole"
                        },
                        {
                            "name": "dcAltCustIdentification"
                        },
                        {
                            "name": "DistinctValues"
                        },
                        {
                            "name": "trimBlankSpaceBaseData"
                        },
                        {
                            "name": "trimBlankSpacesCustExpanded"
                        },
                        {
                            "name": "trimBlankSpacesPIStatus"
                        },
                        {
                            "name": "FilterMobilePhoneOnly"
                        },
                        {
                            "name": "SelectPhone"
                        },
                        {
                            "name": "trimBlankSpacePhone"
                        },
                        {
                            "name": "lojPhone"
                        },
                        {
                            "name": "FilterOutHeaders"
                        },
                        {
                            "name": "RemoveDuplicates"
                        },
                        {
                            "name": "RemoveDuplicatesNoAddr"
                        },
                        {
                            "name": "RemoveDuplicatesBAST"
                        },
                        {
                            "name": "lojCCUMSTR"
                        },
                        {
                            "name": "SelectCCUMSTR"
                        },
                        {
                            "name": "trimCCUMSTR"
                        },
                        {
                            "name": "Sort1"
                        },
                        {
                            "name": "FilterNullRoutingNum"
                        },
                        {
                            "name": "DerivedPlatformdc"
                        },
                        {
                            "name": "AggregatePhone"
                        },
                        {
                            "name": "ijClient"
                        },
                        {
                            "name": "SelectBinClient"
                        },
                        {
                            "name": "cjBinClient"
                        },
                        {
                            "name": "SelectTrimCustExpanded"
                        },
                        {
                            "name": "windowClientBin"
                        },
                        {
                            "name": "filterClientBin"
                        },
                        {
                            "name": "FilterOutHeadings"
                        },
                        {
                            "name": "ljBinClientCustExpanded"
                        },
                        {
                            "name": "distinctAccounts"
                        },
                        {
                            "name": "selectBinClientCustExpanded"
                        }
                    ],
                    "script": "source(output(\n\t\tPI_Record_ID as string,\n\t\tPINS_GROUP_ID as string,\n\t\tPINS_OUT_KEY_SYS_BANK as string,\n\t\tPINS_OUT_KEY_PRIN_BANK as string,\n\t\tPINS_OUT_KEY_AGENT_BANK as string,\n\t\tPINS_OUT_KEY_ACCT_NO as string,\n\t\tPINS_TYPE_CD as string,\n\t\tPINS_MMBR_SQNC_NR as string,\n\t\tPINS_OUT_PI_ID as string,\n\t\tPINS_OUT_ASSG_CRTN_DT as string,\n\t\tPINS_OUT_PLST_GNRT_LAST_DT as string,\n\t\tPINS_OUT_PIN_LAST_CHNG_DT as string,\n\t\tPINS_OUT_PIN_MALR_LAST_DT as string,\n\t\tPINS_OUT_EXPR_DT as string,\n\t\tPINS_OUT_PLST_CT as string,\n\t\tPINS_OUT_PIN_VRFY_NR as string,\n\t\tPINS_OUT_PSTN_TYPE_CD as string,\n\t\tPINS_OUT_PIN_TRNS_FLAG_IN as string,\n\t\tPINS_OUT_SCRT_CD as string,\n\t\tPINS_OUT_PLST_TYPE_CD as string,\n\t\tPINS_OUT_PLST_RPLC_IN as string,\n\t\tPINS_OUT_PIN_PRHB_IN as string,\n\t\tPINS_OUT_PHTC_USE_INDC_CD as string,\n\t\tPINS_OUT_PRSN_EMBS_TX as string,\n\t\tPINS_OUT_LAST_PLST_NNMN_CD as string,\n\t\tPINS_OUT_LAST_PLST_NNMN_DT as string,\n\t\tPINS_OUT_ACCT_ACCS_TS as string,\n\t\tPINS_OUT_PCKG_ID as string,\n\t\tPINS_OUT_LAST_PLST_NNMN_TM as string,\n\t\tPINS_OUT_MNTN_TS as string,\n\t\tPINS_OUT_PI_BULK_MAIL_ID as string,\n\t\tPINS_OUT_PI_TYPE_CD as string,\n\t\tPINS_OUT_PLST_RPLC_DT as string,\n\t\tPINS_OUT_PRIR_EXPR_DT as string,\n\t\tPINS_OUT_PI_RPLC_SQNC_NR as string,\n\t\tPINS_OUT_AUTH_PRIR_EXPR_IN as string,\n\t\tPINS_OUT_PHTC_IMAG_STTS_CD as string,\n\t\treportDate as date 'yyyy-MM-dd',\n\t\tdateProcessed as string,\n\t\tFDR_DATE_PROCESSED as string,\n\t\tDBI_CLIENT_NUMBER as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcPIRecord\nsource(output(\n\t\tBalanceStatus_ID as string,\n\t\tRECORD_TYPE as string,\n\t\tPRIMARY_NAME as string,\n\t\tSECONDARY_NAME as string,\n\t\tADDR_LINE_1 as string,\n\t\tADDR_LINE_2 as string,\n\t\tCITY as string,\n\t\tSTATE as string,\n\t\tZIP_CODE as string,\n\t\tSYS_BANK as string,\n\t\tPRIN_BANK as string,\n\t\tAGENT_BANK as string,\n\t\tACCT_NO as string,\n\t\tNUMBER_OF_PLASTICS_X as string,\n\t\tCYCLE_CODE as string,\n\t\tEXPIRATION_DATE as string,\n\t\tOPEN_DATE_MMYY as string,\n\t\tNEW_CARD_FLAG as string,\n\t\tEXTERNAL_STATUS as string,\n\t\tINTERNAL_STATUS as string,\n\t\tAUTH_FLAG as string,\n\t\tCREDIT_SCORE as string,\n\t\tTYPE_CR_LINE_CHNG as string,\n\t\tTYPE_OF_PLASTICS as string,\n\t\tSPOUSE_TYPE_PLASTIC as string,\n\t\tSPECIAL_FLAGS_5_THRU_8 as string,\n\t\tRENEWAL_CODE as string,\n\t\tCREDIT_LINE as string,\n\t\tAVAILABLE_CREDIT as string,\n\t\tCASH_ADVANCE_BALANCE as string,\n\t\tCREDIT_BUREAU_FLAG as string,\n\t\tTERMS_FLAG as string,\n\t\tHOLD_CODE as string,\n\t\tCROSS_REF_ACCT_NO as string,\n\t\tCROSS_REF_ACCT_NO_1 as string,\n\t\tCROSS_REF_ACCT_NO_2 as string,\n\t\tMISCELLANEOUS_FIELD_1 as string,\n\t\tMISCELLANEOUS_FIELD_2 as string,\n\t\tMISCELLANEOUS_FIELD_3 as string,\n\t\tEXP_USER_FLAGS_1_THRU_4 as string,\n\t\tFIXED_PAYMENT_AMOUNT as string,\n\t\tAUTOMATIC_PAYMENT_FLAG as string,\n\t\tANNUAL_CHARGE_DATE as string,\n\t\tANNUAL_CHARGE_FLAG as string,\n\t\tDATE_OF_CR_LINE_CHNG as string,\n\t\tCREDIT_LIFE_FLAG as string,\n\t\tHOME_TELEPHONE_NUMBER as string,\n\t\tBUSINESS_TELEPHONE_NUMBER as string,\n\t\tSOCIAL_SECURITY_NUMBER as string,\n\t\tCHECKING_ACCOUNT_NUMBER as string,\n\t\tSAVINGS_ACCOUNT_NUMBER as string,\n\t\tRECOURSE_FLAG as string,\n\t\tDUALITY_FLAG as string,\n\t\tTIMES_IN_DISPUTE as string,\n\t\tTIMES_ONE_CYCLE_DELINQ as string,\n\t\tTIMES_TWO_CYCLES_DELINQ as string,\n\t\tTIMES_THREE_CYCLES_DELINQ as string,\n\t\tLAST_PAYMENT_AMOUNT as string,\n\t\tSTATEMENT_BALANCE as string,\n\t\tSTATEMENT_DATE as string,\n\t\tDATE_FIRST_ACTIVE as string,\n\t\tDATE_OF_LAST_PAYMENT as string,\n\t\tDATE_OF_LAST_MONETARY as string,\n\t\tTYPE_OF_LAST_MONETARY as string,\n\t\tHIGH_BALANCE as string,\n\t\tPAYMENT_HISTORY as string,\n\t\tDATE_OF_LAST_NON_MONETARY as string,\n\t\tTYPE_OF_LAST_NON_MONETARY as string,\n\t\tDISPUTE_AMOUNT as string,\n\t\tDISPUTE_DAYS as string,\n\t\tDATE_STATUS_CHANGE as string,\n\t\tTIMES_OVERLIMIT as string,\n\t\tTIMES_REAGED as string,\n\t\tMINIMUM_PAYMENT_DUE as string,\n\t\tDELINQUENCY_DOLLARS as string,\n\t\tCURRENT_BALANCE as string,\n\t\tDAYS_DELINQUENT as string,\n\t\tReportDate as string,\n\t\tDATE_OF_BIRTH as string,\n\t\tSECONDARY_DATE_OF_BIRTH as string,\n\t\tWB_TRAN_TYPE as string,\n\t\tWB_PURGE_DATE as string,\n\t\tLIFE_4_CYCLE_DELQ_CT as string,\n\t\tLIFE_5_CYCLE_DELQ_CT as string,\n\t\tLIFE_6_CYCLE_DELQ_CT as string,\n\t\tLIFE_7_CYCLE_DELQ_CT as string,\n\t\tPREV_CRLINE_CHANGE_DATE as string,\n\t\tNAME_ADDR_CHG as string,\n\t\tSOLICITATION_FLAG as string,\n\t\tEMPL_ACCT_CD as string,\n\t\tANN_RATE_CASH as string,\n\t\tANN_RATE_MRCH as string,\n\t\tCURRENT_PRICING_STRATEGY as string,\n\t\tCOV_STRATEGY_ID as string,\n\t\tSECONDARY_SOC_SEC_NO as string,\n\t\tCMPN_ID as string,\n\t\tPYMN_DUE_DT as string,\n\t\tBONUS_STRATEGY as string,\n\t\tFRAUD_SCORE as string,\n\t\tFRAUD_SCORE_CHANGE_DATE as string,\n\t\tFRAUD_PORT_ID as string,\n\t\tFRAUD_ASSG_STRATEGY as string,\n\t\tFRAUD_SUSPEND_STRATEGY as string,\n\t\tFRAUD_SUSP_STRATEGY_DATE as string,\n\t\tBEHAVIOR_SCORE as string,\n\t\tCR_SCORE_DATE as string,\n\t\tPROCESSING_LEVEL as string,\n\t\tMISCELLANEOUS_FIELD_4 as string,\n\t\tMISCELLANEOUS_FIELD_5 as string,\n\t\tMISCELLANEOUS_FIELD_6 as string,\n\t\tMISCELLANEOUS_FIELD_7 as string,\n\t\tMISCELLANEOUS_FIELD_8 as string,\n\t\tMISC_FIELD_9 as string,\n\t\tMISC_FIELD_10 as string,\n\t\tMISC_FIELD_11_TX as string,\n\t\tMISC_FIELD_12_TX as string,\n\t\tMISC_FIELD_13_TX as string,\n\t\tClient as string,\n\t\tDateArchived as string,\n\t\tREISSUE_CONTROL as string,\n\t\tEM_PD_HM_ADDR_TX as string,\n\t\tEM_PD_BS_ADDR_TX as string,\n\t\tEM_SD_HM_ADDR_TX as string,\n\t\tEM_SD_BS_ADDR_TX as string,\n\t\tSEC_CODE_NUM_1 as string,\n\t\tSTATUS_REASON_CODE as string,\n\t\tMONTHS_GROSS_ACTIVE as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcBalanceStatus\nsource(output(\n\t\tCustExpanded_ID as string,\n\t\tCUEX_GROUP_ID as string,\n\t\tCUEX_OUT_KEY_SYS_BANK as string,\n\t\tCUEX_OUT_KEY_PRIN_BANK as string,\n\t\tCUEX_OUT_KEY_AGENT_BANK as string,\n\t\tCUEX_OUT_KEY_ACCT_NO as string,\n\t\tCUEX_TYPE_CD as string,\n\t\tCUEX_MMBR_SQNC_NR as string,\n\t\tCUEX_OUT_EXTR_ID as string,\n\t\tCUEX_OUT_CUST_NM as string,\n\t\tCUEX_OUT_SLLT_SEX_CD as string,\n\t\tCUEX_OUT_DCSD_CD as string,\n\t\tCUEX_OUT_BRTH_DT as string,\n\t\tCUEX_OUT_SLCT_CD as string,\n\t\tCUEX_OUT_CLNT_EMPL_CD as string,\n\t\tCUEX_OUT_MTHR_MADN_NM as string,\n\t\tCUEX_OUT_SFFX_CD as string,\n\t\tCUEX_OUT_PRFX_TX as string,\n\t\tCUEX_OUT_FRST_NM as string,\n\t\tCUEX_OUT_LAST_NM as string,\n\t\tCUEX_OUT_MDDL_NM as string,\n\t\tCUEX_OUT_QLFC_TX as string,\n\t\tCUEX_OUT_TITL_TX as string,\n\t\tCUEX_OUT_NAME_SQNC_CD as string,\n\t\tCUEX_OUT_CMBN_IN as string,\n\t\tCUEX_OUT_LAST_NNMN_SORC_TX as string,\n\t\tCUEX_OUT_LAST_NNMN_CD as string,\n\t\tCUEX_OUT_LAST_NNMN_DT as string,\n\t\tCUEX_OUT_LAST_NNMN_TM as string,\n\t\treportDate as string,\n\t\tdateProcessed as string,\n\t\tFDR_DATE_PROCESSED as string,\n\t\tDBI_CLIENT_NUMBER as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> scrCustExpanded\nsource(output(\n\t\tAltCustIdentification_ID as string,\n\t\tALTC_GROUP_ID as string,\n\t\tALTC_OUT_KEY_SYS_BANK as string,\n\t\tALTC_OUT_KEY_PRIN_BANK as string,\n\t\tALTC_OUT_KEY_AGENT_BANK as string,\n\t\tALTC_OUT_KEY_ACCT_NO as string,\n\t\tALTC_TYPE_CD as string,\n\t\tALTC_MMBR_SQNC_NR as string,\n\t\tALTC_OUT_EXTR_ID as string,\n\t\tALTC_OUT_ID_TYPE_CD as string,\n\t\tALTC_OUT_ALTR_CUST_ID as string,\n\t\treportDate as string,\n\t\tdateProcessed as string,\n\t\tFDR_DATE_PROCESSED as string,\n\t\tDBI_CLIENT_NUMBER as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcAltCustIdentification\nsource(output(\n\t\tExpAddr_ID as string,\n\t\tADEX_GROUP_ID as string,\n\t\tADEX_OUT_KEY_SYS_BANK as string,\n\t\tADEX_OUT_KEY_PRIN_BANK as string,\n\t\tADEX_OUT_KEY_AGENT_BANK as string,\n\t\tADEX_OUT_KEY_ACCT_NO as string,\n\t\tADEX_TYPE_CD as string,\n\t\tADEX_MMBR_SQNC_NR as string,\n\t\tADEX_OUT_EXTR_ID as string,\n\t\tADEX_OUT_ADDR_TYPE_CD as string,\n\t\tADEX_OUT_CTGR_CD as string,\n\t\tADEX_OUT_ADDR_FRMT_CD as string,\n\t\tADEX_OUT_EFFC_BEGN_DT as string,\n\t\tADEX_OUT_EFFC_END_DT as string,\n\t\tADEX_OUT_LINE_1_TX as string,\n\t\tADEX_OUT_LINE_2_TX as string,\n\t\tADEX_OUT_CITY_NM as string,\n\t\tADEX_OUT_SBDV_1_TX as string,\n\t\tADEX_OUT_PSTL_CD as string,\n\t\tADEX_OUT_MAIL_CD as string,\n\t\tADEX_OUT_MAIL_CD_FLAG_IN as string,\n\t\tADEX_OUT_DLVR_PONT_CD as string,\n\t\tADEX_OUT_VALD_ADDR_IN as string,\n\t\tADEX_OUT_RLTN_TYPE_CD as string,\n\t\tADEX_OUT_EXPR_RESN_CD as string,\n\t\tADEX_OUT_HSTR_RTNT_CD as string,\n\t\tADEX_OUT_HOUS_NMBR_TX as string,\n\t\tADEX_OUT_HOUS_BLDG_NM as string,\n\t\tADEX_OUT_CPNY_NM as string,\n\t\tADEX_OUT_ATTN_LINE_TX as string,\n\t\tADEX_OUT_POBX_NMBR_TX as string,\n\t\tADEX_OUT_STRT_NM as string,\n\t\tADEX_OUT_LINE_3_TX as string,\n\t\tADEX_OUT_LINE_4_TX as string,\n\t\tADEX_OUT_ISO3_CTRY_CD as string,\n\t\tADEX_OUT_VLDT_CD as string,\n\t\treportDate as date 'yyyy-MM-dd',\n\t\tdateProcessed as string,\n\t\tFDR_DATE_PROCESSED as string,\n\t\tDBI_CLIENT_NUMBER as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcExpAddr\nsource(output(\n\t\tPI_Status_ID as string,\n\t\tPRST_GROUP_ID as string,\n\t\tPRST_OUT_KEY_SYS_BANK as string,\n\t\tPRST_OUT_KEY_PRIN_BANK as string,\n\t\tPRST_OUT_KEY_AGENT_BANK as string,\n\t\tPRST_OUT_KEY_ACCT_NO as string,\n\t\tPRST_TYPE_CD as string,\n\t\tPRST_MMBR_SQNC_NR as string,\n\t\tPRST_OUT_PI_ID as string,\n\t\tPRST_OUT_DRVN_SIDE_CD as string,\n\t\tPRST_OUT_LOST_STLN_DT as string,\n\t\tPRST_OUT_ACTV_CD as string,\n\t\tPRST_OUT_PI_STTS_CD as string,\n\t\tPRST_OUT_STTS_RESN_CD as string,\n\t\tPRST_OUT_STTS_CHNG_DT as string,\n\t\tPRST_OUT_SYS_ID as string,\n\t\tPRST_OUT_PRIN_ID as string,\n\t\tPRST_OUT_AGNT_ID as string,\n\t\tPRST_OUT_TMPR_CD as string,\n\t\tPRST_OUT_PI_FRAD_STGY_DT as string,\n\t\tPRST_OUT_PI_FRAD_STGY_ID as string,\n\t\tPRST_OUT_TRMN_PRMP_OVRR_CD as string,\n\t\tPRST_OUT_TRAN_RSTR_CD as string,\n\t\tPRST_OUT_EXTR_CLSS_CD as string,\n\t\tPRST_OUT_PITC_EXTR_CLSS_ID as string,\n\t\treportDate as string,\n\t\tdateProcessed as string,\n\t\tFDR_DATE_PROCESSED as string,\n\t\tDBI_CLIENT_NUMBER as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcPIStatus\nsource(output(\n\t\tEmail_ID as string,\n\t\tEMAL_GROUP_ID as string,\n\t\tEMAL_OUT_KEY_SYS_BANK as string,\n\t\tEMAL_OUT_KEY_PRIN_BANK as string,\n\t\tEMAL_OUT_KEY_AGENT_BANK as string,\n\t\tEMAL_OUT_KEY_ACCT_NO as string,\n\t\tEMAL_TYPE_CD as string,\n\t\tEMAL_MMBR_SQNC_NR as string,\n\t\tEMAL_OUT_EXTR_ID as string,\n\t\tEMAL_OUT_USE_TYPE_CD as string,\n\t\tEMAL_OUT_ADDR_TX as string,\n\t\tEMAL_OUT_SLCT_IN as string,\n\t\tEMAL_OUT_ADDR_STTS_IN as string,\n\t\treportDate as date 'yyyy-MM-dd',\n\t\tdateProcessed as string,\n\t\tFDR_DATE_PROCESSED as string,\n\t\tDBI_CLIENT_NUMBER as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcEmail\nsource(output(\n\t\tAlpha2Code as string,\n\t\tShortName as string,\n\t\tShortNameLowerCase as string,\n\t\tFullName as string,\n\t\tAlpha3Code as string,\n\t\tNumericCode as string,\n\t\tDialCode as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcCountryCode\nsource(output(\n\t\tAlpha2Code as string,\n\t\tSubdivision as string,\n\t\tSubdivisionCategory as string,\n\t\t{3166_2code} as string,\n\t\tSubdivisionName as string,\n\t\tLocalVariant as string,\n\t\tLanguageCode as string,\n\t\tRoaniationSystem as string,\n\t\tParentSubdivision as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcCountryCodeSubdivision\nsource(output(\n\t\tBaseDataID as string,\n\t\t{      CHD_NEW_FILE_TYPE} as string,\n\t\t{      CHD_RECORD_FORMAT} as string,\n\t\t{      CHD_BRANCH_NO} as string,\n\t\t{      CHD_CLIENT_NUMBER} as string,\n\t\t{      CHD_SYSTEM_NO} as string,\n\t\t{      CHD_PRIN_BANK} as string,\n\t\t{      CHD_AGENT_BANK} as string,\n\t\t{      CHD_ACCOUNT_NUMBER} as string,\n\t\t{      CHD_EXTERNAL_STATUS} as string,\n\t\t{      CHD_INTERNAL_STATUS} as string,\n\t\t{      CHD_PREV_EXT_STATUS} as string,\n\t\t{      CHD_CYCLE_CODE_99} as string,\n\t\t{      CHD_DATE_LAST_NONMON} as string,\n\t\t{      CHD_PREVIOUS_CYCLE_CODE_99} as string,\n\t\t{      CHD_CHARGE_DDA_CODE} as string,\n\t\t{      CHD_TRANSIT_ROUTING_NO} as string,\n\t\t{      CHD_CHECKING_ACCT_NO} as string,\n\t\t{      CHD_SAVINGS_ACCT_NO} as string,\n\t\t{      CHD_SEC_CODE_NUM_1} as string,\n\t\t{      CHD_SEC_CODE_NUM_2} as string,\n\t\t{      CHD_PIN_TRANSFER_FLAG} as string,\n\t\t{      CHD_ANN_RATE_CASH} as string,\n\t\t{      CHD_ANN_RATE_MRCH} as string,\n\t\t{      CHD_OLD_ANN_RATE} as string,\n\t\t{      CHD_OLD_ANN_RATE_CASH} as string,\n\t\t{      CHD_ANN_RATE_CASH_MAX} as string,\n\t\t{      CHD_ANN_RATE_MRCH_MAX} as string,\n\t\t{      CHD_ANN_RATE_MRCH_FUTURE} as string,\n\t\t{      CHD_ANN_RATE_CASH_FUTURE} as string,\n\t\t{      CHD_MONTHLY_RATE_CASH} as string,\n\t\t{      CHD_DAILY_RATE_CASH} as string,\n\t\t{      CHD_MONTHLY_RATE} as string,\n\t\t{      CHD_DAILY_RATE_MRCH} as string,\n\t\t{      CHD_ANN_RATE_CRDINT} as string,\n\t\t{      CHD_MONTHLY_RATE_CRDINT} as string,\n\t\t{      CHD_DAILY_RATE_CRDINT} as string,\n\t\t{      CHD_MTH_RATE_CASH_MAX} as string,\n\t\t{      CHD_MTH_RATE_MRCH_MAX} as string,\n\t\t{      CHD_ANN_RATE_CASH_MIN} as string,\n\t\t{      CHD_ANN_RATE_MRCH_MIN} as string,\n\t\t{      CHD_MTH_RATE_CASH_MIN} as string,\n\t\t{      CHD_MTH_RATE_MRCH_MIN} as string,\n\t\t{      CHD_BEHAVIOR_SCORE} as string,\n\t\t{      CHD_PREV_BHVR_SCORE} as string,\n\t\t{      CHD_CR_SCORE_DATE} as string,\n\t\t{      CHD_CREDIT_SCORE} as string,\n\t\t{      CHD_COLLECTION_CODE} as string,\n\t\t{      CHD_COFF_REASON_CODE} as string,\n\t\t{      CHD_RECOURSE_FLAG} as string,\n\t\t{      CHD_RECOURSE_MERCHANT} as string,\n\t\t{      CHD_WB_TRAN_TYPE} as string,\n\t\t{      CHD_WB_PURGE_DATE} as string,\n\t\t{      CHD_CREDIT_BUREAU_FLAG} as string,\n\t\t{      CHD_COLL_PROC_FLAG} as string,\n\t\t{      CHD_RECOVERY_IND} as string,\n\t\t{      CHD_RENEWAL_CODE} as string,\n\t\t{      CHD_NO_PLASTICS} as string,\n\t\t{      CHD_TYPE_PLASTIC} as string,\n\t\t{      CHD_SPOUSE_TYPE_PLASTIC} as string,\n\t\t{      CHD_DUAL_TYPE_PLASTIC} as string,\n\t\t{      CHD_DUAL_SPOUSE_TYPE_PLASTIC} as string,\n\t\t{      CHD_NEWCARD_FLAG} as string,\n\t\t{      CHD_ANNUAL_CHARGE_FLAG} as string,\n\t\t{      CHD_ANNUAL_CHG_DATE} as string,\n\t\t{      CHD_MAIL_CODE} as string,\n\t\t{      CHD_MAIL_CODE_FLAG} as string,\n\t\t{      CHD_OPEN_DATE} as string,\n\t\t{      CHD_MEMBER_SINCE_DATE} as string,\n\t\t{      CHD_EXPIRATION_DATE} as string,\n\t\t{      CHD_REISSUE_CONTROL} as string,\n\t\t{      CHD_DATE_LAST_PLASTIC} as string,\n\t\t{      CHD_SMRT_CARD_ICC_CD} as string,\n\t\t{      CHD_CREDIT_LINE} as string,\n\t\t{      CHD_TYPE_CRED_LINE_CHG} as string,\n\t\t{      CHD_CR_LINE_DATE} as string,\n\t\t{      CHD_DATE_LAST_REVIEW} as string,\n\t\t{      CHD_DATE_NEXT_REVIEW} as string,\n\t\t{      CHD_CUST_FLG_1} as string,\n\t\t{      CHD_CUST_FLG_2} as string,\n\t\t{      CHD_CUST_FLG_3} as string,\n\t\t{      CHD_CUST_FLG_4} as string,\n\t\t{      CHD_SC_1} as string,\n\t\t{      CHD_SC_2} as string,\n\t\t{      CHD_SC_3} as string,\n\t\t{      CHD_SC_4} as string,\n\t\t{      CHD_SC_5} as string,\n\t\t{      CHD_SC_6} as string,\n\t\t{      CHD_SC_7} as string,\n\t\t{      CHD_SC_8} as string,\n\t\t{      CHD_MISCELLANEOUS_FIELD_1} as string,\n\t\t{      CHD_MISCELLANEOUS_FIELD_2} as string,\n\t\t{      CHD_MISCELLANEOUS_FIELD_3} as string,\n\t\t{      CHD_MISCELLANEOUS_FIELD_4} as string,\n\t\t{      CHD_MISCELLANEOUS_FIELD_5} as string,\n\t\t{      CHD_MISCELLANEOUS_FIELD_6} as string,\n\t\t{      CHD_MISCELLANEOUS_FIELD_7} as string,\n\t\t{      CHD_MISCELLANEOUS_FIELD_8} as string,\n\t\t{      CHD_MISC_FIELD_9} as string,\n\t\t{      CHD_MISC_FIELD_10} as string,\n\t\t{      CHD_MISC_FIELD_11_TX} as string,\n\t\t{      CHD_MISC_FIELD_12_TX} as string,\n\t\t{      CHD_CROSS_REFERENCE_ACCT_NO} as string,\n\t\t{      CHD_NEW_XREF_NO_1} as string,\n\t\t{      CHD_NEW_XREF_NO_2} as string,\n\t\t{      CHD_CUST_XREF_ID} as string,\n\t\t{      CHD_CR_LIFE_STAT_DATE} as string,\n\t\t{      CHD_CR_LIFE_PAID_AMT} as string,\n\t\t{      CHD_LS_TERMS_FLAG} as string,\n\t\t{      CHD_CTD_TERMS_FLAG} as string,\n\t\t{      CHD_TERMS_DATE} as string,\n\t\t{      CHD_TRANSFER_FLAG} as string,\n\t\t{      CHD_DATE_LOST_STOLEN} as string,\n\t\t{      CHD_ACCT_TRANSFER} as string,\n\t\t{      CHD_ACCT_XFOOT} as string,\n\t\t{      CHD_STMT_FEE_FLAG} as string,\n\t\t{      CHD_FIXED_PAYMENT_AMT} as string,\n\t\t{      CHD_CASH_FIXED_PAYMENT} as string,\n\t\t{      CHD_ANN_ACTIVITY_SUMM_FLAG} as string,\n\t\t{      CHD_90_DAY_FLAG} as string,\n\t\t{      CHD_DEFER_PAY_FLAG} as string,\n\t\t{      CHD_PAY_AHEAD_FLAG} as string,\n\t\t{      CHD_CREDIT_LIFE_FLAG_N} as string,\n\t\t{      CHD_MAX_REBATE_AMT} as string,\n\t\t{      CHD_DELETE_FLAG} as string,\n\t\t{      CHD_DUALITY_FLAG} as string,\n\t\t{      CHD_TYPE_LAST_NONMON} as string,\n\t\t{      CHD_SPEC_STMT_FLAG} as string,\n\t\t{      CHD_AUTOPAY_SKIP_FLAG} as string,\n\t\t{      CHD_GROSS_ACTIVE} as string,\n\t\t{      CHD_DEBIT_ACTIVE} as string,\n\t\t{      CHD_BASIC_ACTIVE} as string,\n\t\t{      CHD_AUTH_FLAG} as string,\n\t\t{      CHD_INTEREST_SWITCH} as string,\n\t\t{      CHD_STMT_HOLD_FLAG} as string,\n\t\t{      CHD_MULTRAN_FLAG} as string,\n\t\t{      CHD_CR_LIFE_STATUS} as string,\n\t\t{      CHD_CB_SCORE} as string,\n\t\t{      CHD_CB_ID} as string,\n\t\t{      CHD_CB_CODE} as string,\n\t\t{      CHD_CB_ATTR1} as string,\n\t\t{      CHD_CB_ATTR2} as string,\n\t\t{      CHD_CB_ATTR3} as string,\n\t\t{      CHD_CB_SCORE_DATE} as string,\n\t\t{      CHD_CB_REASON1} as string,\n\t\t{      CHD_CB_REASON2} as string,\n\t\t{      CHD_CB_REASON3} as string,\n\t\t{      CHD_CB_REASON4} as string,\n\t\t{      CHD_MO_CHARGE_INT_ONLY} as string,\n\t\t{      CHD_DATE_STATUS_CHG} as string,\n\t\t{      CHD_RISK_PREDICTOR_SCORE} as string,\n\t\t{      CHD_RISK_PREDICTOR_BUREAU} as string,\n\t\t{      CHD_RISK_PREDICTOR_MODEL} as string,\n\t\t{      CHD_VISA_REGION} as string,\n\t\t{      CHD_MC_REGION} as string,\n\t\t{      CHD_ACCT_TRANSFER_DATE} as string,\n\t\t{      CHD_ACCT_TRANSFER_FLAG} as string,\n\t\t{      CHD_CASH_CREDIT_LINE_CHG_DT} as string,\n\t\t{      CHD_CASH_CREDIT_LINE_CHG_TYP} as string,\n\t\t{      CHD_ADD_ON_RATE_FLAG} as string,\n\t\t{      CHD_CURR_PRICING_PORTFOLIO} as string,\n\t\t{      CHD_CURR_PRICING_STRATEGY} as string,\n\t\t{      CHD_CURR_PRICE_STRATEGY_DATE} as string,\n\t\t{      CHD_CURR_STRAT_CYCLE_FLAG} as string,\n\t\t{      CHD_LS_PRCN_PORT_ID} as string,\n\t\t{      CHD_OLD_NEXT_PRICING_STRATEGY} as string,\n\t\t{      CHD_NEXT_PRICE_STRATEGY_DATE} as string,\n\t\t{      CHD_OLD_NEXT_STRAT_CYCLE_FLAG} as string,\n\t\t{      CHD_OLD_NEXT_STRT_STAGE_REASO} as string,\n\t\t{      CHD_LS_PRICING_STRATEGY} as string,\n\t\t{      CHD_LAST_STRATEGY_CHANGE_DATE} as string,\n\t\t{      CHD_PROCESSING_LEVEL} as string,\n\t\t{      CHD_UD_SOURCE_CODE} as string,\n\t\t{      CHD_UD_APPROVAL_OFFICER_CODE} as string,\n\t\t{      CHD_FRAUD_PORT_ID} as string,\n\t\t{      CHD_FRAUD_ASSG_STRATEGY} as string,\n\t\t{      CHD_FRAUD_STRAT_CHANGE_DATE} as string,\n\t\t{      CHD_FRAUD_SUSPEND_STRATEGY} as string,\n\t\t{      CHD_FRAUD_SUSP_STRATEGY_DATE} as string,\n\t\t{      CHD_LAST_PLASTIC_SOURCE} as string,\n\t\t{      CHD_FRAUD_SCORE_CHANGE_DATE} as string,\n\t\t{      CHD_FRAUD_SCORE} as string,\n\t\t{      CHD_DATE_LAST_ACL_LTR} as string,\n\t\t{      CHD_DISCOUNT_CODE} as string,\n\t\t{      CHD_NO_MAIL_FLAG} as string,\n\t\t{      CHD_PRICING_STRATEGY_STATUS} as string,\n\t\t{      CHD_BONUS_STRATEGY} as string,\n\t\t{      CHD_LS_BONUS_STRATEGY} as string,\n\t\t{      CHD_LAST_ANNUAL_CHARGE_FLAG} as string,\n\t\t{      CHD_HIGH_BAL_LIFE} as string,\n\t\t{      CHD_MIN_DAYS_DELQ_NR} as string,\n\t\t{      CHD_ACS_CLNT_ID} as string,\n\t\t{      CHD_PREV_INTERNAL_STATUS} as string,\n\t\t{      CHD_DATE_IN_COLLECTION} as string,\n\t\t{      CHD_START_DATE_OF_DELQ} as string,\n\t\t{      CHD_PRIMARY_PEF} as string,\n\t\t{      CHD_SECONDARY_PEF} as string,\n\t\t{      CHD_COV_STRATEGY_ID} as string,\n\t\t{      CHD_BS_REASON_CODE_1} as string,\n\t\t{      CHD_BS_REASON_CODE_2} as string,\n\t\t{      CHD_BS_REASON_CODE_3} as string,\n\t\t{      CHD_BS_REASON_CODE_4} as string,\n\t\t{      CHD_REQ_CLOSED_DATE} as string,\n\t\t{      CHD_PREV_CRLINE_CHANGE_DATE} as string,\n\t\t{      CHD_CRLINE_CHANGE_AMT} as string,\n\t\t{      CHD_CASH_CRDT_LINE_AM} as string,\n\t\t{      CHD_CASH_LINE_REVW_DT} as string,\n\t\t{      CHD_TLP_CLT_ID} as string,\n\t\t{      CHD_TLP_CLT_EXPR_DT} as string,\n\t\t{      CHD_ACCT_CT} as string,\n\t\t{      CHD_CRRN_ANNL_CASH_RT} as string,\n\t\t{      CHD_CRRN_ANNL_MRCH_RT} as string,\n\t\t{      CHD_HIGH_NOM_MRCH_APPLIED_RT} as string,\n\t\t{      CHD_LOW_NOM_MRCH_APPLIED_RT} as string,\n\t\t{      CHD_HIGH_NOM_CASH_APPLIED_RT} as string,\n\t\t{      CHD_LOW_NOM_CASH_APPLIED_RT} as string,\n\t\t{      CHD_EQTY_ACCT_MTRT_DT} as string,\n\t\t{      CHD_SUB_ACCT_CD} as string,\n\t\t{      CHD_CMPN_ID} as string,\n\t\t{      CHD_ACCT_MRKT_STRT_NM} as string,\n\t\t{      CHD_ACCT_MRKT_PRCS_CD} as string,\n\t\t{      CHD_ACCT_MRKT_STRT_DT} as string,\n\t\t{      CHD_REIS_STRT_NM} as string,\n\t\t{      CHD_REIS_PRCS_CD} as string,\n\t\t{      CHD_REIS_STRT_DT} as string,\n\t\t{      CHD_ACCT_GROP_ID} as string,\n\t\t{      CHD_PYMN_DUE_DT} as string,\n\t\t{      CHD_NEWCRD_FLAG_RETN_DT} as string,\n\t\t{      CHD_NEXT_CYCL_DT} as string,\n\t\t{      CHD_LAST_MON_TRAN_CD} as string,\n\t\t{      CHD_DALY_INTR_CALC_MTHD_CD} as string,\n\t\t{      CHD_CR_LIFE_STATUS_DT} as string,\n\t\t{      CHD_LAST_LTTR_ID} as string,\n\t\t{      CHD_LAST_LTTR_DT} as string,\n\t\t{      CHD_AVLB_CRDT_AMT} as string,\n\t\t{      CHD_CALC_NORM_CASH_RT} as string,\n\t\t{      CHD_CALC_NORM_MRCH_RT} as string,\n\t\t{      CHD_CALC_NORM_CASH_MNTH_RT} as string,\n\t\t{      CHD_CALC_NORM_MRCH_MNTH_RT} as string,\n\t\t{      CHD_CALC_NORM_CASH_ANN_RT} as string,\n\t\t{      CHD_CALC_NORM_MRCH_ANN_RT} as string,\n\t\t{      CHD_PAYMENT_DUE_DAYS_NR} as string,\n\t\t{      CHD_MISC_13_PSTN_1_10_TX} as string,\n\t\t{      CHD_MISC_13_PSTN_11_15_TX} as string,\n\t\t{      CHD_MISC_13_PSTN_16_20_TX} as string,\n\t\t{      CHD_MISC_13_PSTN_21_25_TX} as string,\n\t\t{      CHD_MISC_13_PSTN_26_TX} as string,\n\t\t{      CHD_MISC_13_PSTN_27_TX} as string,\n\t\t{      CHD_MISC_13_PSTN_28_TX} as string,\n\t\t{      CHD_MISC_13_PSTN_29_TX} as string,\n\t\t{      CHD_MISC_13_PSTN_30_TX} as string,\n\t\t{      CHD_MISC_13_PSTN_31_TX} as string,\n\t\t{      CHD_MISC_13_PSTN_32_TX} as string,\n\t\t{      CHD_MISC_13_PSTN_33_TX} as string,\n\t\t{      CHD_MISC_13_PSTN_34_TX} as string,\n\t\t{      CHD_MISC_13_PSTN_35_TX} as string,\n\t\t{      CHD_MISC_13_PSTN_36_TX} as string,\n\t\t{      CHD_MISC_13_PSTN_37_TX} as string,\n\t\t{      CHD_MISC_13_PSTN_38_TX} as string,\n\t\t{      CHD_MISC_13_PSTN_39_TX} as string,\n\t\t{      CHD_MISC_13_PSTN_40_TX} as string,\n\t\t{      CHD_MISC_13_PSTN_41_TX} as string,\n\t\t{      CHD_MISC_13_PSTN_42_TX} as string,\n\t\t{      CHD_MISC_13_PSTN_43_TX} as string,\n\t\t{      CHD_MISC_13_PSTN_44_TX} as string,\n\t\t{      CHD_MISC_13_PSTN_45_TX} as string,\n\t\t{      CHD_MISC_13_PSTN_46_TX} as string,\n\t\t{      CHD_MISC_13_PSTN_47_TX} as string,\n\t\t{      CHD_MISC_13_PSTN_48_TX} as string,\n\t\t{      CHD_MISC_13_PSTN_49_TX} as string,\n\t\t{      CHD_MISC_13_PSTN_50_TX} as string,\n\t\t{      CHD_BHVR_SCOR_DT} as string,\n\t\t{      CHD_DBT_ACTV_ID} as string,\n\t\t{      CHD_CRDT_LINE_CHNG_DT} as string,\n\t\t{      CHD_PREV_CRDT_LINE_CHNG_DT} as string,\n\t\t{      CHD_CRDT_BUR_BKCY_DT} as string,\n\t\t{      RoutingTransit} as string,\n\t\t{      FDR_Date_Processed} as string,\n\t\t{      ExtractDate} as string,\n\t\t{      DateProcessed} as string,\n\t\t{      CHDHD_1098_YTD_INTR_THRD_AM} as string,\n\t\t{      CHDHD_1098_YTD_INTR_TOTL_AM} as string,\n\t\t{      CHDHD_1098_PREV_INTR_THRD_AM} as string,\n\t\t{      CHDHD_1098_PREV_INTR_TOTL_AM} as string,\n\t\t{      SysPrinAgent} as string,\n\t\t{      CHD_AVOD_FINC_CHRG_AM} as string,\n\t\t{      CHD_LFTM_CASH_AND_MRCH_AM} as string,\n\t\t{      CHD_RECOVERY_CD} as string,\n\t\t{      ReportDate} as string,\n\t\t{      CHD_AUTO_PAY_PNDG_IN      } as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcBaseData\nsource(output(\n\t\tCustRole_ID as string,\n\t\tCURL_GROUP_ID as string,\n\t\tCURL_OUT_KEY_SYS_BANK as string,\n\t\tCURL_OUT_KEY_PRIN_BANK as string,\n\t\tCURL_OUT_KEY_AGENT_BANK as string,\n\t\tCURL_OUT_KEY_ACCT_NO as string,\n\t\tCURL_TYPE_CD as string,\n\t\tCURL_MMBR_SQNC_NR as string,\n\t\tCURL_OUT_EXTR_ID as string,\n\t\tCURL_OUT_ROLE_EFFC_TS as string,\n\t\tCURL_OUT_ROLE_END_TS as string,\n\t\tCURL_OUT_CRBR_RPRT_CD as string,\n\t\tCURL_OUT_LAST_CRBR_RPRT_CD as string,\n\t\tCURL_OUT_CNSM_INFR_INDC_CD as string,\n\t\tCURL_OUT_CRBR_RPRT_DLTN_DT as string,\n\t\treportDate as date 'yyyy-MM-dd',\n\t\tdateProcessed as string,\n\t\tFDR_DATE_PROCESSED as string,\n\t\tDBI_CLIENT_NUMBER as string,\n\t\tCURL_OUT_RLTN_TYPE_CD as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcCustRole\nsource(output(\n\t\tPhone_ID as string,\n\t\tPHON_GROUP_ID as string,\n\t\tPHON_OUT_KEY_SYS_BANK as string,\n\t\tPHON_OUT_KEY_PRIN_BANK as string,\n\t\tPHON_OUT_KEY_AGENT_BANK as string,\n\t\tPHON_OUT_KEY_ACCT_NO as string,\n\t\tPHON_TYPE_CD as string,\n\t\tPHON_MMBR_SQNC_NR as string,\n\t\tPHON_OUT_EXTR_ID as string,\n\t\tPHON_OUT_CMNC_TYPE_CD as string,\n\t\tPHON_OUT_CMNC_TX as string,\n\t\tPHON_OUT_CNTC_PRHB_CD as string,\n\t\treportDate as date 'yyyy-MM-dd',\n\t\tdateProcessed as string,\n\t\tFDR_DATE_PROCESSED as string,\n\t\tPHON_OUT_TYPE_CD as string,\n\t\tPHON_OUT_UPDT_DT as string,\n\t\tDBI_CLIENT_NUMBER as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcPhone\nsource(output(\n\t\tSPAIdentifier as string,\n\t\tsys as string,\n\t\tprin as string,\n\t\tagent as string,\n\t\tcu_odindx as string,\n\t\tcardtyp as string,\n\t\tInterestRate as string,\n\t\tAnnualFee as string,\n\t\tOverlimitFee as string,\n\t\tLateFee as string,\n\t\tCwbFee as string,\n\t\tAutoDQFee as string,\n\t\tGroupNo as string,\n\t\tGroupDesc as string,\n\t\tItemizedPerAcct as string,\n\t\tPrimaryBillingSys as string,\n\t\tPlatform as string,\n\t\tSPA as string,\n\t\tDateProcessed as string,\n\t\tStatus as string,\n\t\tUniversalAddressing as string,\n\t\tSeparateEntityFlag as string,\n\t\tInternationalDateFormat as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcCCUMSTR\nsource(output(\n\t\tdw_binkey as long,\n\t\tdw_clientkey as long,\n\t\tbankIdentificationNumberISO as string,\n\t\tbankIdentificationNumberEXT as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'select distinct bin_key as dw_binkey, client_key as dw_clientkey, bankIdentificationNumberISO, bankIdentificationNumberEXT from [financialinstitution].[dim_bin] with (nolock)',\n\tformat: 'query',\n\tstaged: false,\n\tpartitionColumn: 'bankIdentificationNumberEXT',\n\tpartitionBy('external', 2)) ~> dwDimBin\nsource(output(\n\t\tclient_key as long,\n\t\tclient_name as string,\n\t\tclient_number as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'SELECT DISTINCT client_key, client_name, client_number FROM FinancialInstitution.dim_client With(NoLock)',\n\tformat: 'query',\n\tstaged: false,\n\tpartitionColumn: 'client_key',\n\tpartitionBy('external', 2)) ~> dwDimClient\nselectPIRecord derive(AccountSystemEntryDate_dcPIRecord = toDate(case(substring(PINS_OUT_ASSG_CRTN_DT,5,4)=='0001', '1901', substring(PINS_OUT_ASSG_CRTN_DT,5,4))+'-'+substring(PINS_OUT_ASSG_CRTN_DT,1,2)+'-'+substring(PINS_OUT_ASSG_CRTN_DT,3,2),'yyyy-MM-dd'),\n\t\tExpirationDate_dcPIRecord = toDate(case(substring(PINS_OUT_EXPR_DT,5,4)=='0001', '1901', substring(PINS_OUT_EXPR_DT,5,4))+'-'+substring(PINS_OUT_EXPR_DT,1,2)+'-'+substring(PINS_OUT_EXPR_DT,3,2),'yyyy-MM-dd'),\n\t\tCardNum_dcPIRecord = ltrim(rtrim(CardNum_PIRecord)),\n\t\tSourceId_dcPIRecord = toString('FD'),\n\t\tCardTypeCd_dcPIRecord = toString('C'),\n\t\tCreateDate_dcPIRecord = currentUTC()) ~> dcPIRecord\nFilterOutHeadingsIfExists derive(HomePhone_dcBalanceStatus = case(HomePhone_BalanceStatus == '0' || HomePhone_BalanceStatus == '1111111111',toString(null()),HomePhone_BalanceStatus),\n\t\tBusinessPhone_dcBalanceStatus = case(BusinessPhone_BalanceStatus == '0' || BusinessPhone_BalanceStatus == '1111111111',toString(null()),BusinessPhone_BalanceStatus),\n\t\tCrossReferenceAccountNumOne__dcBalanceStatus = case(CrossReferenceAccountNum1_BalanceStatus != '0',CrossReferenceAccountNum1_BalanceStatus,toString(null())),\n\t\tCrossReferenceAccountNumTwo__dcBalanceStatus = case(CrossReferenceAccountNum2_BalanceStatus != '0',CrossReferenceAccountNum2_BalanceStatus,toString(null())),\n\t\tCrossReferenceAccountNumThree__dcBalanceStatus = case(CrossReferenceAccountNum3_BalanceStatus!= '0',CrossReferenceAccountNum3_BalanceStatus,toString(null()))) ~> dcBalanceStatus\nSelectPIStatus derive(CardStatusChangeDate_dcPIStatus = toDate(case(substring(CardStatusChangeDate_PIStatus,5,4) != '0001', substring(CardStatusChangeDate_PIStatus,5,4)+'-'+substring(CardStatusChangeDate_PIStatus,1,2)+'-'+substring(CardStatusChangeDate_PIStatus,3,2)),'yyyy-MM-dd'),\n\t\tCardStatus_dcPIStatus = case(CardStatus_PIStatus != '', CardStatus_PIStatus, toString(null()))) ~> dcPIStatus\nlojCCUMSTR select(mapColumn(\n\t\tPI_Record_ID,\n\t\tAccountNum_PIRecord = PINS_OUT_KEY_ACCT_NO,\n\t\tCardHolder_Type_Cd_PIRecord = PINS_TYPE_CD,\n\t\tCardHolderPositionCd_PIRecord = PINS_MMBR_SQNC_NR,\n\t\tCardNum_PIRecord = PINS_OUT_PI_ID,\n\t\tPINS_OUT_ASSG_CRTN_DT,\n\t\tPINS_OUT_EXPR_DT,\n\t\tReportDate_SelectPIRecord = reportDate,\n\t\tSeparateEntityFlag,\n\t\tCardPlatform = Platform,\n\t\tPINS_OUT_KEY_SYS_BANK,\n\t\tPINS_OUT_KEY_PRIN_BANK,\n\t\tPINS_OUT_KEY_AGENT_BANK\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> selectPIRecord\nsrcBalanceStatus select(mapColumn(\n\t\tBalanceStatus_ID_BalanceStatus = BalanceStatus_ID,\n\t\tAccountNum_BalanceStatus = ACCT_NO,\n\t\tCardsIssuedCnt_BalanceStatus = NUMBER_OF_PLASTICS_X,\n\t\tAddress1LineOne_BalanceStatus = ADDR_LINE_1,\n\t\tAddress1LineTwo_BalanceStatus = ADDR_LINE_2,\n\t\tAddress1City_BalanceStatus = CITY,\n\t\tAddress1State_BalanceStatus = STATE,\n\t\tAddress1ZipCode_BalanceStatus = ZIP_CODE,\n\t\tStatementCycleCd_BalanceStatus = CYCLE_CODE,\n\t\tExternalStatus_BalanceStatus = EXTERNAL_STATUS,\n\t\tInternalStatus_BalanceStatus = INTERNAL_STATUS,\n\t\tCrossReferenceAccountNum1_BalanceStatus = CROSS_REF_ACCT_NO,\n\t\tCrossReferenceAccountNum2_BalanceStatus = CROSS_REF_ACCT_NO_1,\n\t\tCrossReferenceAccountNum3_BalanceStatus = CROSS_REF_ACCT_NO_2,\n\t\tHomePhone_BalanceStatus = HOME_TELEPHONE_NUMBER,\n\t\tBusinessPhone_BalanceStatus = BUSINESS_TELEPHONE_NUMBER,\n\t\tCheckingAccountNum_BalanceStatus = CHECKING_ACCOUNT_NUMBER,\n\t\tSavingsAccountNum_BalanceStatus = SAVINGS_ACCOUNT_NUMBER,\n\t\tAccountBalance_BalanceStatus = CURRENT_BALANCE,\n\t\tReportDate_BalanceStatus = ReportDate,\n\t\tSYS_BANK,\n\t\tPRIN_BANK,\n\t\tAGENT_BANK\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectBalanceStatus\ndcPIRecord, SelectBalanceStatusAll join(AccountNum_PIRecord == AccountNum_SelectBalanceStatusAll\n\t&& PINS_OUT_KEY_SYS_BANK == SYS_BANK\n\t&& PINS_OUT_KEY_PRIN_BANK == PRIN_BANK\n\t&& PINS_OUT_KEY_AGENT_BANK == AGENT_BANK,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> ijBalanceStatus\nljBinClientCustExpanded select(mapColumn(\n\t\tCustExpanded_ID_CustExpanded = CustExpanded_ID,\n\t\tClientNum_CustExpanded = client_number,\n\t\tAccountNum_CustExpanded = CUEX_OUT_KEY_ACCT_NO,\n\t\tCardHolder_Type_Cd_CustExpanded = CUEX_TYPE_CD,\n\t\tCardHolderPositionCd_CustExpanded = CUEX_MMBR_SQNC_NR,\n\t\tCardHolderName_CustExpanded = CUEX_OUT_CUST_NM,\n\t\tCardHolderNamePrefix_CustExpanded = CUEX_OUT_PRFX_TX,\n\t\tCardholderFirstName_CustExpanded = CUEX_OUT_FRST_NM,\n\t\tCardHolderMiddleName_CustExpanded = CUEX_OUT_MDDL_NM,\n\t\tCardholderLastName_CustExpanded = CUEX_OUT_LAST_NM,\n\t\tCardHolderNameSuffix_CustExpanded = CUEX_OUT_SFFX_CD,\n\t\tMothersMadenName_CustExpanded = CUEX_OUT_MTHR_MADN_NM,\n\t\tDeceasedCd_CustExpanded = CUEX_OUT_DCSD_CD,\n\t\tBirthDate_CustExpanded = CUEX_OUT_BRTH_DT,\n\t\tCardHolderSexCd_CustExpanded = CUEX_OUT_SLLT_SEX_CD,\n\t\tDoNotSolicitInd_CustExpanded = CUEX_OUT_SLCT_CD,\n\t\tReportDate_CustExpanded = reportDate\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> SelectCustExpanded\nijBalanceStatus, dcCustExpanded join(AccountNum_PIRecord == AccountNum_CustExpanded\n\t&& CardHolder_Type_Cd_PIRecord == CardHolder_Type_Cd_CustExpanded\n\t&& CardHolderPositionCd_PIRecord == CardHolderPositionCd_CustExpanded,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> ijCustExpanded\nDistinctValues select(mapColumn(\n\t\tAccountNum_SelectAltCustIdentification = ALTC_OUT_KEY_ACCT_NO,\n\t\tCardHolder_Type_Cd_SelectAltCustIdentification = ALTC_TYPE_CD,\n\t\tCardHolderPositionCd_SelectAltCustIdentification = ALTC_MMBR_SQNC_NR,\n\t\tSocialSecurityNum_SelectAltCustIdentification = SocialSecurityNum_dcAltCustIdentification,\n\t\tCustomerControlId_SelectAltCustIdentification = CustomerControlId_dcAltCustIdentification,\n\t\tReportDate_SelectAltCustIdentification = reportDate,\n\t\tALTC_OUT_EXTR_ID\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectAltCustIdentification\nsrcExpAddr select(mapColumn(\n\t\tExpAddr_ID_ExpAddr = ExpAddr_ID,\n\t\tAccountNum_ExpAddr = ADEX_OUT_KEY_ACCT_NO,\n\t\tCardHolder_Type_Cd_ExpAddr = ADEX_TYPE_CD,\n\t\tCardHolderPositionCd_ExpAddr = ADEX_MMBR_SQNC_NR,\n\t\tADEX_OUT_EFFC_BEGN_DT_ExpAddr = ADEX_OUT_EFFC_BEGN_DT,\n\t\tADEX_OUT_EFFC_END_DT_ExpAddr = ADEX_OUT_EFFC_END_DT,\n\t\tAddress1LineOne_ExpAddr = ADEX_OUT_LINE_1_TX,\n\t\tAddress1LineTwo_ExpAddr = ADEX_OUT_LINE_2_TX,\n\t\tAddress1City_ExpAddr = ADEX_OUT_CITY_NM,\n\t\tAddress1State_ExpAddr = ADEX_OUT_SBDV_1_TX,\n\t\tAddress1ZipCode_ExpAddr = ADEX_OUT_PSTL_CD,\n\t\tReportDate_ExpAddr = reportDate,\n\t\tADEX_OUT_ADDR_TYPE_CD_ExpAddr = ADEX_OUT_ADDR_TYPE_CD,\n\t\tADEX_OUT_CTGR_CD_ExpAddr = ADEX_OUT_CTGR_CD,\n\t\tAddress1CountryAlpha3_ExpAddr = ADEX_OUT_ISO3_CTRY_CD,\n\t\tAddress1LineThree_ExpAddr = ADEX_OUT_LINE_3_TX,\n\t\tAddress1LineFour_ExpAddr = ADEX_OUT_LINE_4_TX\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectExpAddr\ntrimBlankSpacesPIStatus select(mapColumn(\n\t\tPI_Status_ID,\n\t\tAccountNum_PIStatus = PRST_OUT_KEY_ACCT_NO,\n\t\tCardHolder_Type_Cd_PIStatus = PRST_TYPE_CD,\n\t\tCardHolderPositionCd_PIStatus = PRST_MMBR_SQNC_NR,\n\t\tCardNum_PIStatus = PRST_OUT_PI_ID,\n\t\tCardStatus_PIStatus = PRST_OUT_PI_STTS_CD,\n\t\tCardStatusChangeDate_PIStatus = PRST_OUT_STTS_CHNG_DT,\n\t\tSpaSystemBank_PIStatus = PRST_OUT_KEY_SYS_BANK,\n\t\tSpaPrincipalBank_PIStatus = PRST_OUT_KEY_PRIN_BANK,\n\t\tSpaAgentBank_PIStatus = PRST_OUT_KEY_AGENT_BANK,\n\t\tReportDate_PIStatus = reportDate\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectPIStatus\nlojPhone, dcPIStatus join(CardNum_dcPIRecord == CardNum_PIStatus\n\t&& AccountNum_PIRecord == AccountNum_PIStatus\n\t&& CardHolder_Type_Cd_PIRecord == CardHolder_Type_Cd_PIStatus\n\t&& CardHolderPositionCd_PIRecord == CardHolderPositionCd_PIStatus,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> lojPIStatus\ntrimBlankSpacesPIRecord select(mapColumn(\n\t\tAccountNum_PIRecordEmail = PINS_OUT_KEY_ACCT_NO,\n\t\tCardHolder_Type_Cd_PIRecordEmail = PINS_TYPE_CD,\n\t\tCardHolderPositionCd_PIRecordEmail = PINS_MMBR_SQNC_NR,\n\t\tReportDate_PIRecordEmail = reportDate\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectPIRecordForEmail\nSelectPIRecordForEmail aggregate(groupBy(AccountNum_PIRecordEmail,\n\t\tCardHolder_Type_Cd_PIRecordEmail,\n\t\tCardHolderPositionCd_PIRecordEmail),\n\tReportDate_LastPIRecordEmail = last(ReportDate_PIRecordEmail)) ~> DistinctPIRecordAccount\ndcEmail select(mapColumn(\n\t\tEmail_ID_Email = Email_ID,\n\t\tAccountNum_Email = EMAL_OUT_KEY_ACCT_NO,\n\t\tCardHolder_Type_Cd_Email = EMAL_TYPE_CD,\n\t\tCardHolderPositionCd_Email = EMAL_MMBR_SQNC_NR,\n\t\tEmailUseTypeCd_Email = EMAL_OUT_USE_TYPE_CD,\n\t\tEmailAddress_Email = EMAL_OUT_ADDR_TX,\n\t\tEmailAddressStatus_Email = EMAL_OUT_ADDR_STTS_IN,\n\t\tReportDate_Email = reportDate,\n\t\tCreateDate_Email = CreateDate_dcEmail\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectEmail\nDistinctPIRecordAccount, trimBlankSpacesEmail join(AccountNum_PIRecordEmail == AccountNum_Email\n\t&& CardHolder_Type_Cd_PIRecordEmail == CardHolder_Type_Cd_Email\n\t&& CardHolderPositionCd_PIRecordEmail == CardHolderPositionCd_Email,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> ijEmail\nsrcPIRecord derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null()))))) ~> trimBlankSpacesPIRecord\nSelectEmail derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null()))))) ~> trimBlankSpacesEmail\nSelectBalanceStatus derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null()))))) ~> trimBlankSpacesBalanceStatus\nsrcAltCustIdentification derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null()))))) ~> trimBlankSpacesAltCustIdentification\nFilterExpAddr derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',toString($$),toString(null()))))) ~> trimBlankSpacesExpAddr\nlojBaseData, SelectAltCustIdentification join(AccountNum_PIRecord == AccountNum_SelectAltCustIdentification\n\t&& CardHolder_Type_Cd_PIRecord == CardHolder_Type_Cd_SelectAltCustIdentification\n\t&& CardHolderPositionCd_PIRecord == CardHolderPositionCd_SelectAltCustIdentification,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> lojAltCustIdentification\nSelectExpAddr filter(ADEX_OUT_ADDR_TYPE_CD_ExpAddr == 'BLL1' && toDate(substring(ADEX_OUT_EFFC_BEGN_DT_ExpAddr,5,4)+'-'+substring(ADEX_OUT_EFFC_BEGN_DT_ExpAddr,1,2)+'-'+substring(ADEX_OUT_EFFC_BEGN_DT_ExpAddr,3,2),'yyyy-MM-dd') <= ReportDate_ExpAddr && ADEX_OUT_CTGR_CD_ExpAddr == 'P') ~> FilterExpAddr\ntrimBlankSpacesExpAddr derive(Address1LineTwo_dcExpAddr = case(length(toString(Address1LineTwo_ExpAddr)) < 2, toString(null()), Address1LineTwo_ExpAddr),\n\t\tAddress1CountryAlpha3_dcExpAddr = case(isNull(Address1CountryAlpha3_ExpAddr)==true() && (left(Address1LineThree_ExpAddr,3)=='CAN' || left(Address1LineFour_ExpAddr,3)=='CAN'), \r\n    'CAN',\r\n    (case(isNull(Address1CountryAlpha3_ExpAddr)==true() && (left(Address1LineThree_ExpAddr,3)=='USA' || left(Address1LineFour_ExpAddr,3)=='USA'), \r\n    'USA',\r\n    Address1CountryAlpha3_ExpAddr))\r\n)) ~> dcExpAddr\ndcAddressBAST select(mapColumn(\n\t\tClientNum_BASTAddrPrimary = ClientNum_CustExpanded,\n\t\tAccountNum_BASTAddrPrimary = AccountNum_PIRecord,\n\t\tCardHolder_Type_Cd_BASTAddrPrimary = CardHolder_Type_Cd_PIRecord,\n\t\tCardHolderPositionCd_BASTAddrPrimary = CardHolderPositionCd_PIRecord,\n\t\tCardNum_BASTAddrPrimary = CardNum_PIRecord,\n\t\tCardTypeCd_BASTAddrPrimary = CardTypeCd_dcPIRecord,\n\t\tCardHolderNamePrefix_BASTAddrPrimary = CardHolderNamePrefix_dcCustExpanded,\n\t\tCardHolderFirstName_BASTAddrPrimary = CardHolderFirstName_dcCustExpanded,\n\t\tCardHolderMiddleName_BASTAddrPrimary = CardHolderMiddleName_CustExpanded,\n\t\tCardHolderLastName_BASTAddrPrimary = CardHolderLastName_dcCustExpanded,\n\t\tCardHolderNameSuffix_BASTAddrPrimary = CardHolderNameSuffix_dcCustExpanded,\n\t\tSocialSecurityNum_BASTAddrPrimary = SocialSecurityNum_SelectAltCustIdentification,\n\t\tCustomerControlId_BASTAddrPrimary = CustomerControlId_SelectAltCustIdentification,\n\t\tMothersMadenName_BASTAddrPrimary = MothersMadenName_dcCustExpanded,\n\t\tBirthDate_BASTAddrPrimary = BirthDate_dcCustExpanded,\n\t\tDeceasedCd_BASTAddrPrimary = DeceasedCd_CustExpanded,\n\t\tAddress1LineOne_BASTAddrPrimary = Address1LineOne_SelectBalanceStatusAll,\n\t\tAddress1LineTwo_BASTAddrPrimary = Address1LineTwo_SelectBalanceStatusAll,\n\t\tAddress1City_BASTAddrPrimary = Address1City_SelectBalanceStatusAll,\n\t\tAddress1State_BASTAddrPrimary = Address1State_SelectBalanceStatusAll,\n\t\tAddress1ZipCode_BASTAddrPrimary = Address1ZipCode_SelectBalanceStatusAll,\n\t\tAddress1CountryAlpha3_BASTAddrPrimary = Address1CountryAlpha3_SelectBalanceStatusAll,\n\t\tAddress1CountryNumeric_BASTAddrPrimary = Address1CountryNumeric_SelectBalanceStatusAll,\n\t\tAddressSource_BASTAddrPrimary = AddressSource_dcAddressBAST,\n\t\tCardHolderSexCd_BASTAddrPrimary = CardHolderSexCd_dcCustExpanded,\n\t\tHomePhone_BASTAddrPrimary = dc_HomeNum,\n\t\tBusinessPhone_BASTAddrPrimary = dc_BusinessNum,\n\t\tTransitRoutingNum_BASTAddrPrimary = TransitRoutingNum_dcBaseData,\n\t\tCheckingAccountNum_BASTAddrPrimary = CheckingAccountNum_SelectBalanceStatusAll,\n\t\tSavingsAccountNum_BASTAddrPrimary = SavingsAccountNum_SelectBalanceStatusAll,\n\t\tAccountSystemEntryDate_BASTAddrPrimary = AccountSystemEntryDate_dcPIRecord,\n\t\tExpirationDate_BASTAddrPrimary = ExpirationDate_dcPIRecord,\n\t\tCardsIssuedCnt_BASTAddrPrimary = CardsIssuedCnt_SelectBalanceStatusAll,\n\t\tStatementCycleCd_BASTAddrPrimary = StatementCycleCd_SelectBalanceStatusAll,\n\t\tCrossReferenceAccountNum1_BASTAddrPrimary = CrossReferenceAccountNumOne_SelectBalanceStatusAll,\n\t\tCrossReferenceAccountNum2_BASTAddrPrimary = CrossReferenceAccountNumTwo_SelectBalanceStatusAll,\n\t\tCrossReferenceAccountNum3_BASTAddrPrimary = CrossReferenceAccountNumThree_SelectBalanceStatusAll,\n\t\tAccountBalance_BASTAddrPrimary = AccountBalance_SelectBalanceStatusAll,\n\t\tExternalStatus_BASTAddrPrimary = ExternalStatus_SelectBalanceStatusAll,\n\t\tInternalStatus_BASTAddrPrimary = InternalStatus_SelectBalanceStatusAll,\n\t\tCardStatus_BASTAddrPrimary = CardStatus_dcPIStatus,\n\t\tCardStatusChangeDate_BASTAddrPrimary = CardStatusChangeDate_dcPIStatus,\n\t\tDoNotSolicitInd_BASTAddrPrimary = {DoNotSolicitInd _dcCustExpanded},\n\t\tSpaSystemBank_BASTAddrPrimary = SpaSystemBank_PIStatus,\n\t\tSpaPrincipalBank_BASTAddrPrimary = SpaPrincipalBank_PIStatus,\n\t\tSpaAgentBank_BASTAddrPrimary = SpaAgentBank_PIStatus,\n\t\tSourceId_BASTAddrPrimary = SourceId_dcPIRecord,\n\t\tALTC_OUT_EXTR_ID,\n\t\tReportDate_BASTAddrPrimary = ReportDate_SelectPIRecord,\n\t\tCreateDate_BASTAddrPrimary = CreateDate_dcPIRecord,\n\t\tMobilePhone = dc_MoblieNum,\n\t\tCardProgram = CardPlatform,\n\t\tSeperateEntityInd = SeparateEntityFlag,\n\t\tCreditBureauRptCode_BASTAddrPrimary = CreditBureauRptCode_CustRole\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> BASTAddrPrimaryOnly\nNotExistsExpAddrPrimary filter(CardHolder_Type_Cd_PIRecord == '01' && CardHolderPositionCd_PIRecord == '001') ~> FilterBASTAddrPrimaryOnly\nlojPIStatus, SelectExpAddrAll exists(AccountNum_PIRecord == AccountNum_SelectExpAddrAll\n\t&& CardHolder_Type_Cd_PIRecord == CardHolder_Type_Cd_SelectExpAddrAll\n\t&& CardHolderPositionCd_PIRecord == CardHolderPositionCd_SelectExpAddrAll,\n\tnegate:true,\n\tbroadcast: 'auto')~> NotExistsExpAddrPrimary\ndcAddressExpAddr select(mapColumn(\n\t\tClientNum_ExpAddrFinal = ClientNum_CustExpanded,\n\t\tAccountNum_ExpAddrFinal = AccountNum_PIRecord,\n\t\tCardHolder_Type_Cd_ExpAddrFinal = CardHolder_Type_Cd_PIRecord,\n\t\tCardHolderPositionCd_ExpAddrFinal = CardHolderPositionCd_PIRecord,\n\t\tCardNum_ExpAddrFinal = CardNum_PIRecord,\n\t\tCardTypeCd_ExpAddrFinal = CardTypeCd_dcPIRecord,\n\t\tCardHolderNamePrefix_ExpAddrFinal = CardHolderNamePrefix_dcCustExpanded,\n\t\tCardHolderFirstName_ExpAddrFinal = CardHolderFirstName_dcCustExpanded,\n\t\tCardHolderMiddleName_ExpAddrFinal = CardHolderMiddleName_dcCustExpanded,\n\t\tCardHolderLastName_ExpAddrFinal = CardHolderLastName_dcCustExpanded,\n\t\tCardHolderNameSuffix_ExpAddrFinal = CardHolderNameSuffix_dcCustExpanded,\n\t\tSocialSecurityNum_ExpAddrFinal = SocialSecurityNum_SelectAltCustIdentification,\n\t\tCustomerControlId_ExpAddrFinal = CustomerControlId_SelectAltCustIdentification,\n\t\tMothersMadenName_ExpAddrFinal = MothersMadenName_dcCustExpanded,\n\t\tBirthDate_ExpAddrFinal = BirthDate_dcCustExpanded,\n\t\tDeceasedCd_ExpAddrFinal = DeceasedCd_CustExpanded,\n\t\tAddress1LineOne_ExpAddrFinal = Address1LineOne_SelectExpAddrAll,\n\t\tAddress1LineTwo_ExpAddrFinal = Address1LineTwo_SelectExpAddrAll,\n\t\tAddress1City_ExpAddrFinal = Address1City_SelectExpAddrAll,\n\t\tAddress1State_ExpAddrFinal = Address1State_SelectExpAddrAll,\n\t\tAddress1ZipCode_ExpAddrFinal = Address1ZipCode_SelectExpAddrAll,\n\t\tAddress1CountryAlpha3_ExpAddrFinal = Address1CountryAlpha3_SelectExpAddrAll,\n\t\tAddress1CountryNumeric_ExpAddrFinal = Address1CountryNumeric_SelectExpAddrAll,\n\t\tAddressSource_ExpAddrFinal = AddressSource_dcAddressExpAddr,\n\t\tCardHolderSexCd_ExpAddrFinal = CardHolderSexCd_dcCustExpanded,\n\t\tHomePhone_ExpAddrFinal = dc_HomeNum,\n\t\tBusinessPhone_ExpAddrFinal = dc_BusinessNum,\n\t\tTransitRoutingNum_ExpAddrFinal = TransitRoutingNum_dcBaseData,\n\t\tCheckingAccountNum_ExpAddrFinal = CheckingAccountNum_SelectBalanceStatusAll,\n\t\tSavingsAccountNum_ExpAddrFinal = SavingsAccountNum_SelectBalanceStatusAll,\n\t\tAccountSystemEntryDate_ExpAddrFinal = AccountSystemEntryDate_dcPIRecord,\n\t\tExpirationDate_ExpAddrFinal = ExpirationDate_dcPIRecord,\n\t\tCardsIssuedCnt_ExpAddrFinal = CardsIssuedCnt_SelectBalanceStatusAll,\n\t\tStatementCycleCd_ExpAddrFinal = StatementCycleCd_SelectBalanceStatusAll,\n\t\tCrossReferenceAccountNum1_ExpAddrFinal = CrossReferenceAccountNumOne_SelectBalanceStatusAll,\n\t\tCrossReferenceAccountNum2_ExpAddrFinal = CrossReferenceAccountNumTwo_SelectBalanceStatusAll,\n\t\tCrossReferenceAccountNum3_ExpAddrFinal = CrossReferenceAccountNumThree_SelectBalanceStatusAll,\n\t\tPlatform = CardPlatform,\n\t\tAccountBalance_ExpAddrFinal = AccountBalance_SelectBalanceStatusAll,\n\t\tExternalStatus_ExpAddrFinal = ExternalStatus_SelectBalanceStatusAll,\n\t\tInternalStatus_ExpAddrFinal = InternalStatus_SelectBalanceStatusAll,\n\t\tCardStatus_ExpAddrFinal = CardStatus_dcPIStatus,\n\t\tCardStatusChangeDate_ExpAddrFinal = CardStatusChangeDate_dcPIStatus,\n\t\tCreditBureauRptCode_ExpAddrFinal = CreditBureauRptCode_CustRole,\n\t\tDoNotSolicitInd_ExpAddrFinal = {DoNotSolicitInd _dcCustExpanded},\n\t\tSpaSystemBank_ExpAddrFinal = SpaSystemBank_PIStatus,\n\t\tSpaPrincipalBank_ExpAddrFinal = SpaPrincipalBank_PIStatus,\n\t\tSpaAgentBank_ExpAddrFinal = SpaAgentBank_PIStatus,\n\t\tSourceId_ExpAddrFinal = SourceId_dcPIRecord,\n\t\tALTC_OUT_EXTR_ID,\n\t\tReportDate_ExpAddrFinal = ReportDate_SelectPIRecord,\n\t\tCreateDate_ExpAddrFinal = CreateDate_dcPIRecord,\n\t\tMobilePhone = dc_MoblieNum,\n\t\tCardProgram = CardPlatform,\n\t\tSeparateEntityFlag\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> ExpAddrFinal\nlojPIStatus, SelectExpAddrAll join(AccountNum_PIRecord == AccountNum_SelectExpAddrAll\n\t&& CardHolder_Type_Cd_PIRecord == CardHolder_Type_Cd_SelectExpAddrAll\n\t&& CardHolderPositionCd_PIRecord == CardHolderPositionCd_SelectExpAddrAll,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> ijExpAddr\nNotExistsExpAddrPrimary filter(not(CardHolder_Type_Cd_PIRecord == '01' && CardHolderPositionCd_PIRecord == '001')) ~> FilterNoAddr\ndcAddressNoAddr select(mapColumn(\n\t\tClientNum_NoAddr = ClientNum_CustExpanded,\n\t\tAccountNum_NoAddr = AccountNum_PIRecord,\n\t\tCardHolder_Type_Cd_NoAddr = CardHolder_Type_Cd_PIRecord,\n\t\tCardHolderPositionCd_NoAddr = CardHolderPositionCd_PIRecord,\n\t\tCardNum_NoAddr = CardNum_PIRecord,\n\t\tCardTypeCd_NoAddr = CardTypeCd_dcPIRecord,\n\t\tCardHolderNamePrefix_NoAddr = CardHolderNamePrefix_dcCustExpanded,\n\t\tCardHolderFirstName_NoAddr = CardHolderFirstName_dcCustExpanded,\n\t\tCardHolderMiddleName_NoAddr = CardHolderMiddleName_dcCustExpanded,\n\t\tCardHolderLastName_NoAddr = CardHolderLastName_dcCustExpanded,\n\t\tCardHolderNameSuffix_NoAddr = CardHolderNameSuffix_dcCustExpanded,\n\t\tSocialSecurityNum_NoAddr = SocialSecurityNum_SelectAltCustIdentification,\n\t\tCustomerControlId_NoAddr = CustomerControlId_SelectAltCustIdentification,\n\t\tMothersMadenName_NoAddr = MothersMadenName_dcCustExpanded,\n\t\tBirthDate_NoAddr = BirthDate_dcCustExpanded,\n\t\tDeceasedCd_NoAddr = DeceasedCd_CustExpanded,\n\t\tAddressSource_NoAddr = AddressSource_dcAddressNoAddr,\n\t\tCardHolderSexCd_NoAddr = CardHolderSexCd_CustExpanded,\n\t\tHomePhone_NoAddr = dc_HomeNum,\n\t\tBusinessPhone_NoAddr = dc_BusinessNum,\n\t\tTransitRoutingNum_NoAddr = TransitRoutingNum_dcBaseData,\n\t\tCheckingAccountNum_NoAddr = CheckingAccountNum_SelectBalanceStatusAll,\n\t\tSavingsAccountNum_NoAddr = SavingsAccountNum_SelectBalanceStatusAll,\n\t\tAccountSystemEntryDate_NoAddr = AccountSystemEntryDate_dcPIRecord,\n\t\tExpirationDate_NoAddr = ExpirationDate_dcPIRecord,\n\t\tCardsIssuedCnt_NoAddr = CardsIssuedCnt_SelectBalanceStatusAll,\n\t\tStatementCycleCd_NoAddr = StatementCycleCd_SelectBalanceStatusAll,\n\t\tCrossReferenceAccountNum1_NoAddr = CrossReferenceAccountNumOne_SelectBalanceStatusAll,\n\t\tCrossReferenceAccountNum2_NoAddr = CrossReferenceAccountNumTwo_SelectBalanceStatusAll,\n\t\tCrossReferenceAccountNum3_NoAddr = CrossReferenceAccountNumThree_SelectBalanceStatusAll,\n\t\tAccountBalance_NoAddr = AccountBalance_SelectBalanceStatusAll,\n\t\tExternalStatus_NoAddr = ExternalStatus_SelectBalanceStatusAll,\n\t\tInternalStatus_NoAddr = InternalStatus_SelectBalanceStatusAll,\n\t\tCardStatus_NoAddr = CardStatus_dcPIStatus,\n\t\tCardStatusChangeDate_NoAddr = CardStatusChangeDate_dcPIStatus,\n\t\tCreditBureauRptCode_NoAddr = CreditBureauRptCode_CustRole,\n\t\tDoNotSolicitInd_NoAddr = {DoNotSolicitInd _dcCustExpanded},\n\t\tSpaSystemBank_NoAddr = SpaSystemBank_PIStatus,\n\t\tSpaPrincipalBank_NoAddr = SpaPrincipalBank_PIStatus,\n\t\tSpaAgentBank_NoAddr = SpaAgentBank_PIStatus,\n\t\tSourceId_NoAddr = SourceId_dcPIRecord,\n\t\tALTC_OUT_EXTR_ID,\n\t\tReportDate_NoAddr = ReportDate_SelectPIRecord,\n\t\tCreateDate_NoAddr = CreateDate_dcPIRecord,\n\t\tMobilePhone = dc_MoblieNum,\n\t\tCardProgram = CardPlatform,\n\t\tSeperateEntityId = SeparateEntityFlag\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> NoAddr\nSelectCustExpanded derive(CardHolderNamePrefix_dcCustExpanded = case(abs(locate(',', CardHolderNamePrefix_CustExpanded,1)) != 0, substring(CardHolderNamePrefix_CustExpanded, 1, abs(locate(',', CardHolderNamePrefix_CustExpanded,1)) -1)),\n\t\tCardHolderFirstName_dcCustExpanded = iif(like(CardHolderName_CustExpanded,'%,%')==true(),case(locate(' ', replace(trim(CardHolderName_CustExpanded),', ',','),locate(',', replace(trim(CardHolderName_CustExpanded),', ',','))) == 0,\r\n\ttrim(substring(trim(CardHolderName_CustExpanded), locate(',',replace(trim(CardHolderName_CustExpanded),', ',','))+1, length(CardHolderName_CustExpanded)-locate(',',replace(CardHolderName_CustExpanded,', ',',')))),\r\n    substring(CardHolderName_CustExpanded, locate(',',replace(CardHolderName_CustExpanded,', ',','))+1, locate(' ',trim(CardHolderName_CustExpanded), locate(',',replace(CardHolderName_CustExpanded,', ',',')))-locate(',',replace(CardHolderName_CustExpanded,', ',','))-1))\t,toString(null())),\n\t\tCardHolderMiddleName_dcCustExpanded = case(locate(' ', replace(CardHolderName_CustExpanded, ', ', ','), locate(',', replace(CardHolderName_CustExpanded, ', ', ','))) == 0,\r\n    toString(''),\r\n    left(substring(replace(CardHolderName_CustExpanded, ', ', ','), locate(' ', replace(CardHolderName_CustExpanded, ', ', ','), locate(',', replace(CardHolderName_CustExpanded, ', ', ',')))), 18)),\n\t\tCardHolderLastName_dcCustExpanded = case(locate(',',CardHolderName_CustExpanded) == 0, iifNull(CardHolderName_CustExpanded,'Unknown') , iif(left(CardHolderName_CustExpanded, abs(locate(',',replace(CardHolderName_CustExpanded, ', ', ',') )-1)) == 'NULL', 'Unknown',left(CardHolderName_CustExpanded, abs(locate(',',replace(CardHolderName_CustExpanded, ', ', ',') )-1)))),\n\t\tCardHolderNameSuffix_dcCustExpanded = case(abs(locate(',', CardHolderNameSuffix_CustExpanded,1)) != 0, substring(CardHolderNameSuffix_CustExpanded, 1, abs(locate(',', CardHolderNameSuffix_CustExpanded,1)) -1)),\n\t\tBirthDate_dcCustExpanded = case(substring(BirthDate_CustExpanded,5,4) == '0001' || substring(BirthDate_CustExpanded,5,4) == '0000', toDate(''), toDate(substring(BirthDate_CustExpanded,5,4)+'-'+substring(BirthDate_CustExpanded,1,2)+'-'+substring(BirthDate_CustExpanded,3,2),'yyyy-MM-dd')),\n\t\tCardHolderSexCd_dcCustExpanded = iif(CardHolderSexCd_CustExpanded == 'C', 'M', CardHolderSexCd_CustExpanded),\n\t\t{DoNotSolicitInd _dcCustExpanded} = toBoolean(case(length(DoNotSolicitInd_CustExpanded) == 0, '0', '1')),\n\t\tMothersMadenName_dcCustExpanded = case(MothersMadenName_CustExpanded == '', toString(null()), MothersMadenName_CustExpanded)) ~> dcCustExpanded\ndcExpAddr, SelectCountryAll lookup(Address1CountryAlpha3_dcExpAddr == Alpha3Code_SelectCountryAll,\n\tmultiple: false,\n\tpickup: 'any',\n\tbroadcast: 'auto')~> LookupExpAddrCountry\nsrcCountryCode select(mapColumn(\n\t\tAlpha2Code_SelectCountry = Alpha2Code,\n\t\tAlpha3Code_SelectCountry = Alpha3Code,\n\t\tNumericCode_SelectCountry = NumericCode,\n\t\tDialCode_SelectCountry = DialCode\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectCountry\nSelectCountry derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',toString($$),toString(null()))))) ~> trimBlankSpaceCountry\nijCountrySubdivision derive(NumericCode_dcCountrySubdivision = toShort(NumericCode_SelectCountry)) ~> dcCountrySubdivision\ndcBalanceStatus, SelectCountryAll lookup(Address1State_BalanceStatus == Subdivision_SelectCountryAll,\n\tmultiple: false,\n\tpickup: 'any',\n\tbroadcast: 'auto')~> LookupSubdivisionBalanceStatus\nSelectSubdivision derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',toString($$),toString(null()))))) ~> trimBlankSpaceSubdivision\nsrcCountryCodeSubdivision select(mapColumn(\n\t\tAlpha2Code_SelectSubdivision = Alpha2Code,\n\t\tAlpha2Code_Subdivision_SelectSubdivision = {3166_2code},\n\t\tSubdivision_SelectSubdivision = Subdivision\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectSubdivision\ntrimBlankSpaceCountry, trimBlankSpaceSubdivision join(Alpha2Code_SelectCountry == Alpha2Code_SelectSubdivision,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> ijCountrySubdivision\ndcCountrySubdivision select(mapColumn(\n\t\tAlpha2Code_SelectCountryAll = Alpha2Code_SelectCountry,\n\t\tAlpha3Code_SelectCountryAll = Alpha3Code_SelectCountry,\n\t\tNumericCode_SelectCountryAll = NumericCode_dcCountrySubdivision,\n\t\tDialCode_SelectCountryAll = DialCode_SelectCountry,\n\t\tAlpha2Code_Subdivision_SelectCountryAll = Alpha2Code_Subdivision_SelectSubdivision,\n\t\tSubdivision_SelectCountryAll = Subdivision_SelectSubdivision\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectCountryAll\nLookupExpAddrCountry select(mapColumn(\n\t\tExpAddr_ID_SelectExpAddrAll = ExpAddr_ID_ExpAddr,\n\t\tAccountNum_SelectExpAddrAll = AccountNum_ExpAddr,\n\t\tCardHolder_Type_Cd_SelectExpAddrAll = CardHolder_Type_Cd_ExpAddr,\n\t\tCardHolderPositionCd_SelectExpAddrAll = CardHolderPositionCd_ExpAddr,\n\t\tAddress1LineOne_SelectExpAddrAll = Address1LineOne_ExpAddr,\n\t\tAddress1LineTwo_SelectExpAddrAll = Address1LineTwo_dcExpAddr,\n\t\tAddress1City_SelectExpAddrAll = Address1City_ExpAddr,\n\t\tAddress1State_SelectExpAddrAll = Address1State_ExpAddr,\n\t\tAddress1ZipCode_SelectExpAddrAll = Address1ZipCode_ExpAddr,\n\t\tAddress1CountryAlpha3_SelectExpAddrAll = Address1CountryAlpha3_dcExpAddr,\n\t\tAddress1CountryNumeric_SelectExpAddrAll = NumericCode_SelectCountryAll,\n\t\tReportDate_SelectExpAddrAll = ReportDate_ExpAddr,\n\t\tDialCode_SelectExpAddrAll = DialCode_SelectCountryAll,\n\t\tAlpha2Code_Subdivision_SelectExpAddrAll = Alpha2Code_Subdivision_SelectCountryAll\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectExpAddrAll\nLookupSubdivisionBalanceStatus select(mapColumn(\n\t\tBalanceStatus_ID_SelectBalanceStatusAll = BalanceStatus_ID_BalanceStatus,\n\t\tAccountNum_SelectBalanceStatusAll = AccountNum_BalanceStatus,\n\t\tCardsIssuedCnt_SelectBalanceStatusAll = CardsIssuedCnt_BalanceStatus,\n\t\tAddress1LineOne_SelectBalanceStatusAll = Address1LineOne_BalanceStatus,\n\t\tAddress1LineTwo_SelectBalanceStatusAll = Address1LineTwo_BalanceStatus,\n\t\tAddress1City_SelectBalanceStatusAll = Address1City_BalanceStatus,\n\t\tAddress1State_SelectBalanceStatusAll = Address1State_BalanceStatus,\n\t\tAddress1ZipCode_SelectBalanceStatusAll = Address1ZipCode_BalanceStatus,\n\t\tStatementCycleCd_SelectBalanceStatusAll = StatementCycleCd_BalanceStatus,\n\t\tExternalStatus_SelectBalanceStatusAll = ExternalStatus_BalanceStatus,\n\t\tInternalStatus_SelectBalanceStatusAll = InternalStatus_BalanceStatus,\n\t\tHomePhone_SelectBalanceStatusAll = HomePhone_dcBalanceStatus,\n\t\tBusinessPhone_SelectBalanceStatusAll = BusinessPhone_dcBalanceStatus,\n\t\tCheckingAccountNum_SelectBalanceStatusAll = CheckingAccountNum_BalanceStatus,\n\t\tSavingsAccountNum_SelectBalanceStatusAll = SavingsAccountNum_BalanceStatus,\n\t\tAccountBalance_SelectBalanceStatusAll = AccountBalance_BalanceStatus,\n\t\tReportDate_SelectBalanceStatusAll = ReportDate_BalanceStatus,\n\t\tHomePhone_SelectBalanceStatusAll = HomePhone_dcBalanceStatus,\n\t\tBusinessPhone_SelectBalanceStatusAll = BusinessPhone_dcBalanceStatus,\n\t\tCrossReferenceAccountNumOne_SelectBalanceStatusAll = CrossReferenceAccountNumOne__dcBalanceStatus,\n\t\tCrossReferenceAccountNumTwo_SelectBalanceStatusAll = CrossReferenceAccountNumTwo__dcBalanceStatus,\n\t\tCrossReferenceAccountNumThree_SelectBalanceStatusAll = CrossReferenceAccountNumThree__dcBalanceStatus,\n\t\tAlpha2Code_SelectBalanceStatusAll = Alpha2Code_SelectCountryAll,\n\t\tAddress1CountryAlpha3_SelectBalanceStatusAll = Alpha3Code_SelectCountryAll,\n\t\tAddress1CountryNumeric_SelectBalanceStatusAll = NumericCode_SelectCountryAll,\n\t\tDialCode_SelectBalanceStatusAll = DialCode_SelectCountryAll,\n\t\tAlpha2Code_Subdivision_SelectBalanceStatusAll = Alpha2Code_Subdivision_SelectCountryAll,\n\t\tSYS_BANK,\n\t\tPRIN_BANK,\n\t\tAGENT_BANK\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectBalanceStatusAll\ntrimBlankSpacesBalanceStatus filter(BalanceStatus_ID_BalanceStatus != 'BalanceStatus_Daily_ArchiveID') ~> FilterOutHeadingsIfExists\nijExpAddr derive(AddressSource_dcAddressExpAddr = 'ExpAddr') ~> dcAddressExpAddr\nFilterNoAddr derive(AddressSource_dcAddressNoAddr = 'NoAddr') ~> dcAddressNoAddr\nFilterBASTAddrPrimaryOnly derive(AddressSource_dcAddressBAST = 'BalanceStatus') ~> dcAddressBAST\ntrimBlankSpaceBaseData select(mapColumn(\n\t\tBaseDataID,\n\t\tCHD_ACCOUNT_NUMBER = {      CHD_ACCOUNT_NUMBER},\n\t\tTransitRoutingNum = {      CHD_TRANSIT_ROUTING_NO},\n\t\tReportDate = {      ReportDate}\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectBaseData\nSelectBaseData derive(TransitRoutingNum_dcBaseData = iif(TransitRoutingNum == '0', toString(null()), TransitRoutingNum)) ~> dcBaseData\nijCustExpanded, FilterNullRoutingNum join(AccountNum_PIRecord == CHD_ACCOUNT_NUMBER,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> lojBaseData\nsrcEmail derive(CreateDate_dcEmail = currentUTC()) ~> dcEmail\ntrimBlankSpaceCustRole select(mapColumn(\n\t\tCustRole_ID_CustRole = CustRole_ID,\n\t\tCURL_OUT_KEY_ACCT_NO_CustRole = CURL_OUT_KEY_ACCT_NO,\n\t\tCURL_TYPE_CD_CustRole = CURL_TYPE_CD,\n\t\tCURL_MMBR_SQNC_NR_CustRole = CURL_MMBR_SQNC_NR,\n\t\tCreditBureauRptCode_CustRole = CURL_OUT_CRBR_RPRT_CD,\n\t\treportDate_CustRole = reportDate,\n\t\tDBI_CLIENT_NUMBER_CustRole = DBI_CLIENT_NUMBER\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectCustRole\nsrcCustRole derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null()))))) ~> trimBlankSpaceCustRole\nlojAltCustIdentification, SelectCustRole join(AccountNum_PIRecord == CURL_OUT_KEY_ACCT_NO_CustRole\n\t&& CardHolder_Type_Cd_PIRecord == CURL_TYPE_CD_CustRole\n\t&& CardHolderPositionCd_PIRecord == CURL_MMBR_SQNC_NR_CustRole,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> lojCustRole\ntrimBlankSpacesAltCustIdentification derive(SocialSecurityNum_dcAltCustIdentification = case(ALTC_OUT_ID_TYPE_CD == '07', ALTC_OUT_ALTR_CUST_ID, toString(null())),\n\t\tCustomerControlId_dcAltCustIdentification = case(ALTC_OUT_ID_TYPE_CD == '01', ALTC_OUT_ALTR_CUST_ID, toString(null()))) ~> dcAltCustIdentification\ndcAltCustIdentification aggregate(groupBy(ALTC_OUT_KEY_ACCT_NO,\n\t\tALTC_OUT_EXTR_ID,\n\t\tALTC_TYPE_CD,\n\t\tALTC_MMBR_SQNC_NR),\n\tSocialSecurityNum_dcAltCustIdentification = first(SocialSecurityNum_dcAltCustIdentification,true()),\n\t\tCustomerControlId_dcAltCustIdentification = first(CustomerControlId_dcAltCustIdentification,true()),\n\t\treportDate = first(reportDate,true())) ~> DistinctValues\nFilterOutHeaders derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null()))))) ~> trimBlankSpaceBaseData\nFilterOutHeadings derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null()))))) ~> trimBlankSpacesCustExpanded\nsrcPIStatus derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null()))))) ~> trimBlankSpacesPIStatus\nsrcPhone filter(trim(PHON_OUT_CMNC_TYPE_CD) == \"MB\" || trim(PHON_OUT_CMNC_TYPE_CD) == \"BS\" || trim(PHON_OUT_CMNC_TYPE_CD) == \"HM\") ~> FilterMobilePhoneOnly\nFilterMobilePhoneOnly select(mapColumn(\n\t\tPhone_ID,\n\t\tPHON_GROUP_ID,\n\t\tPHON_OUT_KEY_SYS_BANK,\n\t\tPHON_OUT_KEY_PRIN_BANK,\n\t\tPHON_OUT_KEY_AGENT_BANK,\n\t\tPHON_OUT_KEY_ACCT_NO,\n\t\tPHON_TYPE_CD,\n\t\tPHON_MMBR_SQNC_NR,\n\t\tPHON_OUT_EXTR_ID,\n\t\tPHON_OUT_CMNC_TYPE_CD,\n\t\tPHON_OUT_CMNC_TX,\n\t\tPHON_OUT_CNTC_PRHB_CD,\n\t\treportDate,\n\t\tdateProcessed,\n\t\tFDR_DATE_PROCESSED,\n\t\tPHON_OUT_TYPE_CD,\n\t\tPHON_OUT_UPDT_DT,\n\t\tDBI_CLIENT_NUMBER\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectPhone\nSelectPhone derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null())))),\n\t\tdc_BusinessNum = case(trim(PHON_OUT_CMNC_TYPE_CD) == 'BS',PHON_OUT_CMNC_TX, toString (null())),\n\t\tdc_HomeNum = case(trim(PHON_OUT_CMNC_TYPE_CD) == 'HM',PHON_OUT_CMNC_TX,toString (null())),\n\t\tdc_MoblieNum = case(trim(PHON_OUT_CMNC_TYPE_CD) == 'MB',PHON_OUT_CMNC_TX,toString (null()))) ~> trimBlankSpacePhone\nlojCustRole, AggregatePhone join(AccountNum_PIRecord == PHON_OUT_KEY_ACCT_NO\n\t&& CardHolder_Type_Cd_PIRecord == PHON_TYPE_CD\n\t&& CardHolderPositionCd_PIRecord == PHON_MMBR_SQNC_NR,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> lojPhone\nsrcBaseData filter(BaseDataID!='BaseDataID') ~> FilterOutHeaders\nExpAddrFinal aggregate(groupBy(AccountNum_ExpAddrFinal,\n\t\tCardNum_ExpAddrFinal,\n\t\tCardHolder_Type_Cd_ExpAddrFinal,\n\t\tCardHolderPositionCd_ExpAddrFinal),\n\teach(match(name!='CardNum_ExpAddrFinal'&&name!='AccountNum_ExpAddrFinal'&&name!='CardHolder_Type_Cd_ExpAddrFinal'&&name!='CardHolderPositionCd_ExpAddrFinal'), $$ = first ($$)),\n\t\tCount = max(CreateDate_ExpAddrFinal)) ~> RemoveDuplicates\nNoAddr aggregate(groupBy(AccountNum_NoAddr,\n\t\tCardNum_NoAddr,\n\t\tCardHolder_Type_Cd_NoAddr,\n\t\tCardHolderPositionCd_NoAddr),\n\teach(match(name!='AccountNum_NoAddr'&&name!='CardHolder_Type_Cd_NoAddr'&&name!='CardHolderPositionCd_NoAddr'&&name!='CardNum_NoAddr'), $$ = first ($$))) ~> RemoveDuplicatesNoAddr\nBASTAddrPrimaryOnly aggregate(groupBy(AccountNum_BASTAddrPrimary,\n\t\tCardNum_BASTAddrPrimary,\n\t\tCardHolder_Type_Cd_BASTAddrPrimary,\n\t\tCardHolderPositionCd_BASTAddrPrimary),\n\teach(match(name!='CardNum_BASTAddrPrimary'&&name!='AccountNum_BASTAddrPrimary'&&name!='CardHolder_Type_Cd_BASTAddrPrimary'&&name!='CardHolderPositionCd_BASTAddrPrimary'), $$ = first ($$))) ~> RemoveDuplicatesBAST\ntrimBlankSpacesPIRecord, trimCCUMSTR join(PINS_OUT_KEY_SYS_BANK == sys\n\t&& PINS_OUT_KEY_PRIN_BANK == prin\n\t&& PINS_OUT_KEY_AGENT_BANK == agent,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> lojCCUMSTR\nDerivedPlatformdc select(mapColumn(\n\t\tsys,\n\t\tprin,\n\t\tagent,\n\t\tcardtyp,\n\t\tPlatform = Platform_dc,\n\t\tSeparateEntityFlag\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectCCUMSTR\nSort1 derive(each(match(type==\"string\"), $$ = trim(iif(toString($$)!='NULL',$$,toString(null()))))) ~> trimCCUMSTR\nSelectCCUMSTR sort(asc(sys, true),\n\tasc(prin, true),\n\tasc(agent, true),\n\tcaseInsensitive: true) ~> Sort1\ndcBaseData filter(TransitRoutingNum_dcBaseData== '') ~> FilterNullRoutingNum\nsrcCCUMSTR derive(Platform_dc = case(Platform=='C','Credit',case(Platform=='D','Debit'))) ~> DerivedPlatformdc\ntrimBlankSpacePhone aggregate(groupBy(PHON_OUT_KEY_ACCT_NO,\n\t\tPHON_TYPE_CD,\n\t\tPHON_MMBR_SQNC_NR),\n\tdc_BusinessNum = min(dc_BusinessNum),\n\t\tdc_HomeNum = min(dc_HomeNum),\n\t\tdc_MoblieNum = min(dc_MoblieNum)) ~> AggregatePhone\ndwDimBin, dwDimClient join(dw_clientkey == client_key,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'off')~> ijClient\nijClient select(mapColumn(\n\t\tdw_binkey,\n\t\tdw_clientkey,\n\t\tbankIdentificationNumberISO,\n\t\tbankIdentificationNumberEXT,\n\t\tclient_number\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectBinClient\ndistinctAccounts, SelectBinClient join(left(CUEX_OUT_KEY_ACCT_NO,6) == left(bankIdentificationNumberEXT,6) && like (CUEX_OUT_KEY_ACCT_NO, bankIdentificationNumberEXT+'%'),\n\tjoinType:'cross',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'off')~> cjBinClient\ntrimBlankSpacesCustExpanded select(mapColumn(\n\t\tCustExpanded_ID,\n\t\tCUEX_GROUP_ID,\n\t\tCUEX_OUT_KEY_SYS_BANK,\n\t\tCUEX_OUT_KEY_PRIN_BANK,\n\t\tCUEX_OUT_KEY_AGENT_BANK,\n\t\tCUEX_OUT_KEY_ACCT_NO,\n\t\tCUEX_TYPE_CD,\n\t\tCUEX_MMBR_SQNC_NR,\n\t\tCUEX_OUT_EXTR_ID,\n\t\tCUEX_OUT_CUST_NM,\n\t\tCUEX_OUT_SLLT_SEX_CD,\n\t\tCUEX_OUT_DCSD_CD,\n\t\tCUEX_OUT_BRTH_DT,\n\t\tCUEX_OUT_SLCT_CD,\n\t\tCUEX_OUT_CLNT_EMPL_CD,\n\t\tCUEX_OUT_MTHR_MADN_NM,\n\t\tCUEX_OUT_SFFX_CD,\n\t\tCUEX_OUT_PRFX_TX,\n\t\tCUEX_OUT_FRST_NM,\n\t\tCUEX_OUT_LAST_NM,\n\t\tCUEX_OUT_MDDL_NM,\n\t\tCUEX_OUT_QLFC_TX,\n\t\tCUEX_OUT_TITL_TX,\n\t\tCUEX_OUT_NAME_SQNC_CD,\n\t\tCUEX_OUT_CMBN_IN,\n\t\tCUEX_OUT_LAST_NNMN_SORC_TX,\n\t\tCUEX_OUT_LAST_NNMN_CD,\n\t\tCUEX_OUT_LAST_NNMN_DT,\n\t\tCUEX_OUT_LAST_NNMN_TM,\n\t\treportDate,\n\t\tdateProcessed,\n\t\tFDR_DATE_PROCESSED,\n\t\tDBI_CLIENT_NUMBER\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectTrimCustExpanded\ncjBinClient window(over(CUEX_OUT_KEY_ACCT_NO),\n\tdesc(bankIdentificationNumberEXT, true),\n\trow_num = rowNumber()) ~> windowClientBin\nwindowClientBin filter(row_num==1) ~> filterClientBin\nscrCustExpanded filter(CustExpanded_ID != 'CustExpanded_ID') ~> FilterOutHeadings\nSelectTrimCustExpanded, selectBinClientCustExpanded join(CUEX_OUT_KEY_ACCT_NO == ClientBin_CUEX_OUT_KEY_ACCT_NO,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> ljBinClientCustExpanded\nSelectTrimCustExpanded aggregate(groupBy(CUEX_OUT_KEY_ACCT_NO),\n\tcount = count()) ~> distinctAccounts\nfilterClientBin select(mapColumn(\n\t\tClientBin_CUEX_OUT_KEY_ACCT_NO = CUEX_OUT_KEY_ACCT_NO,\n\t\tclient_number\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> selectBinClientCustExpanded\nRemoveDuplicatesBAST sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tCardHolderId as long,\n\t\tClientNum as string,\n\t\tAccountNum as string,\n\t\tCardHolder_Type_Cd as string,\n\t\tCardHolderPositionCd as string,\n\t\tCardNum as string,\n\t\tCardTypeCd as string,\n\t\tCardProgram as string,\n\t\tSeperateEntityInd as boolean,\n\t\tPersonUniqueId as integer,\n\t\tCardHolderNamePrefix as string,\n\t\tCardHolderFirstName as string,\n\t\tCardHolderMiddleName as string,\n\t\tCardHolderLastName as string,\n\t\tCardHolderNameSuffix as string,\n\t\tSocialSecurityNum as string,\n\t\tCustomerControlId as string,\n\t\tMothersMadenName as string,\n\t\tBirthDate as date,\n\t\tDeceasedCd as string,\n\t\tAddress1LineOne as string,\n\t\tAddress1LineTwo as string,\n\t\tAddress1City as string,\n\t\tAddress1State as string,\n\t\tAddress1ZipCode as string,\n\t\tAddress1CountryAlpha3 as string,\n\t\tAddress1CountryNumeric as integer,\n\t\tAddressSource as string,\n\t\tCardHolderSex as string,\n\t\tDriversLicenseNum as string,\n\t\tDriversLicenseState as string,\n\t\tHomePhone as string,\n\t\tBusinessPhone as string,\n\t\tMobilePhone as string,\n\t\tTransitRoutingNum as string,\n\t\tCheckingAccountNum as string,\n\t\tSavingsAccountNum as string,\n\t\tAccountSystemEntryDate as date,\n\t\tExpirationDate as date,\n\t\tCardsIssuedCnt as string,\n\t\tStatementCycleCd as string,\n\t\tCrossReferenceAccountNum1 as string,\n\t\tCrossReferenceAccountNum2 as string,\n\t\tCrossReferenceAccountNum3 as string,\n\t\tAccountBalance as decimal(19,4),\n\t\tExternalStatus as string,\n\t\tInternalStatus as string,\n\t\tCardStatus as string,\n\t\tCardStatusChangeDate as date,\n\t\tCreditBureauReportCode as string,\n\t\tDoNotSolicitInd as boolean,\n\t\tSpaSystemBank as string,\n\t\tSpaPrincipalBank as string,\n\t\tSpaAgentBank as string,\n\t\tSourceId as string,\n\t\tReportDate as date,\n\t\tCreateDate as timestamp,\n\t\tModifiedDate as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\ttruncate:true,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 2,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tClientNum = ClientNum_BASTAddrPrimary,\n\t\tAccountNum = AccountNum_BASTAddrPrimary,\n\t\tCardHolder_Type_Cd = CardHolder_Type_Cd_BASTAddrPrimary,\n\t\tCardHolderPositionCd = CardHolderPositionCd_BASTAddrPrimary,\n\t\tCardNum = CardNum_BASTAddrPrimary,\n\t\tCardTypeCd = CardTypeCd_BASTAddrPrimary,\n\t\tCardHolderNamePrefix = CardHolderNamePrefix_BASTAddrPrimary,\n\t\tCardHolderFirstName = CardHolderFirstName_BASTAddrPrimary,\n\t\tCardHolderMiddleName = CardHolderMiddleName_BASTAddrPrimary,\n\t\tCardHolderLastName = CardHolderLastName_BASTAddrPrimary,\n\t\tCardHolderNameSuffix = CardHolderNameSuffix_BASTAddrPrimary,\n\t\tSocialSecurityNum = SocialSecurityNum_BASTAddrPrimary,\n\t\tCustomerControlId = CustomerControlId_BASTAddrPrimary,\n\t\tMothersMadenName = MothersMadenName_BASTAddrPrimary,\n\t\tBirthDate = BirthDate_BASTAddrPrimary,\n\t\tDeceasedCd = DeceasedCd_BASTAddrPrimary,\n\t\tAddress1LineOne = Address1LineOne_BASTAddrPrimary,\n\t\tAddress1LineTwo = Address1LineTwo_BASTAddrPrimary,\n\t\tAddress1City = Address1City_BASTAddrPrimary,\n\t\tAddress1State = Address1State_BASTAddrPrimary,\n\t\tAddress1ZipCode = Address1ZipCode_BASTAddrPrimary,\n\t\tAddress1CountryAlpha3 = Address1CountryAlpha3_BASTAddrPrimary,\n\t\tAddress1CountryNumeric = Address1CountryNumeric_BASTAddrPrimary,\n\t\tAddressSource = AddressSource_BASTAddrPrimary,\n\t\tCardHolderSex = CardHolderSexCd_BASTAddrPrimary,\n\t\tHomePhone = HomePhone_BASTAddrPrimary,\n\t\tBusinessPhone = BusinessPhone_BASTAddrPrimary,\n\t\tTransitRoutingNum = TransitRoutingNum_BASTAddrPrimary,\n\t\tCheckingAccountNum = CheckingAccountNum_BASTAddrPrimary,\n\t\tSavingsAccountNum = SavingsAccountNum_BASTAddrPrimary,\n\t\tAccountSystemEntryDate = AccountSystemEntryDate_BASTAddrPrimary,\n\t\tExpirationDate = ExpirationDate_BASTAddrPrimary,\n\t\tCardsIssuedCnt = CardsIssuedCnt_BASTAddrPrimary,\n\t\tStatementCycleCd = StatementCycleCd_BASTAddrPrimary,\n\t\tCrossReferenceAccountNum1 = CrossReferenceAccountNum1_BASTAddrPrimary,\n\t\tCrossReferenceAccountNum2 = CrossReferenceAccountNum2_BASTAddrPrimary,\n\t\tCrossReferenceAccountNum3 = CrossReferenceAccountNum3_BASTAddrPrimary,\n\t\tAccountBalance = AccountBalance_BASTAddrPrimary,\n\t\tExternalStatus = ExternalStatus_BASTAddrPrimary,\n\t\tInternalStatus = InternalStatus_BASTAddrPrimary,\n\t\tCardStatus = CardStatus_BASTAddrPrimary,\n\t\tCardStatusChangeDate = CardStatusChangeDate_BASTAddrPrimary,\n\t\tCreditBureauReportCode = CreditBureauRptCode_BASTAddrPrimary,\n\t\tDoNotSolicitInd = DoNotSolicitInd_BASTAddrPrimary,\n\t\tSpaSystemBank = SpaSystemBank_BASTAddrPrimary,\n\t\tSpaPrincipalBank = SpaPrincipalBank_BASTAddrPrimary,\n\t\tSpaAgentBank = SpaAgentBank_BASTAddrPrimary,\n\t\tSourceId = SourceId_BASTAddrPrimary,\n\t\tSOURCE_MEMBER_ID = ALTC_OUT_EXTR_ID,\n\t\tReportDate = ReportDate_BASTAddrPrimary,\n\t\tCreateDate = CreateDate_BASTAddrPrimary,\n\t\tMobilePhone,\n\t\tCardProgram,\n\t\tSeperateEntityInd\n\t)) ~> snkCardHolderWithBASTAddr\nijEmail sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tCardHolderEmailId as long,\n\t\tAccountNum as string,\n\t\tCardHolder_Type_Cd as string,\n\t\tCardHolderPositionCd as string,\n\t\tEmailAddress as string,\n\t\tEmailAddressStatus as string,\n\t\tEmailUseTypeCd as string,\n\t\tReportDate as date,\n\t\tCreateDate as timestamp,\n\t\tModifiedDate as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\ttruncate:true,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 1,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tAccountNum = AccountNum_PIRecordEmail,\n\t\tCardHolder_Type_Cd = CardHolder_Type_Cd_PIRecordEmail,\n\t\tCardHolderPositionCd = CardHolderPositionCd_PIRecordEmail,\n\t\tEmailAddress = EmailAddress_Email,\n\t\tEmailAddressStatus = EmailAddressStatus_Email,\n\t\tEmailUseTypeCd = EmailUseTypeCd_Email,\n\t\tReportDate = ReportDate_Email,\n\t\tCreateDate = CreateDate_Email\n\t)) ~> snkMemberCardHolderEmail\nRemoveDuplicates sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tCardHolderId as long,\n\t\tClientNum as string,\n\t\tAccountNum as string,\n\t\tCardHolder_Type_Cd as string,\n\t\tCardHolderPositionCd as string,\n\t\tCardNum as string,\n\t\tCardTypeCd as string,\n\t\tCardProgram as string,\n\t\tSeperateEntityInd as boolean,\n\t\tPersonUniqueId as integer,\n\t\tCardHolderNamePrefix as string,\n\t\tCardHolderFirstName as string,\n\t\tCardHolderMiddleName as string,\n\t\tCardHolderLastName as string,\n\t\tCardHolderNameSuffix as string,\n\t\tSocialSecurityNum as string,\n\t\tCustomerControlId as string,\n\t\tMothersMadenName as string,\n\t\tBirthDate as date,\n\t\tDeceasedCd as string,\n\t\tAddress1LineOne as string,\n\t\tAddress1LineTwo as string,\n\t\tAddress1City as string,\n\t\tAddress1State as string,\n\t\tAddress1ZipCode as string,\n\t\tAddress1CountryAlpha3 as string,\n\t\tAddress1CountryNumeric as integer,\n\t\tAddressSource as string,\n\t\tCardHolderSex as string,\n\t\tDriversLicenseNum as string,\n\t\tDriversLicenseState as string,\n\t\tHomePhone as string,\n\t\tBusinessPhone as string,\n\t\tMobilePhone as string,\n\t\tTransitRoutingNum as string,\n\t\tCheckingAccountNum as string,\n\t\tSavingsAccountNum as string,\n\t\tAccountSystemEntryDate as date,\n\t\tExpirationDate as date,\n\t\tCardsIssuedCnt as string,\n\t\tStatementCycleCd as string,\n\t\tCrossReferenceAccountNum1 as string,\n\t\tCrossReferenceAccountNum2 as string,\n\t\tCrossReferenceAccountNum3 as string,\n\t\tAccountBalance as decimal(19,4),\n\t\tExternalStatus as string,\n\t\tInternalStatus as string,\n\t\tCardStatus as string,\n\t\tCardStatusChangeDate as date,\n\t\tCreditBureauReportCode as string,\n\t\tDoNotSolicitInd as boolean,\n\t\tSpaSystemBank as string,\n\t\tSpaPrincipalBank as string,\n\t\tSpaAgentBank as string,\n\t\tSourceId as string,\n\t\tReportDate as date,\n\t\tCreateDate as timestamp,\n\t\tModifiedDate as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 4,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tClientNum = ClientNum_ExpAddrFinal,\n\t\tAccountNum = AccountNum_ExpAddrFinal,\n\t\tCardHolder_Type_Cd = CardHolder_Type_Cd_ExpAddrFinal,\n\t\tCardHolderPositionCd = CardHolderPositionCd_ExpAddrFinal,\n\t\tCardNum = CardNum_ExpAddrFinal,\n\t\tCardProgram = Platform,\n\t\tCardTypeCd = CardTypeCd_ExpAddrFinal,\n\t\tCardHolderNamePrefix = CardHolderNamePrefix_ExpAddrFinal,\n\t\tCardHolderFirstName = CardHolderFirstName_ExpAddrFinal,\n\t\tCardHolderMiddleName = CardHolderMiddleName_ExpAddrFinal,\n\t\tCardHolderLastName = CardHolderLastName_ExpAddrFinal,\n\t\tCardHolderNameSuffix = CardHolderNameSuffix_ExpAddrFinal,\n\t\tSocialSecurityNum = SocialSecurityNum_ExpAddrFinal,\n\t\tCustomerControlId = CustomerControlId_ExpAddrFinal,\n\t\tMothersMadenName = MothersMadenName_ExpAddrFinal,\n\t\tBirthDate = BirthDate_ExpAddrFinal,\n\t\tDeceasedCd = DeceasedCd_ExpAddrFinal,\n\t\tAddress1LineOne = Address1LineOne_ExpAddrFinal,\n\t\tAddress1LineTwo = Address1LineTwo_ExpAddrFinal,\n\t\tAddress1City = Address1City_ExpAddrFinal,\n\t\tAddress1State = Address1State_ExpAddrFinal,\n\t\tAddress1ZipCode = Address1ZipCode_ExpAddrFinal,\n\t\tAddress1CountryAlpha3 = Address1CountryAlpha3_ExpAddrFinal,\n\t\tAddress1CountryNumeric = Address1CountryNumeric_ExpAddrFinal,\n\t\tAddressSource = AddressSource_ExpAddrFinal,\n\t\tCardHolderSex = CardHolderSexCd_ExpAddrFinal,\n\t\tHomePhone = HomePhone_ExpAddrFinal,\n\t\tBusinessPhone = BusinessPhone_ExpAddrFinal,\n\t\tTransitRoutingNum = TransitRoutingNum_ExpAddrFinal,\n\t\tCheckingAccountNum = CheckingAccountNum_ExpAddrFinal,\n\t\tSavingsAccountNum = SavingsAccountNum_ExpAddrFinal,\n\t\tAccountSystemEntryDate = AccountSystemEntryDate_ExpAddrFinal,\n\t\tExpirationDate = ExpirationDate_ExpAddrFinal,\n\t\tCardsIssuedCnt = CardsIssuedCnt_ExpAddrFinal,\n\t\tStatementCycleCd = StatementCycleCd_ExpAddrFinal,\n\t\tCrossReferenceAccountNum1 = CrossReferenceAccountNum1_ExpAddrFinal,\n\t\tCrossReferenceAccountNum2 = CrossReferenceAccountNum2_ExpAddrFinal,\n\t\tCrossReferenceAccountNum3 = CrossReferenceAccountNum3_ExpAddrFinal,\n\t\tAccountBalance = AccountBalance_ExpAddrFinal,\n\t\tExternalStatus = ExternalStatus_ExpAddrFinal,\n\t\tInternalStatus = InternalStatus_ExpAddrFinal,\n\t\tCardStatus = CardStatus_ExpAddrFinal,\n\t\tCardStatusChangeDate = CardStatusChangeDate_ExpAddrFinal,\n\t\tCreditBureauReportCode = CreditBureauRptCode_ExpAddrFinal,\n\t\tDoNotSolicitInd = DoNotSolicitInd_ExpAddrFinal,\n\t\tSpaSystemBank = SpaSystemBank_ExpAddrFinal,\n\t\tSpaPrincipalBank = SpaPrincipalBank_ExpAddrFinal,\n\t\tSpaAgentBank = SpaAgentBank_ExpAddrFinal,\n\t\tSourceId = SourceId_ExpAddrFinal,\n\t\tSOURCE_MEMBER_ID = ALTC_OUT_EXTR_ID,\n\t\tReportDate = ReportDate_ExpAddrFinal,\n\t\tCreateDate = CreateDate_ExpAddrFinal,\n\t\tMobilePhone,\n\t\tSeperateEntityInd = SeparateEntityFlag\n\t)) ~> snkCardHolderWithExpAddr\nRemoveDuplicatesNoAddr sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tCardHolderId as long,\n\t\tClientNum as string,\n\t\tAccountNum as string,\n\t\tCardHolder_Type_Cd as string,\n\t\tCardHolderPositionCd as string,\n\t\tCardNum as string,\n\t\tCardTypeCd as string,\n\t\tCardProgram as string,\n\t\tSeperateEntityInd as boolean,\n\t\tPersonUniqueId as integer,\n\t\tCardHolderNamePrefix as string,\n\t\tCardHolderFirstName as string,\n\t\tCardHolderMiddleName as string,\n\t\tCardHolderLastName as string,\n\t\tCardHolderNameSuffix as string,\n\t\tSocialSecurityNum as string,\n\t\tCustomerControlId as string,\n\t\tMothersMadenName as string,\n\t\tBirthDate as date,\n\t\tDeceasedCd as string,\n\t\tAddress1LineOne as string,\n\t\tAddress1LineTwo as string,\n\t\tAddress1City as string,\n\t\tAddress1State as string,\n\t\tAddress1ZipCode as string,\n\t\tAddress1CountryAlpha3 as string,\n\t\tAddress1CountryNumeric as integer,\n\t\tAddressSource as string,\n\t\tCardHolderSex as string,\n\t\tDriversLicenseNum as string,\n\t\tDriversLicenseState as string,\n\t\tHomePhone as string,\n\t\tBusinessPhone as string,\n\t\tMobilePhone as string,\n\t\tTransitRoutingNum as string,\n\t\tCheckingAccountNum as string,\n\t\tSavingsAccountNum as string,\n\t\tAccountSystemEntryDate as date,\n\t\tExpirationDate as date,\n\t\tCardsIssuedCnt as string,\n\t\tStatementCycleCd as string,\n\t\tCrossReferenceAccountNum1 as string,\n\t\tCrossReferenceAccountNum2 as string,\n\t\tCrossReferenceAccountNum3 as string,\n\t\tAccountBalance as decimal(19,4),\n\t\tExternalStatus as string,\n\t\tInternalStatus as string,\n\t\tCardStatus as string,\n\t\tCardStatusChangeDate as date,\n\t\tCreditBureauReportCode as string,\n\t\tDoNotSolicitInd as boolean,\n\t\tSpaSystemBank as string,\n\t\tSpaPrincipalBank as string,\n\t\tSpaAgentBank as string,\n\t\tSourceId as string,\n\t\tReportDate as date,\n\t\tCreateDate as timestamp,\n\t\tModifiedDate as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 3,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tClientNum = ClientNum_NoAddr,\n\t\tAccountNum = AccountNum_NoAddr,\n\t\tCardHolder_Type_Cd = CardHolder_Type_Cd_NoAddr,\n\t\tCardHolderPositionCd = CardHolderPositionCd_NoAddr,\n\t\tCardNum = CardNum_NoAddr,\n\t\tCardTypeCd = CardTypeCd_NoAddr,\n\t\tCardHolderNamePrefix = CardHolderNamePrefix_NoAddr,\n\t\tCardHolderFirstName = CardHolderFirstName_NoAddr,\n\t\tCardHolderMiddleName = CardHolderMiddleName_NoAddr,\n\t\tCardHolderLastName = CardHolderLastName_NoAddr,\n\t\tCardHolderNameSuffix = CardHolderNameSuffix_NoAddr,\n\t\tSocialSecurityNum = SocialSecurityNum_NoAddr,\n\t\tCustomerControlId = CustomerControlId_NoAddr,\n\t\tMothersMadenName = MothersMadenName_NoAddr,\n\t\tBirthDate = BirthDate_NoAddr,\n\t\tDeceasedCd = DeceasedCd_NoAddr,\n\t\tCardHolderSex = CardHolderSexCd_NoAddr,\n\t\tHomePhone = HomePhone_NoAddr,\n\t\tBusinessPhone = BusinessPhone_NoAddr,\n\t\tTransitRoutingNum = TransitRoutingNum_NoAddr,\n\t\tCheckingAccountNum = CheckingAccountNum_NoAddr,\n\t\tSavingsAccountNum = SavingsAccountNum_NoAddr,\n\t\tAccountSystemEntryDate = AccountSystemEntryDate_NoAddr,\n\t\tExpirationDate = ExpirationDate_NoAddr,\n\t\tCardsIssuedCnt = CardsIssuedCnt_NoAddr,\n\t\tStatementCycleCd = StatementCycleCd_NoAddr,\n\t\tCrossReferenceAccountNum1 = CrossReferenceAccountNum1_NoAddr,\n\t\tCrossReferenceAccountNum2 = CrossReferenceAccountNum2_NoAddr,\n\t\tCrossReferenceAccountNum3 = CrossReferenceAccountNum3_NoAddr,\n\t\tAccountBalance = AccountBalance_NoAddr,\n\t\tExternalStatus = ExternalStatus_NoAddr,\n\t\tInternalStatus = InternalStatus_NoAddr,\n\t\tCardStatus = CardStatus_NoAddr,\n\t\tCardStatusChangeDate = CardStatusChangeDate_NoAddr,\n\t\tCreditBureauReportCode = CreditBureauRptCode_NoAddr,\n\t\tDoNotSolicitInd = DoNotSolicitInd_NoAddr,\n\t\tSpaSystemBank = SpaSystemBank_NoAddr,\n\t\tSpaPrincipalBank = SpaPrincipalBank_NoAddr,\n\t\tSpaAgentBank = SpaAgentBank_NoAddr,\n\t\tSourceId = SourceId_NoAddr,\n\t\tSOURCE_MEMBER_ID = ALTC_OUT_EXTR_ID,\n\t\tReportDate = ReportDate_NoAddr,\n\t\tCreateDate = CreateDate_NoAddr,\n\t\tMobilePhone,\n\t\tCardProgram,\n\t\tSeperateEntityInd = SeperateEntityId\n\t)) ~> snkNoAddr"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/Rewards_Response')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "Rewards/DroptoDW"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "dropZoneTransactions_Rewards",
                                "type": "DatasetReference"
                            },
                            "name": "RewardsSource"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "DS_ASDW_rewards_member_response_raw",
                                "type": "DatasetReference"
                            },
                            "name": "ResponseDWRaw"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "AddingColumn"
                        }
                    ],
                    "script": "parameters{\n\tfileName as string\n}\nsource(output(\n\t\tColumn_1 as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> RewardsSource\nRewardsSource derive(File_name = $fileName) ~> AddingColumn\nAddingColumn sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tfilename as string,\n\t\tData_f as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tfilename = File_name,\n\t\tData_f = Column_1\n\t),\n\tpartitionBy('hash', 1)) ~> ResponseDWRaw"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/3DS_4140csv')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "dataflow for MessageLog 3DS request in csv format",
                "folder": {
                    "name": "3DS"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "src_3DSMessageLog",
                                "type": "DatasetReference"
                            },
                            "name": "MessageLog3DS4140"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "3DS4140_Output",
                                "type": "DatasetReference"
                            },
                            "name": "sinkOutboundfolder"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "Selectcolumns"
                        },
                        {
                            "name": "FilterConditions"
                        }
                    ],
                    "script": "source(output(\n\t\tMessageLogId as long,\n\t\tAPIName as string,\n\t\tInvocationTimestamp as timestamp,\n\t\tClientId as string,\n\t\tClientApplication as string,\n\t\tRequestPath as string,\n\t\tLogId as string,\n\t\tProcessorId as string,\n\t\tIssuerId as string,\n\t\tTransactionId as string,\n\t\tStepupRequestId as string,\n\t\tDeviceUserAgent as string,\n\t\tMessageVersion as string,\n\t\tRDXMessageVersion as string,\n\t\tLanguage as string,\n\t\tPaymentInfoCardNumber as string,\n\t\tPaymentInfoCardExpiryMonth as string,\n\t\tPaymentInfoCardExpiryYear as string,\n\t\tStepupType as string,\n\t\tStatus as string,\n\t\tCredentialsId as string,\n\t\tCredentialsType as string,\n\t\tCredentialsText as string,\n\t\tVerificationToken as string,\n\t\tReasonCode as string,\n\t\tReasonDescription as string,\n\t\tErrorReferenceNumber as string,\n\t\tErrorDescription as string,\n\t\tErrorMessage as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tpartitionBy('hash', 1)) ~> MessageLog3DS4140\nMessageLog3DS4140 select(mapColumn(\n\t\tTransaction_Timestamp = InvocationTimestamp,\n\t\tTransaction_Log_ID = TransactionId,\n\t\tCard_Number = PaymentInfoCardNumber,\n\t\tStatus,\n\t\tMobile_Phone = CredentialsText,\n\t\tReason_Code = ReasonCode,\n\t\tReason_Description = ReasonDescription,\n\t\tError_Reference_Number = ErrorReferenceNumber,\n\t\tError_Description = ErrorDescription,\n\t\tError_Message = ErrorMessage\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Selectcolumns\nSelectcolumns filter(and(or(Status !='SUCCESS', isNull(Status)), in(['511328','536313','536314','549917','554919','554924','557567'], left(Card_Number, 6)))) ~> FilterConditions\nFilterConditions sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tColumn_1 as string,\n\t\tColumn_2 as string,\n\t\tColumn_3 as string,\n\t\tColumn_4 as string,\n\t\tColumn_5 as string,\n\t\tColumn_6 as string,\n\t\tColumn_7 as string,\n\t\tColumn_8 as string,\n\t\tColumn_9 as string\n\t),\n\tpartitionFileNames:[(concat('4140_', replace(replace(replace(toString(toTimestamp(toString(currentUTC()),'yyyy-MM-dd HH:mm:ss')),'-',''),':',''),' ','_'),'.csv'))],\n\ttruncate: true,\n\tumask: 0022,\n\tpreCommands: [],\n\tpostCommands: [],\n\tdateFormat:'MM-dd-yyyy',\n\ttimestampFormat:'MM/dd/yyyy HH:mm:ss',\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tpartitionBy('hash', 1)) ~> sinkOutboundfolder"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/DF_populateCUSCIssuer')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "Get Issuer reference data from CUSC Complete (Central DB) to Data Warehouse",
                "folder": {
                    "name": "Shared Branch/SEM"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "dbo_coopissuers",
                                "type": "DatasetReference"
                            },
                            "name": "srcCUSCIssuers"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "ASDW_CUSC_issuer",
                                "type": "DatasetReference"
                            },
                            "name": "sinkCUSCissuerStg"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "DerivedTrim"
                        }
                    ],
                    "script": "source(output(\n\t\tIS_Number as decimal(18,0),\n\t\tCUI_Index as integer,\n\t\tiss_CU_Name as string,\n\t\tI_NetworkID as string,\n\t\tI_ABA as string,\n\t\tI_PseudoRT as string,\n\t\tI_Status as string,\n\t\tNetwork as integer,\n\t\tload_date as date,\n\t\tloaded_by as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'SELECT distinct ISO.IS_Number, CUI.[index] as CUI_Index, CU.CU_Name as iss_CU_Name, I.I_NetworkID, I.I_ABA, I.I_PseudoRT, I.I_Status, ISO.Network,\\nCAST(FORMAT (GETDATE(), \\'MM-dd-yyyy\\') as [date]) [load_date],\\n\\'ETL_USER\\' as [loaded_by]\\nFROM dbo.CreditUnion CU INNER JOIN\\ndbo.Issuer I ON CU.[index] = I.CU_CreditUnionIndex INNER JOIN\\ndbo.ISO ISO ON ISO.CU_CreditUnionIndex = I.CU_CreditUnionIndex INNER JOIN\\ndbo.CreditUnionInstitution CUI on ISO.CU_CreditUnionIndex = CUI.CU_CreditUnionIndex\\nWHERE ISO.IS_Number is not NULL',\n\tformat: 'query') ~> srcCUSCIssuers\nsrcCUSCIssuers derive(each(match(type=='string'), $$ = trim(regexReplace($$,'(^\\\\h*)|(\\\\h*$)','')))) ~> DerivedTrim\nDerivedTrim sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tISO_Issuer as string,\n\t\tCU_Institution_Index as integer,\n\t\tI_CU_Name as string,\n\t\tI_Network_ID as string,\n\t\tI_ABA_RT as string,\n\t\tI_PseudoRT as string,\n\t\tI_Status as string,\n\t\tISO_Network as string,\n\t\tload_date as date,\n\t\tloaded_by as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\ttruncate:true,\n\tformat: 'table',\n\tstaged: false,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tISO_Issuer = IS_Number,\n\t\tCU_Institution_Index = CUI_Index,\n\t\tI_CU_Name = iss_CU_Name,\n\t\tI_Network_ID = I_NetworkID,\n\t\tI_ABA_RT = I_ABA,\n\t\tI_PseudoRT,\n\t\tI_Status,\n\t\tISO_Network = Network,\n\t\tload_date,\n\t\tloaded_by\n\t)) ~> sinkCUSCissuerStg"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/DF_populateCUSCAcquirer')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "Get Acquirer reference data from CUSC Complete (Central DB) to Data Warehouse",
                "folder": {
                    "name": "Shared Branch/SEM"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "ASQL_acquirer_CU",
                                "type": "DatasetReference"
                            },
                            "name": "srcAcquirerCU"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "ASDW_CUSC_acquirer",
                                "type": "DatasetReference"
                            },
                            "name": "sinkCUSCAcquirerStg"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "DerivedTrim"
                        }
                    ],
                    "script": "source(output(\n\t\tPseudo_Terminal as string,\n\t\tCUI_Index as integer,\n\t\tacquirer_name as string,\n\t\tacquirer_branch_street as string,\n\t\tsix_acquirer_branch_street as string,\n\t\tacquirer_branch_city as string,\n\t\tacquirer_branch_state as string,\n\t\tacquirer_branch_Country as string,\n\t\tacquiring_institution_rt_number as string,\n\t\tacquirer_network_id as string,\n\t\tProduct_Code as string,\n\t\tproduct_type as string,\n\t\tclosing_date as date,\n\t\tload_date as date,\n\t\tloaded_by as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'select *,\\nCAST(FORMAT (GETDATE(), \\'MM-dd-yyyy\\') as [date]) [load_date],\\n\\'ETL_USER\\' as [loaded_by]\\nfrom [dbo].[acquirer_CU]',\n\tformat: 'query') ~> srcAcquirerCU\nsrcAcquirerCU derive(each(match(type=='string'), $$ = trim(regexReplace($$,'(^\\\\h*)|(\\\\h*$)','')))) ~> DerivedTrim\nDerivedTrim sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tPseudo_Terminal as string,\n\t\tCU_Institution_Index as integer,\n\t\tA_CU_Name as string,\n\t\tA_branch_street as string,\n\t\tsix_A_branch_street as string,\n\t\tA_branch_city as string,\n\t\tA_branch_state as string,\n\t\tA_branch_country as string,\n\t\tacquirer_RT as string,\n\t\tA_network_id as string,\n\t\tProduct_Code as string,\n\t\tproduct_type as string,\n\t\tclosing_date as date,\n\t\tload_date as date,\n\t\tloaded_by as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\ttruncate:true,\n\tformat: 'table',\n\tstaged: false,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tPseudo_Terminal,\n\t\tCU_Institution_Index = CUI_Index,\n\t\tA_CU_Name = acquirer_name,\n\t\tA_branch_street = acquirer_branch_street,\n\t\tsix_A_branch_street = six_acquirer_branch_street,\n\t\tA_branch_city = acquirer_branch_city,\n\t\tA_branch_state = acquirer_branch_state,\n\t\tA_branch_country = acquirer_branch_Country,\n\t\tacquirer_RT = acquiring_institution_rt_number,\n\t\tA_network_id = acquirer_network_id,\n\t\tProduct_Code,\n\t\tproduct_type,\n\t\tclosing_date,\n\t\tload_date,\n\t\tloaded_by\n\t)) ~> sinkCUSCAcquirerStg"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/3DS_LongTerm_DF')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "This is for 3DS Long Term Report ",
                "folder": {
                    "name": "3DS"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "src_3DSMessageLog",
                                "type": "DatasetReference"
                            },
                            "name": "MessageLog"
                        },
                        {
                            "dataset": {
                                "referenceName": "dst_MemberCardHolder",
                                "type": "DatasetReference"
                            },
                            "name": "MemberCardholder"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "3DSLongtermReport",
                                "type": "DatasetReference"
                            },
                            "name": "sink1"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "JoinMemberLogandCardholder"
                        },
                        {
                            "name": "FilteredCardholder"
                        },
                        {
                            "name": "Select1"
                        },
                        {
                            "name": "MessageLogforlast60days"
                        },
                        {
                            "name": "DerivedColumn1"
                        }
                    ],
                    "script": "source(output(\n\t\tMessageLogId as long,\n\t\tAPIName as string,\n\t\tInvocationTimestamp as timestamp,\n\t\tClientId as string,\n\t\tClientApplication as string,\n\t\tRequestPath as string,\n\t\tLogId as string,\n\t\tProcessorId as string,\n\t\tIssuerId as string,\n\t\tTransactionId as string,\n\t\tStepupRequestId as string,\n\t\tDeviceUserAgent as string,\n\t\tMessageVersion as string,\n\t\tRDXMessageVersion as string,\n\t\tLanguage as string,\n\t\tPaymentInfoCardNumber as string,\n\t\tPaymentInfoCardExpiryMonth as string,\n\t\tPaymentInfoCardExpiryYear as string,\n\t\tStepupType as string,\n\t\tStatus as string,\n\t\tCredentialsId as string,\n\t\tCredentialsType as string,\n\t\tCredentialsText as string,\n\t\tVerificationToken as string,\n\t\tReasonCode as string,\n\t\tReasonDescription as string,\n\t\tErrorReferenceNumber as string,\n\t\tErrorDescription as string,\n\t\tErrorMessage as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table') ~> MessageLog\nsource(output(\n\t\tCardHolderId as long,\n\t\tClientNum as string,\n\t\tAccountNum as string,\n\t\tCardHolder_Type_Cd as string,\n\t\tCardHolderPositionCd as string,\n\t\tCardNum as string,\n\t\tCardTypeCd as string,\n\t\tCardProgram as string,\n\t\tSeperateEntityInd as boolean,\n\t\tPersonUniqueId as integer,\n\t\tCardHolderNamePrefix as string,\n\t\tCardHolderFirstName as string,\n\t\tCardHolderMiddleName as string,\n\t\tCardHolderLastName as string,\n\t\tCardHolderNameSuffix as string,\n\t\tSocialSecurityNum as string,\n\t\tCustomerControlId as string,\n\t\tMothersMadenName as string,\n\t\tBirthDate as date,\n\t\tDeceasedCd as string,\n\t\tAddress1LineOne as string,\n\t\tAddress1LineTwo as string,\n\t\tAddress1City as string,\n\t\tAddress1State as string,\n\t\tAddress1ZipCode as string,\n\t\tAddress1CountryAlpha3 as string,\n\t\tAddress1CountryNumeric as integer,\n\t\tAddressSource as string,\n\t\tCardHolderSex as string,\n\t\tDriversLicenseNum as string,\n\t\tDriversLicenseState as string,\n\t\tHomePhone as string,\n\t\tBusinessPhone as string,\n\t\tMobilePhone as string,\n\t\tTransitRoutingNum as string,\n\t\tCheckingAccountNum as string,\n\t\tSavingsAccountNum as string,\n\t\tAccountSystemEntryDate as date,\n\t\tExpirationDate as date,\n\t\tCardsIssuedCnt as string,\n\t\tStatementCycleCd as string,\n\t\tCrossReferenceAccountNum1 as string,\n\t\tCrossReferenceAccountNum2 as string,\n\t\tCrossReferenceAccountNum3 as string,\n\t\tAccountBalance as decimal(19,4),\n\t\tExternalStatus as string,\n\t\tInternalStatus as string,\n\t\tCardStatus as string,\n\t\tCardStatusChangeDate as date,\n\t\tCreditBureauReportCode as string,\n\t\tDoNotSolicitInd as boolean,\n\t\tSpaSystemBank as string,\n\t\tSpaPrincipalBank as string,\n\t\tSpaAgentBank as string,\n\t\tSourceId as string,\n\t\tReportDate as date,\n\t\tCreateDate as timestamp,\n\t\tModifiedDate as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false) ~> MemberCardholder\nMessageLogforlast60days, FilteredCardholder join(trim(toString(PaymentInfoCardNumber)) == CardNum,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinMemberLogandCardholder\nMemberCardholder filter(and(CardHolder_Type_Cd == '01',CardHolderPositionCd == '001')) ~> FilteredCardholder\nDerivedColumn1 select(mapColumn(\n\t\tMessageLogId,\n\t\tAPIName,\n\t\tInvocationTimestamp,\n\t\tClientId,\n\t\tClientApplication,\n\t\tRequestPath,\n\t\tLogId,\n\t\tProcessorId,\n\t\tIssuerId,\n\t\tTransactionId,\n\t\tStepupRequestId,\n\t\tDeviceUserAgent,\n\t\tMessageVersion,\n\t\tRDXMessageVersion,\n\t\tLanguage,\n\t\tPaymentInfoCardNumber = PaymentInfoCardNumber_Update,\n\t\tPaymentInfoCardExpiryMonth,\n\t\tPaymentInfoCardExpiryYear,\n\t\tStepupType,\n\t\tStatus,\n\t\tCredentialsId,\n\t\tCredentialsType,\n\t\tCredentialsText,\n\t\tVerificationToken,\n\t\tReasonCode,\n\t\tReasonDescription,\n\t\tErrorReferenceNumber,\n\t\tErrorDescription,\n\t\tErrorMessage,\n\t\tAccountNum = AccountNum_update,\n\t\tCardHolderFirstName,\n\t\tCardHolderLastName,\n\t\tClientNum\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select1\nMessageLog filter(toDate(InvocationTimestamp) >= subDays( currentDate(),60)) ~> MessageLogforlast60days\nJoinMemberLogandCardholder derive(PaymentInfoCardNumber_Update = concat(left(PaymentInfoCardNumber, 6) ,'XXXXXX', right(PaymentInfoCardNumber, 4)),\n\t\tAccountNum_update = concat(left(AccountNum, 6),'XXXXXX',right(AccountNum, 4))) ~> DerivedColumn1\nSelect1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tpartitionFileNames:[(concat('3DS_LongTerm_',replace(replace(replace(toString(toTimestamp(toString(currentUTC()),'yyyy-MM-dd')),'-',''),':',''),'','_'),'.txt'))],\n\ttruncate: true,\n\tumask: 0022,\n\tpreCommands: [],\n\tpostCommands: [],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tpartitionBy('hash', 1)) ~> sink1"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/DF_load_Dim_State_stage')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "Reference"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "DS_ABLB_iso_subdivision",
                                "type": "DatasetReference"
                            },
                            "name": "ABLBStatesrcfile"
                        },
                        {
                            "dataset": {
                                "referenceName": "DS_ASDW_Dim_Country",
                                "type": "DatasetReference"
                            },
                            "name": "DimCountrytable"
                        },
                        {
                            "dataset": {
                                "referenceName": "DS_ABLB_Geographic_Regions_by_State",
                                "type": "DatasetReference"
                            },
                            "name": "LkpFileGeographicRegions"
                        },
                        {
                            "dataset": {
                                "referenceName": "DS_ASDW_Dim_Geographic_Regions",
                                "type": "DatasetReference"
                            },
                            "name": "DimGeographicRegiontable"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "DS_ASDW_Dim_State_Stg",
                                "type": "DatasetReference"
                            },
                            "name": "sinkDimStateStagetable"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "JoinStateandCountryGetCountryKey"
                        },
                        {
                            "name": "JoinonStatenametogetGeoKey"
                        },
                        {
                            "name": "JoinLkpFileandDimGeographicRegiontable"
                        },
                        {
                            "name": "FinalOutput"
                        },
                        {
                            "name": "DeriveSubdivisionCode"
                        }
                    ],
                    "script": "source(output(\n\t\tState_key as string,\n\t\talpha_2_code as string,\n\t\talpha_3_code as string,\n\t\tnumeric_code as string,\n\t\tsubdivision_category_id as string,\n\t\tsubdivision_code as string,\n\t\tlanguage as string,\n\t\tlanguage_alpha_3_code as string,\n\t\tsubdivision_name as string,\n\t\tsubdivision_name_local_variation as string,\n\t\tromanization_system as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> ABLBStatesrcfile\nsource(output(\n\t\tCOUNTRY_KEY as integer,\n\t\tCOUNTRY_NM as string,\n\t\tCOUNTRY_ISO_ALPHA2_CD as string,\n\t\tCOUNTRY_ISO_ALPHA3_CD as string,\n\t\tCOUNTRY_ISO_NUMERIC_CD as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false) ~> DimCountrytable\nsource(output(\n\t\tState as string,\n\t\tRegions as string,\n\t\tCountry as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> LkpFileGeographicRegions\nsource(output(\n\t\tGEOGRAPHIC_REGION_KEY as integer,\n\t\tGEOGRAPIC_REGION_NM as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false) ~> DimGeographicRegiontable\nABLBStatesrcfile, DimCountrytable join(alpha_2_code == COUNTRY_ISO_ALPHA2_CD\n\t&& alpha_3_code == COUNTRY_ISO_ALPHA3_CD,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinStateandCountryGetCountryKey\nJoinStateandCountryGetCountryKey, JoinLkpFileandDimGeographicRegiontable join(subdivision_name == State\n\t&& COUNTRY_ISO_ALPHA2_CD == Country,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinonStatenametogetGeoKey\nLkpFileGeographicRegions, DimGeographicRegiontable join(Regions == GEOGRAPIC_REGION_NM,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinLkpFileandDimGeographicRegiontable\nDeriveSubdivisionCode select(mapColumn(\n\t\tsubdivision_code,\n\t\tstate_key = State_key,\n\t\tsubdivision_name,\n\t\tCOUNTRY_KEY,\n\t\tGEOGRAPHIC_REGION_KEY\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> FinalOutput\nJoinonStatenametogetGeoKey derive(subdivision_code = substring(subdivision_code,4,length(subdivision_code))) ~> DeriveSubdivisionCode\nFinalOutput sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tSTATE_KEY as integer,\n\t\tSTATE_NM as string,\n\t\tSTATE_ABVR as string,\n\t\tCOUNTRY_KEY as integer,\n\t\tGEOGRAPHIC_REGION_KEY as integer\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\ttruncate:true,\n\tformat: 'table',\n\tstaged: false,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 1,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tSTATE_KEY = state_key,\n\t\tSTATE_NM = subdivision_name,\n\t\tSTATE_ABVR = subdivision_code,\n\t\tCOUNTRY_KEY,\n\t\tGEOGRAPHIC_REGION_KEY\n\t)) ~> sinkDimStateStagetable"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/IC_Billing')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "Snowflake_SEM_User",
                                "type": "DatasetReference"
                            },
                            "name": "srcUserSecurity"
                        },
                        {
                            "dataset": {
                                "referenceName": "fact_Transaction",
                                "type": "DatasetReference"
                            },
                            "name": "dwFactTrans"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Routing_Number",
                                "type": "DatasetReference"
                            },
                            "name": "dwRTN"
                        },
                        {
                            "dataset": {
                                "referenceName": "stg_BillingClientBlacklist",
                                "type": "DatasetReference"
                            },
                            "name": "srcClientBlacklist"
                        },
                        {
                            "dataset": {
                                "referenceName": "DS_stgBillingException",
                                "type": "DatasetReference"
                            },
                            "name": "srcClientExceptions"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "DS_snk_ConnexBilling_IC",
                                "type": "DatasetReference"
                            },
                            "name": "SinkConnex"
                        },
                        {
                            "dataset": {
                                "referenceName": "DS_snk_OmahaBilling_IC",
                                "type": "DatasetReference"
                            },
                            "name": "SinkOmaha"
                        },
                        {
                            "dataset": {
                                "referenceName": "DS_snk_NeitherBilling_IC",
                                "type": "DatasetReference"
                            },
                            "name": "SinkNeither"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "TrimClientBlacklist"
                        },
                        {
                            "name": "ExcludeBlacklist"
                        },
                        {
                            "name": "Select"
                        },
                        {
                            "name": "AggBySource"
                        },
                        {
                            "name": "ConditionalSplit1"
                        },
                        {
                            "name": "RemoveRTN"
                        },
                        {
                            "name": "SelectOmaha"
                        },
                        {
                            "name": "SelectConnex"
                        },
                        {
                            "name": "SelectNeither"
                        },
                        {
                            "name": "SortConnex"
                        },
                        {
                            "name": "SortOmaha"
                        },
                        {
                            "name": "SortNeither"
                        },
                        {
                            "name": "JoinRTN"
                        },
                        {
                            "name": "JoinFactTrans"
                        },
                        {
                            "name": "DerivedColumn"
                        },
                        {
                            "name": "deriveRTNLength"
                        },
                        {
                            "name": "FilterNullRTN"
                        },
                        {
                            "name": "FilterRTN"
                        },
                        {
                            "name": "TrimClientException"
                        },
                        {
                            "name": "JoinClientException"
                        },
                        {
                            "name": "SelectClientException"
                        },
                        {
                            "name": "rankRTNs"
                        },
                        {
                            "name": "finalRTN"
                        }
                    ],
                    "script": "parameters{\n\treport_date as string\n}\nsource(output(\n\t\tCLIENTID as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tquery: 'SELECT DISTINCT CLIENTID FROM SEM.VW_USER',\n\tformat: 'query') ~> srcUserSecurity\nsource(output(\n\t\tsource_system_key as integer,\n\t\tclient_number_fact as string,\n\t\tclient_name as string,\n\t\tcnt_transactions as integer\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: (\"Select a.source_system_key,client_number as client_number_fact, client_name, count(*) as cnt_transactions from [transaction].[fact_transaction] a with (nolock) INNER JOIN (select distinct client_key, bin_key, bin_type, bankidentificationnumberISO from [financialinstitution].[dim_bin] with (nolock)) b on a.bin_key = b.bin_key INNER JOIN [financialinstitution].[dim_client] c with (nolock) on b.client_key = c.client_key where DATEADD(m, DATEDIFF(m, 0, a.import_file_date_key), 0) = DATEADD(m,-1,DATEADD(m, DATEDIFF(m, 0, CONVERT(date,'{$report_date}',127)), 0)) group by a.source_system_key, client_number, client_name\"),\n\tformat: 'query',\n\tstaged: false) ~> dwFactTrans\nsource(output(\n\t\tclient_number_rtn as string,\n\t\trouting_number as string,\n\t\tis_primary as boolean\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'Select distinct b.client_number as client_number_rtn, a.routing_number, is_primary from [FinancialInstitution].[dim_routing_number] a\\nINNER JOIN [FinancialInstitution].[dim_client] b\\non a.client_key = b.client_key',\n\tformat: 'query',\n\tstaged: false) ~> dwRTN\nsource(output(\n\t\tclient_number as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcClientBlacklist\nsource(output(\n\t\tclient_number as string,\n\t\tsource_system_key as integer\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcClientExceptions\nsrcClientBlacklist derive(each(match(type=='string'), $$ = trim($$))) ~> TrimClientBlacklist\nsrcUserSecurity, srcClientBlacklist exists(CLIENTID == client_number,\n\tnegate:true,\n\tbroadcast: 'auto')~> ExcludeBlacklist\nDerivedColumn select(mapColumn(\n\t\tSource,\n\t\tclient_number = CLIENTID,\n\t\tclient_name,\n\t\tsource_system_key,\n\t\trouting_number,\n\t\tcnt_transactions\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select\nSelect aggregate(groupBy(client_number,\n\t\tclient_name,\n\t\tSource),\n\tsource_system_key = min(source_system_key),\n\t\trouting_number = max(routing_number),\n\t\tcnt_transactions = sum(cnt_transactions)) ~> AggBySource\nAggBySource split(source_system_key==1,\n\tsource_system_key==2,\n\tdisjoint: false) ~> ConditionalSplit1@(Connex, Omaha, Neither)\nConditionalSplit1@Omaha aggregate(groupBy(source_system_key,\n\t\tSource,\n\t\tclient_number,\n\t\tclient_name,\n\t\tcnt_transactions),\n\trouting_number = max(routing_number)) ~> RemoveRTN\nRemoveRTN select(mapColumn(\n\t\tSource,\n\t\tClient_Number = client_number,\n\t\tClient_Name = client_name,\n\t\tQTY = cnt_transactions\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectOmaha\nConditionalSplit1@Connex select(mapColumn(\n\t\tSource,\n\t\tClient_Number = client_number,\n\t\tClient_Name = client_name,\n\t\tRouting_Number = routing_number,\n\t\tQTY = cnt_transactions\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectConnex\nConditionalSplit1@Neither select(mapColumn(\n\t\tclient_number,\n\t\tclient_name,\n\t\trouting_number,\n\t\tsource_system_key,\n\t\tcnt_transactions\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectNeither\nFilterNullRTN sort(asc(Client_Number, true),\n\tasc(Routing_Number, true)) ~> SortConnex\nSelectOmaha sort(asc(Client_Number, true)) ~> SortOmaha\nSelectNeither sort(asc(client_number, true),\n\tasc(routing_number, true)) ~> SortNeither\nExcludeBlacklist, finalRTN join(CLIENTID == client_number_rtn,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinRTN\nJoinRTN, dwFactTrans join(CLIENTID == client_number_fact,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinFactTrans\nJoinClientException derive(Source = 'INSIGHT CENTER',\n\t\tsource_system_key = coalesce(source_system_key_exception,source_system_key)) ~> DerivedColumn\nFilterRTN derive(routing_number = lpad(routing_number,9,'0')) ~> deriveRTNLength\nSelectConnex filter(!isNull(Routing_Number)||Routing_Number!='') ~> FilterNullRTN\ndwRTN filter(!isNull(routing_number)||routing_number!='') ~> FilterRTN\nsrcClientExceptions derive(each(match(type=='string'), $$ = trim($$))) ~> TrimClientException\nJoinFactTrans, SelectClientException join(CLIENTID == client_number_exception,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinClientException\nTrimClientException select(mapColumn(\n\t\tclient_number_exception = client_number,\n\t\tsource_system_key_exception = source_system_key\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectClientException\nderiveRTNLength window(over(client_number_rtn),\n\tdesc(is_primary, false),\n\tasc(routing_number, false),\n\trowNum = rowNumber()) ~> rankRTNs\nrankRTNs filter(rowNum==1) ~> finalRTN\nSortConnex sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tpartitionFileNames:[(concat('Connex_IC_Billing_',replace(toString(addMonths(toDate(substring($report_date,1,7),'yyyy-MM'),-1)),'-',''),'.csv'))],\n\tumask: 0022,\n\tpreCommands: [],\n\tpostCommands: [],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tpartitionBy('hash', 1)) ~> SinkConnex\nSortOmaha sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tpartitionFileNames:[(concat('Omaha_IC_Billing_',replace(toString(addMonths(toDate(substring($report_date,1,7),'yyyy-MM'),-1)),'-',''),'.csv'))],\n\tumask: 0022,\n\tpreCommands: [],\n\tpostCommands: [],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tpartitionBy('hash', 1)) ~> SinkOmaha\nSortNeither sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tpartitionFileNames:[(concat('Neither_IC_Billing_',replace(toString(addMonths(toDate(substring($report_date,1,7),'yyyy-MM'),-1)),'-',''),'.csv'))],\n\tumask: 0022,\n\tpreCommands: [],\n\tpostCommands: [],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tpartitionBy('hash', 1)) ~> SinkNeither"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/DF_BIN_Invalid')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "Data flow for ingesting invalid BINs",
                "folder": {
                    "name": "Audit"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "DS_XLSX_InvalidBIN",
                                "type": "DatasetReference"
                            },
                            "name": "srcInvalidBINs"
                        },
                        {
                            "dataset": {
                                "referenceName": "DS_ASDW_InvalidBINs",
                                "type": "DatasetReference"
                            },
                            "name": "srcDWInvalidBINs"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "DS_ASDW_InvalidBINs",
                                "type": "DatasetReference"
                            },
                            "name": "snkDWInvalidBINs"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "deriveCreateDate"
                        },
                        {
                            "name": "DoesNotExist"
                        },
                        {
                            "name": "deriveTrim"
                        }
                    ],
                    "script": "source(output(\n\t\tBIN as string,\n\t\tEnterUserName as string,\n\t\tDescription as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcInvalidBINs\nsource(output(\n\t\tROWID as long,\n\t\tBIN as string,\n\t\tEnterUserName as string,\n\t\tDescription as string,\n\t\tcreate_date as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false) ~> srcDWInvalidBINs\nderiveTrim derive(create_date = currentTimestamp()) ~> deriveCreateDate\nderiveCreateDate, srcDWInvalidBINs exists(deriveTrim@BIN == srcDWInvalidBINs@BIN,\n\tnegate:true,\n\tbroadcast: 'auto')~> DoesNotExist\nsrcInvalidBINs derive(each(match(type=='string'), $$ = trim($$))) ~> deriveTrim\nDoesNotExist sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tROWID as long,\n\t\tBIN as string,\n\t\tEnterUserName as string,\n\t\tDescription as string,\n\t\tcreate_date as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tBIN,\n\t\tEnterUserName,\n\t\tDescription,\n\t\tcreate_date\n\t)) ~> snkDWInvalidBINs"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/DF_Spendtrend_Stage_to_ConsDW')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "Cooper"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "DS_ABLB_Stage_FiservSpendtrend",
                                "type": "DatasetReference"
                            },
                            "name": "sourcefromStage"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "DS_ASDW_Stg_FraudTransaction",
                                "type": "DatasetReference"
                            },
                            "name": "sinktostagetable",
                            "rejectedDataLinkedService": {
                                "referenceName": "EnterpriseDataSource",
                                "type": "LinkedServiceReference"
                            }
                        }
                    ],
                    "transformations": [
                        {
                            "name": "DerivedColumn1"
                        },
                        {
                            "name": "Filter1"
                        }
                    ],
                    "script": "source(output(\n\t\t{Party Identifier} as string,\n\t\t{Hierarchy Detail 1 Identifier} as string,\n\t\t{Hierarchy Detail 2 Identifier} as string,\n\t\t{Hierarchy Detail 3 Identifier} as string,\n\t\t{Hierarchy Detail 4 Identifier} as string,\n\t\t{Account Identifier} as string,\n\t\t{Authorization Amount} as string,\n\t\t{Authorization Identifier} as string,\n\t\t{AVS Response Code} as string,\n\t\t{Card Activated Terminal Indicator} as string,\n\t\t{Card Capability Code} as string,\n\t\t{Cash Back Indicator} as string,\n\t\t{Chargeback Reason Code} as string,\n\t\t{Counterfeit Type Code} as string,\n\t\t{Customer Identification Method Code} as string,\n\t\t{Create Date} as string,\n\t\t{Device Identifier} as string,\n\t\t{Entered Account Identifier} as string,\n\t\t{Entry Mode Code} as string,\n\t\t{External Status Change Date} as string,\n\t\t{First Data Industry Transaction Identifier} as string,\n\t\t{First Use Fraud Date} as string,\n\t\t{Fraud Area Code} as string,\n\t\t{Fraud Completion Status} as string,\n\t\t{Fraud First Reported Time} as string,\n\t\t{Lost Stolen Type Code} as string,\n\t\t{Merchant Category Code} as string,\n\t\t{Merchant City} as string,\n\t\t{Merchant Country Code} as string,\n\t\t{Merchant Identifier} as string,\n\t\t{Merchant Name} as string,\n\t\t{Merchant Postal Code} as string,\n\t\t{Merchant State} as string,\n\t\t{POS Cardholder Present Code} as string,\n\t\t{POS Terminal Attendance Code} as string,\n\t\t{Presentation Instrument Lost Stolen Date} as string,\n\t\t{Set Fraud Date} as string,\n\t\t{Terminal Capability Code} as string,\n\t\t{Transaction Amount} as string,\n\t\t{Transaction Posting Date} as string,\n\t\t{Transaction Source Identifier Code} as string,\n\t\t{Authorization Time} as string,\n\t\t{Authorization Timestamp} as string,\n\t\t{Authorization Fraud Action Number} as string,\n\t\t{Authorization Fraud Queue Number} as string,\n\t\t{Authorization Date} as string,\n\t\t{Auth Count in 24 Hours} as string,\n\t\t{Fraud Score} as string,\n\t\t{Previous Fraud Score} as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> sourcefromStage\nFilter1 derive(Der_TransactionDate = toTimestamp( concat( toString(toDate({Authorization Timestamp}, 'yyyy-MM-dd')),  \" \", substring({Authorization Timestamp}, 12, 2) , substring({Authorization Timestamp}, 14, 2) , substring({Authorization Timestamp}, 16, 4) ), 'yyyy-MM-dd HH:mm:ss'),\n\t\tDer_ConfirmedNotFraudInd = toBoolean('false'),\n\t\tDer_SicDsc = \"N/A\",\n\t\tDer_SourceId = \"Fiserv Spendtrend\",\n\t\tDer_CreateDate = currentUTC(),\n\t\tDer_tansactionAmt = toDecimal({Transaction Amount}, 10,2)) ~> DerivedColumn1\nsourcefromStage filter({Party Identifier}!='Party Identifier') ~> Filter1\nDerivedColumn1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tFT_Id as long,\n\t\tCardNum as string,\n\t\tAccountNum as string,\n\t\tTransactionDate as timestamp,\n\t\tTransactionAmt as decimal(19,4),\n\t\tConfirmedNonFraudInd as boolean,\n\t\tFraudTypeDsc as string,\n\t\tMerchantName as string,\n\t\tMerchantCity as string,\n\t\tMerchantState as string,\n\t\tMerchantCountryCd as string,\n\t\tTerminalPostalCode as string,\n\t\tSicCd as string,\n\t\tSicDsc as string,\n\t\tSourceId as string,\n\t\tCreateDate as timestamp,\n\t\tFI_Transaction_Id as string,\n\t\tCase_Cls_Dte as string,\n\t\tCase_Id as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\ttruncate:true,\n\tformat: 'table',\n\tstaged: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tCardNum = {Entered Account Identifier},\n\t\tAccountNum = {Account Identifier},\n\t\tTransactionDate = Der_TransactionDate,\n\t\tTransactionAmt = Der_tansactionAmt,\n\t\tConfirmedNonFraudInd = Der_ConfirmedNotFraudInd,\n\t\tFraudTypeDsc = {Lost Stolen Type Code},\n\t\tMerchantName = {Merchant Name},\n\t\tMerchantCity = {Merchant City},\n\t\tMerchantState = {Merchant State},\n\t\tMerchantCountryCd = {Merchant Country Code},\n\t\tTerminalPostalCode = {Merchant Postal Code},\n\t\tSicCd = {Merchant Category Code},\n\t\tSicDsc = Der_SicDsc,\n\t\tSourceId = Der_SourceId,\n\t\tCreateDate = Der_CreateDate\n\t),\n\tpartitionBy('hash', 1)) ~> sinktostagetable"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/DF_FISConfirmedFraudStage_to_ConsDW')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "Cooper"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "DS_ABLB_Stage_FISConfirmedFraud",
                                "type": "DatasetReference"
                            },
                            "name": "SourcerfromStage"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "DS_ASDW_Stg_FraudTransaction",
                                "type": "DatasetReference"
                            },
                            "name": "sink1"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "DerivedColumn1"
                        },
                        {
                            "name": "Filter1"
                        }
                    ],
                    "script": "source(output(\n\t\t{Transaction Tag} as string,\n\t\t{Frd Desc} as string,\n\t\t{Institution Name} as string,\n\t\t{FI Card Port} as string,\n\t\t{Account Number} as string,\n\t\t{Trn Dt} as string,\n\t\t{Fraud Score} as string,\n\t\t{PAD Score} as string,\n\t\t{Pad Response} as string,\n\t\t{Transaction Amount} as string,\n\t\t{Original Decision Code} as string,\n\t\t{Decision Code} as string,\n\t\tRealTime as string,\n\t\t{Sic Code} as string,\n\t\t{SIC Description} as string,\n\t\t{Merchant Name} as string,\n\t\t{Original Merchant Name} as string,\n\t\t{Merchant City} as string,\n\t\t{Merchant State} as string,\n\t\t{Merchant Zip Code} as string,\n\t\t{Merchant Country} as string,\n\t\t{Merchant Country Code} as string,\n\t\t{Trn Typ} as string,\n\t\t{Crd Psnt Ind} as string,\n\t\t{POS Entry Code} as string,\n\t\t{CVV Verify Code} as string,\n\t\t{PIN Verify Code} as string,\n\t\t{Avs Response} as string,\n\t\t{Token/Provision} as string,\n\t\t{ECI Ind} as string,\n\t\t{CAVV/UCAF Result} as string,\n\t\t{Prod Case Rules Fired} as string,\n\t\t{Prod Real Time Rules Fired} as string,\n\t\t{Test Case Rules Fired} as string,\n\t\t{Test Real Time Rules Fired} as string,\n\t\t{Case Number} as string,\n\t\t{Credit(C) or Debit(D)} as string,\n\t\t{Cus Birth Dt} as string,\n\t\t{Cus City} as string,\n\t\t{Cus State} as string,\n\t\t{Cus Zip} as string,\n\t\t{Decline Reason Cd} as string,\n\t\t{CrdAcctID/MercID} as string,\n\t\t{Terminal Id} as string,\n\t\t{Travel/VIP Usr Ind 4} as string,\n\t\t{Compromise Usr Dat 3} as string,\n\t\t{VAA MCEMS Score} as string,\n\t\t{STAR Score} as string,\n\t\t{Cas Sta} as string,\n\t\t{Case Cls Dt} as string,\n\t\t{COOPER Frd Score} as string,\n\t\t{COOPER Frd Scr Cd} as string,\n\t\t{Fi Transaction Id} as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> SourcerfromStage\nFilter1 derive(Der_CardNum = {Account Number},\n\t\tDer_ConfirmedNotFraudInd = toBoolean('false'),\n\t\tDer_SourceId = \"FIS Confirmed Fraud\",\n\t\tDer_CreateDate = currentUTC(),\n\t\tDer_TransactionAmt = toDecimal(replace(replace(replace({Transaction Amount}, \"$\", \"\"), \",\", \"\"), \" \", \"\"), 10,2),\n\t\tDer_TransactionDate = iif ( like({Trn Dt}, '%PM'),\r\n                           toTimestamp(\r\n\t\t\t\t\t                     concat( toString (toDate({Trn Dt}, 'MM/dd/yy')),\r\n                                                  \" \", \r\n                                                iif ( like(substring({Trn Dt}, 10, 2), '12'),\r\n                                                      substring({Trn Dt}, 10, 2),\r\n                                                      toString ( (toInteger(substring({Trn Dt}, 10, 2))+12) )\r\n                                                    ),\r\n                                                  \":\" , \r\n                                                  substring({Trn Dt}, 13, 2) , \":\", substring({Trn Dt}, 16, 2)),\r\n                        'yyyy-MM-dd HH:mm:ss'),\r\n                        iif(\r\n                            like({Trn Dt}, '%AM'), \r\n                                                 toTimestamp(\r\n                                                              concat( toString (toDate({Trn Dt}, 'MM/dd/yy')), \r\n                                                            \" \", \r\n                                                            iif ( like(substring({Trn Dt}, 10, 2), '12'), '00',substring({Trn Dt}, 10, 2) ),\r\n                                                            \":\",\r\n                                                            substring({Trn Dt}, 13, 2) , \":\", substring({Trn Dt}, 16, 2)), \r\n                                                  'yyyy-MM-dd HH:mm:ss'),\r\n                                                  iif(\r\n                                                      like({Trn Dt},'%T%'),\r\n                                                                      toTimestamp(replace(replace({Trn Dt},'T',' '),'Z',' '),'yyyy-MM-dd HH:mm:ss'), \r\n                                                                      toTimestamp( \r\n                                                                                   concat( toString (toDate({Trn Dt}, 'MM/dd/yy')),  \r\n                                                                                    \" \",\t\t\t\t\t\t\t\t\t\t\t\r\n                                                                                    toString(trim(substring({Trn Dt},instr({Trn Dt},' '),instr({Trn Dt},':')-instr({Trn Dt},' ')))),\r\n                                                                                    ':',\r\n                                                                                    toString(trim(substring({Trn Dt},instr({Trn Dt},':')+1,2))),\r\n                                                                                    \":\", substring({Trn Dt}, 16, 2)                                                     \r\n\t\t\t\t\t\t\t\t\t\t                                        ),'yyyy-MM-dd HH:mm:ss')\r\n                                                      )\r\n                           )\r\n    ),\n\t\tDer_Case_ID = replace({Case Number},\",\",\"\")) ~> DerivedColumn1\nSourcerfromStage filter({Account Number}!='Account Number') ~> Filter1\nDerivedColumn1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tFT_Id as long,\n\t\tCardNum as string,\n\t\tAccountNum as string,\n\t\tTransactionDate as timestamp,\n\t\tTransactionAmt as decimal(19,4),\n\t\tConfirmedNonFraudInd as boolean,\n\t\tFraudTypeDsc as string,\n\t\tMerchantName as string,\n\t\tMerchantCity as string,\n\t\tMerchantState as string,\n\t\tMerchantCountryCd as string,\n\t\tTerminalPostalCode as string,\n\t\tSicCd as string,\n\t\tSicDsc as string,\n\t\tSourceId as string,\n\t\tCreateDate as timestamp,\n\t\tFI_Transaction_Id as string,\n\t\tCase_Cls_Dte as string,\n\t\tCase_Id as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\ttruncate:true,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tCardNum = Der_CardNum,\n\t\tAccountNum = {Account Number},\n\t\tTransactionDate = Der_TransactionDate,\n\t\tTransactionAmt = Der_TransactionAmt,\n\t\tConfirmedNonFraudInd = Der_ConfirmedNotFraudInd,\n\t\tFraudTypeDsc = {Frd Desc},\n\t\tMerchantName = {Merchant Name},\n\t\tMerchantCity = {Merchant City},\n\t\tMerchantState = {Merchant State},\n\t\tMerchantCountryCd = {Merchant Country Code},\n\t\tTerminalPostalCode = {Merchant Zip Code},\n\t\tSicCd = {Sic Code},\n\t\tSicDsc = {SIC Description},\n\t\tSourceId = Der_SourceId,\n\t\tCreateDate = Der_CreateDate,\n\t\tCase_Id = Der_Case_ID,\n\t\tCase_Cls_Dte = {Case Cls Dt},\n\t\tFI_Transaction_Id = {Fi Transaction Id}\n\t),\n\tpartitionBy('hash', 1)) ~> sink1"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/DF_Visa_Stage_to_ConsDW')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "Cooper"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "DS_ABLB_Stage_VisaChargeback",
                                "type": "DatasetReference"
                            },
                            "name": "sourcefromStage"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "DS_ASDW_Stg_FraudTransaction",
                                "type": "DatasetReference"
                            },
                            "name": "sink1"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "DerivedColumn1"
                        },
                        {
                            "name": "Filter1"
                        }
                    ],
                    "script": "source(output(\n\t\tMember as string,\n\t\t{Fraud RPT Date} as string,\n\t\tBIN as string,\n\t\t{ROL Case #} as string,\n\t\t{Card/Account Number} as string,\n\t\t{Acct Seq#} as string,\n\t\t{Fraud Type} as string,\n\t\t{Notification Code} as string,\n\t\t{Tran Amt} as string,\n\t\t{Curr Code} as string,\n\t\t{Tran Date} as string,\n\t\t{Acquirer Ref # or ACQ BIN/RRN/STAN} as string,\n\t\t{Merchant Name} as string,\n\t\t{Merch City} as string,\n\t\t{Merch State} as string,\n\t\t{Ntwk ID} as string,\n\t\tMCC as string,\n\t\tTRN as string,\n\t\t{Member Case #} as string,\n\t\t{Report Type} as string,\n\t\t{Cardholder Name} as string,\n\t\t{Cardholder City} as string,\n\t\t{CH State/Province} as string,\n\t\t{CH Postal Code} as string,\n\t\tCountry as string,\n\t\t{Valid From Date} as string,\n\t\t{Card Mailing Date} as string,\n\t\t{Card Mailing City} as string,\n\t\t{State/Province} as string,\n\t\t{Postal Code} as string,\n\t\t{Tran ID} as string,\n\t\tToken as string,\n\t\t{Merch Notified} as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> sourcefromStage\nsourcefromStage derive(Der_CardNumber = replace({Card/Account Number}, '-',''),\n\t\tDer_accountNum = replace({Card/Account Number}, '-',''),\n\t\tDer_tranDate = toTimestamp( concat( toString( toDate({Tran Date} ,'MM/dd/yyyy')), \" 00:00:00\"), 'yyyy-MM-dd HH:mm:ss'),\n\t\tDer_ConfirmedNotFraudInd = toBoolean('false'),\n\t\tDer_MerchantCountryCd = \"N/A\",\n\t\tDer_SicCd = \"N/A\",\n\t\tDer_SicDsc = \"N/A\",\n\t\tDer_SourceId = \"Visa Chargeback\",\n\t\tDer_CreateDate = currentUTC(),\n\t\tDer_Tran_amt = toDecimal({Tran Amt}, 10,2)) ~> DerivedColumn1\nDerivedColumn1 filter(Member!='Member') ~> Filter1\nFilter1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tFT_Id as long,\n\t\tCardNum as string,\n\t\tAccountNum as string,\n\t\tTransactionDate as timestamp,\n\t\tTransactionAmt as decimal(19,4),\n\t\tConfirmedNonFraudInd as boolean,\n\t\tFraudTypeDsc as string,\n\t\tMerchantName as string,\n\t\tMerchantCity as string,\n\t\tMerchantState as string,\n\t\tMerchantCountryCd as string,\n\t\tTerminalPostalCode as string,\n\t\tSicCd as string,\n\t\tSicDsc as string,\n\t\tSourceId as string,\n\t\tCreateDate as timestamp,\n\t\tFI_Transaction_Id as string,\n\t\tCase_Cls_Dte as string,\n\t\tCase_Id as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\ttruncate:true,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 1,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tCardNum = Der_CardNumber,\n\t\tAccountNum = Der_accountNum,\n\t\tTransactionDate = Der_tranDate,\n\t\tTransactionAmt = Der_Tran_amt,\n\t\tConfirmedNonFraudInd = Der_ConfirmedNotFraudInd,\n\t\tFraudTypeDsc = {Fraud Type},\n\t\tMerchantName = {Merchant Name},\n\t\tMerchantCity = {Merch City},\n\t\tMerchantState = {Merch State},\n\t\tMerchantCountryCd = Der_MerchantCountryCd,\n\t\tTerminalPostalCode = {Postal Code},\n\t\tSicCd = Der_SicCd,\n\t\tSicDsc = Der_SicDsc,\n\t\tSourceId = Der_SourceId,\n\t\tCreateDate = Der_CreateDate\n\t)) ~> sink1"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/DF_update_BinType')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "Updates BINType for FIS CU's.   Source is CUSA.CBAS file from FIS.",
                "folder": {
                    "name": "Dimensions"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "dim_BIN",
                                "type": "DatasetReference"
                            },
                            "name": "srcDWBin"
                        },
                        {
                            "dataset": {
                                "referenceName": "src_rawBinType",
                                "type": "DatasetReference"
                            },
                            "name": "BinType"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "dim_BIN",
                                "type": "DatasetReference"
                            },
                            "name": "snkDWBIN"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "trimBinType"
                        },
                        {
                            "name": "JoinBinType"
                        },
                        {
                            "name": "derivedBinType"
                        },
                        {
                            "name": "LimitSelectBinType"
                        },
                        {
                            "name": "MarkUpdate"
                        },
                        {
                            "name": "windowRankBinType"
                        },
                        {
                            "name": "dedupeFinal"
                        },
                        {
                            "name": "dedupeBinType"
                        }
                    ],
                    "script": "source(output(\n\t\tbankIdentificationNumberEXT as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'Select distinct  [bankIdentificationNumberEXT]\\nfrom  [FinancialInstitution].[dim_bin]',\n\tformat: 'query',\n\tstaged: false) ~> srcDWBin\nsource(output(\n\t\tPROC_ID as string,\n\t\t{PROC_NAME } as string,\n\t\tINSTITUTION_ID as string,\n\t\tINSTITUTION_NAME as string,\n\t\tADDRESS_LINE_1 as string,\n\t\tADDRESS_LINE_2 as string,\n\t\tCITY_TOWN as string,\n\t\tSTATE_ZIPCODE as string,\n\t\tBIN_NUMBER as string,\n\t\tLOGO as string,\n\t\tFILLER_1 as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> BinType\nBinType derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null()))))) ~> trimBinType\nsrcDWBin, LimitSelectBinType join(bankIdentificationNumberEXT == BIN_NUMBER,\n\tjoinType:'cross',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinBinType\ntrimBinType derive(BinType = iif(LOGO=='COOPCRDT' || LOGO=='COOPCRVC', 'Credit', 'Debit'),\n\t\tBIN_NUMBER = replace(BIN_NUMBER,'~','')) ~> derivedBinType\ndedupeBinType select(mapColumn(\n\t\tBIN_NUMBER,\n\t\tBinType\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> LimitSelectBinType\ndedupeFinal alterRow(updateIf(true())) ~> MarkUpdate\nJoinBinType window(over(bankIdentificationNumberEXT),\n\tdesc(bankIdentificationNumberEXT, true),\n\tasc(BinType, true),\n\trow_num = rowNumber()) ~> windowRankBinType\nwindowRankBinType filter(row_num==1) ~> dedupeFinal\nderivedBinType aggregate(groupBy(BIN_NUMBER,\n\t\tBinType),\n\tcount = count()) ~> dedupeBinType\nMarkUpdate sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tbin_key as long,\n\t\tsource_system_key as integer,\n\t\tsource_system_id as string,\n\t\tbankIdentificationNumberISO as string,\n\t\tbankIdentificationNumberEXT as string,\n\t\tbin_type as string,\n\t\tclient_key as long\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['bankIdentificationNumberEXT'],\n\tskipKeyWrites:true,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tbankIdentificationNumberEXT,\n\t\tbin_type = BinType\n\t)) ~> snkDWBIN"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/DF_update_BinType_CoreBIN')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "Updates BINType based on data from CORE.",
                "folder": {
                    "name": "Dimensions"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "DS_ABLB_CSV_Header_File",
                                "type": "DatasetReference"
                            },
                            "name": "srcCoreBin"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_BIN",
                                "type": "DatasetReference"
                            },
                            "name": "srcDWBIN"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "dim_BIN",
                                "type": "DatasetReference"
                            },
                            "name": "snkDWBIN"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "Trim"
                        },
                        {
                            "name": "CleanupCoreBIN"
                        },
                        {
                            "name": "ResolveBIN"
                        },
                        {
                            "name": "FilterBINs"
                        },
                        {
                            "name": "SelectBIN"
                        },
                        {
                            "name": "RankBINs"
                        },
                        {
                            "name": "Dedupe"
                        },
                        {
                            "name": "JoinBINs"
                        },
                        {
                            "name": "MarkUpdates"
                        },
                        {
                            "name": "windowRankBinType"
                        },
                        {
                            "name": "filterBinType"
                        }
                    ],
                    "script": "source(output(\n\t\tClientNumber as string,\n\t\tClientName as string,\n\t\tRoutingTransitNumber as string,\n\t\tOriginalBINNumber as string,\n\t\tBINNumberSixDigits as string,\n\t\tFirstDataPlatform as string,\n\t\tSys as string,\n\t\tPrin as string,\n\t\tAgent as string,\n\t\tCardType as string,\n\t\tType as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcCoreBin\nsource(output(\n\t\tbankIdentificationNumberEXT as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'Select distinct\\nbankIdentificationNumberEXT\\nfrom [FinancialInstitution].[dim_bin]',\n\tformat: 'query',\n\tstaged: false) ~> srcDWBIN\nsrcCoreBin derive(each(match(type=='string'), $$ = trim($$))) ~> Trim\nTrim derive(FirstDataPlatform = iif(initCap(FirstDataPlatform)=='Credit'||initCap(FirstDataPlatform)=='Debit',initCap(FirstDataPlatform),toString(null())),\n\t\tCardType = iif(initCap(CardType)=='Credit'||initCap(CardType)=='Debit',initCap(CardType),toString(null()))) ~> CleanupCoreBIN\nCleanupCoreBIN derive(FirstDataPlatform = coalesce(CardType,FirstDataPlatform,'Unknown')) ~> ResolveBIN\nResolveBIN filter(!like(ClientName,'%Merged%')) ~> FilterBINs\nFilterBINs select(mapColumn(\n\t\tBINType = FirstDataPlatform,\n\t\tOriginalBINNumber\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectBIN\nSelectBIN window(over(OriginalBINNumber),\n\tasc(BINType, true),\n\tranking = rowNumber()) ~> RankBINs\nRankBINs filter(ranking==1) ~> Dedupe\nsrcDWBIN, Dedupe join(bankIdentificationNumberEXT == OriginalBINNumber,\n\tjoinType:'cross',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinBINs\nfilterBinType alterRow(updateIf(true())) ~> MarkUpdates\nJoinBINs window(over(bankIdentificationNumberEXT),\n\tdesc(bankIdentificationNumberEXT, true),\n\tasc(BINType, true),\n\trow_num = rowNumber()) ~> windowRankBinType\nwindowRankBinType filter(row_num==1) ~> filterBinType\nMarkUpdates sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tbin_key as long,\n\t\tsource_system_key as integer,\n\t\tsource_system_id as string,\n\t\tbankIdentificationNumberISO as string,\n\t\tbankIdentificationNumberEXT as string,\n\t\tbin_type as string,\n\t\tclient_key as long\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['bankIdentificationNumberEXT'],\n\tskipKeyWrites:true,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tbin_type = BINType,\n\t\tbankIdentificationNumberEXT\n\t)) ~> snkDWBIN"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/update_Interchange_STAR')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "Updates Interchange Values for STAR using  7 days worth of dates from Interchange Raw which surround a single day of FIS Transactions from Conformed.",
                "folder": {
                    "name": "FIS"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "src_cnfm_All",
                                "type": "DatasetReference"
                            },
                            "name": "srcFISConformedTransactions"
                        },
                        {
                            "dataset": {
                                "referenceName": "populate_AuditTransactionsLog",
                                "type": "DatasetReference"
                            },
                            "name": "dwTransactionAuditLog"
                        },
                        {
                            "dataset": {
                                "referenceName": "dw_FISInterchangeRaw",
                                "type": "DatasetReference"
                            },
                            "name": "srcInterchangeRaw"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "fact_Transaction",
                                "type": "DatasetReference"
                            },
                            "name": "snkFactTransactions"
                        },
                        {
                            "dataset": {
                                "referenceName": "dwAuditUpdatedTransactions",
                                "type": "DatasetReference"
                            },
                            "name": "snkAuditInterchange"
                        },
                        {
                            "dataset": {
                                "referenceName": "populate_AuditTransactionsLog",
                                "type": "DatasetReference"
                            },
                            "name": "snkAuditTransactionsLog"
                        },
                        {
                            "dataset": {
                                "referenceName": "dw_FISInterchangeRaw",
                                "type": "DatasetReference"
                            },
                            "name": "snkInterchangeRaw"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "Trim"
                        },
                        {
                            "name": "LimitSelectInterchange"
                        },
                        {
                            "name": "deriveInterchange"
                        },
                        {
                            "name": "derivedTrans"
                        },
                        {
                            "name": "MarkUpdates"
                        },
                        {
                            "name": "DerivedColumn"
                        },
                        {
                            "name": "DistinctLoadID"
                        },
                        {
                            "name": "Lookup1"
                        },
                        {
                            "name": "AlterRow1"
                        },
                        {
                            "name": "derivedTransactionLog"
                        },
                        {
                            "name": "JoinSTAR"
                        },
                        {
                            "name": "LimitSelectTransactions"
                        },
                        {
                            "name": "SelectFinal"
                        },
                        {
                            "name": "TrimConformed"
                        },
                        {
                            "name": "FilterAuthorizations"
                        },
                        {
                            "name": "FilterCard"
                        }
                    ],
                    "script": "parameters{\n\tload_date as string ('20200118'),\n\tcard as string ('STAR')\n}\nsource(output(\n\t\tAccountNumber as string,\n\t\tAcquirerAccountNumber as string,\n\t\tAcquirerNetworkCode as string,\n\t\tBin_ISO as string,\n\t\tBin_EXT as string,\n\t\tCardEntryMethodCode as string,\n\t\tCardPresenceDescription as string,\n\t\tImportFileDate as date,\n\t\tSource as string,\n\t\tInterchangeAmount as float,\n\t\tIssuerAccountNumber as string,\n\t\tIssuerNetworkCode as string,\n\t\tMerchantName as string,\n\t\tMerchantType as string,\n\t\tMonetary as integer,\n\t\tOnUsDescription as string,\n\t\tOriginalDataTransmissionDate as date,\n\t\tOriginDate as date,\n\t\tRecurringDescription as string,\n\t\tResponseCode as string,\n\t\tSettlementAmount as float,\n\t\tSettlementDate as date,\n\t\tSurchargeAmount as float,\n\t\tTerminalAddress as string,\n\t\tTerminalCity as string,\n\t\tTerminalCountry as string,\n\t\tTerminalKey as string,\n\t\tTerminalState as string,\n\t\tTerminalZipCode as string,\n\t\tTokenRequestId as string,\n\t\tTransactionName as string,\n\t\tTransactionTypeCode as string,\n\t\tTransmissionDate as date,\n\t\tTransmissionTime as string,\n\t\tTimeLocalTransaction as string,\n\t\tRetrievalReferenceNumber as string,\n\t\tTransaction_Key as long,\n\t\tAgentNo as string,\n\t\tSystemNo as string,\n\t\tOperCode as string,\n\t\tPrincipalNo as string,\n\t\tAuthorizationNo as string,\n\t\tClientNo as string,\n\t\ttransaction_amount as float,\n\t\tis_authorization as integer,\n\t\tAcquiringRTN as string,\n\t\tSettlementRTN as string,\n\t\tTraceNumber as string,\n\t\tAcqTraceNumber as string,\n\t\tVisaTransactionID as string,\n\t\tMasterCardTransactionID as string,\n\t\tMerchantAccountNumber as string\n\t),\n\tallowSchemaDrift: false,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tformat: 'parquet',\n\twildcardPaths:[(concat\r\n(\r\n'Transactions/'\r\n, substring($load_date,0,4)\r\n,'/'\r\n,substring($load_date,5,2)\r\n,'/'\r\n,substring($load_date,7,2)\r\n,'/FISDebitTransaction_*'\r\n))]) ~> srcFISConformedTransactions\nsource(output(\n\t\trun_id as long,\n\t\tload_date as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'SELECT run_id, load_date\\n  FROM [Audit].[transactions_log] a \\n  INNER JOIN (Select [file_name], max(create_date) as create_date from [Audit].[transactions_log] where source_system_key = 1 and [file_name] like \\'FISDebitTransaction%\\'\\ngroup by [file_name]) b\\n  on a.[file_name] = b.[file_name]\\n  and a.create_date = b.create_date',\n\tformat: 'query',\n\tstaged: false) ~> dwTransactionAuditLog\nsource(output(\n\t\tROWID as long,\n\t\tPAN as string,\n\t\t{SWITCH DATE} as string,\n\t\t{LOCAL DATE} as string,\n\t\t{DEBIT AMOUNT} as string,\n\t\t{CREDIT AMOUNT} as string,\n\t\t{MEMO AMOUNT} as string,\n\t\t{TERMINAL INTERCHANGE FEE} as string,\n\t\tSIGN7 as string,\n\t\t{CARDHOLDER INTERCHANGE FEE} as string,\n\t\tSIGN9 as string,\n\t\tACQ as string,\n\t\tISS as string,\n\t\t{TERM INST} as string,\n\t\t{CARD INST} as string,\n\t\t{TRAN TYPE} as string,\n\t\t{TRAN ID} as string,\n\t\tRRN as string,\n\t\t{SEQ NO} as string,\n\t\t{ACQ/ISS} as string,\n\t\t{ACTION CODE} as string,\n\t\t{TRANSACTION DESCRIPTION} as string,\n\t\t{REV REASON} as string,\n\t\t{REJ REASON} as string,\n\t\t{TRACE DATA} as string,\n\t\tProp_24 as string,\n\t\tProp_25 as string,\n\t\tfile_name as string,\n\t\tprocessed as boolean,\n\t\tcreate_date as string,\n\t\tmodified_date as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: (concat('Select * from [Staging].[FIS_Interchange_RAW] where processed = 0 and substring([LOCAL DATE],1,6)<= substring(convert(varchar(8),DATEADD(DAY,2,convert(date,',toString('\\''+ right($load_date,6)+ '\\''),')),112),3,6) and substring([LOCAL DATE],1,6) >= substring(convert(varchar(8),DATEADD(DAY,-7,convert(date,',toString('\\''+ right($load_date,6)+ '\\''),')),112),3,6) and cast([create_date] as datetime) > DATEADD(DAY,-7,GETUTCDATE())')),\n\tformat: 'query',\n\tstaged: false,\n\tpartitionColumn: 'ROWID',\n\tpartitionBy('external', 8)) ~> srcInterchangeRaw\nFilterCard derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null()))))) ~> Trim\nTrim select(mapColumn(\n\t\tROWID,\n\t\tPAN,\n\t\t{LOCAL DATE},\n\t\t{TERMINAL INTERCHANGE FEE},\n\t\tSIGN7,\n\t\t{CARDHOLDER INTERCHANGE FEE},\n\t\tSIGN9,\n\t\tfile_name\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> LimitSelectInterchange\nLimitSelectInterchange derive(local_date_timestamp = right(left({LOCAL DATE},12),6),\n\t\tinterchange_real = (iif(SIGN7=='DR', toDecimal(concat('-',{TERMINAL INTERCHANGE FEE})), toDecimal({TERMINAL INTERCHANGE FEE})))\r\n+\r\n(iif(SIGN9=='DR', toDecimal(concat('-',{CARDHOLDER INTERCHANGE FEE})), toDecimal({CARDHOLDER INTERCHANGE FEE}))),\n\t\tmodified_date = toString(currentUTC()),\n\t\tPAN_masked = iif(like(PAN,'%XXXXXX%'),concat(left(PAN,6),right(PAN,4)),left(PAN,16)),\n\t\tprocessed = 1) ~> deriveInterchange\nLimitSelectTransactions derive(OriginDate_timestamp = replace(left(TimeLocalTransaction,8),':',''),\n\t\tsource_system_key = 1,\n\t\tAccountNumber = left(AccountNumber,16),\n\t\tmasked_acctnum = concat(left(AccountNumber,6),right(left(AccountNumber,16),4))) ~> derivedTrans\nSelectFinal alterRow(updateIf(true())) ~> MarkUpdates\nSelectFinal derive(create_date = toTimestamp(modified_date),\n\t\tcolumn_name = 'interchange_amount') ~> DerivedColumn\nSelectFinal aggregate(groupBy(ImportFileDate),\n\tcount = count()) ~> DistinctLoadID\nDistinctLoadID, derivedTransactionLog lookup(ImportFileDate == load_date,\n\tmultiple: true,\n\tbroadcast: 'auto',\n\tpickup: 'any')~> Lookup1\nLookup1 alterRow(updateIf(true())) ~> AlterRow1\ndwTransactionAuditLog derive(load_date = toDate(load_date),\n\t\tloaded_to_semantic = false(),\n\t\tsem_start_date = toTimestamp(toString(null())),\n\t\tsem_end_date = toTimestamp(toString(null()))) ~> derivedTransactionLog\nderivedTrans, deriveInterchange join((PAN_masked==AccountNumber||PAN_masked==masked_acctnum)\r\n&&\r\nlocal_date_timestamp==OriginDate_timestamp,\n\tjoinType:'cross',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinSTAR\nTrimConformed select(mapColumn(\n\t\tAccountNumber,\n\t\tImportFileDate,\n\t\tSource,\n\t\tInterchangeAmount,\n\t\tOriginDate,\n\t\tTimeLocalTransaction,\n\t\tTransaction_Key\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> LimitSelectTransactions\nJoinSTAR select(mapColumn(\n\t\tAccountNumber,\n\t\tImportFileDate,\n\t\tSource,\n\t\tInterchangeAmount,\n\t\tOriginDate,\n\t\tTransaction_Key,\n\t\tsource_system_key,\n\t\tROWID,\n\t\tfile_name,\n\t\tinterchange_real,\n\t\tmodified_date,\n\t\tprocessed\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectFinal\nFilterAuthorizations derive(each(match(type=='string'), $$ = trim($$))) ~> TrimConformed\nsrcFISConformedTransactions filter(is_authorization==0) ~> FilterAuthorizations\nsrcInterchangeRaw filter(instr(file_name,$card) > 0) ~> FilterCard\nMarkUpdates sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\ttransaction_key as long,\n\t\tsource_system_key as integer,\n\t\tsource_system_id as string,\n\t\taccount_key as string,\n\t\tacquirer_key as long,\n\t\tAcquirer_Network_key as long,\n\t\tbin_key as long,\n\t\tcard_entry_method_code_key as long,\n\t\tcard_presence_desc as string,\n\t\timport_file_date_key as date,\n\t\tinterchange_amount as decimal(25,2),\n\t\tissuer_key as long,\n\t\tissuer_network_key as long,\n\t\tmerchant_key as long,\n\t\tmerchant_terminal_geography_key as long,\n\t\tmerchant_type_key as long,\n\t\tmonetary as boolean,\n\t\ton_us_desc as string,\n\t\ttransmission_date_key as date,\n\t\torigin_date_key as date,\n\t\trecurring_desc as string,\n\t\tresponse_code_key as long,\n\t\tsettlement_amount as decimal(25,2),\n\t\tsettlement_date_key as date,\n\t\tsurcharge_amount as decimal(25,2),\n\t\ttermnial_key as long,\n\t\ttoken_requestid as long,\n\t\ttransaction_name_key as long,\n\t\tTransaction_type_key as long,\n\t\trun_id as long,\n\t\tdigital_card_issued_ind as boolean,\n\t\tauthorization_ind as boolean,\n\t\tauthorization_no as string\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['transaction_key','source_system_key','origin_date_key'],\n\tskipKeyWrites:true,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 1,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\ttransaction_key = Transaction_Key,\n\t\tsource_system_key,\n\t\torigin_date_key = OriginDate,\n\t\tinterchange_amount = interchange_real\n\t)) ~> snkFactTransactions\nDerivedColumn sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tsource_system_key as integer,\n\t\ttransaction_key as long,\n\t\tcolumn_name as string,\n\t\told_value as string,\n\t\tnew_value as string,\n\t\tload_date as timestamp,\n\t\tcreate_date as timestamp,\n\t\tfile_name as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tbatchSize: 5000,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 4,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tsource_system_key,\n\t\ttransaction_key = Transaction_Key,\n\t\tcolumn_name,\n\t\told_value = InterchangeAmount,\n\t\tnew_value = interchange_real,\n\t\tload_date = ImportFileDate,\n\t\tcreate_date,\n\t\tfile_name\n\t)) ~> snkAuditInterchange\nAlterRow1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\trun_id as long,\n\t\tsource_system_key as integer,\n\t\tfile_name as string,\n\t\trecord_count as long,\n\t\tloaded_to_semantic as boolean,\n\t\tload_date as timestamp,\n\t\tcreate_date as timestamp,\n\t\tsem_start_date as timestamp,\n\t\tsem_end_date as timestamp,\n\t\tsf_loaded_to_semantic as boolean,\n\t\tsf_sem_start_date as timestamp,\n\t\tsf_sem_end_date as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['run_id'],\n\tskipKeyWrites:true,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 3,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\trun_id,\n\t\tloaded_to_semantic,\n\t\tsem_start_date,\n\t\tsem_end_date,\n\t\tsf_loaded_to_semantic = loaded_to_semantic,\n\t\tsf_sem_start_date = sem_start_date,\n\t\tsf_sem_end_date = sem_end_date\n\t)) ~> snkAuditTransactionsLog\nMarkUpdates sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tROWID as long,\n\t\tPAN as string,\n\t\t{SWITCH DATE} as string,\n\t\t{LOCAL DATE} as string,\n\t\t{DEBIT AMOUNT} as string,\n\t\t{CREDIT AMOUNT} as string,\n\t\t{MEMO AMOUNT} as string,\n\t\t{TERMINAL INTERCHANGE FEE} as string,\n\t\tSIGN7 as string,\n\t\t{CARDHOLDER INTERCHANGE FEE} as string,\n\t\tSIGN9 as string,\n\t\tACQ as string,\n\t\tISS as string,\n\t\t{TERM INST} as string,\n\t\t{CARD INST} as string,\n\t\t{TRAN TYPE} as string,\n\t\t{TRAN ID} as string,\n\t\tRRN as string,\n\t\t{SEQ NO} as string,\n\t\t{ACQ/ISS} as string,\n\t\t{ACTION CODE} as string,\n\t\t{TRANSACTION DESCRIPTION} as string,\n\t\t{REV REASON} as string,\n\t\t{REJ REASON} as string,\n\t\t{TRACE DATA} as string,\n\t\tProp_24 as string,\n\t\tProp_25 as string,\n\t\tfile_name as string,\n\t\tprocessed as boolean,\n\t\tcreate_date as string,\n\t\tmodified_date as string\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['ROWID'],\n\tskipKeyWrites:true,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tpostSQLs:['Update Statistics [Staging].[FIS_Interchange_RAW] '],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 2,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tROWID,\n\t\tprocessed,\n\t\tmodified_date\n\t)) ~> snkInterchangeRaw"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/DF_ASDW_ClientBINRTN')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "Dimensions"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "DS_ASDW_vwMDMProcessing",
                                "type": "DatasetReference"
                            },
                            "name": "srcMDM"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_BIN",
                                "type": "DatasetReference"
                            },
                            "name": "srcDimBIN"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Routing_Number",
                                "type": "DatasetReference"
                            },
                            "name": "srcDimRTN"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "dim_Routing_Number",
                                "type": "DatasetReference"
                            },
                            "name": "snkDimRTN"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_BIN",
                                "type": "DatasetReference"
                            },
                            "name": "snkDimBIN"
                        },
                        {
                            "dataset": {
                                "referenceName": "dim_Client",
                                "type": "DatasetReference"
                            },
                            "name": "snkDimClient"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "trimMDM"
                        },
                        {
                            "name": "distinctClient"
                        },
                        {
                            "name": "deriveMDM"
                        },
                        {
                            "name": "distinctBIN"
                        },
                        {
                            "name": "distinctRTN"
                        },
                        {
                            "name": "filterNullRTN"
                        },
                        {
                            "name": "filterNullBIN"
                        },
                        {
                            "name": "notExistsRTN"
                        },
                        {
                            "name": "notExistsBIN"
                        },
                        {
                            "name": "setRowMethod"
                        }
                    ],
                    "script": "source(output(\n\t\tSourceLoadDateTime as timestamp,\n\t\tICINumber as string,\n\t\tClientNumber as string,\n\t\tCode as string,\n\t\tMatchStatus as string,\n\t\tFinancialInstitutionName as string,\n\t\tPreferredName as string,\n\t\tParentClientNumber as string,\n\t\tMergerAcquisitionDate as string,\n\t\tASSET_SIZE_KEY as integer,\n\t\tTotalAssets as string,\n\t\tPORTFOLIO_SIZE_KEY as integer,\n\t\tCurrentMembers as string,\n\t\tAddressLine1 as string,\n\t\tAddressLine2 as string,\n\t\tAddressCity as string,\n\t\tAddressState as string,\n\t\tAddressPostalCode as string,\n\t\tAddressType as string,\n\t\tAddressTypeDescription as string,\n\t\tGEOGRAPHIC_REGION_KEY as integer,\n\t\tBINNumber as string,\n\t\tBINNumberType as string,\n\t\tISO_BINNumber as string,\n\t\tRouteTransitNumber as string,\n\t\tIsPseudo as string,\n\t\tIsPrimary as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: true) ~> srcMDM\nsource(output(\n\t\tbin_key as long,\n\t\tsource_system_key as integer,\n\t\tsource_system_id as string,\n\t\tbankIdentificationNumberISO as string,\n\t\tbankIdentificationNumberEXT as string,\n\t\tbin_type as string,\n\t\tclient_key as long\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false) ~> srcDimBIN\nsource(output(\n\t\trouting_number_key as long,\n\t\tsource_system_key as integer,\n\t\tsource_system_id as string,\n\t\trouting_number as string,\n\t\tis_pseudo as boolean,\n\t\tis_primary as boolean,\n\t\tclient_key as long,\n\t\tcreate_date as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false) ~> srcDimRTN\nsrcMDM derive(each(match(type=='string'), $$ = trim($$))) ~> trimMDM\nderiveMDM aggregate(groupBy(client_key,\n\t\tClientNumber,\n\t\tFinancialInstitutionName,\n\t\tAddressLine1,\n\t\tAddressLine2,\n\t\tAddressCity,\n\t\tAddressState,\n\t\tAddressPostalCode,\n\t\tPreferredName,\n\t\tclient_key_parent,\n\t\tMergerAcquisitionDate,\n\t\tGEOGRAPHIC_REGION_KEY,\n\t\tASSET_SIZE_KEY,\n\t\tPORTFOLIO_SIZE_KEY,\n\t\tTotalAssets,\n\t\tCurrentMembers,\n\t\tis_current,\n\t\tcreate_date),\n\tcnt = count()) ~> distinctClient\ntrimMDM derive(is_current = toBoolean('y'),\n\t\tsource_system_key = 3,\n\t\tcreate_date = toDate(currentUTC()),\n\t\tclient_key = crc32(ClientNumber),\n\t\tclient_key_parent = iif(isNull(ParentClientNumber),toLong(null()),crc32(ParentClientNumber)),\n\t\tbin_key = crc32(BINNumber),\n\t\trouting_number_key = crc32(RouteTransitNumber),\n\t\tCurrentMembers = toInteger(CurrentMembers),\n\t\tTotalAssets = toDecimal(TotalAssets,15,2),\n\t\tMergerAcquisitionDate = toDate(MergerAcquisitionDate),\n\t\tIsPseudo = toBoolean(IsPseudo),\n\t\tIsPrimary = toBoolean(IsPrimary)) ~> deriveMDM\nderiveMDM aggregate(groupBy(bin_key,\n\t\tsource_system_key,\n\t\tBINNumber,\n\t\tBINNumberType,\n\t\tclient_key,\n\t\tcreate_date,\n\t\tISO_BINNumber),\n\tcnt = count()) ~> distinctBIN\nderiveMDM aggregate(groupBy(routing_number_key,\n\t\tsource_system_key,\n\t\tRouteTransitNumber,\n\t\tclient_key,\n\t\tIsPseudo,\n\t\tIsPrimary,\n\t\tcreate_date),\n\tcnt = count()) ~> distinctRTN\ndistinctRTN filter(!isNull(RouteTransitNumber)) ~> filterNullRTN\ndistinctBIN filter(!isNull(BINNumber)) ~> filterNullBIN\nfilterNullRTN, srcDimRTN exists(distinctRTN@routing_number_key == srcDimRTN@routing_number_key,\n\tnegate:true,\n\tbroadcast: 'auto')~> notExistsRTN\nfilterNullBIN, srcDimBIN exists(distinctBIN@bin_key == srcDimBIN@bin_key,\n\tnegate:true,\n\tbroadcast: 'auto')~> notExistsBIN\ndistinctClient alterRow(upsertIf(true())) ~> setRowMethod\nnotExistsRTN sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\trouting_number_key as long,\n\t\tsource_system_key as integer,\n\t\tsource_system_id as string,\n\t\trouting_number as string,\n\t\tis_pseudo as boolean,\n\t\tis_primary as boolean,\n\t\tclient_key as long,\n\t\tcreate_date as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\trouting_number_key,\n\t\tsource_system_key,\n\t\tsource_system_id = RouteTransitNumber,\n\t\trouting_number = RouteTransitNumber,\n\t\tclient_key,\n\t\tis_pseudo = IsPseudo,\n\t\tis_primary = IsPrimary,\n\t\tcreate_date\n\t)) ~> snkDimRTN\nnotExistsBIN sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tbin_key as long,\n\t\tsource_system_key as integer,\n\t\tsource_system_id as string,\n\t\tbankIdentificationNumberISO as string,\n\t\tbankIdentificationNumberEXT as string,\n\t\tbin_type as string,\n\t\tclient_key as long\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tbin_key,\n\t\tsource_system_key,\n\t\tsource_system_id = BINNumber,\n\t\tbankIdentificationNumberISO = ISO_BINNumber,\n\t\tbankIdentificationNumberEXT = BINNumber,\n\t\tbin_type = BINNumberType,\n\t\tclient_key\n\t)) ~> snkDimBIN\nsetRowMethod sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tclient_key as long,\n\t\tir_id as integer,\n\t\tclient_name as string,\n\t\tstreet_address1 as string,\n\t\tstreet_address2 as string,\n\t\tcity as string,\n\t\tstate as string,\n\t\tzipcode as string,\n\t\tclient_number as string,\n\t\tis_current as boolean,\n\t\tbegin_effective_date as timestamp,\n\t\tend_effective_date as timestamp,\n\t\tPREFERRED_NAME as string,\n\t\tPARENT_CLIENT_KEY as long,\n\t\tMERGER_ACQUISITION_DTE as date,\n\t\tGEOGRAPHIC_REGION_KEY as integer,\n\t\tASSET_SIZE_KEY as integer,\n\t\tPORTFOLIO_SIZE_KEY as integer,\n\t\tASSET_SIZE_AMT as decimal(19,4),\n\t\tPORTFOLIO_SIZE_CNT as integer,\n\t\tBUSINESS_PARTNER_CLIENT_KEY as long,\n\t\tCREATE_DTE as date\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:false,\n\tupsertable:true,\n\tkeys:['client_key'],\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tclient_key,\n\t\tclient_name = FinancialInstitutionName,\n\t\tstreet_address1 = AddressLine1,\n\t\tstreet_address2 = AddressLine2,\n\t\tcity = AddressCity,\n\t\tstate = AddressState,\n\t\tzipcode = AddressPostalCode,\n\t\tclient_number = ClientNumber,\n\t\tis_current,\n\t\tPREFERRED_NAME = PreferredName,\n\t\tPARENT_CLIENT_KEY = client_key_parent,\n\t\tMERGER_ACQUISITION_DTE = MergerAcquisitionDate,\n\t\tGEOGRAPHIC_REGION_KEY,\n\t\tASSET_SIZE_KEY,\n\t\tPORTFOLIO_SIZE_KEY,\n\t\tASSET_SIZE_AMT = TotalAssets,\n\t\tPORTFOLIO_SIZE_CNT = CurrentMembers,\n\t\tCREATE_DTE = create_date\n\t)) ~> snkDimClient"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/DF_Rewards_Custom_Demographic')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "folder": {
                    "name": "Rewards/DroptoDW"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "DS_ADLS_dropZone_Rewards_Custom_Demo",
                                "type": "DatasetReference"
                            },
                            "name": "srcRewardsSourceCustomDemo"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "DS_ASDW_Response_Member_Outbound_Custom_Demo",
                                "type": "DatasetReference"
                            },
                            "name": "sinkResponseDWRawCustomDemo"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "deriveAddingColumn"
                        }
                    ],
                    "script": "parameters{\n\tfileName as string\n}\nsource(output(\n\t\tColumn_1 as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcRewardsSourceCustomDemo\nsrcRewardsSourceCustomDemo derive(File_name = $fileName) ~> deriveAddingColumn\nderiveAddingColumn sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tfilename as string,\n\t\tData_f as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tfilename = File_name,\n\t\tData_f = Column_1\n\t),\n\tpartitionBy('hash', 1)) ~> sinkResponseDWRawCustomDemo"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/update_Interchange_COOP')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "Updates Interchange Values for COOP using  7 days worth of dates from Interchange Raw which surround a single day of FIS Transactions from Conformed.",
                "folder": {
                    "name": "FIS"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "src_cnfm_All",
                                "type": "DatasetReference"
                            },
                            "name": "srcFISConformedTransactions"
                        },
                        {
                            "dataset": {
                                "referenceName": "populate_AuditTransactionsLog",
                                "type": "DatasetReference"
                            },
                            "name": "dwTransactionAuditLog"
                        },
                        {
                            "dataset": {
                                "referenceName": "dw_FISInterchangeRaw",
                                "type": "DatasetReference"
                            },
                            "name": "srcInterchangeRaw"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "fact_Transaction",
                                "type": "DatasetReference"
                            },
                            "name": "snkFactTransactions"
                        },
                        {
                            "dataset": {
                                "referenceName": "dwAuditUpdatedTransactions",
                                "type": "DatasetReference"
                            },
                            "name": "snkAuditInterchange"
                        },
                        {
                            "dataset": {
                                "referenceName": "populate_AuditTransactionsLog",
                                "type": "DatasetReference"
                            },
                            "name": "snkAuditTransactionsLog"
                        },
                        {
                            "dataset": {
                                "referenceName": "dw_FISInterchangeRaw",
                                "type": "DatasetReference"
                            },
                            "name": "snkInterchangeRaw"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "Trim"
                        },
                        {
                            "name": "LimitSelectInterchange"
                        },
                        {
                            "name": "deriveInterchange"
                        },
                        {
                            "name": "derivedTrans"
                        },
                        {
                            "name": "MarkUpdates"
                        },
                        {
                            "name": "DerivedColumn"
                        },
                        {
                            "name": "DistinctLoadID"
                        },
                        {
                            "name": "Lookup1"
                        },
                        {
                            "name": "AlterRow1"
                        },
                        {
                            "name": "derivedTransactionLog"
                        },
                        {
                            "name": "JoinCOOP"
                        },
                        {
                            "name": "LimitSelectTransactions"
                        },
                        {
                            "name": "SelectFinal"
                        },
                        {
                            "name": "TrimConformed"
                        },
                        {
                            "name": "FilterAuthorizations"
                        },
                        {
                            "name": "FilterCard"
                        }
                    ],
                    "script": "parameters{\n\tload_date as string ('20210413'),\n\tcard as string ('COOP')\n}\nsource(output(\n\t\tAccountNumber as string,\n\t\tAcquirerAccountNumber as string,\n\t\tAcquirerNetworkCode as string,\n\t\tBin_ISO as string,\n\t\tBin_EXT as string,\n\t\tCardEntryMethodCode as string,\n\t\tCardPresenceDescription as string,\n\t\tImportFileDate as date,\n\t\tSource as string,\n\t\tInterchangeAmount as float,\n\t\tIssuerAccountNumber as string,\n\t\tIssuerNetworkCode as string,\n\t\tMerchantName as string,\n\t\tMerchantType as string,\n\t\tMonetary as integer,\n\t\tOnUsDescription as string,\n\t\tOriginalDataTransmissionDate as date,\n\t\tOriginDate as date,\n\t\tRecurringDescription as string,\n\t\tResponseCode as string,\n\t\tSettlementAmount as float,\n\t\tSettlementDate as date,\n\t\tSurchargeAmount as float,\n\t\tTerminalAddress as string,\n\t\tTerminalCity as string,\n\t\tTerminalCountry as string,\n\t\tTerminalKey as string,\n\t\tTerminalState as string,\n\t\tTerminalZipCode as string,\n\t\tTokenRequestId as string,\n\t\tTransactionName as string,\n\t\tTransactionTypeCode as string,\n\t\tTransmissionDate as date,\n\t\tTransmissionTime as string,\n\t\tTimeLocalTransaction as string,\n\t\tRetrievalReferenceNumber as string,\n\t\tTransaction_Key as long,\n\t\tAgentNo as string,\n\t\tSystemNo as string,\n\t\tOperCode as string,\n\t\tPrincipalNo as string,\n\t\tAuthorizationNo as string,\n\t\tClientNo as string,\n\t\ttransaction_amount as float,\n\t\tis_authorization as integer,\n\t\tAcquiringRTN as string,\n\t\tSettlementRTN as string,\n\t\tTraceNumber as string,\n\t\tAcqTraceNumber as string,\n\t\tVisaTransactionID as string,\n\t\tMasterCardTransactionID as string,\n\t\tMerchantAccountNumber as string,\n\t\tISOMessageType as string,\n\t\tForwardingRTN as string\n\t),\n\tallowSchemaDrift: false,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tformat: 'parquet',\n\twildcardPaths:[(concat\r\n(\r\n'Transactions/'\r\n, substring($load_date,0,4)\r\n,'/'\r\n,substring($load_date,5,2)\r\n,'/'\r\n,substring($load_date,7,2)\r\n,'/FISDebitTransaction_*'\r\n))]) ~> srcFISConformedTransactions\nsource(output(\n\t\trun_id as long,\n\t\tload_date as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'SELECT run_id, load_date\\n  FROM [Audit].[transactions_log] a \\n  INNER JOIN (Select [file_name], max(create_date) as create_date from [Audit].[transactions_log] where source_system_key = 1 and [file_name] like \\'FISDebitTransaction%\\'\\ngroup by [file_name]) b\\n  on a.[file_name] = b.[file_name]\\n  and a.create_date = b.create_date',\n\tformat: 'query',\n\tstaged: false) ~> dwTransactionAuditLog\nsource(output(\n\t\tROWID as long,\n\t\tPAN as string,\n\t\t{SWITCH DATE} as string,\n\t\t{LOCAL DATE} as string,\n\t\t{DEBIT AMOUNT} as string,\n\t\t{CREDIT AMOUNT} as string,\n\t\t{MEMO AMOUNT} as string,\n\t\t{TERMINAL INTERCHANGE FEE} as string,\n\t\tSIGN7 as string,\n\t\t{CARDHOLDER INTERCHANGE FEE} as string,\n\t\tSIGN9 as string,\n\t\tACQ as string,\n\t\tISS as string,\n\t\t{TERM INST} as string,\n\t\t{CARD INST} as string,\n\t\t{TRAN TYPE} as string,\n\t\t{TRAN ID} as string,\n\t\tRRN as string,\n\t\t{SEQ NO} as string,\n\t\t{ACQ/ISS} as string,\n\t\t{ACTION CODE} as string,\n\t\t{TRANSACTION DESCRIPTION} as string,\n\t\t{REV REASON} as string,\n\t\t{REJ REASON} as string,\n\t\t{TRACE DATA} as string,\n\t\tProp_24 as string,\n\t\tProp_25 as string,\n\t\tfile_name as string,\n\t\tprocessed as boolean,\n\t\tcreate_date as string,\n\t\tmodified_date as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: (concat('Select * from [Staging].[FIS_Interchange_RAW] where processed = 0 and substring([LOCAL DATE],1,6)<= substring(convert(varchar(8),DATEADD(DAY,2,convert(date,',toString('\\''+ right($load_date,6)+ '\\''),')),112),3,6) and substring([LOCAL DATE],1,6) >= substring(convert(varchar(8),DATEADD(DAY,-7,convert(date,',toString('\\''+ right($load_date,6)+ '\\''),')),112),3,6) and cast([create_date] as datetime) > DATEADD(DAY,-7,GETUTCDATE())')),\n\tformat: 'query',\n\tstaged: false,\n\tpartitionColumn: 'ROWID',\n\tpartitionBy('external', 8)) ~> srcInterchangeRaw\nFilterCard derive(each(match(type=='string'), $$ = trim(iif(toString($$)!='NULL',$$,toString(null()))))) ~> Trim\nTrim select(mapColumn(\n\t\tROWID,\n\t\tPAN,\n\t\t{LOCAL DATE},\n\t\t{TERMINAL INTERCHANGE FEE},\n\t\tSIGN7,\n\t\t{CARDHOLDER INTERCHANGE FEE},\n\t\tSIGN9,\n\t\tfile_name,\n\t\t{TERM INST},\n\t\tRRN\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> LimitSelectInterchange\nLimitSelectInterchange derive(local_date_timestamp = right(left({LOCAL DATE},12),6),\n\t\tlocal_date = toDate(left({LOCAL DATE},6),'yyMMdd'),\n\t\tinterchange_real = (iif(SIGN7=='DR', toDecimal(concat('-',{TERMINAL INTERCHANGE FEE})), toDecimal({TERMINAL INTERCHANGE FEE})))\r\n+\r\n(iif(SIGN9=='DR', toDecimal(concat('-',{CARDHOLDER INTERCHANGE FEE})), toDecimal({CARDHOLDER INTERCHANGE FEE}))),\n\t\tmodified_date = toString(currentUTC()),\n\t\tPAN_masked = iif(like(PAN,'%XXXXXX%'),concat(left(PAN,6),right(PAN,4)),left(PAN,16)),\n\t\tprocessed = 1,\n\t\tRRN = left(RRN,12)) ~> deriveInterchange\nLimitSelectTransactions derive(OriginDate_timestamp = replace(left(TimeLocalTransaction,8),':',''),\n\t\tsource_system_key = 1,\n\t\tAccountNumber = left(AccountNumber,16),\n\t\tmasked_acctnum = concat(left(AccountNumber,6),right(left(AccountNumber,16),4))) ~> derivedTrans\nSelectFinal alterRow(updateIf(true())) ~> MarkUpdates\nSelectFinal derive(create_date = toTimestamp(modified_date),\n\t\tcolumn_name = 'interchange_amount') ~> DerivedColumn\nSelectFinal aggregate(groupBy(ImportFileDate),\n\tcount = count()) ~> DistinctLoadID\nDistinctLoadID, derivedTransactionLog lookup(ImportFileDate == load_date,\n\tmultiple: true,\n\tbroadcast: 'auto',\n\tpickup: 'any')~> Lookup1\nLookup1 alterRow(updateIf(true())) ~> AlterRow1\ndwTransactionAuditLog derive(load_date = toDate(load_date),\n\t\tloaded_to_semantic = false(),\n\t\tsem_start_date = toTimestamp(toString(null())),\n\t\tsem_end_date = toTimestamp(toString(null()))) ~> derivedTransactionLog\nderivedTrans, deriveInterchange join((PAN_masked==AccountNumber||PAN_masked==masked_acctnum)\r\n&&\r\nlocal_date==OriginDate\r\n&&\r\nlocal_date_timestamp==OriginDate_timestamp\r\n&&\r\n{TERM INST}==ForwardingRTN\r\n&&\r\nRetrievalReferenceNumber==left(RRN,length(RetrievalReferenceNumber)),\n\tjoinType:'cross',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinCOOP\nTrimConformed select(mapColumn(\n\t\tAccountNumber,\n\t\tImportFileDate,\n\t\tSource,\n\t\tInterchangeAmount,\n\t\tOriginDate,\n\t\tTimeLocalTransaction,\n\t\tTransaction_Key,\n\t\tForwardingRTN,\n\t\tRetrievalReferenceNumber\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> LimitSelectTransactions\nJoinCOOP select(mapColumn(\n\t\tAccountNumber,\n\t\tImportFileDate,\n\t\tSource,\n\t\tInterchangeAmount,\n\t\tOriginDate,\n\t\tTransaction_Key,\n\t\tsource_system_key,\n\t\tROWID,\n\t\tfile_name,\n\t\tinterchange_real,\n\t\tmodified_date,\n\t\tprocessed\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectFinal\nFilterAuthorizations derive(each(match(type=='string'), $$ = trim($$))) ~> TrimConformed\nsrcFISConformedTransactions filter(is_authorization==0 \r\n&&\r\nSettlementRTN==ForwardingRTN\r\n&&\r\nleft(ISOMessageType,2) != 'OE') ~> FilterAuthorizations\nsrcInterchangeRaw filter(instr(file_name,$card) > 0) ~> FilterCard\nMarkUpdates sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\ttransaction_key as long,\n\t\tsource_system_key as integer,\n\t\tsource_system_id as string,\n\t\taccount_key as string,\n\t\tacquirer_key as long,\n\t\tAcquirer_Network_key as long,\n\t\tbin_key as long,\n\t\tcard_entry_method_code_key as long,\n\t\tcard_presence_desc as string,\n\t\timport_file_date_key as date,\n\t\tinterchange_amount as decimal(25,2),\n\t\tissuer_key as long,\n\t\tissuer_network_key as long,\n\t\tmerchant_key as long,\n\t\tmerchant_terminal_geography_key as long,\n\t\tmerchant_type_key as long,\n\t\tmonetary as boolean,\n\t\ton_us_desc as string,\n\t\ttransmission_date_key as date,\n\t\torigin_date_key as date,\n\t\trecurring_desc as string,\n\t\tresponse_code_key as long,\n\t\tsettlement_amount as decimal(25,2),\n\t\tsettlement_date_key as date,\n\t\tsurcharge_amount as decimal(25,2),\n\t\ttermnial_key as long,\n\t\ttoken_requestid as long,\n\t\ttransaction_name_key as long,\n\t\tTransaction_type_key as long,\n\t\trun_id as long,\n\t\tdigital_card_issued_ind as boolean,\n\t\tauthorization_ind as boolean,\n\t\tauthorization_no as string\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['transaction_key','source_system_key','origin_date_key'],\n\tskipKeyWrites:true,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 1,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\ttransaction_key = Transaction_Key,\n\t\tsource_system_key,\n\t\torigin_date_key = OriginDate,\n\t\tinterchange_amount = interchange_real\n\t)) ~> snkFactTransactions\nDerivedColumn sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tsource_system_key as integer,\n\t\ttransaction_key as long,\n\t\tcolumn_name as string,\n\t\told_value as string,\n\t\tnew_value as string,\n\t\tload_date as timestamp,\n\t\tcreate_date as timestamp,\n\t\tfile_name as string\n\t),\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tbatchSize: 5000,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 4,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tsource_system_key,\n\t\ttransaction_key = Transaction_Key,\n\t\tcolumn_name,\n\t\told_value = InterchangeAmount,\n\t\tnew_value = interchange_real,\n\t\tload_date = ImportFileDate,\n\t\tcreate_date,\n\t\tfile_name\n\t)) ~> snkAuditInterchange\nAlterRow1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\trun_id as long,\n\t\tsource_system_key as integer,\n\t\tfile_name as string,\n\t\trecord_count as long,\n\t\tloaded_to_semantic as boolean,\n\t\tload_date as timestamp,\n\t\tcreate_date as timestamp,\n\t\tsem_start_date as timestamp,\n\t\tsem_end_date as timestamp,\n\t\tsf_loaded_to_semantic as boolean,\n\t\tsf_sem_start_date as timestamp,\n\t\tsf_sem_end_date as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['run_id'],\n\tskipKeyWrites:true,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 3,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\trun_id,\n\t\tloaded_to_semantic,\n\t\tsem_start_date,\n\t\tsem_end_date,\n\t\tsf_loaded_to_semantic = loaded_to_semantic,\n\t\tsf_sem_start_date = sem_start_date,\n\t\tsf_sem_end_date = sem_end_date\n\t)) ~> snkAuditTransactionsLog\nMarkUpdates sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tROWID as long,\n\t\tPAN as string,\n\t\t{SWITCH DATE} as string,\n\t\t{LOCAL DATE} as string,\n\t\t{DEBIT AMOUNT} as string,\n\t\t{CREDIT AMOUNT} as string,\n\t\t{MEMO AMOUNT} as string,\n\t\t{TERMINAL INTERCHANGE FEE} as string,\n\t\tSIGN7 as string,\n\t\t{CARDHOLDER INTERCHANGE FEE} as string,\n\t\tSIGN9 as string,\n\t\tACQ as string,\n\t\tISS as string,\n\t\t{TERM INST} as string,\n\t\t{CARD INST} as string,\n\t\t{TRAN TYPE} as string,\n\t\t{TRAN ID} as string,\n\t\tRRN as string,\n\t\t{SEQ NO} as string,\n\t\t{ACQ/ISS} as string,\n\t\t{ACTION CODE} as string,\n\t\t{TRANSACTION DESCRIPTION} as string,\n\t\t{REV REASON} as string,\n\t\t{REJ REASON} as string,\n\t\t{TRACE DATA} as string,\n\t\tProp_24 as string,\n\t\tProp_25 as string,\n\t\tfile_name as string,\n\t\tprocessed as boolean,\n\t\tcreate_date as string,\n\t\tmodified_date as string\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['ROWID'],\n\tskipKeyWrites:true,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tpostSQLs:['Update Statistics [Staging].[FIS_Interchange_RAW] '],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 2,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tROWID,\n\t\tprocessed,\n\t\tmodified_date\n\t)) ~> snkInterchangeRaw"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/DF_dimTerminal_ATMInd')]",
            "type": "Microsoft.DataFactory/factories/dataflows",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "One Off dataflow to populate dim terminal historically for atm indicator.",
                "folder": {
                    "name": "Temporary Loads"
                },
                "type": "MappingDataFlow",
                "typeProperties": {
                    "sources": [
                        {
                            "dataset": {
                                "referenceName": "DS_ATM_terminals_history",
                                "type": "DatasetReference"
                            },
                            "name": "srcATMTerminals"
                        }
                    ],
                    "sinks": [
                        {
                            "dataset": {
                                "referenceName": "dim_Terminal",
                                "type": "DatasetReference"
                            },
                            "name": "snkdimTerminal"
                        }
                    ],
                    "transformations": [
                        {
                            "name": "deriveATMTerminal"
                        },
                        {
                            "name": "setUpdate"
                        },
                        {
                            "name": "dedupeATMs"
                        }
                    ],
                    "script": "source(output(\n\t\tterminal_code as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> srcATMTerminals\nsrcATMTerminals derive(atm_indicator = toBoolean('1'),\n\t\teach(match(type=='string'), $$ = trim($$))) ~> deriveATMTerminal\ndedupeATMs alterRow(updateIf(true())) ~> setUpdate\nderiveATMTerminal aggregate(groupBy(terminal_code),\n\tatm_indicator = max(atm_indicator)) ~> dedupeATMs\nsetUpdate sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinput(\n\t\tatm_terminal_key as long,\n\t\tsource_system_key as integer,\n\t\tterminal_key as string,\n\t\tclient_key as long,\n\t\tcoop_atm_indicator as boolean,\n\t\ton_premise_indicator as boolean,\n\t\tatm_indicator as boolean,\n\t\tload_date as date,\n\t\tmodified_date as date,\n\t\tcreate_date as timestamp\n\t),\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['terminal_key'],\n\tskipKeyWrites:true,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tterminal_key = terminal_code,\n\t\tatm_indicator\n\t)) ~> snkdimTerminal"
                }
            },
            "dependsOn": []
        }
    ]
}